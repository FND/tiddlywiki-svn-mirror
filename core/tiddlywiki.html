<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!--
TiddlyWiki 1.2.22 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Published under a BSD open source license
Incorporating improvements by Isao Sonobe, http://www-gauge.scphys.kyoto-u.ac.jp/~sonobe/OgreKit/OgreKitWiki.html

Copyright (c) Osmosoft Limited, 14 April 2005

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the Osmosoft Limited nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<title>TiddlyWiki</title>
<script type="text/javascript">
 
// ---------------------------------------------------------------------------------
// Main
// ---------------------------------------------------------------------------------

// Default options
var options = {
	 chkRegExp: false,
	 chkCaseSens: false,
	 chkAnimate: true,
	 txtUserName: "YourName",
	 chkSaveBackups: true,
	 chkAutoSave: false,
	 chkGenerateAnRssFeed: false,
	 chkSaveEmptyTemplate: false,
	 txtCurrentTab: "tabTimeline",
	 txtTabMore: "moreTabAll"
	 };

// Number of items in the RSS feed
var numRssItems = 20;

// Special tiddlers
var specialTiddlers = ["SiteTitle","SiteSubtitle","MainMenu","DefaultTiddlers","SaveChanges","SiteUrl","StyleSheet"];

var store = new TiddlyWiki();

// Starting up
function main()
{
    setupRegexp();
    saveTest();
    store.loadFromDiv("storeArea","store");
    var css = store.getTiddlerText("StyleSheet");
    if(css)
        addStylesheet(css);
    loadOptionsCookie();
    setupOptionsPanel();
    refreshAll();
    var start = store.getTiddlerText("DefaultTiddlers");
    if(window.location.hash)
        displayTiddlers(null,convertUTF8ToUnicode(decodeURI(window.location.hash.substr(1))),1,null,null);
    else if(start)
        displayTiddlers(null,start,1,null,null);
}

function saveTest()
{
    var saveTest = document.getElementById("saveTest");
    if(saveTest.hasChildNodes())
        alert("It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details");
    saveTest.appendChild(document.createTextNode("savetest"));
}

// ---------------------------------------------------------------------------------
// Tiddler() object
// ---------------------------------------------------------------------------------

function Tiddler()
{
    this.title = null;
    this.text = null;
    this.modifier = null;
    this.modified = null;
    this.links = [];
    this.tags = [];
    return this;
}

// Load a tiddler from an HTML DIV
Tiddler.prototype.loadFromDiv = function(divRef,idPrefix)
{
    this.title = divRef.id.substr(idPrefix.length);
    this.text = divRef.firstChild ? divRef.firstChild.nodeValue : "";
    this.text = this.unescapeLineBreaks();
    this.modifier = divRef.getAttribute("modifier");
    this.modified = divRef.getAttribute("modified");
    if (this.modified) this.modified = convertFromYYYYMMDDHHMM(this.modified);
    this.setTags(divRef.getAttribute("tags"));
    this.changed();
    return this;
}

// Format the text for storage in an HTML DIV
Tiddler.prototype.saveToDiv = function()
{
    return '<div id="store' + this.title + '" modified="' +
                            convertToYYYYMMDDHHMM(this.modified) + '" modifier="' + this.modifier + 
                            '" tags="' + this.getTags() + '">' +
                            htmlEncode(this.escapeLineBreaks()) + '</div>';
}

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(url)
{
    var s = [];
    s.push("<item>");
    s.push("<title>" + htmlEncode(this.title) + "</title>");
    s.push("<description>" + htmlEncode(this.text.replace(regexpNewLine,"<br />")) + "</description>");
    s.push("<link>" + url + "#" + encodeURIComponent(encodeTiddlyLink(this.title)) + "</link>");
    s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
    s.push("</item>");
    return(s.join("\n"));
}

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified)
{
    if(title != null)
        this.title = title;
    if(text != null)
        this.text = text;
    if(modifier != null)
        this.modifier = modifier;
    if(modified != null)
        this.modified = modified;
    this.changed();
    return this;
}

// Set the tags for a tiddler (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.setTags = function(tags)
{
    if(tags)
        this.tags = readTiddlerList(tags);
    else
        this.tags = [];
    return this;
}

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
    if(this.tags)
        {
        var results = [];
        for(var t=0; t<this.tags.length; t++)
            results.push(encodeTiddlyLink(this.tags[t]));
        return results.join(" ");
        }
    else
        return "";
}

var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");

// Convert "\n" to newlines, "\s" to "\"
Tiddler.prototype.unescapeLineBreaks = function()
{
    return this.text.replace(regexpBackSlashEn,"\n").replace(regexpBackSlashEss,"\\").replace(regexpCarriageReturn,"");
}

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
    return this.text.replace(regexpBackSlash,"\\s").replace(regexpNewLine,"\\n").replace(regexpCarriageReturn,"");
}

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
    this.links = [];
    var nextPos = 0;
    var theLink;
    do {
        var formatMatch = wikiNameRegExp.exec(this.text);
        if(formatMatch)
            {
            if(formatMatch[1])
                this.links.push(formatMatch[0]);
            else if(formatMatch[5])
                this.links.push(formatMatch[0].substr(2,formatMatch[0].length-4));
            }
    } while(formatMatch);
    return;
}

Tiddler.prototype.getSubtitle = function()
{
    var theModifier = this.modifier;
    if(!theModifier)
        theModifier = "(unknown)";
    var theModified = this.modified;
    if(theModified)
        theModified = theModified.toLocaleString();
    else
        theModified = "(unknown)";
    return(theModifier + ", " + theModified);
}

// ---------------------------------------------------------------------------------
// TiddlyWiki() object contains Tiddler()s
// ---------------------------------------------------------------------------------

function TiddlyWiki()
{
    this.tiddlers = {};
    this.dirty = false;
}

// Clear a TiddlyWiki so that it contains no tiddlers
TiddlyWiki.prototype.clear = function(src)
{
    this.tiddlers = {};
}

TiddlyWiki.prototype.removeTiddler = function(title)
{
    if(this.tiddlers[title])
        delete this.tiddlers[title];
}

TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
    var tiddler = this.tiddlers[title];
    if(tiddler)
        return tiddler.text;
    if(defaultText)
        return defaultText;
    else
        return null;
}

TiddlyWiki.prototype.createTiddler = function(title,body,modifier,modified,tags)
{
    this.tiddlers[title] = new Tiddler();
    return this.setTiddler(title,title,body,modifier,modified,tags);
}

TiddlyWiki.prototype.setTiddler = function(title,newTitle,newBody,modifier,modified,tags)
{
    var tiddler = this.tiddlers[title];
    if(tiddler)
        delete this.tiddlers[title];
    tiddler = new Tiddler();
    tiddler.set(newTitle,newBody,modifier,modified)
    tiddler.setTags(tags);
    this.tiddlers[newTitle] = tiddler;
    return tiddler;
}

// Load contents of a tiddlywiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(srcID,idPrefix)
{
    if(document.normalize)
        document.normalize();
    var lenPrefix = idPrefix.length;
    var store = document.getElementById(srcID).childNodes;
    for(var t = 0; t < store.length; t++) {
        var e = store[t];
        if(e.id)
            if(e.id.substr(0,lenPrefix) == idPrefix) {
                var tiddler = new Tiddler();
                tiddler.loadFromDiv(e,idPrefix);
                this.tiddlers[tiddler.title] = tiddler;
                }
        }
    this.dirty = false;
}

// Return an array of tiddlers matching a search string
TiddlyWiki.prototype.search = function(searchText,caseSensitive,useRegExp,sortField)
{
    if (!useRegExp)
        searchText = escapeRegExp(searchText);
    var regExp = new RegExp(searchText,caseSensitive ? "m" : "im");
    var results = [];
    for(var t in this.tiddlers)
        {
        if(regExp.exec(t) || regExp.exec(this.tiddlers[t].text))
            results.push(this.tiddlers[t]);
        }
    if(!sortField)
        sortField = "title";
    results.sort(function (a,b) {if(a[sortField] == b[sortField]) return(0); else return (a[sortField] < b[sortField]) ? -1 : +1; });
    return results;
}

// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances
TiddlyWiki.prototype.getTags = function()
{
    var results = [];
    for(var t in this.tiddlers)
        {
        var tiddler = this.tiddlers[t];
        for(g=0; g<tiddler.tags.length; g++)
            {
            var tag = tiddler.tags[g];
            var f = false;
            for(var c=0; c<results.length; c++)
                if(results[c][0] == tag)
                    {
                    f = true;
                    results[c][1]++;
                    }
            if(!f)
                results.push([tag,1]);
            }
        }
    results.sort(function (a,b) {if(a[0] == b[0]) return(0); else return (a[0] < b[0]) ? -1 : +1; });
    return results;
}

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,exclude,sortField)
{
    return this.reverseLookup("tags",tag,exclude,sortField);
}

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,exclude,sortField)
{
    return this.reverseLookup("links",title,exclude,sortField);
}

// Return an array of the tiddlers that have a specified entry in the specified storage array (ie, "links" or "tags")
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,exclude,sortField)
{
    var results = [];
    for(var t in this.tiddlers)
        {
        var tiddler = this.tiddlers[t];
        var f = false;
        if(tiddler.title != exclude)
            for(var lookup=0; lookup<tiddler[lookupField].length; lookup++)
                if(tiddler[lookupField][lookup] == lookupValue)
                    f = true;
        if(f)
            results.push(tiddler);
        }
    if(!sortField)
        sortField = "title";
    results.sort(function (a,b) {if(a[sortField] == b[sortField]) return(0); else return (a[sortField] < b[sortField]) ? -1 : +1; });
    return results;
}

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field)
{
    var results = [];
    for(var t in this.tiddlers)
        results.push(this.tiddlers[t]);
    if(field)
        results.sort(function (a,b) {if(a[field] == b[field]) return(0); else return (a[field] < b[field]) ? -1 : +1; });
    return results;
}

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
    var results = [];
    for(var t in this.tiddlers)
        {
        var tiddler = this.tiddlers[t];
        for(var n=0; n<tiddler.links.length;n++)
            {
            var link = tiddler.links[n];
            if(this.tiddlers[link] == null)
                {
                var e = false;
                for(var c=0;c<results.length;c++)
                    if(results[c]==link)
                        e = true;
                if(!e)
                    results.push(link);
                }
            }
        }
    results.sort();
    return results;
}

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
    var results = [];
    for(var t in this.tiddlers)
        if(this.getReferringTiddlers(t).length == 0)
            results.push(t);
    results.sort();
    return results;
}

// ---------------------------------------------------------------------------------
// Tiddler functions
// ---------------------------------------------------------------------------------

// Display several tiddlers from a list of space separated titles
function displayTiddlers(src,titles,state,highlightText,highlightCaseSensitive,slowly)
{
    var tiddlerNames = readTiddlerList(titles);
    for(var t = tiddlerNames.length-1;t>=0;t--)
        displayTiddler(src,tiddlerNames[t],state,highlightText,highlightCaseSensitive,slowly);
}

// Display a tiddler with animation and scrolling, as though a link to it has been clicked on
//  src = source element object (eg link) for animation effects and positioning
//  title = title of tiddler to display
//  state = 0 is default or current state, 1 is read only and 2 is edittable
//  highlightText = text to highlight in the displayed tiddler
//  highlightCaseSensitive = flag for whether the highlight text is case sensitive
function displayTiddler(src,title,state,highlightText,highlightCaseSensitive,slowly)
{
    var place = document.getElementById("tiddlerDisplay");
    var after = findContainingTiddler(src); // Which tiddler this one will be positioned after
    var before;
    if(after == null)
        before = place.firstChild;
    else if(after.nextSibling)
        before = after.nextSibling;
    else
        before = null;
    var theTiddler = createTiddler(place,before,title,state,highlightText,highlightCaseSensitive);
    if(src)
        {
        var floater = document.getElementById("floater");
        var floaterTitle = document.createTextNode(title);
        if(floater.firstChild)
            floater.replaceChild(floaterTitle,floater.firstChild);
        if(options.chkAnimate)
            {
            theTiddler.style.opacity = 0;
            startZoomer(floater,src,theTiddler,slowly);
            }
        else
            window.scrollTo(0,ensureVisible(theTiddler));
        }
}

// Create a tiddler if it doesn't exist (with no fancy animating)
//  place = parent element
//  before = node before which to create/move the tiddler
//  title = title of tiddler to display
//  state = 0 is default or current state, 1 is read only and 2 is edittable
//  highlightText = text to highlight in the displayed tiddler
//  highlightCaseSensitive = flag for whether the highlight text is case sensitive
function createTiddler(place,before,title,state,highlightText,highlightCaseSensitive)
{
    var theTiddler = createTiddlerSkeleton(place,before,title);
    createTiddlerTitle(title,highlightText,highlightCaseSensitive);
    var theViewer = document.getElementById("viewer" + title);
    var theEditor = document.getElementById("editor" + title);
    switch(state)
        {
        case 0:
            if(!theViewer && !theEditor)
                {
                createTiddlerToolbar(title,false);
                createTiddlerViewer(title,highlightText,highlightCaseSensitive);
                }
            break;
        case 1: // Viewer
            if(theViewer)
                theViewer.parentNode.removeChild(theViewer);
            if(theEditor)
                theEditor.parentNode.removeChild(theEditor);
            createTiddlerToolbar(title,false);
            createTiddlerViewer(title,highlightText,highlightCaseSensitive);
            break;
        case 2: // Editor
            if(!theEditor)
                {
                if(theViewer)
                    theViewer.parentNode.removeChild(theViewer);
                createTiddlerToolbar(title,true);
                createTiddlerEditor(title);
                }
            break;
        }
    return(theTiddler);
}

function refreshTiddler(title)
{
    var theViewer = document.getElementById("viewer" + title);
    if(theViewer)
        {
        theViewer.parentNode.removeChild(theViewer);
        createTiddlerViewer(title,null,null);
        }
}

function createTiddlerSkeleton(place,before,title)
{
    var theTiddler = document.getElementById("tiddler" + title);
    if(!theTiddler)
        {
        theTiddler = createTiddlyElement(null,"div","tiddler" + title,"tiddler",null);
        theTiddler.onmouseover = onMouseOverTiddler;
        theTiddler.onmouseout = onMouseOutTiddler;
        theTiddler.ondblclick = onDblClickTiddler;
        var theInnerTiddler = createTiddlyElement(theTiddler,"div",null,"innerTiddler",null);
        var theTitle = createTiddlyElement(theInnerTiddler,"div","title" + title,"title",null);
        var theToolbar = createTiddlyElement(theInnerTiddler,"div","toolbar" + title,"toolbar", null);
        var theBody = createTiddlyElement(theInnerTiddler,"div","body" + title,"body",null);
        place.insertBefore(theTiddler,before);
        }
    return(theTiddler);
}

function createTiddlerTitle(title,highlightText,highlightCaseSensitive)
{
    var theTitle = document.getElementById("title" + title);
    if(theTitle)
        {
        removeChildren(theTitle);
        if(highlightText == "")
            highlightText = null;
        var highlightRegExp,highlightMatch;
        if(highlightText)
            {
            highlightRegExp = new RegExp(highlightText,highlightCaseSensitive ? "mg" : "img");
            highlightMatch = highlightRegExp.exec(title);
            }
        highlightMatch = subWikify(theTitle,title,0,title.length,highlightRegExp,highlightMatch);
        var tiddler = store.tiddlers[title];
        if(tiddler)
            theTitle.title = tiddler.getSubtitle();
        }
}

// Create a tiddler toolbar according to whether it's an editor or not
function createTiddlerToolbar(title,editor)
{
    var theToolbar = document.getElementById("toolbar" + title);
    if(theToolbar)
        {
        removeChildren(theToolbar);
        insertSpacer(theToolbar);
        if(!editor)
            {
            // Non-editor toolbar
            createTiddlyButton(theToolbar,"close","Close this tiddler",onClickToolbarClose);
            insertSpacer(theToolbar);
            createTiddlyButton(theToolbar,"edit","Edit this tiddler",onClickToolbarEdit);
            insertSpacer(theToolbar);
            createTiddlyButton(theToolbar,"permalink","Permalink for this tiddler",onClickToolbarPermaLink);
            insertSpacer(theToolbar);
            createTiddlyButton(theToolbar,"references","Show tiddlers that link to this one",onClickToolbarReferences);
            }
        else
            {
            // Editor toolbar
            createTiddlyButton(theToolbar,"done","Save changes to this tiddler",onClickToolbarSave);
            insertSpacer(theToolbar);
            createTiddlyButton(theToolbar,"cancel","Undo changes to this tiddler",onClickToolbarUndo);
            insertSpacer(theToolbar);
            createTiddlyButton(theToolbar,"delete","Delete this tiddler",onClickToolbarDelete);
            }
        insertSpacer(theToolbar);
        }
}

function createTiddlerPopup(srcElement)
{
    var popup = document.getElementById("popup");
    if(popup && popup.nextSibling == srcElement)
        {
        hideTiddlerPopup();
        return null;
        }
    if(popup)
        popup.parentNode.removeChild(popup);
    popup = createTiddlyElement(null,"div","popup",null,null);
    popup.style.left = srcElement.offsetLeft;
    popup.style.top = srcElement.offsetTop + srcElement.offsetHeight;
    popup.style.display = "block";
    srcElement.onmouseout = onMouseOutTiddlerPopup;
    srcElement.appendChild(popup);
    return popup;
}

function onMouseOutTiddlerPopup(e)
{
    if (!e) var e = window.event;
    var related = (e.relatedTarget) ? e.relatedTarget : e.toElement;
    while (related != this && related && related.nodeName.toLowerCase() != "body")
        related = related.parentNode;
    if(related != this)   
        {
        this.onmouseout = null;
        hideTiddlerPopup();
        }
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    return(false);
}

function hideTiddlerPopup()
{
    var popup = document.getElementById("popup");
    if(popup)
        popup.parentNode.removeChild(popup);
}

// Create the body section of a read-only tiddler
function createTiddlerViewer(title,highlightText,highlightCaseSensitive)
{
    var theBody = document.getElementById("body" + title);
    if(theBody)
        {
        var tiddlerText = store.getTiddlerText(title);
        var tiddlerExists = (tiddlerText != null);
        if(!tiddlerExists)
            tiddlerText = "This tiddler doesn't yet exist. Double-click to create it";
        var theViewer = createTiddlyElement(theBody,"div","viewer" + title,"viewer",null);
        if(!tiddlerExists)
            theViewer.style.fontStyle = "italic";
        wikify(tiddlerText,theViewer,highlightText,highlightCaseSensitive);
        var tiddler = store.tiddlers[title];
        if(tiddler)
            {
            var prompt = tiddler.tags.length == 0 ? "no tags" : "tags:";
            var theTags = createTiddlyElement(theViewer,"div","viewerTags" + title,"tags",prompt);
            for(var t=0; t<tiddler.tags.length; t++)
                {
                var theTag = createTiddlyButton(theTags,tiddler.tags[t],"Show tiddlers tagged with '" + tiddler.tags[t] + "'",onClickTag);
                theTag.setAttribute("tag",tiddler.tags[t]);
                insertSpacer(theTags);
                }
            }
        }
}

// Create the body section of an edittable tiddler
function createTiddlerEditor(title)
{
    var theBody = document.getElementById("body" + title);
    if(theBody)
        {
        var tiddlerText = store.getTiddlerText(title);
        var tiddlerExists = (tiddlerText != null);
        if(!tiddlerExists)
            tiddlerText = "Type the text for '" + title + "' here.";
        var theEditor = createTiddlyElement(theBody,"div","editor" + title,"editor",null);
        theEditor.onkeypress = onEditKey;
        var theTitleBox = createTiddlyElement(theEditor,"input","editorTitle" + title,null,null);
        theTitleBox.setAttribute("type","text");
        theTitleBox.value = title;
        theTitleBox.setAttribute("size","40");
        var theBodyBox = createTiddlyElement(theEditor,"textarea","editorBody" + title,null,null);
        theBodyBox.value = tiddlerText;
        var rows = 10;
        var lines = tiddlerText.match(regexpNewLine);
        if(lines != null && lines.length > rows)
            rows = lines.length + 5;
        theBodyBox.setAttribute("rows",rows);
        createTiddlyElement(theEditor,"div",null,"editorPrompt","Tags separated with spaces, [[use brackets]] for tags containing spaces");
        var theTagsBox = createTiddlyElement(theEditor,"input","editorTags" + title,null,null);
        theTagsBox.setAttribute("type","text");
        var tiddler = store.tiddlers[title];
        theTagsBox.value = tiddler ? tiddler.getTags() : "";
        theTagsBox.setAttribute("size","40");
        theBodyBox.focus();
        }
}

function saveTiddler(title)
{
    var newTitle = document.getElementById("editorTitle" + title).value;
    var newBody = document.getElementById("editorBody" + title).value;
    var newTags = document.getElementById("editorTags" + title).value;
    store.setTiddler(title,newTitle,newBody,options.txtUserName,new Date(),newTags);
    displayTiddler(null,newTitle,1,null,null,null,false);
    // Close the old tiddler if this is a rename
    if(title != newTitle)
        {
        var oldTiddler = document.getElementById("tiddler" + title);
        oldTiddler.parentNode.removeChild(oldTiddler);
        }
    refreshAll(title);
    if(options.chkAutoSave)
        saveChanges();
}

function searchTiddlers(searchText,caseSensitive,useRegExp)
{
    closeAllTiddlers();
    var matches = store.search(searchText,caseSensitive,useRegExp);
    if(store.tiddlers[searchText])
        displayTiddler(null,searchText,1,searchText,caseSensitive,false); // Special case of searching for a tiddler title
    for(var t=matches.length-1; t>=0;t--)
        displayTiddler(null,matches[t].title,1,searchText,caseSensitive,false);
    var q = useRegExp ? "/" : "'";
    displayMessage(matches.length + " tiddlers found matching " + q + searchText + q);
}

function selectTiddler(title)
{
    var e = document.getElementById("toolbar" + title);
    if(e != null)
        e.style.visibility = "visible";
    e = document.getElementById("viewerTags" + title);
    if(e != null)
        e.style.visibility = "visible";
}

function deselectTiddler(title)
{
    var e = document.getElementById("toolbar" + title);
    if(e != null)
        e.style.visibility = "hidden";
    e = document.getElementById("viewerTags" + title);
    if(e != null)
        e.style.visibility = "hidden";
}

function deleteTiddler(title)
{
    closeTiddler(title,false);
    store.removeTiddler(title);
    refreshAll(title);
    // Autosave
    if(options.chkAutoSave)
        saveChanges();
}

function closeTiddler(title,slowly)
{
    var tiddler = document.getElementById("tiddler" + title);
    if(tiddler != null)
        {
        scrubIds(tiddler);
        if(options.chkAnimate)
            startSlider(tiddler,false,slowly,"all");
        else
            tiddler.parentNode.removeChild(tiddler);
        }
}

function scrubIds(e)
{
    if(e.id)
        e.id = null;
    var children = e.childNodes;
    for(var t=0; t<children.length; t++)
        {
        var c = children[t];
        if(c.id)
            c.id = null;
        }
}

function closeAllTiddlers()
{
    clearMessage();
    var place = document.getElementById("tiddlerDisplay");
    var tiddler = place.firstChild;
    var nextTiddler;
    while(tiddler)
        {
        nextTiddler = tiddler.nextSibling;
        if(tiddler.id)
            if(tiddler.id.substr(0,7) == "tiddler")
                {
                var title = tiddler.id.substr(7);
                if(!document.getElementById("editor" + title))
                    place.removeChild(tiddler);
                }
        tiddler = nextTiddler;
        }
}

// ---------------------------------------------------------------------------------
// Regular expression stuff
// ---------------------------------------------------------------------------------

var upperLetter = "[A-ZÀ-Þ]";
var lowerLetter = "[a-zß-ÿ_0-9\\-]";
var anyLetter = "[A-Za-zÀ-Þß-ÿ_0-9\\-]";
var anyDigit = "[0-9]";
var anyNumberChar = "[0-9\\.E]";
var wikiNamePattern = "(?:" + upperLetter + "+" + lowerLetter + "+" + upperLetter + anyLetter + "*)|(?:" + upperLetter + "{2,}" + lowerLetter + "+)";
var urlPattern = "(?:http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)";
var explicitLinkPattern = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
var bracketNamePattern = "\\[\\[([^\\]]+)\\]\\]";

var wikiNamePatterns;
var wikiNameRegExp;
var structurePatterns;
var stylePatterns;
var tableRegExp;
var tableRowColRegExp;
var invalidPreWikiNamePattern;

function setupRegexp()
{
    // Table rows pattern
    var rowPattern = "^\\|([^\\n]*\\|)([fhc]?)$";
    tableRegExp = new RegExp(rowPattern,"mg");
    // Table columns pattern
    var elementPattern = "(?:(?:BGCOLOR|bgcolor)\\(([^\\)]+)\\):)?" +
        "("+
        "("+explicitLinkPattern+")?"+
        "("+bracketNamePattern+")?" +
        "[^\\|]*"+
        ")\\|";
    tableRowColRegExp = new RegExp(elementPattern,"g");
    // Link patterns
    wikiNamePatterns = "(" + wikiNamePattern + 
        ")|(" + urlPattern + 
        ")|(?:" + explicitLinkPattern + 
        ")|(?:" + bracketNamePattern + 
        ")";
    wikiNameRegExp = new RegExp(wikiNamePatterns,"mg");
    invalidPreWikiNamePattern = anyLetter;
    // Structural patterns
    var breakPattern = "\\n";
    var horizontalRulePattern = "^----$\\n?";
    var headerPattern = "^!{1,5}";
    var bulletListItemPattern = "^\\*+";
    var numberedListItemPattern = "^#+";
    var tablePattern = "(?:^\\|[^\\n]*$\\n?)+";
    var blockquotePattern = "(?:^>[^\\n]*$\\n?)+";
    var blockquotePattern2 = "^<<<\\n((?:^(?!<<<)[^\\n]*\\n)+)(^<<<$\\n?)";
    var imagePattern = "\\[[Ii][Mm][Gg]\\[(?:([^\\|]+)\\|)?([^\\[\\]\\|]+)\\]\\]";
    var verbatimPattern = "^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)";
    structurePatterns = "(" + breakPattern + 
        ")|(" + horizontalRulePattern + 
        ")|(" + headerPattern + 
        ")|(" + bulletListItemPattern + 
        ")|(" + numberedListItemPattern + 
        ")|(" + tablePattern + 
        ")|(" + blockquotePattern + 
        ")|(?:" + blockquotePattern2 + 
        ")|(?:" + imagePattern + 
        ")|(?:" + verbatimPattern + 
        ")";
    // Style patterns
    var boldPattern = "''((?:[^']+(?:'[^'])?)+)''";
    var strikePattern = "==([^=]+)==";
    var underlinePattern = "__([^_]+)__";
    var italicPattern = "//([^/]+)//";
    var supPattern = "\\^\\^([^\\^]+)\\^\\^";
    var subPattern = "~~([^~]+)~~";
    var monoPattern = "\\{\\{\\{(.*?)\\}\\}\\}";
    var colorPattern = "@@(?:color\\(([^\\)]+)\\):|bgcolor\\(([^\\)]+)\\):){0,2}([^@]+)@@";
    stylePatterns = "(?:" + boldPattern + 
        ")|(?:" + strikePattern + 
        ")|(?:" + underlinePattern + 
        ")|(?:" + italicPattern + 
        ")|(?:" + supPattern + 
        ")|(?:" + subPattern + 
        ")|(?:" + colorPattern + 
        ")|(?:" + monoPattern + 
        ")";
}

// Create child text nodes and link elements to represent a wiki-fied version of some text
function wikify(text,parent,highlightText,highlightCaseSensitive)
{
    // Prepare the regexp for the highlighted selection
    if(highlightText == "")
        highlightText = null;
    var highlightRegExp,highlightMatch;
    if(highlightText)
        {
        highlightRegExp = new RegExp(highlightText,highlightCaseSensitive ? "mg" : "img");
        highlightMatch = highlightRegExp.exec(text);
        }
    wikifyStructures(parent,text,text,0,text.length,highlightRegExp,highlightMatch);
}


function wikifyStructures(parent,text,targetText,startPos,endPos,highlightRegExp,highlightMatch)
{
    var body = parent;
    var structureRegExp = new RegExp(structurePatterns,"mg");
    var theList = [];  // theList[0]: don't use
    var isInListMode = false;
    var isInHeaderMode = false;
    var isNewline = false;
    // The start of the fragment of the text being considered
    var nextPos = 0;
    // Loop through the bits of the body text
    do {
        // Get the next formatting match
        var formatMatch = structureRegExp.exec(targetText);
        var matchPos = formatMatch ? formatMatch.index : targetText.length;
        // Subwikify the plain text before the match
        if(nextPos < matchPos)
            {
            isNewline = false;
            highlightMatch = wikifyStyles(body,text,targetText.substring(nextPos,matchPos),startPos+nextPos,startPos+matchPos,highlightRegExp,highlightMatch);
            }
        // Dump out the formatted match
        var level;
        var theBlockquote;
        if(formatMatch)
            {
            // Dump out the link itself in the appropriate format
            if(formatMatch[1])
                {
                if(isNewline && isInListMode)
                    {
                    theList = [];
                    body = parent;
                    isInListMode = false;
                    }
                else if(isInHeaderMode)
                    {
                    body = parent;
                    isInHeaderMode = false;
                    }
                else
                    {
                    isNewline = true;
                    body.appendChild(document.createElement("br"));
                    }
                }
            else if(formatMatch[2])
                {
                isNewline = false;
                body.appendChild(document.createElement("hr"));
                }
            else if(formatMatch[3])
                {
                level = formatMatch[3].length + 1;
                isNewline = false;
                isInHeaderMode = true;
                var theHeader = document.createElement("h" + level);
                parent.appendChild(theHeader);
                body = theHeader;
                }
            else if(formatMatch[4])
                {
                level = formatMatch[4].length;
                isNewline = false;
                isInListMode = true;
                if (theList[level] == null)
                    {
                    theList[level] = document.createElement("ul");
                    body.appendChild(theList[level]);
                    }
                theList = theList.slice(0,level + 1);
                body = document.createElement("li");
                theList[level].appendChild(body);
                }
            else if(formatMatch[5])
                {
                level = formatMatch[5].length;
                isNewline = false;
                isInListMode = true;
                if (theList[level] == null)
                    {
                    theList[level] = document.createElement("ol");
                    body.appendChild(theList[level]);
                    }
                theList = theList.slice(0,level + 1);
                body = document.createElement("li");
                theList[level].appendChild(body);
                }
            else if(formatMatch[6])
                {
                isNewline = false;
                highlightMatch = wikifyTable(body,text,formatMatch[6],startPos+matchPos,startPos+structureRegExp.lastIndex,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[7])
                {
                isNewline = false;
                var quotedText = formatMatch[7].replace(new RegExp("^>(>*)","mg"),"$1");
                theBlockquote = document.createElement("blockquote");
                var newHighlightRegExp,newHighlightMatch;
                if (highlightRegExp) {
                    newHighlightRegExp = new RegExp(highlightRegExp.toString(), "img");
                    newHighlightMatch = newHighlightRegExp.exec(quotedText);
                }
                wikifyStructures(theBlockquote,quotedText,quotedText,0,quotedText.length,newHighlightRegExp,newHighlightMatch);
                body.appendChild(theBlockquote);
                }
            else if(formatMatch[8])
                {
                isNewline = false;
                theBlockquote = document.createElement("blockquote");
                highlightMatch = wikifyStructures(theBlockquote,text,formatMatch[8],startPos+matchPos+4,startPos+structureRegExp.lastIndex-formatMatch[9].length,highlightRegExp,highlightMatch);
                body.appendChild(theBlockquote);
                }
            else if(formatMatch[11])
                {
                isNewline = false;
                var theImage = document.createElement("img");
                theImage.alt = formatMatch[10];
                theImage.src = formatMatch[11];
                body.appendChild(theImage);
                }
            else if(formatMatch[12])
                {
                isNewline = false;
                var theVerbatim = document.createElement("pre");
                theVerbatim.appendChild(document.createTextNode(text.substr(startPos+matchPos+4,startPos+structureRegExp.lastIndex-formatMatch[13].length-startPos-matchPos-4)));
                body.appendChild(theVerbatim);
                }
            }
        // Move the next position past the formatting match
        nextPos = structureRegExp.lastIndex;
    } while(formatMatch);
    return highlightMatch;
}

function wikifyLinks(parent,text,targetText,startPos,endPos,highlightRegExp,highlightMatch)
{
    // The start of the fragment of the text being considered
    var nextPos = 0;
    // Loop through the bits of the body text
    var theLink;
    do {
        // Get the next formatting match
        var formatMatch = wikiNameRegExp.exec(targetText);
        var matchPos = formatMatch ? formatMatch.index : targetText.length;
        // Subwikify the plain text before the match
        if(nextPos < matchPos)
            highlightMatch = subWikify(parent,text,startPos+nextPos,startPos+matchPos,highlightRegExp,highlightMatch);
        // Dump out the formatted match
        if(formatMatch)
            {
            // Dump out the link itself in the appropriate format
            if(formatMatch[1])
                {
                if(matchPos > 0 && new RegExp(invalidPreWikiNamePattern,"").exec(targetText.charAt(matchPos - 1)))
                    {
                    theLink = parent;
                    }
                else
                    {
                     theLink = createTiddlyLink(parent,formatMatch[0],false);
                     }
                 highlightMatch = subWikify(theLink,text,startPos+matchPos,startPos+wikiNameRegExp.lastIndex,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[2])
                {
                theLink = createExternalLink(parent,formatMatch[0]);
                highlightMatch = subWikify(theLink,text,startPos+matchPos,startPos+wikiNameRegExp.lastIndex,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[3])
                {
                theLink = createExternalLink(parent,formatMatch[4]);
                highlightMatch = subWikify(theLink,text,startPos+matchPos+2,startPos+matchPos+2+formatMatch[3].length,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[5])
                {
                theLink = createTiddlyLink(parent,formatMatch[5],false);
                highlightMatch = subWikify(theLink,text,startPos+matchPos+2,startPos+wikiNameRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            }
        // Move the next position past the formatting match
        nextPos = wikiNameRegExp.lastIndex;
    } while(formatMatch);
    return highlightMatch;
}

function wikifyStyles(parent,text,targetText,startPos,endPos,highlightRegExp,highlightMatch)
{
    var formatRegExp = new RegExp(stylePatterns,"mg");
    // The start of the fragment of the text being considered
    var nextPos = 0;
    // Loop through the bits of the body text
    do {
        // Get the next formatting match
        var formatMatch = formatRegExp.exec(targetText);
        var matchPos = formatMatch ? formatMatch.index : targetText.length;
        // Subwikify the plain text before the match
        if(nextPos < matchPos)
            highlightMatch = wikifyLinks(parent,text,targetText.substring(nextPos,matchPos),startPos+nextPos,startPos+matchPos,highlightRegExp,highlightMatch);
        // Dump out the formatted match
        if(formatMatch)
            {
            // Dump out the link itself in the appropriate format
            if(formatMatch[1])
                {
                var theBold = createTiddlyElement(parent,"b",null,null,null);
                highlightMatch = wikifyStyles(theBold,text,formatMatch[1],startPos+matchPos+2,startPos+formatRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[2])
                {
                var theStrike = createTiddlyElement(parent,"strike",null,null,null);
                highlightMatch = wikifyStyles(theStrike,text,formatMatch[2],startPos+matchPos+2,startPos+formatRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[3])
                {
                var theUnderline = createTiddlyElement(parent,"u",null,null,null);
                highlightMatch = wikifyStyles(theUnderline,text,formatMatch[3],startPos+matchPos+2,startPos+formatRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[4])
                {
                var theItalic = createTiddlyElement(parent,"i",null,null,null);
                highlightMatch = wikifyStyles(theItalic,text,formatMatch[4],startPos+matchPos+2,startPos+formatRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[5])
                {
                var theSup = createTiddlyElement(parent,"sup",null,null,null);
                highlightMatch = wikifyStyles(theSup,text,formatMatch[5],startPos+matchPos+2,startPos+formatRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[6])
                {
                var theSub = createTiddlyElement(parent,"sub",null,null,null);
                highlightMatch = wikifyStyles(theSub,text,formatMatch[6],startPos+matchPos+2,startPos+formatRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[9])
                {
                var theSpan;
                if ((formatMatch[7] == "" || formatMatch[7] == null) && (formatMatch[8] == "" || formatMatch[8] == null))
                    {
                    theSpan = createTiddlyElement(parent,"span",null,"marked",null);
                    }
                    else
                    {
                    theSpan = createTiddlyElement(parent,"span",null,null,null);
                    if (formatMatch[7] != "") theSpan.style.color = formatMatch[7];
                    if (formatMatch[8] != "") theSpan.style.background = formatMatch[8];
                    }
                highlightMatch = wikifyStyles(theSpan,text,formatMatch[9],startPos+formatRegExp.lastIndex-2-formatMatch[9].length,startPos+formatRegExp.lastIndex-2,highlightRegExp,highlightMatch);
                }
            else if(formatMatch[10])
                {
                var theCode = createTiddlyElement(parent,"code",null,null,null);
                highlightMatch = wikifyStyles(theCode,text,formatMatch[10],startPos+matchPos+3,startPos+formatRegExp.lastIndex-3,highlightRegExp,highlightMatch);
                }
            }
        // Move the next position past the formatting match
        nextPos = formatRegExp.lastIndex;
    } while(formatMatch);
    return highlightMatch;
}

// Create a table 
function wikifyTable(parent,text,targetText,startPos,endPos,highlightRegExp,highlightMatch)
{
    // The start of the fragment of the text being considered
    var nextPos = 0;
    var theTable = document.createElement("table");
    var bodyRowLen = 0;
    var headRowLen = 0;
    var footRowLen = 0;
    var bodyRows = [];
    var headRows = [];
    var footRows = [];
    var theCaption = null;
    // Loop through the bits of the body text
    do {
        // Get the next formatting match
        var formatMatch = tableRegExp.exec(targetText);
        var matchPos = formatMatch ? formatMatch.index : targetText.length;
        // Dump out the formatted match
        if(formatMatch) {
            if (formatMatch[2] == "c") {
                var cap = formatMatch[1].substring(0,formatMatch[1].length-1);
                theCaption = document.createElement("caption");
                highlightMatch = wikifyStyles(theCaption,text,cap,startPos+matchPos+1,startPos+cap.length,highlightRegExp,highlightMatch);
                if (bodyRowLen == 0 && headRowLen == 0 && footRowLen == 0) {
                    theCaption.setAttribute("align", "top");
                } else {
                    theCaption.setAttribute("align", "bottom");
                }
            } else if (formatMatch[2] == "h") {
                highlightMatch = wikifyTableRow(headRows,headRowLen,text,formatMatch[1],startPos+matchPos,startPos+matchPos+formatMatch[1].length,highlightRegExp,highlightMatch);
                headRowLen++;
            } else if (formatMatch[2] == "f") {
                highlightMatch = wikifyTableRow(footRows,footRowLen,text,formatMatch[1],startPos+matchPos,startPos+matchPos+formatMatch[1].length,highlightRegExp,highlightMatch);
                footRowLen++;
            } else {
                highlightMatch = wikifyTableRow(bodyRows,bodyRowLen,text,formatMatch[1],startPos+matchPos,startPos+matchPos+formatMatch[1].length,highlightRegExp,highlightMatch);
                bodyRowLen++;
            }
        }
        nextPos = tableRegExp.lastIndex;
    } while(formatMatch);
    
    if (theCaption != null) {
        theTable.appendChild(theCaption);
    }
    
    if (headRowLen > 0) {
        var theTableHead = document.createElement("thead");
        createTableRows(headRows,theTableHead);
        theTable.appendChild(theTableHead);
    }
    
    if (bodyRowLen > 0) {
        var theTableBody = document.createElement("tbody");
        createTableRows(bodyRows,theTableBody);
        theTable.appendChild(theTableBody);
    }
    
    if (footRowLen > 0) {
        var theTableFoot = document.createElement("tfoot");
        createTableRows(footRows,theTableFoot);
        theTable.appendChild(theTableFoot);
    }
    
    parent.appendChild(theTable);
    return highlightMatch;
}

function wikifyTableRow(rows,rowIndex,text,targetText,startPos,endPos,highlightRegExp,highlightMatch)
{
    // The start of the fragment of the text being considered
    var eIndex = 0;
    var elements = [];
    // Loop through the bits of the body text
    do {
        // Get the next formatting match
        var formatMatch = tableRowColRegExp.exec(targetText);
        var matchPos = formatMatch ? formatMatch.index : targetText.length;
        if(formatMatch) {
            var eText = formatMatch[2];
            if (eText == "~" || eText == ">") {
                elements[eIndex] = eText;
            } else {
                var eTextLen = eText.length;
                var align = "";
                if (eTextLen >= 1 && eText.charAt(0) == " ") {
                    if (eTextLen >= 3 && eText.charAt(eTextLen - 1) == " ") {
                        align = "center";
                        eText = eText.substring(1,eTextLen - 1);
                        //eTextLen -= 2;
                        eTextLen--;
                    } else {
                        align = "right";
                        eText = eText.substring(1);
                        eTextLen--;
                    }
                } else if (eTextLen >= 2 && eText.charAt(eTextLen - 1) == " ") {
                    align = "left";
                    eText = eText.substring(0,eTextLen - 1);
                    //eTextLen--;
                }
                
                var theElement;
                if (eTextLen >= 1 && eText.charAt(0) == "!") {
                    theElement = document.createElement("th");
                    eText = eText.substring(1);
                    eTextLen--;
                } else {
                    theElement = document.createElement("td");
                }
                
                if (align != "") {
                    theElement.align = align;
                }
                
                if (formatMatch[1]) {
                    theElement.style.background = formatMatch[1];
                }
                
                highlightMatch = wikifyStyles(theElement,text,eText,startPos+tableRowColRegExp.lastIndex-eTextLen,startPos+tableRowColRegExp.lastIndex-1,highlightRegExp,highlightMatch);
                elements[eIndex] = theElement;
            }
            eIndex++;
        }
    } while(formatMatch);
    rows[rowIndex] = elements;
    return highlightMatch;
}

function createTableRows(rows,parent)
{
    var i, j, k, cols;
    for (i = 0; i < rows.length; i++) {
        cols = rows[i];
        var theRow = document.createElement("tr");
        for (j = 0; j < cols.length; j++) {
            if (cols[j] == "~") continue;
            
            var rowspan = 1;
            for (k = i+1; k < rows.length; k++) {
                if (rows[k][j] != "~") break;
                rowspan++;
            }
            
            var colspan = 1;
            for (; j < cols.length - 1; j++) {
                if (cols[j] != ">") break;
                colspan++;
            }
            
            var theElement = cols[j];
            if (rowspan > 1) {
                theElement.setAttribute("rowSpan",rowspan);
                theElement.setAttribute("rowspan",rowspan);
                theElement.valign = "center";
            }
            if (colspan > 1) {
                theElement.setAttribute("colSpan",colspan);
                theElement.setAttribute("colspan",colspan);
            }
            theRow.appendChild(theElement);
        }
        parent.appendChild(theRow);
    }
}

// Helper for wikify that handles highlights within runs of text
function subWikify(parent,text,startPos,endPos,highlightRegExp,highlightMatch)
{
    // Check for highlights
    while(highlightMatch && (highlightRegExp.lastIndex > startPos) && (highlightMatch.index < endPos) && (startPos < endPos))
        {
        // Deal with the plain text before the highlight
        if(highlightMatch.index > startPos)
            {
            parent.appendChild(document.createTextNode(text.substring(startPos,highlightMatch.index)));
            startPos = highlightMatch.index;
            }
        // Deal with the highlight
        var highlightEnd = Math.min(highlightRegExp.lastIndex,endPos);
        var theHighlight = createTiddlyElement(parent,"span",null,"highlight",text.substring(startPos,highlightEnd));
        startPos = highlightEnd;
        // Nudge along to the next highlight if we're done with this one
        if(startPos >= highlightRegExp.lastIndex)
            highlightMatch = highlightRegExp.exec(text);
        }
    // Do the unhighlighted text left over
    if(startPos < endPos)
        {
        parent.appendChild(document.createTextNode(text.substring(startPos,endPos)));
        //startPos = endPos;
        }
    return(highlightMatch);
}

// ---------------------------------------------------------------------------------
// Tiddler-related utility functions
// ---------------------------------------------------------------------------------

var regexpAmp = new RegExp("&","mg");
var regexpLessThan = new RegExp("<","mg");
var regexpGreaterThan = new RegExp(">","mg");
var regexpQuote = new RegExp("\"","mg");

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
function htmlEncode(text)
{
    return(text.replace(regexpAmp,"&amp;").replace(regexpLessThan,"&lt;").replace(regexpGreaterThan,"&gt;").replace(regexpQuote,"&quot;"));
}

// Process a string list tiddler names into an array. Tiddler names that are not WikiWords must be [[bracketed]]
function readTiddlerList(titles)
{
    var bracketedPattern = "\\[\\[([^\\]]+)\\]\\]";
    var unbracketedPattern = "[^\\s$]+";
    var pattern = "(?:" + bracketedPattern + ")|(" + unbracketedPattern + ")";
    var re = new RegExp(pattern,"mg");
    var tiddlerNames = [];
    do {
        var match = re.exec(titles);
        if(match)
            {
            if(match[1]) // Bracketed
                tiddlerNames.push(match[1]);
            else if(match[2]) // Unbracketed
                tiddlerNames.push(match[2]);
            }
    } while(match);
    return(tiddlerNames);
}

function encodeTiddlyLink(title)
{
    if(title.indexOf(" ") == -1)
        return(title);
    else
        return("[[" + title + "]]");
}

function createTiddlyElement(theParent,theElement,theID,theClass,theText)
{
    var e = document.createElement(theElement);
    if(theClass != null)
        e.className = theClass;
    if(theID != null)
        e.setAttribute("id",theID);
    if(theText != null)
        e.appendChild(document.createTextNode(theText));
    if(theParent != null)
        theParent.appendChild(e);
    return(e);
}

function createTiddlyButton(theParent,theText,theTooltip,theAction)
{
    var theButton = document.createElement("a");
    if(theAction)
        {
        theButton.onclick = theAction;
        theButton.setAttribute("href","JavaScript:;");
        }
    theButton.setAttribute("title",theTooltip);
    if(theText)
        {
        theButton.appendChild(document.createTextNode(theText));
        }
    theParent.appendChild(theButton);
    return(theButton);
}

function createTiddlyLink(place,title,includeText)
{
    var text = includeText ? title : null;
    var subTitle;
    var tiddler = store.tiddlers[title];
    if(tiddler)
        subTitle = tiddler.getSubtitle();
    else
        subTitle = title + " doesn't yet exist";
    var theClass = tiddler ? "tiddlyLinkExisting" : "tiddlyLinkNonExisting";
    var btn = createTiddlyButton(place,text,subTitle,onClickTiddlerLink);
    btn.className = theClass;
    btn.setAttribute("tiddlyLink",title);
    return(btn);
}

function createExternalLink(place,url)
{
    var theLink = document.createElement("a");
    theLink.className = "externalLink";
    theLink.href = url;
    theLink.title = "External link to " + url;
    theLink.target = "_blank";
    place.appendChild(theLink);
    return(theLink);
}

// Find the tiddler instance (if any) containing a specified element
function findContainingTiddler(e)
{
    if(e == null)
        return(null);
    do {
        if(e != document)
            {
            if(e.id)
                if(e.id.substr(0,7) == "tiddler")
                    return(e);
            }
        e = e.parentNode;
    } while(e != document);
    return(null);
}

function displayMessage(text,linkText)
{
    var msgArea = document.getElementById("messageArea");
    var msg = createTiddlyElement(msgArea,"div",null,null,text);
    msgArea.style.display = "block";
    if(linkText)
        {
        var link = createTiddlyElement(msg,"a",null,null,linkText);
        link.href = linkText;
        link.target = "_blank";
        }
}

function clearMessage()
{
    var msgArea = document.getElementById("messageArea");
    while(msgArea.hasChildNodes())
        msgArea.removeChild(msgArea.firstChild);
    msgArea.style.display = "none";
}

// ---------------------------------------------------------------------------------
// Menu and sidebar functions
// ---------------------------------------------------------------------------------

function refreshAll(hint) // Optional name of the tiddler that's changed
{
    refreshHeader();
    refreshMenu();
    refreshSidebar();
    refreshDisplay(hint);
}

function refreshDisplay(hint)
{
    var hits = hint ? store.getReferringTiddlers(hint) : null;
    var displayNodes = document.getElementById("tiddlerDisplay").childNodes;
    for(var t=0;t<displayNodes.length;t++)
        {
        var theId = displayNodes[t].id;
        if(theId && theId.substr(0,7) == "tiddler")
            {
            var title = theId.substr(7);
            if(hint)
                {
                var f = false;
                for(var h=0; h<hits.length; h++)
                    if(hits[h].title == title)
                        f = true
                if(f)
                    refreshTiddler(title);
                }
            else
                refreshTiddler(title);
            }
        }
}

// Refresh all parts of the header
function refreshHeader()
{
    var theTitle = store.getTiddlerText("SiteTitle","SiteTitle");
    var theSubtitle = store.getTiddlerText("SiteSubtitle","SiteSubtitle");
    document.title = theTitle + " - " + theSubtitle;
    var place = document.getElementById("siteTitle");
    while(place.firstChild != null)
        place.removeChild(place.firstChild);
    wikify(theTitle,place,null,null);
    place = document.getElementById("siteSubtitle");
    while(place.firstChild != null)
        place.removeChild(place.firstChild);
    wikify(theSubtitle,place,null,null);
}

function refreshMenu()
{
    var place = document.getElementById("mainMenu");
    while(place.firstChild != null)
        place.removeChild(place.firstChild);
    var menu = store.getTiddlerText("MainMenu","MainMenu");
    wikify(menu,place,null,null);
}

function refreshSidebar()
{
    var tabContent = document.getElementById("sidebarContent");
    switch(options.txtCurrentTab)
        {
        case "tabTimeline":
        default:
            tabContent.className = "tabContentTimeline";
            refreshTabTimeline();
            break;
        case "tabTags":
            tabContent.className = "tabContentTags";
            refreshTabTags();
            break;
        case "tabMore":
            tabContent.className = "tabContentMore";
            refreshTabMore();
            break;
        }
}

// Event handler for clicking on a tab
function onClickTab(e)
{
    if (!e) var e = window.event;
    var theTab = resolveTarget(e);
    options.txtCurrentTab = theTab.id;
    saveOptionCookie("txtCurrentTab");
    refreshSidebar();
}

function refreshTabTimeline()
{
    var tiddlers = store.getTiddlers("modified");
    var place = document.getElementById("sidebarContent");
    while(place.firstChild != null)
        place.removeChild(place.firstChild);
    var lastDay = "";
    for (t=tiddlers.length-1; t>=0; t--)
        {
        var tiddler = tiddlers[t];
        var theDay = convertToYYYYMMDDHHMM(tiddler.modified).substr(0,8);
        if(theDay != lastDay)
            {
            var theDateElement = document.createElement("span");
            var theDateCaption = tiddler.modified.toLocaleDateString();
            theDateElement.appendChild(document.createTextNode(theDateCaption));
            theDateElement.className = "sidebarSubHeading";
            place.appendChild(theDateElement);
            place.appendChild(document.createElement("br")); 
            lastDay = theDay;
            }
        place.appendChild(document.createTextNode(String.fromCharCode(160)));
        place.appendChild(document.createTextNode(String.fromCharCode(160)));
        createTiddlyLink(place,tiddler.title,true);
        place.appendChild(document.createElement("br"));
        }
}

function refreshTabTags()
{
    var tags = store.getTags();
    var place = document.getElementById("sidebarContent");
    while(place.firstChild != null)
        place.removeChild(place.firstChild);
    if(tags.length == 0)
        createTiddlyElement(place,"div",null,null,"There are no tagged tiddlers");
    for (t=0; t<tags.length; t++)
        {
        var theTag = createTiddlyButton(place,tags[t][0] + " (" + tags[t][1] + ")","Show tiddlers tagged with '" + tags[t][0] + "'",onClickTag);
        theTag.setAttribute("tag",tags[t][0]);
        place.appendChild(document.createElement("br"));
        }
}

var moreTabModes = {
    moreTabAll: {label: "All", prompt: "All tiddlers in alphabetical order"},
    moreTabMissing: {label: "Missing", prompt: "Tiddlers that have links to them but are not defined"},
    moreTabOrphans: {label: "Orphans", prompt: "Tiddlers that are not linked to from any other tiddlers"},
    moreTabSpecial: {label: "Special", prompt: "Tiddlers that serve special purposes within TiddlyWiki"}
    };

function refreshTabMore()
{
    var place = document.getElementById("sidebarContent");
    while(place.firstChild != null)
        place.removeChild(place.firstChild);
    var selWrapper = createTiddlyElement(place,"div",null,"tabContentMorePrompt",null);
    var sel = createTiddlyElement(selWrapper,"select","optTabMore",null,null);
    sel.onchange = onChangeTabMore;
    for(var m in moreTabModes)
        {
        var opt = createTiddlyElement(sel,"option",null,null,moreTabModes[m].label);
        opt.value = m;
        if(m == options.txtTabMore)
            opt.selected = true;
        }
    var prompt = createTiddlyElement(place,"div",null,"tabContentMorePrompt",moreTabModes[options.txtTabMore].prompt);
    var results;
    switch(options.txtTabMore)
        {
        case "moreTabAll":
        default:
            results = store.getTiddlers("title");
            break;
        case "moreTabMissing":
            results = store.getMissingLinks();
            break;
        case "moreTabOrphans":
            results = store.getOrphans();
            break;
        case "moreTabSpecial":
            results = specialTiddlers.slice(0);
            results.sort();
            break;
        }
    for (t = 0; t < results.length; t++)
        {
        if(typeof results[t] == "string")
            createTiddlyLink(place,results[t],true);
        else
            createTiddlyLink(place,results[t].title,true);
        place.appendChild(document.createElement("br"));
        }
}

function onChangeTabMore()
{
    var e = document.getElementById("optTabMore");
    if(e)
        {
        options.txtTabMore = e.value;
        saveOptionCookie("txtTabMore");
        refreshTabMore();
        }
}

// ---------------------------------------------------------------------------------
// Options stuff
// ---------------------------------------------------------------------------------

function setupOptionsPanel()
{
    for(var opt in options)
        {
        var e = document.getElementById(opt);
        if(e)
            switch(opt.substr(0,3))
                {
                case "txt":
                    e.value = options[opt];
                    break;
                case "chk":
                    e.checked = options[opt];
                    break;
                }
        }
}

function loadOptionsCookie()
{
    var cookies = document.cookie;
    if(cookies.length > 0)
        for(var opt in options)
            {
            var n = opt + "=";
            var p = cookies.indexOf(n);
            if(p > -1)
                {
                p += n.length;
                var e = cookies.indexOf(";",p);
                if(e == -1)
                    e = cookies.length;
                var v = cookies.substr(p,e-p);
                switch(opt.substr(0,3))
                    {
                    case "txt":
                        options[opt] = unescape(v);
                        break;
                    case "chk":
                        options[opt] = v == "true";
                        break;
                    }
                }
            }
}

function saveOptionCookie(name)
{
    var c = name + "=";
    switch(name.substr(0,3))
        {
        case "txt":
            c += escape(options[name].toString());
            break;
        case "chk":
            c += options[name] ? "true" : "false";
            break;
        }
    c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
    document.cookie = c;
}

function onChangeOption(e)
{
    if (!e) var e = window.event;
    var opt = resolveTarget(e);
    if(opt.id)
        {
        switch(opt.id.substr(0,3))
            {
            case "txt":
                options[opt.id] = opt.value;
                break;
            case "chk":
                options[opt.id] = opt.checked;
                break;
            }
        saveOptionCookie(opt.id);
        changeOption(opt.id);
        }
    return(true);
}

// React to an option having been changed
function changeOption(name)
{
    switch(name)
        {
        case "chkRegExp":
            break;
        case "chkCaseSens":
            break;
        case "txtUserName":
            break;
        }
}

// ---------------------------------------------------------------------------------
// Saving
// ---------------------------------------------------------------------------------

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// Save this tiddlywiki with the pending changes
function saveChanges()
{
    clearMessage();
    // Get the URL of the document
    var originalPath = document.location.toString();
    // Check we were loaded from a file URL
    if(originalPath.substr(0,5) != "file:")
        {
        alert("You need to save this TiddlyWiki to a file before you can save changes");
        displayTiddler(null,"SaveChanges",0,null,null,null);
        return;
        }
    // Remove any location part of the URL
    var hashPos = originalPath.indexOf("#");
    if(hashPos != -1)
        originalPath = originalPath.substr(0,hashPos);
    // Convert to a native file format assuming
    // "file:///x:/path/path/path..." - pc local file --> "x:\path\path\path..."
    // "file://///server/share/path/path/path..." - FireFox pc network file --> "\\server\share\path\path\path..."
    // "file:///path/path/path..." - mac/unix local file --> "/path/path/path..."
    // "file://server/share/path/path/path..." - pc network file --> "\\server\share\path\path\path..."
    var localPath;
    if(originalPath.charAt(9) == ":") // pc local file
        localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
    else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
        localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
    else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
        localPath = unescape(originalPath.substr(7));
    else // pc network file
        localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
    // Load the original file
    var original = loadFile(localPath);
    if(original == null)
        {
        alert("It's not possible to save changes using this browser. Use FireFox if you can");
        displayTiddler(null,"SaveChanges",0,null,null,null);
        return;
        }
    // Locate the storeArea div's
    var posOpeningDiv = original.indexOf(startSaveArea);
    var posClosingDiv = original.lastIndexOf(endSaveArea);
    if((posOpeningDiv == -1) || (posClosingDiv == -1))
        {
        alert("The file '" + localPath + "' doesn't appear to be a valid TiddlyWiki");
        return;
        }
    // Save the backup
    if(options.chkSaveBackups)
        {
        var backupPath = localPath.substr(0,localPath.lastIndexOf(".")) + "." + convertToYYYYMMDDHHMMSSMMM(new Date()) + ".html";
        var backup = saveFile(backupPath,original);
        if(backup)
            displayMessage("Backup file saved as ","file://" + backupPath);
        else
            alert("Couldn't save backup file");
        }
    // Save Rss
    if(options.chkGenerateAnRssFeed)
        {
        var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
        var rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));
        if(rssSave)
            displayMessage("RSS feed saved as ","file://" + rssPath);
        else
            alert("Failed to save RSS feed");
        }
    // Save empty template
    if(options.chkSaveEmptyTemplate)
        {
        var emptyPath,p;
        if((p = localPath.lastIndexOf("/")) != -1)
            emptyPath = localPath.substr(0,p) + "/empty.html";
        else if((p = localPath.lastIndexOf("\\")) != -1)
            emptyPath = localPath.substr(0,p) + "\\empty.html";
        else
            emptyPath = localPath + ".empty.html";
        var empty = original.substr(0,posOpeningDiv + startSaveArea.length) + convertUnicodeToUTF8(generateEmpty()) + original.substr(posClosingDiv);
        var emptySave = saveFile(emptyPath,empty);
        if(emptySave)
            displayMessage("Empty template saved as ","file://" + emptyPath);
        else
            alert("Failed to save empty template file");
        }
    // Save new file
    var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + convertUnicodeToUTF8(allTiddlersAsHtml()) + original.substr(posClosingDiv);
    var save = saveFile(localPath,revised);
    if(save)
        displayMessage("Main TiddlyWiki file saved as ","file://" + localPath);
    else
        alert("Failed to save file");
}

function generateRss()
{
    var s = [];
    var d = new Date();
    var u = store.getTiddlerText("SiteUrl","");
    // Assemble the header
    s.push("<?xml version=\"1.0\"?>");
    s.push("<rss version=\"2.0\">");
    s.push("<channel>");
	s.push("<title>" + store.getTiddlerText("SiteTitle","") + "</title>");
    s.push("<link>" + u + "</link>");
	s.push("<description>" + store.getTiddlerText("SiteSubtitle","") + "</description>");
	s.push("<language>en-us</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + htmlEncode(options.txtUserName) + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki</generator>");
    // The body
    var tiddlers = store.getTiddlers("modified");
    var n = numRssItems > tiddlers.length ? tiddlers.length : tiddlers.length-numRssItems;
    for (var t=tiddlers.length-1; t>=n; t--)
        s.push(tiddlers[t].saveToRss(u));
    // And footer
    s.push("</channel>");
	s.push("</rss>");
    // Save it all
    return s.join("\n");
}

function generateEmpty()
{
    var savedTiddlers = [];
    for(var s=0; s<specialTiddlers.length; s++)
        {
        var tiddler = store.tiddlers[specialTiddlers[s]];
        if(tiddler)
            savedTiddlers.push(tiddler.saveToDiv());
        }
    return savedTiddlers.join("\n");
}

function allTiddlersAsHtml()
{
    var savedTiddlers = [];
    var tiddlers = store.getTiddlers("modified");
    for (var t = 0; t < tiddlers.length; t++)
        savedTiddlers.push(tiddlers[t].saveToDiv());
    return savedTiddlers.join("\n");
}

// UTF-8 encoding rules:
// 0x0000 - 0x007F:	0xxxxxxx
// 0x0080 - 0x07FF:	110xxxxx 10xxxxxx
// 0x0800 - 0xFFFF:	1110xxxx 10xxxxxx 10xxxxxx

function convertUTF8ToUnicode(u)
{
    var s = "";
    var t = 0;
    var b1, b2, b3;
    while(t < u.length)
        {
        b1 = u.charCodeAt(t++);
        if(b1 < 0x80)
            s += String.fromCharCode(b1);
        else if(b1 < 0xE0)
            {
            b2 = u.charCodeAt(t++);
            s += String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
            }
        else
            {
            b2 = u.charCodeAt(t++);
            b3 = u.charCodeAt(t++);
            s += String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
            }
    }
    return(s);
}

function convertUnicodeToUTF8(s)
{
    var u = "";
    for(var t=0;t<s.length;t++)
        {
        var c = s.charCodeAt(t);
        if(c <= 0x7F) 
            u += String.fromCharCode(c);
        else
            u += "&#" + c.toString() + ";";
        }
    return(u);
}

function saveFile(fileUrl, content)
{
    var r = mozillaSaveFile(fileUrl, content);
    if((r == null) || (r == false))
        r = ieSaveFile(fileUrl, content);
    return(r);
}

function loadFile(fileUrl)
{
    var r = mozillaLoadFile(fileUrl);
    if((r == null) || (r == false))
        r = ieLoadFile(fileUrl);
    return(r);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath, content)
{
    try
        {
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        }
    catch(e)
        {
        //alert("Exception while attempting to save\n\n" + e.toString());
        return(null);
        }
    var file = fso.OpenTextFile(filePath,2,-1,0);
    file.Write(content);
    file.Close();
    return(true);
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
    try
        {
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        }
    catch(e)
        {
        //alert("Exception while attempting to load\n\n" + e.toString());
        return(null);
        }
    var file = fso.OpenTextFile(filePath,1);
    var content = file.ReadAll();
    file.Close();
    return(content);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath, content)
{
    if(window.Components)
        try
            {
            netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
            var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
            file.initWithPath(filePath);
            if (!file.exists())
                file.create(0, 0664);
            var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
            out.init(file, 0x20 | 0x02, 00004,null);
            out.write(content, content.length);
            out.flush();
            out.close();
            return(true);
            }
        catch(e)
            {
            //alert("Exception while attempting to save\n\n" + e);
            return(false);
            }
    return(null);
}
    
// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
    if(window.Components)
        try 
            {
            netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
            var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
            file.initWithPath(filePath);
            if (!file.exists())
                return(null);
            var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
            inputStream.init(file, 0x01, 00004, null);
            var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
            sInputStream.init(inputStream);
            return(sInputStream.read(sInputStream.available()));
            }
        catch(e)
            {
            //alert("Exception while attempting to load\n\n" + e);
            return(false);
            }
    return(null);
}

// ---------------------------------------------------------------------------------
// Event handlers
// ---------------------------------------------------------------------------------

function onEditKey(e)
{
    if (!e) var e = window.event;
    clearMessage();
    var consume = false;
    switch(e.keyCode)
        {
        case 13: // Ctrl-Enter
        case 10: // Ctrl-Enter on IE PC
        case 77: // Ctrl-Enter is "M" on some platforms
            if(e.ctrlKey && this.id && this.id.substr(0,6) == "editor")
                {
                saveTiddler(this.id.substr(6));
                consume = true;
                }
            break;
        case 27: // Escape
            if(this.id && this.id.substr(0,6) == "editor")
                {
                displayTiddler(null,this.id.substr(6),1,null,null,false);
                consume = true;
                }
            break;
        }
    e.cancelBubble = consume;
    if(consume)
        if (e.stopPropagation) e.stopPropagation();
    return(!consume);

}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(e)
{
    if (!e) var e = window.event;
    var theTarget = resolveTarget(e);
    var theLink = theTarget;
    var title = null;
    do {
        title = theLink.getAttribute("tiddlyLink");
        theLink = theLink.parentNode;
    } while(title == null && theLink != null);
    if(title)
        {
        var opening;
        if(e.metaKey || e.ctrlKey)
            opening = document.getElementById("tiddler" + title) == null;
        else   
            opening = true;
        if(opening)
            displayTiddler(theTarget,title,0,null,null,e.shiftKey || e.altKey);
        else
            closeTiddler(title,e.shiftKey || e.altKey);
        }
    clearMessage();
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    return(false);
}

// Event handler for mouse over a tiddler
function onMouseOverTiddler(e)
{
    var tiddler;
    if(this.id.substr(0,7) == "tiddler")
        tiddler = this.id.substr(7);
    if(tiddler)
        selectTiddler(tiddler);
}

// Event handler for mouse out of a tiddler
function onMouseOutTiddler(e)
{
    var tiddler;
    if(this.id.substr(0,7) == "tiddler")
        tiddler = this.id.substr(7);
    if(tiddler)
        deselectTiddler(tiddler);
}

// Event handler for double click on a tiddler
function onDblClickTiddler(e)
{
    clearMessage();
    if(document.selection)
        document.selection.empty();
    var tiddler;
    if(this.id.substr(0,7) == "tiddler")
        tiddler = this.id.substr(7);
    if(tiddler)
        displayTiddler(null,tiddler,2,null,null,false);
}

// Event handler for clicking on toolbar close
function onClickToolbarClose(e)
{
    if (!e) var e = window.event;
    clearMessage();
    if(this.parentNode.id)
        closeTiddler(this.parentNode.id.substr(7),e.shiftKey || e.altKey);
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    return(false);
}

// Event handler for clicking on toolbar permalink
function onClickToolbarPermaLink(e)
{
    if(this.parentNode.id)
        {
        var title = this.parentNode.id.substr(7);
        var t = encodeURIComponent(encodeTiddlyLink(title));
        if(window.location.hash != t)
            window.location.hash = t;
        }
}

// Event handler for clicking on toolbar close
function onClickToolbarDelete(e)
{
    clearMessage();
    if(this.parentNode.id)
        deleteTiddler(this.parentNode.id.substr(7));
}

// Event handler for clicking on the toolbar references button
function onClickToolbarReferences(e)
{
    if (!e) var e = window.event;
    var theTarget = resolveTarget(e);
    var popup = createTiddlerPopup(this);
    if(popup && this.parentNode.id)
        {
        var title = this.parentNode.id.substr(7);
        var references = store.getReferringTiddlers(title,title);
        var c = false;
        for(var r in references)
            {
            createTiddlyLink(popup,references[r].title,true);
            c = true;
            }
        if(!c)
            popup.appendChild(document.createTextNode("No references"));
        }
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    return(false);
}

// Event handler for clicking on a tiddler tag
function onClickTag(e)
{
    if (!e) var e = window.event;
    var theTarget = resolveTarget(e);
    var popup = createTiddlerPopup(this);
    var tag = this.getAttribute("tag");
    if(popup && tag)
        {
        var title = this.parentNode.id.substr(10);
        var tagged = store.getTaggedTiddlers(tag,title);
        var c = false;
        for(var r in tagged)
            {
            createTiddlyLink(popup,tagged[r].title,true);
            c = true;
            }
        if(!c)
            popup.appendChild(document.createTextNode("No other tiddlers tagged with '" + tag + "'"));
        }
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    return(false);
}

// Event handler for clicking on toolbar close
function onClickToolbarEdit(e)
{
    clearMessage();
    if(this.parentNode.id)
        displayTiddler(null,this.parentNode.id.substr(7),2,null,null,false);
}

// Event handler for clicking on toolbar save
function onClickToolbarSave(e)
{
    if(this.parentNode.id)
        saveTiddler(this.parentNode.id.substr(7));
}

// Event handler for clicking on toolbar save
function onClickToolbarUndo(e)
{
    if(this.parentNode.id)
        displayTiddler(null,this.parentNode.id.substr(7),1,null,null,false);
}

var optionsOpen = false;

// Options button
function onClickOptions(e)
{
    if (!e) var e = window.event;
    var thePanel = document.getElementById("optionsPanel");
    optionsOpen = !optionsOpen;
    if(options.chkAnimate)
        startSlider(thePanel,optionsOpen,e.shiftKey || e.altKey,"none");
    else
        thePanel.style.display = optionsOpen ? "block" : "none";
    e.cancelBubble = true;
    if (e.stopPropagation) e.stopPropagation();
    return(false);
}

var lastSearchText = ""; // For keeping track of when the search text actually changes
var searchTimeout = null;

function onSearchKey(e)
{
    if (!e) var e = window.event;
    switch(e.keyCode)
        {
        case 27:
            onClearSearch();
            break;
        }
    var text = document.getElementById("searchText").value;
    if((text.length > 2) && (text != lastSearchText))
        {
        if(searchTimeout)
            clearTimeout(searchTimeout);
        searchTimeout = setTimeout("doSearch();",200);
        }
}

function doSearch()
{
    var text = document.getElementById("searchText").value;
    searchTiddlers(text,options.chkCaseSens,options.chkRegExp,false);
    lastSearchText = text;
}

function onClearSearch()
{
    var text = document.getElementById("searchText");
    text.value = "";
    clearMessage();
}

function onFocusSearch()
{
    var text = document.getElementById("searchText");
    text.select();
}

// Eek... it's bad that this is done via a function rather than a normal, copy-able href
function onClickPermaView()
{
    var wikiRegExp = new RegExp("^" + wikiNamePattern + "$","");
    var tiddlerDisplay = document.getElementById("tiddlerDisplay");
    var links = [];
    for(var t=0;t<tiddlerDisplay.childNodes.length;t++)
        {
        var tiddlerName = tiddlerDisplay.childNodes[t].id.substr(7);
        links.push(encodeTiddlyLink(tiddlerName));
        }
    window.location.hash = encodeURIComponent(links.join(" "));
}

// ---------------------------------------------------------------------------------
// Animation engine
// ---------------------------------------------------------------------------------

// Animation housekeeping
var animating = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
var animaterID; // ID of the timer used for animating
// 'zoomer' module of the animation engine smoothly moves an element from the position/size of the start element to the target element
var zoomerElement = null; // Element being shifted; null if none
var zoomerStart; // Where we're shifting from
var zoomerTarget; // Where we're shifting to
var zoomerStartScroll; // Where we're scrolling from
var zoomerTargetScroll; // Where we're scrolling to
var zoomerProgress; // 0..1 of how far we are
var zoomerStep; // 0..1 of how much to shift each step
// 'slider' module of the animation engine slides an element smoothly open or closed
var sliderElement = null; // Element being slid open or closed; null if none
var sliderDeleteMode;
var sliderOpening; // True if the element is being opened
var sliderRealHeight; // Starting height
var sliderProgress; // 0..1 of how far we are
var sliderStep; // 0..1 of how much to shift each step

// Start animation engine
function startAnimating()
{
    if(animating++ == 0)
        animaterID = window.setInterval("doAnimate();",25);
}

// Stop animation engine
function stopAnimating()
{
    if(--animating == 0)
        window.clearInterval(animaterID)
}

// Perform an animation engine tick, calling each of the known animation modules
function doAnimate()
{
    if(zoomerElement)
        doZoomer();
    if(sliderElement)
        doSlider();
}

// Start moving the element 'e' from the position of the element 'start' to the position of the element 'target'
function startZoomer(e,start,target,slowly)
{
    stopZoomer();
    zoomerElement = e;
    zoomerStart = start;
    zoomerStartScroll = findScrollY();
    zoomerTargetScroll = ensureVisible(target);
    zoomerTarget = target;
    zoomerProgress = 0;
    zoomerStep = slowly ? 0.01 : 0.12;
    startAnimating();
}

// Stop any ongoing zoomer animation
function stopZoomer()
{
    if(zoomerElement)
        {
        stopAnimating();
        zoomerElement.style.display = "none";
        zoomerTarget.style.opacity = 1;
        window.scrollTo(0,zoomerTargetScroll);
        zoomerElement = null;
        }
}

// Perform a tick of the zoomer animation
function doZoomer()
{
    zoomerProgress += zoomerStep;
    if(zoomerProgress >= 1.0)
        stopZoomer();
    else
        {
        var f = slowInSlowOut(zoomerProgress);
        var zoomerStartLeft = findPosX(zoomerStart);
        var zoomerStartTop = findPosY(zoomerStart);
        var zoomerStartWidth = zoomerStart.offsetWidth;
        var zoomerStartHeight = zoomerStart.offsetHeight;
        var zoomerTargetLeft = findPosX(zoomerTarget);
        var zoomerTargetTop = findPosY(zoomerTarget);
        var zoomerTargetWidth = zoomerTarget.offsetWidth;
        var zoomerTargetHeight = zoomerTarget.offsetHeight;
        zoomerElement.style.left = zoomerStartLeft + (zoomerTargetLeft-zoomerStartLeft) * f;
        zoomerElement.style.top = zoomerStartTop + (zoomerTargetTop-zoomerStartTop) * f;
        zoomerElement.style.width = zoomerStartWidth + (zoomerTargetWidth-zoomerStartWidth) * f;
        zoomerElement.style.height = zoomerStartHeight + (zoomerTargetHeight-zoomerStartHeight) * f;
        zoomerElement.style.display = "block";
        zoomerTarget.style.opacity = zoomerProgress;
        window.scrollTo(0,zoomerStartScroll + (zoomerTargetScroll-zoomerStartScroll) * f);
        }
}

// Start sliding an element
// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function startSlider(e,opening,slowly,deleteMode)
{
    stopSlider();
    sliderDeleteMode = deleteMode;
    sliderElement = e;
        sliderElement.style.display = "block";
    sliderElement.style.height = "auto";
    sliderRealHeight = sliderElement.offsetHeight;
    sliderOpening = opening;
    sliderStep = slowly ? 0.01 : 0.16;
    if(opening)
        {
        sliderProgress = 0;
        sliderElement.style.height = "2px";
        sliderElement.style.display = "block";
        }
    else
        {
        sliderStep = -sliderStep;
        sliderProgress = 1;
        }
    sliderElement.style.overflow = "hidden";
    startAnimating();
}

// Stop sliding the current element
function stopSlider()
{
    if(sliderElement)
        {
        stopAnimating();
        if(sliderOpening)
            sliderElement.style.height = "auto";
        else
            {
            switch(sliderDeleteMode)
                {
                case "none":
                    sliderElement.style.display = "none";
                    break;
                case "all":
                    sliderElement.parentNode.removeChild(sliderElement);
                    break;
                case "children":
                    while(sliderElement.hasChildNodes())
                        sliderElement.removeChild(sliderElement.firstChild);
                    break;
                }
            }
        sliderElement = null;
        }
}

// Perform a tick of the slider animation
function doSlider()
{
    sliderProgress += sliderStep;
    if((sliderProgress < 0) || (sliderProgress > 1.0))
        stopSlider();
    else
        {
        var f = slowInSlowOut(sliderProgress);
        var h = sliderRealHeight*f;
        sliderElement.style.height = (h <= 2) ? 2 : h;
        sliderElement.style.opacity = f;
        }
}

// ---------------------------------------------------------------------------------
// Standalone utility functions
// ---------------------------------------------------------------------------------

function escapeRegExp(s)
{
    // Escape any special RegExp characters with that character preceded by a backslash
    return(s.replace(new RegExp("[\\\\\\^\\$\\*\\+\\?\\(\\)\\=\\!\\|\\,\\{\\}\\[\\]\\.]","g"),"\\$&"));
}

// Return a date in UTC YYYYMMDDHHMM format
function convertToYYYYMMDDHHMM(d)
{
    return(zeroPad(d.getFullYear(),4) + zeroPad(d.getMonth()+1,2) + zeroPad(d.getDate(),2) + zeroPad(d.getHours(),2) + zeroPad(d.getMinutes(),2));
}

// Left-pad a string with 0s to a certain width
function zeroPad(n,d)
{
    var s = n.toString();
    if(s.length < d)
        s = "000000000000000000000000000".substr(0,d-s.length) + s;
    return(s);
}

// Return a date in UTC YYYYMMDD.HHMMSSMMM format
function convertToYYYYMMDDHHMMSSMMM(d)
{
    return(zeroPad(d.getFullYear(),4) + zeroPad(d.getMonth()+1,2) + zeroPad(d.getDate(),2) + "." + zeroPad(d.getHours(),2) + zeroPad(d.getMinutes(),2) + zeroPad(d.getSeconds(),2) + zeroPad(d.getMilliseconds(),4));
}

// Convert a date in UTC YYYYMMDDHHMM format to date type
function convertFromYYYYMMDDHHMM(d)
{
    var theDate = new Date(parseInt(d.substr(0,4),10),
                            parseInt(d.substr(4,2),10)-1,
                            parseInt(d.substr(6,2),10),
                            parseInt(d.substr(8,2),10),
                            parseInt(d.substr(10,2),10),0,0);
    return(theDate);
}

// Map a 0..1 value to 0..1, but slow down at the start and end
function slowInSlowOut(progress)
{
    return(1-((Math.cos(progress * Math.PI)+1)/2));
}

// Resolve the target object of an event
function resolveTarget(e)
{
    var obj;
    if (e.target)
        obj = e.target;
    else if (e.srcElement)
        obj = e.srcElement;
    if (obj.nodeType == 3) // defeat Safari bug
        obj = obj.parentNode;
    return(obj);
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
    var posTop = findPosY(e);
    var posBot = posTop + e.offsetHeight;
    var winTop = findScrollY();
    var winHeight = findWindowHeight();
    var winBot = winTop + winHeight;
    if(posTop < winTop)
        return(posTop);
    else if(posBot > winBot)
        {
        if(e.offsetHeight < winHeight)
            return(posTop - (winHeight - e.offsetHeight));
        else
            return(posTop);
        }
    else
        return(winTop);
}

function findWindowHeight()
{
    return(window.innerHeight ? window.innerHeight : document.body.clientHeight);
}

function findScrollY()
{
    return(window.scrollY ? window.scrollY : document.body.scrollTop);
}

// From QuirksMode.com
function findPosX(obj)
{
    var curleft = 0;
    if (obj.offsetParent)
    {
        while (obj.offsetParent)
        {
            curleft += obj.offsetLeft;
            obj = obj.offsetParent;
        }
    }
    else if (obj.x)
        curleft += obj.x;
    return curleft;
}

// From QuirksMode.com
function findPosY(obj)
{
    var curtop = 0;
    if (obj.offsetParent)
    {
        while (obj.offsetParent)
        {
            curtop += obj.offsetTop;
            obj = obj.offsetParent;
        }
    }
    else if (obj.y)
        curtop += obj.y;
    return curtop;
}

// Create a non-breaking space
function insertSpacer(place)
{
    place.appendChild(document.createTextNode(String.fromCharCode(160)));
}

function removeChildren(e)
{
    while(e.hasChildNodes())
        e.removeChild(e.firstChild);
}


// Add a stylesheet
function addStylesheet(s)
{
    try
        {
        if(document.createStyleSheet)
            { 
            document.createStyleSheet("javascript:'" + s + "'"); 
            }
        else
            { 
            var n = document.createElement("link"); 
            n.rel = "stylesheet"; 
            n.href = "data:text/css," + escape(s); 
            document.getElementsByTagName("head")[0].appendChild(n);
            }
        }
    catch(e)
        {
        clearMessage();
        displayMessage("Error in StyleSheet: " + e.message);
        }
}

// ---------------------------------------------------------------------------------
// End of scripts
// ---------------------------------------------------------------------------------

</script>
<style type="text/css">

body {
    background-color: #ffffff;
    font-size: 9pt;
    font-family: verdana,arial,helvetica;
    margin: 0em 0em 0em 0em;
    padding: 0em 0em 0em 0em;
    position: relative;
}

a:link, a:visited {
    text-decoration: none;
}

a:hover, a:active {
    text-decoration: none;
}

#header {
    margin-bottom: 0em;
}

#titleLine {
    color: #ffffff;
    background-color: #330000;
    padding: 5em 1em 1em 1em;
}

#titleLine a {
    color: #CCFF66;
}

#siteTitle {
    font-size: 26pt;
}

#siteSubtitle {
    padding-left: 1em;
    font-size: 10pt;
}

#mainMenu {
    float: left;
    width: 10em;
    line-height: 166%;
    padding: 1.5em 0.5em 0.5em 0.5em;
    font-size: 10pt;
    color: black;
    text-align: right;
}

#mainMenu a {
    color: #996633;
}

#mainMenu a:hover {
    background-color: #996633;
    color: #ffffff;
}

#displayArea {
    margin: 1em 14em 0em 13em;
}

#messageArea {
    background-color: #993300;
    color: #ffffff;
    padding: 0.5em 0.5em 0.5em 0.5em;
    margin: 0em 0em 0.6em 0em;
    display: none;
}

#messageArea a:link, #messageArea a:visited {
    display: inline;
    text-decoration: underline;
    color: #cc9900;
}

#messageArea a:hover {
    color: #996633;
}

#messageArea a:active {
    color: #ffffff;
}

.tiddler {
    padding: 0em 0em 0em 0em;
}

.innerTiddler {
    padding: 1em 1em 0em 1em;
    font-size: 9pt;
}

#displayArea .tiddlyLinkExisting {
    font-weight: bold;
}

#displayArea .tiddlyLinkNonExisting {
    font-style: italic;
}

#displayArea .externalLink {
    text-decoration: underline;
}

.title {
    font-size: 10pt;
    font-weight: bold;
    display: inline;
}

.toolbar {
    font-weight: normal;
    font-size: 8pt;
    padding: 0em 0em 0em 0em;
    color: #aaaaaa;
    display: inline;
    visibility: hidden;
}

.toolbar A {
    padding: 0.2em 0.4em 0.2em 0.4em;
    color: #cc9900;
}

.toolbar A:hover {
    text-decoration: none;
    color: #ccff66;
    background-color: #993300;
}

.toolbar A:active {
    color: #ffffff;
    background-color: #cc9900;
}

#popup {
    display: none;
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 8pt;
    color: #ccff66;
    background-color: #993300;
    padding: 0.25em 0.25em 0.25em 0.25em;
    border-right: 1px solid #330000;
    border-bottom: 1px solid #330000;
}

#popup a {
    display: block;
    color: #ccff66;
    line-height: 100%;
}

#popup a:hover {
    background-color: #ccff66;
    color: #330000;
}

.body {
    padding-top: 0.5em;
}

.viewer {
    color: #000000;
    line-height: 140%;
}

.viewer a:link, .body a:visited {
    text-decoration: none;
    color: #996633;
}

.viewer a:hover {
    color: #ffffff;
    background-color: #996633;
    text-decoration: none;
}

.viewer blockquote {
    font-size: 8pt;
    line-height: 150%;
    border-left: 3px solid #666666;
    padding-left: 0.8em;
    margin-left: 2.5em;
}

.viewer ul {
    margin-left: 0.5em;
    padding-left: 1.5em;
}

.viewer ol {
    margin-left: 0.5em;
    padding-left: 1.5em;
}

.viewer h2,h3,h4,h5,h6 {
    font-weight: bold;
    text-decoration: none;
    background-color: #cccc99;
    padding-left: 0.4em;
}

.viewer h2 {
    font-size: 12pt;
}

.viewer h3 {
    font-size: 11pt;
}

.viewer h4 {
    font-size: 10pt;
}

.viewer h5 {
    font-size: 9pt;
}

.viewer h6 {
    font-size: 8pt;
}

.viewer table {
    border-collapse: collapse;
    border: 2px solid #303030;
    margin-left: 1.0em;
    margin-right: 1.0em;
    margin-top: 0.8em;
    margin-bottom: 0.8em;
    font-size: 100%;
}

.viewer th {
    background-color: #999966;
    border: 1px solid #606060;
    color: #ffffff;
    padding: 3px;
}

.viewer td, tr {
    border: 1px solid #606060;
    padding: 3px;
}

.viewer caption {
    padding: 3px;
}

.viewer pre, .viewer code {
    font-size: 100%;
    line-height: 1.4em;
    color: #660000;
}
       
.viewer hr {
    border-top: dashed 1px #606060;
    border-left: none;
    border-right: none;
    border-bottom: none;
    height: 1px;
    color: #666666;
}

.tags {
    font-weight: normal;
    font-size: 8pt;
    margin: 0.5em 0em 0em 0em;
    padding: 0em 0em 0em 0em;
    color: #aaaaaa;
    visibility: hidden;
}

.tags A {
    padding: 0.2em 0.4em 0.2em 0.4em;
    color: #993300;
}

.tags A:hover {
    text-decoration: none;
    color: #ccff66;
    background-color: #993300;
}

.tags A:active {
    color: #ffffff;
    background-color: #cc9900;
}

.highlight, .marked {
    color: #000000;
    background-color: #ffe72f;
}

.editor {
    font-size: 8pt;
    color: #402C74;
    font-weight: normal;
}

.editor input {
    display: block;
    border: 1px solid black;
    width: 100%;
}

.editor textarea {
    display: block;
    font: inherit;
    border: 1px solid black;
    width: 100%;
}

.editorPrompt {
    font-size: 8pt;
    color: #996633;
}

#sidebar {
    float: right;
    width: 14em;
    color: #000000;
    font-size: 8pt;
    background-color: #ffffff;
    position: relative;
}

.sidebarSubHeading {
    font-size: 7pt;
    color: #330000;
}

#commandPanel {
    padding-top: 0.5em;
    background-color: #cc9900;
    color: #996633;
    font-size: 8pt;
}

#commandPanel A {
    display: block;
    padding: 0.3em 0.2em 0.3em 1em;
    color: #993300;
}

#commandPanel A:hover {
    text-decoration: none;
    color: #ccff66;
    background-color: #993300;
}

#commandPanel A:active {
    color: #993300;
    background-color: #ccff66;
}

#commandPanel input {
    margin: 0.4em 0em 0.3em 1em;
    border: 1px solid #000000;
}

#optionsPanel {
    display: none;
    padding: 0.5em 0.5em 0.5em 0.5em;
    background-color: #eeeeaa;
    font-size: 7pt;
    color: #444400;
}

#optionsPanel a:link, #optionsPanel a:visited {
    color: #777700;
    font-weight: bold;
}

#optionsPanel a:hover {
    text-decoration: none;
    color: #ffffff;
    background-color: #444400;
}

.optionsText {
    margin-top: 0.25em;
    margin-bottom: 0.75em;
}

.optionsItem {
}

#sidebarTabs {
    background-color: #cc9900;
    padding: 1em 0em 0em 0.5em;
}

#sidebarTabs a {
    color: #ccff66;
    font-weight: normal;
}

#sidebarTabs a:hover {
    background-color: #ccff66;
    color: #330000;
    text-decoration: none;
}

#sidebarTabs a:active {
    color: #000000;
}

#tabTimeline {
    font-weight: bold;
    display: inline;
    background-color: #996633;
    padding: 2px 3px 0px 3px;
    margin: 0px 1px 0px 1px;
}

#tabTags {
    font-weight: bold;
    display: inline;
    background-color: #993300;
    padding: 2px 3px 0px 3px;
    margin: 0px 1px 0px 1px;
}

#tabMore {
    font-weight: bold;
    display: inline;
    background-color: #330000;
    padding: 2px 3px 0px 3px;
    margin: 0px 1px 0px 1px;
}

.tabContentTimeline {
    background-color: #996633;
    padding: 0.5em 0.5em 0.5em 0.5em;
    overflow: hidden;
}

.tabContentTags {
    background-color: #993300;
    padding: 0.5em 0.5em 0.5em 0.5em;
    overflow: hidden;
}

.tabContentTags #popup {
    background-color: #330000;
}

.tabContentMore {
    background-color: #330000;
    padding: 0.5em 0.5em 0.5em 0.5em;
    overflow: hidden;
}

.tabContentMorePrompt {
    color: #ffffff;
    padding: 1em 0em 1em 0em;
}

#sidebarContent a {
    color: #ccff66;
}

#sidebarContent a:hover {
    color: #330000;
    background-color: #ccff66;
    text-decoration: none;
}

#licensePanel {
    padding: 0.5em 0em 0.5em 0em;
}

#licensePanel A {
    display: block;
    padding: 0.2em 0.2em 0.2em 0.2em;
    color: #993300;
}

#licensePanel A:hover {
    text-decoration: none;
    color: #ccff66;
    background-color: #993300;
}

#licensePanel A:active {
    color: #993300;
    background-color: #ccff66;
}

#storeArea, #copyright {
    display: none;
}

#floater {
    font-size: 10pt;
    display: none;
    color: white;
    background-color: #b8b896;
    position: absolute;
    padding: 1em 1em 1em 1em;
    opacity: 0.5;
    filter: alpha(opacity=50);
}

#saveTest {
    display: none;
}

@media print {

#mainMenu {
    display: none;
}

#displayArea {
    margin: 1em 1em 0em 1em;
}

#sidebar {
    display: none;
}

}

</style>
</head>
<body onload="main()">
    <div id="copyright">
    Welcome to TiddlyWiki by Jeremy Ruston, Copyright &copy; 2005 Osmosoft Limited
    </div>
    <div id="saveTest"></div>
    <div id="header">
        <div id="titleLine">
            <span id="siteTitle"></span>
            <span id="siteSubtitle"></span>
        </div>
    </div>
    <div id="sidebar">
        <div id="commandPanel">
            <a href="JavaScript:;" onclick="doSearch()" title="Search this TiddlyWiki">search</a>
            <input id="searchText" size=15 onKeyUp="onSearchKey(event)" onfocus="onFocusSearch(event)" autocomplete=off title="Search this TiddlyWiki">
            <a href="javascript:;" onclick="closeAllTiddlers(event)" title="Close all displayed tiddlers (except any that are being edited)">close all</a>
            <a href="javascript:;" onclick="onClickPermaView(event)" title="Link to an URL that retrieves all the currently displayed tiddlers">permaview</a>
            <a href="javascript:;" onclick="saveChanges(event)" title="Save all tiddlers to create a new TiddlyWiki">save changes</a>
            <a href="javascript:;" onclick="onClickOptions(event)" title="Change TiddlyWikiOptions">options</a>
        </div>
        <div id="optionsPanel">
            <div class="optionsText">These
                <a href="javascript:;" tiddlyLink="InterfaceOptions" onclick="onClickTiddlerLink(event);">InterfaceOptions</a>
                for customising
                <a href="javascript:;" tiddlyLink="TiddlyWiki" onclick="onClickTiddlerLink(event);">TiddlyWiki</a>
                are saved in your browser
            </div>
            <div class="optionsText">Your username for signing your edits. Write it as a 
                <a href="javascript:;" tiddlyLink="WikiWord" onclick="onClickTiddlerLink(event);">WikiWord</a>
                (eg 
                <a href="javascript:;" tiddlyLink="JoeBloggs" onclick="onClickTiddlerLink(event);">JoeBloggs</a>) 
            </div>
            <input id="txtUserName" size=15 onKeyUp="onChangeOption(event)" autocomplete=off>
            <div class="optionsItem"><input type=checkbox onclick="onChangeOption(event);" id="chkSaveBackups">
                <a href="javascript:;" tiddlyLink="SaveBackups" onclick="onClickTiddlerLink(event);">SaveBackups</a>
            </div>
            <div class="optionsItem"><input type=checkbox onclick="onChangeOption(event);" id="chkAutoSave">
                <a href="javascript:;" tiddlyLink="AutoSave" onclick="onClickTiddlerLink(event);">AutoSave</a>
            </div>
            <div class="optionsItem"><input type=checkbox onclick="onChangeOption(event);" id="chkGenerateAnRssFeed">
                <a href="javascript:;" tiddlyLink="GenerateAnRssFeed" onclick="onClickTiddlerLink(event);">GenerateAnRssFeed</a>
            </div>
            <div class="optionsItem"><input type=checkbox onclick="onChangeOption(event);" id="chkSaveEmptyTemplate">
                <a href="javascript:;" tiddlyLink="SaveEmptyTemplate" onclick="onClickTiddlerLink(event);">SaveEmptyTemplate</a>
            </div>
            <div class="optionsItem"><input type=checkbox onclick="onChangeOption(event);" id="chkRegExp">
                <a href="javascript:;" tiddlyLink="RegExpSearch" onclick="onClickTiddlerLink(event);">RegExpSearch</a>
            </div>
            <div class="optionsItem"><input type=checkbox onclick="onChangeOption(event);" id="chkCaseSens">
                <a href="javascript:;" tiddlyLink="CaseSensitiveSearch" onclick="onClickTiddlerLink(event);">CaseSensitiveSearch</a>
            </div>
            <div class="optionsItem"><input type=checkbox onclick="onChangeOption(event);" id="chkAnimate">
                <a href="javascript:;" tiddlyLink="EnableAnimations" onclick="onClickTiddlerLink(event);">EnableAnimations</a>
            </div>
        </div>
        <div id="sidebarTabs">
            <a href="JavaScript:;" onclick="onClickTab(event)" id="tabTimeline">Timeline</a>
            <a href="JavaScript:;" onclick="onClickTab(event)" id="tabTags">Tags</a>
            <a href="JavaScript:;" onclick="onClickTab(event)" id="tabMore">More</a>
        </div>
        <div id="sidebarContent" class="tabContentTimeline">
        </div>
        <div id="licensePanel">
            <a rel="license" href="http://www.tiddlywiki.com" target="_new">
                TiddlyWiki is published by Osmosoft under a BSD open source license
            </a>
        </div>
    </div>
    <div id="messageArea"></div>
    <div id="mainMenu"></div>
    <div id="displayArea">
        <div id="tiddlerDisplay"></div>
        &nbsp;
        <div id="floater">&nbsp;</div>
    </div>
    <div id="storeArea"><div id="storeSiteTitle" modified="200409161548" modifier="JeremyRuston" tags="system">TiddlyWiki</div>
<div id="storeSiteSubtitle" modified="200409171651" modifier="JeremyRuston" tags="system">a reusable non-linear personal web notebook</div>
<div id="storeMainMenu" modified="200505171916" modifier="JeremyRuston" tags="system">HelloThere\nLatestStuff\nTiddlyWiki\nUsingThisSite\nReusingThisSite\nDownloadSoftware\nHowToUpgrade\nRssFeed\n\n&#169; [[osmosoft|http://www.osmosoft.com]] 2005</div>
<div id="storeDefaultTiddlers" modified="200505121952" modifier="JeremyRuston" tags="system">HelloThere LatestStuff MainFeatures</div>
<div id="storeSaveChanges" modified="200505230013" modifier="JeremyRuston" tags="features instructions">You can SaveChanges if you're using FireFox or InternetExplorer:\n# if you're using Windows XP you might run into ServicePack2Problems\n# right click on [[this link|empty.html]] and select 'Save link as...' or 'Save target as...'\n** do ''not'' try to use the File/Save command in your browser because of SaveUnpredictabilities.\n** choose where to save the file, and what to call it (but keep the .HTML extension)\n# open the newly downloaded file in your browser\n# click the 'options' button on the right to set your username\n# edit, create and delete the tiddlers you want\n** you can change the SpecialTiddlers to change the SiteTitle and MainMenu etc.\n# click the 'save changes' button on the right to save your changes\n# TiddlyWiki will make a backup copy of the existing file, and then replace it with the new version\n</div>
<div id="storeSiteUrl" modified="200505100122" modifier="JeremyRuston" tags="system">http://www.tiddlywiki.com/</div></div>
    </body>
</html>