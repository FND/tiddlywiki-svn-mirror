



	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>JigglyWiki : a simple, web-visable, jquery supported tiddlywiki clone</title>
	<meta name="generator" content="TextMate http://macromates.com/">
	<meta name="author" content="Phil Hawksworth">
	<meta name="viewport" content="initial-scale = 1.0">
	<style type="text/css" media="screen">
body{font:12px/1.7em arial;margin:0;padding:0;}
div#header{display:block;background-color:#111;padding:1.5em 2em;color:#ddd;}
div#header h1{display:inline;color:#4174CD;margin-right:0.5em;}
div#header h3{display:inline;}
div#controls{display:block;background-color:#eee;padding:0;overflow:auto;}
div#controls a{display:inline;float:left;color:#4174CD;padding:4px 1em;margin-right:1px;text-decoration:none;font-weight:bold;border-style:none;}
div#controls a:hover{background-color:#111;color:#4174CD;border-style:none;}
a:link{color:#111;text-decoration:none;border-bottom:solid 1px #111;}
a:visited{color:#333;text-decoration:none;border-bottom:solid 1px #111;}
a:hover{color:#4174CD;border-bottom:solid 2px #4174CD;}
/* =========== */
/* = Tiddler = */
/* =========== */
div.tiddler{border-bottom:solid 1px #ccc;padding:1em 2em;font-size:14px;line-height:1.7em;}
div.tiddler h1.tiddlerName{letter-spacing:-3px; font-size:3.8em; line-height:1;padding:0; margin:10px 0;}
div.tiddler ul.tags{list-style:none;padding:0;}
div.tiddler ul.tags *{display:inline;margin-right:1em;}
div.tiddler ul.tags h3{font-weight:normal;font-size:1em;color:#777;}
div.tiddler ul.tags li a{text-decoration:none;color:#666;background-color:#eee;padding:1px 4px;border-style:none;}
div.tiddler ul.tags li a:hover{text-decoration:none;color:#fff;background-color:#444;padding:1px 4px;margin:0;border-style:none;}
div.tiddler ul.meta{display:none;}
div.tiddler a.tiddlerLink{color:#4174CD;text-decoration:none;border-style:none;}
div.tiddler a.tiddlerLink:hover{background-color:#4174CD;color:#fff;margin:0 -2px;padding:1px 2px;border-style:none;}
div.tiddler .meta{color:#999;margin-right:0.5em;}
div.tiddler .meta a{color:#666;background-color:#f0f0f0;padding:1px 4px;margin:0;border-style:none;}
div.tiddler .meta a:hover{color:#fff;background-color:#4174CD;padding:1px 4px;margin:0;border-style:none;}
div.tiddler div.controls{display:block;text-align:right;}
div.tiddler a.control{margin-left:2px;padding:2px 6px;color:#fff;background-color:#bbb;border-style:none;font-style:bold;}
div.tiddler a.control:hover{color:#fff;background-color:#666;border-style:none;}
/* ================ */
/* = Tiddler Edit = */
/* ================ */
div.text textarea {width:100%; height:200px;}



/* ========================= */
/* = Vanilla Skin Tiddlers = */
/* ========================= */
div.tags a.tiddlerLink,
div.tags a.tiddlerLink:hover {margin:1px; font-size:0.9em;}


/* ================= */
/* = iPhone styles = */
/* ================= */
@media only screen and (max-device-width:480px){
	html,body{width:320px;}
	div.tiddler h1.tiddlerName{font-size:2.8em; }	
}
div.wysiwyg { border: 1px solid #ccc; padding: 5px; background-color: #FFF; }
div.wysiwyg * { margin: 0; padding: 0; }

div.wysiwyg ul.panel { border-bottom: 1px solid #ccc; float: left; width: 100%; padding: 0 0 4px 0; }
div.wysiwyg ul.panel li { list-style-type: none; float: left; margin: 0 2px; }
div.wysiwyg ul.panel li.separator { height: 16px; margin: 0 4px; border-left: 1px solid #ccc; }
div.wysiwyg ul.panel li a { opacity: 0.6; display: block; width: 16px; height: 16px; background: url('jquery.wysiwyg.gif') no-repeat -64px -80px; border: 0; cursor: pointer; padding: 1px; }
div.wysiwyg ul.panel li a:hover, div.wysiwyg ul.panel li a.active { opacity: 0.99; }
div.wysiwyg ul.panel li a.active { background-color: #f9f9f9; border: 1px solid #ccc; border-left-color: #AAA; border-top-color: #AAA; padding: 0; }

div.wysiwyg ul.panel li a.bold { background-position: 0 -16px; }
div.wysiwyg ul.panel li a.italic { background-position: -16px -16px; }
div.wysiwyg ul.panel li a.strikeThrough { background-position: -32px -16px; }
div.wysiwyg ul.panel li a.underline { background-position: -48px -16px; }

div.wysiwyg ul.panel li a.justifyLeft { background-position: 0 0; }
div.wysiwyg ul.panel li a.justifyCenter { background-position: -16px 0; }
div.wysiwyg ul.panel li a.justifyRight { background-position: -32px 0; }
div.wysiwyg ul.panel li a.justifyFull { background-position: -48px 0; }

div.wysiwyg ul.panel li a.indent { background-position: -64px 0; }
div.wysiwyg ul.panel li a.outdent { background-position: -80px 0; }

div.wysiwyg ul.panel li a.subscript { background-position: -64px -16px; }
div.wysiwyg ul.panel li a.superscript { background-position: -80px -16px; }

div.wysiwyg ul.panel li a.undo { background-position: 0 -64px; }
div.wysiwyg ul.panel li a.redo { background-position: -16px -64px; }

div.wysiwyg ul.panel li a.insertOrderedList { background-position: -32px -48px; }
div.wysiwyg ul.panel li a.insertUnorderedList { background-position: -16px -48px; }
div.wysiwyg ul.panel li a.insertHorizontalRule { background-position: 0 -48px; }

div.wysiwyg ul.panel li a.h1 { background-position: 0 -32px; }
div.wysiwyg ul.panel li a.h2 { background-position: -16px -32px; }
div.wysiwyg ul.panel li a.h3 { background-position: -32px -32px; }
div.wysiwyg ul.panel li a.h4 { background-position: -48px -32px; }
div.wysiwyg ul.panel li a.h5 { background-position: -64px -32px; }
div.wysiwyg ul.panel li a.h6 { background-position: -80px -32px; }

div.wysiwyg ul.panel li a.cut { background-position: -32px -64px; }
div.wysiwyg ul.panel li a.copy { background-position: -48px -64px; }
div.wysiwyg ul.panel li a.paste { background-position: -64px -64px; }

div.wysiwyg ul.panel li a.increaseFontSize { background-position: -16px -80px; }
div.wysiwyg ul.panel li a.decreaseFontSize { background-position: -32px -80px; }

div.wysiwyg ul.panel li a.createLink { background-position: -80px -48px; }
div.wysiwyg ul.panel li a.insertImage { background-position: -80px -80px; }

div.wysiwyg ul.panel li a.html { background-position: -48px -48px; }
div.wysiwyg ul.panel li a.removeFormat { background-position: -80px -64px; }

div.wysiwyg ul.panel li a.empty { background-position: -64px -80px; }

div.wysiwyg iframe { border: 0; margin: 5px 0 0 0; clear: left; }	</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js" type="text/javascript"></script>
	<div id="header">
		<h1 class="tiddlerName">JigglyWiki</h1>
		<h3>a web-visible, jQuery-based tiddlywiki clone</h3>
	</div>
	<div id="controls">
		<a class="control" href="#">close all</a>
		<a class="control" href="#">save</a>
		<a class="control" href="#">permalink</a>
		<a class="tiddlerLink" href="#tiddler:help">help</a>
		<a class="control" href="#">jiggle</a>
	</div>
	
	
	<!-- We use this div to display content via user actions -->
	<div id="story1" class="story">
		<div style="" class="tiddler"><a class="tiddlerName" name="tiddler:JigglyWiki"></a>
			<h1 class="tiddlerName" macro="view property:title">JigglyWiki</h1>
			<span class="meta" macro="view property:modifier">PhilHawksworth</span>
			<span class="meta">at</span>
			<span class="meta" macro="view property:modified">200808010000</span>
			<a href="#" class="control">edit</a><a href="#" class="control">close</a>
			<div class="text" macro="view property:text">
		<p><a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> is an experiment by <a class="tiddlerLink" href="#tiddler:PhilHawksworth">PhilHawksworth</a>. It is a clone of <a href="http://TiddlyWiki.com/">TiddlyWiki</a>, the popular single page javascript wiki originally created by Jeremy Ruston and developed by <a href="http://osmosoft.com/">Osmosoft</a> and the TiddlyWiki community.</p>
		<p><a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> is built using <a href="http://jquery.com">jQuery</a> and is intended to demonstrate an unobtrusive use of Javascript.  If you disable Javascript in your browser, this page should continue to be visible and navigable, but the more advanced features, will not be available.</p>
		<p>Since <a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> exposes the html first, web crawlers and screen readers should be able to more easily understand it and find meaning in its contents.</p>
		<p></p>
	</div>
			<div class="tags meta">
				<p>tags</p>
				<div macro="view property:tags"><a class="tiddlerLink" href="#tiddler:about">about</a><a class="tiddlerLink" href="#tiddler:help">help</a><a class="tiddlerLink" href="#tiddler:documentation">documentation</a></div>
			</div>
		</div>
	
		<div style="" class="tiddler"><a class="tiddlerName" name="tiddler:help"></a>
			<h1 class="tiddlerName" macro="view property:title">help</h1>
			<span class="meta" macro="view property:modifier">PhilHawksworth</span>
			<span class="meta">at</span>
			<span class="meta" macro="view property:modified">200808010000</span>
			<a href="#" class="control">edit</a><a href="#" class="control">close</a>
			<div class="text" macro="view property:text">
		<p>If javascript is not enabled, you should still be able to use tiddlerlinks to navigate the document.</p>
		<p>By default, <a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> will display the tiddlers that you list in the <a class="tiddlerLink" href="#tiddler:DefaultTiddlers">DefaultTiddlers</a> tiddler.</p>
		<p>
			We keep the tiddlers stored as readable html in a div called 'store'. This represents the content of the page. Displaying different tiddlers will not impact the order in which this content is stored but after manipulating 
			the order of tiddler display in the UI, we can reflect those changes back here by calling the Jiggle function to jiggle the contents of the store around to be the same as the displayed tiddlers.  That way, when we save 
			our page, the content that search engines and screen readers will find, will be the same as what we can see.
		</p>
		<p><a class="tiddlerLink" href="#tiddler:a_sample_viewable_tiddler">a sample viewable tiddler</a></p>
		<p><a class="tiddlerLink" href="#tiddler:another_sample_viewable_tiddler">another sample viewable tiddler</a></p>
	</div>
			<div class="tags meta">
				<p>tags</p>
				<div macro="view property:tags"></div>
			</div>
		</div>
	</div>
	
	<!-- We keep the tiddlers stored here. This represents the content of the page. -->
	<!-- Displaying different tiddlers will not impact the order in which this content is stored -->
	<!-- but after manipulating the order of tiddler display in the UI, we can reflect those -->
	<!-- changes back here by calling jiggleStore() -->
	<div id="store">
<div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:JigglyWiki"></a>
	<h1 class="tiddlerName">JigglyWiki</h1>
	<div class="text">
		<p><a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> is an experiment by <a class="tiddlerLink" href="#tiddler:PhilHawksworth">PhilHawksworth</a>. It is a clone of <a href="http://TiddlyWiki.com/">TiddlyWiki</a>, the popular single page javascript wiki originally created by Jeremy Ruston and developed by <a href="http://osmosoft.com/">Osmosoft</a> and the TiddlyWiki community.</p>
		<p><a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> is built using <a href="http://jquery.com">jQuery</a> and is intended to demonstrate an unobtrusive use of Javascript.  If you disable Javascript in your browser, this page should continue to be visible and navigable, but the more advanced features, will not be available.</p>
		<p>Since <a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> exposes the html first, web crawlers and screen readers should be able to more easily understand it and find meaning in its contents.</p>
		<p></p>
	</div>
	<ul class="tags">
		<h3>tags</h3>
		<li><a class="tiddlerLink" href="#tiddler:about">about</a></li>
		<li><a class="tiddlerLink" href="#tiddler:help">help</a></li>
		<li><a class="tiddlerLink" href="#tiddler:documentation">documentation</a></li>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
		<li><i>foo</i> <span>bar</span></li>
	</ul>
</div><div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:PhilHawksworth"></a>
	<h1 class="tiddlerName">PhilHawksworth</h1>
	<div class="text">
		<p>Phil can't help but explore the possibilities of building a TiddlyWiki clone using jQuery in an attempt to create a version of TiddlyWiki which is based on the contents first, with functionality added via unobtrusive Javascript.</p>
		<p>'tis but an experiment.</p>
	</div>
	<ul class="tags">
		<h3>tags</h3>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
		<li><i>foo</i> <span>bar</span></li>
	</ul>
</div><div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:a_sample_viewable_tiddler"></a>
	<h1 class="tiddlerName">a sample viewable tiddler</h1>
	<div class="text">
		<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p> 
		<a class="tiddlerLink" href="#tiddler:another_sample_viewable_tiddler">another sample viewable tiddler</a>
		<p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
	</div>
	<ul class="tags">
		<h3>tags</h3>
		<li><a class="tiddlerLink" href="#tiddler:sample">sample</a></li>
		<li><a class="tiddlerLink" href="#tiddler:temp">temp</a></li>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div>
<div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:another_sample_viewable_tiddler"></a>
	<h1 class="tiddlerName">another sample viewable tiddler</h1>
	<div class="text">
		<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.</p> 
		<a class="tiddlerLink" href="#tiddler:a_sample_viewable_tiddler">a sample viewable tiddler</a>
		<p>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
	</div>
	<ul class="tags">
		<h3>tags</h3>
		<li><a class="tiddlerLink" href="#tiddler:sample">sample</a></li>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div><div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:help"></a>
	<h1 class="tiddlerName">help</h1>
	<div class="text">
		<p>If javascript is not enabled, you should still be able to use tiddlerlinks to navigate the document.</p>
		<p>By default, <a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a> will display the tiddlers that you list in the <a class="tiddlerLink" href="#tiddler:DefaultTiddlers">DefaultTiddlers</a> tiddler.</p>
		<p>
			We keep the tiddlers stored as readable html in a div called 'store'. This represents the content of the page. Displaying different tiddlers will not impact the order in which this content is stored but after manipulating 
			the order of tiddler display in the UI, we can reflect those changes back here by calling the Jiggle function to jiggle the contents of the store around to be the same as the displayed tiddlers.  That way, when we save 
			our page, the content that search engines and screen readers will find, will be the same as what we can see.
		</p>
		<p><a class="tiddlerLink" href="#tiddler:a_sample_viewable_tiddler">a sample viewable tiddler</a></p>
		<p><a class="tiddlerLink" href="#tiddler:another_sample_viewable_tiddler">another sample viewable tiddler</a></p>
	</div>
	<ul class="tags">
		<h3>tags</h3>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div><div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:sample"></a>
	<h1 class="tiddlerName">sample</h1>
	<div class="text">
		This tiddler is tagging some others. Do you See? <a class="tiddlerLink" href="#tiddler:help">help</a>
	</div>
	<ul class="tags">
		<h3>tags</h3>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div><div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:shadow"></a>
	<h1 class="tiddlerName">shadow</h1>
	<div class="text">
		A shadow tiddler is a tiddler which lurks behind the scenes with a default value. You can overwrite it. If you delete it, it will revert to it's default
	</div>
	<ul class="tags">
		<h3>tags</h3>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div><div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:DefaultTiddlers"></a>
	<h1 class="tiddlerName">DefaultTiddlers</h1>
	<div class="text">
		<p><a class="tiddlerLink" href="#tiddler:JigglyWiki">JigglyWiki</a></p>
		<p><a class="tiddlerLink" href="#tiddler:help">help</a></p>
	</div>
	<ul class="tags">
		<h3>tags</h3>
		<li><a class="tiddlerLink" href="#tiddler:shadow">shadow</a></li>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div><div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:ViewTemplate"></a>
	<h1 class="tiddlerName">ViewTemplate</h1>
	<div class="text">
		<div style="display: none;" class="tiddler">
			<h1 class="tiddlerName" macro="view property:title"></h1>
			<span class="meta" macro="view property:modifier"></span>
			<span class="meta">at</span>
			<span class="meta" macro="view property:modified"></span>
			<a href="#" class="control">edit</a><a href="#" class="control">close</a>
			<div class="text" macro="view property:text"></div>
			<div class="tags meta">
				<p>tags</p>
				<div macro="view property:tags"></div>
			</div>
		</div>
	</div>
	<ul class="tags">
		<h3>tags</h3>
		<li><a class="tiddlerLink" href="#tiddler:shadow">shadow</a></li>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div>
<div style="display: none;" class="tiddler">
	<a class="tiddlerName" name="tiddler:EditTemplate"></a>
	<h1 class="tiddlerName">EditTemplate</h1>
	<div class="text">
		
		<div style="display: none;" class="tiddler edit">
			<h1 class="tiddlerName" macro="view property:title"></h1>
			<span class="meta" macro="view property:modifier"></span>
			<span class="meta">at</span>
			<span class="meta" macro="view property:modified"></span>
			<a href="#" class="control">save tiddler</a><a href="#" class="control">cancel</a>
			<div class="text"><textarea macro="view property:text"></textarea></div>
			<span class="meta">tags:</span><span class="meta" macro="view property:tags">tags</span>
		</div>
		
	</div>
	<ul class="tags">
		<h3>tags</h3>
		<li><a class="tiddlerLink" href="#tiddler:shadow">shadow</a></li>
	</ul>
	<ul class="meta">
		<h3>metadata</h3>
		<li><i>created</i> <span>200808010000</span></li>
		<li><i>modified</i> <span>200808010000</span></li>
		<li><i>modifier</i> <span>PhilHawksworth</span></li>
	</ul>
</div>
	</div>

	<script type="text/javascript">
	</script>
	<script type="text/javascript">
function loadJQueryExtensions() {
	jQuery.fn.reverse = Array.prototype.reverse;
}


var jigglywiki = {};

var config = {};
config.options = {};
config.options.txtFileSystemCharSet = 'UTF-8';


// We don't include the jQuery library when we server the page.
// If it isn't here, we should get it from Google and then save 
// it as part of the page or future sessions.
if(typeof jQuery !== 'function') {
	var head = document.getElementsByTagName("head")[0];
	script = document.createElement('script');
	script.type = 'text/javascript';
	script.src = "http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js";
	head.appendChild(script);
	jQueryReady();
} else {
	jQueryReady();
}

function jQueryReady() {
	if(typeof jQuery !== 'function') {
		setTimeout(function() {jQueryReady();},100);
		alert('waiting for jQuery to be available');
	} else {
		loadJQueryExtensions();
		$(document).ready(function(){
			initJigglyWiki(); 
			saveChanges();
		});		
	}
}

function initJigglyWiki() {
	$('div.tiddler').hide();
	showDefaultTiddlers();
	addEventHandlers();
	
	// speed tests
	// runSpeedTests();
}


// Show the default tiddlers
function showDefaultTiddlers(container) {
	var container = container ? container : "story1";
	var links = getTiddlerData('DefaultTiddlers', 'store').tiddlerLinks;	
	links.each(function(){
		var tiddlerName = $(this).attr('href');
		displayTiddler(tiddlerName, null, null, container, 'ViewTemplate', true);
	});
}


function containingTiddler(ele) {
	var tiddler = $(ele).parents('div.tiddler');
	if(tiddler.length == 1) {
		return tiddler;
	} else {
		return null;
	}
}


// return a tiddler object.
function getTiddler(name, container) {
	if(typeof name == 'string') {
		name = name.replace("#tiddler:","");
		name = name.replace("tiddler:","");		
		var t = $("#"+container+" div.tiddler a.tiddlerName[name='tiddler:"+name+"']").parents('div.tiddler');
		if(t.length > 0) {
			return t;
		} else {
			return null;
		}
	} else {
		t = $("#"+container).find(name)[0];
		return t;
	}
}


// return all tiddler divs from a container
function getAllTiddlers(container) {
	var t = $('#'+container+' div.tiddler');
	if(t.length !== 0) {
		return t;
	} else {
		return null;
	}	
}


// return tiddlers which have the specified tag
function getTiddlersByTag(tag, container) {
	var t = $('#'+container+' ul.tags li a[href=#tiddler:'+ tag +']').parents('div.tiddler');
	if(t.length !== 0) {
		return t;
	} else {
		return null;
	}
}


// return tiddlers which have the pecified modifier
function getTiddlersByModifier(modifier, container) {
	return getTiddlersByField('modifier', modifier, container);
}


// return tiddlers with a specified field value
function getTiddlersByField(field, value, container) {
	var t = $('#'+container+' ul.meta li:contains("'+field+'")').find('span:contains("'+value+'")').parents('div.tiddler');
	if(t.length !== 0) {
		return t;
	} else {
		return null;
	}
}


// return tiddlers which contain specified text
function getTiddlersByText(text, container) {
	var t = $("#"+container+" div.tiddler div.text:contains('"+text+"')").parents('div.tiddler');
	if(t.length !== 0) {
		return t;
	} else {
		return null;
	}
}


function getTiddlerNameFromStory(tiddler) {
	return $(tiddler).find('a.tiddlerName').attr('name');
}


// return an object containing jQuery objects for each piece of tiddler data.
function getTiddlerData(name, container) {
	var t = getTiddler(name, 'store');
	var data = null;
	if(t) {
		data = {};
		data['title'] = t.find('h1.tiddlerName');
		data['tiddlerName'] = data['title'].text().replace(/ /g,'_');
		data['text'] = t.find('div.text').get(0);
		data['tiddlerLinks'] = t.find('div.text a.tiddlerLink');
		data['tags'] = t.find('ul.tags li');
		t.find('ul.meta li').each(function(i,m){
			data[$(m).find('i').text()] = $(m).find('span').text();
		});
	}
	return data;
}


// jiggle the tiddlers in the store to echo the order in which they are displayed in the story(ies).
function jiggleStore() {
	$('div.story > div.tiddler').reverse().each(function(t){
		n = getTiddlerNameFromStory(this);
		t = getTiddler(n,"store");
		t.remove();
		t.prependTo($('#store'));
	});
	console.log("jiggled!");
}
function addEventHandlers() {
	
	//
	// use event delgation to handle the tiddler click events.
	//
	
	$('div.story').click(function(e){
		e.preventDefault();
		// tiddlerLink clicks.
		if( $(e.target).is('a.tiddlerLink') ) {
			tiddlerLinkClick.call(e.target, e, 'story1');
		}
		// tiddler controls clicks
		if( $(e.target).is('a.control') ) {
			var fn = $(e.target).text();
			var tiddler = containingTiddler(e.target);	
			if(jigglywiki.controls[fn] !== undefined) {
				jigglywiki.controls[fn].handler(tiddler);	
			} else {
				console.log("No handler for " + fn);
			}
		}
	 });

	//  control bar button click handlers.	
	$('#controls').click(function(e){
		e.preventDefault();
		// tiddlerLink clicks.
		if( $(e.target).is('a.tiddlerLink') ) {
			tiddlerLinkClick.call(e.target, e, 'story1');
		}
		// tiddler controls clicks
		if( $(e.target).is('a.control') ) {
			var fn = $(e.target).text();
			var tiddler = containingTiddler(e.target);
			if(jigglywiki.controls[fn] !== undefined) {
				jigglywiki.controls[fn].handler(tiddler);	
			} else {
				console.log("No handler for " + fn);
			}
		}
	 });
}

function tiddlerLinkClick(link, container) {
	var tiddlerName = $(this).attr("href");
	var ct = containingTiddler($(this));
	displayTiddler(tiddlerName, ct, 'after', container, 'ViewTemplate');
}jigglywiki.controls = {
	'edit': {
		handler: function(tiddler) { editTiddler(tiddler); }
	},
	'save': {
		handler: function(tiddler) { saveChanges(); }
	},
	'save tiddler': {
		handler: function(tiddler) { saveTiddler(tiddler); }
	},
	'cancel': {
		handler: function(tiddler) { cancelEditTiddler(tiddler); }
	},
	'close': {
		handler: function(tiddler) { closeTiddler(tiddler); }
	},
	'close all': {
		handler: function() { closeAllTiddlers(); }
	},
	'jiggle': {
		handler: function() { jiggleStore(); }
	}
};


function editTiddler(tiddler) {
	var container = $(tiddler).parents('div.story')[0].id;
	var name = getTiddlerNameFromStory(tiddler);
	displayTiddler(name, tiddler, 'replace', container, 'EditTemplate', true);
	// getTiddler(name,container).find('div.text textarea').wysiwyg();
}

function cancelEditTiddler(tiddler) {
	var container = $(tiddler).parents('div.story')[0].id;
	var name = getTiddlerNameFromStory(tiddler);
	displayTiddler(name, tiddler, 'replace', container, 'ViewTemplate', true);
}

function saveTiddler(tiddler) {
	
	var n = getTiddlerNameFromStory(tiddler);
	
	// name
	
	// text
	var text = tiddler.find("textarea[macro='view property:text']")[0].value;
	var t = getTiddler(n,'store');
	storedTextDiv = t.find('div.text');
	storedTextDiv.html(text);

	// tags
	
	// meta
	
	// Reflect the changes in the UI.
	cancelEditTiddler(tiddler);
}

function closeTiddler(tiddler) {
	tiddler.slideUp( function(){
	 	tiddler.remove();
	});
}

function closeAllTiddlers() {
	$('div.tiddler').each(function(){
		closeTiddler($(this));
	});
}
function displayTiddler(name, relative, position, container, template, overflow) {

	// get the tiddler from the store
	var t = getTiddler(name, 'store');

	// get the templated html of the tiddler
	var templatedTiddler = getTemplatedTiddler(t, template);

	// switching a template
	if(position == 'replace') {
	var refTiddler = getTiddler(relative, container);
		refTiddler.after(templatedTiddler);
		refTiddler.remove();
	} 

	// if the tiddler is not in the story, then add it now.		
	if(!getTiddler(name, container)) {
		if(relative) {
			var refTiddler = getTiddler(relative, container);	
			if(position == 'before'){
				refTiddler.before(templatedTiddler);
			} else {
				refTiddler.after(templatedTiddler);
			}
		} else {
			$('#'+container).append(templatedTiddler);
		}
	}
	//ensure that it is visible.
	var s = getTiddler(name, container).show();	
	if(!overflow) {
		var y = s.offset().top; 
		$('html,body').animate({scrollTop: y}, 500);
	}		
}


// Map the tiddler values onto a given template structure.
function getTemplatedTiddler(tiddler,template) {
	
	// get a copy of the template html structure from template tiddler.
	var html = $(getTiddlerData(template,'store').text).clone();
	
	// //use the macros in the templates to populate them.
	html.find('*').each(function(i,n) {	
		var macro = $(n).attr('macro');
		if(macro !== undefined) {
			applyMacros($(n), macro, tiddler);
		}
		if(i==0){
			$(n).prepend("<a class='tiddlerName' name='tiddler:"+ getTiddlerData(tiddler,'store').tiddlerName +"'></a>");
		}
	});
	
	
	return html.html();
}


jigglywiki.macros = {
	'view': {
		handler: function(place, tiddler, params) { viewTiddlerProperty(place, tiddler, params); }
	},
	'edit': {
		handler: function(place, tiddler, params) { viewTiddlerProperty(place, tiddler, params); }
	}
};


function applyMacros(element, args, tiddler) {

	// build a params object from the parameters passed
	var params = {};
	var args = args.split(" ");
	var macro = args[0];
	for(var a=1; a<args.length; a++) {
		nvp = args[a].split(":");
		params[nvp[0]] = nvp[1];
	};

	// call the macro if a handler for it exists
	if(jigglywiki.macros[macro]) {
		jigglywiki.macros[macro].handler(element, tiddler, params);
	} else {
		console.log("No handler for ", macro);
	}
}


function viewTiddlerProperty(place, tiddler, params) {
	var d = getTiddlerData(tiddler, 'store');
	var h = '';
	var prop = d[params['property']];
	if(typeof prop == 'string') {
		h += prop;
	} else {
		$(prop).each(function(i,e){
			h += $(e).html();
		});
	}
	place.html(h);
}
//--
//-- Saving
//--

var saveUsingSafari = false;

// var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
// var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
// function confirmExit()
// {
// 	hadConfirmExit = true;
// 	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
// 		return config.messages.confirmExit;
// }

// Give the user a chance to save changes before exitting
// function checkUnsavedChanges()
// {
// 	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
// 		if(confirm(config.messages.unsavedChangesWarning))
// 			saveChanges();
// 	}
// }

// function updateLanguageAttribute(s)
// {
// 	if(config.locale) {
// 		var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
// 		var m = mRE.exec(s);
// 		if(m) {
// 			var t = m[1];
// 			if(m[2])
// 				t += ' xml:lang="' + config.locale + '"';
// 			if(m[3])
// 				t += ' lang="' + config.locale + '"';
// 			t += ">";
// 			s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
// 		}
// 	}
// 	return s;
// }

// function updateMarkupBlock(s,blockName,tiddlerName)
// {
// 	return s.replaceChunk(
// 			"<!--%0-START-->".format([blockName]),
// 			"<!--%0-END-->".format([blockName]),
// 			"\n" + convertUnicodeToFileFormat(store.getRecursiveTiddlerText(tiddlerName,"")) + "\n");
// }

function updateOriginal(original,posDiv,localPath)
{
	var head = $('head').html();
	var body = $('body').html();
	var revised = head + body;
	return revised;
}

// function locateStoreArea(original)
// {
// 	// Locate the storeArea div's
// 	var posOpeningDiv = original.indexOf(startSaveArea);
// 	var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
// 	if(limitClosingDiv == -1)
// 		limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
// 	var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
// 	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
// }

// function autoSaveChanges(onlyIfDirty,tiddlers)
// {
// 	if(config.options.chkAutoSave)
// 		saveChanges(onlyIfDirty,tiddlers);
// }

function loadOriginal(localPath)
{
	return loadFile(localPath);
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	// clearMessage();
	var t0 = new Date();
	var originalPath = document.location.toString();
	// if(originalPath.substr(0,5) != "file:") {
	// 	alert(config.messages.notFileUrlError);
	// 	if(store.tiddlerExists(config.messages.saveInstructions))
	// 		story.displayTiddler(null,config.messages.saveInstructions);
	// 	return;
	// }
	var localPath = getLocalPath(originalPath);
	var original = loadOriginal(localPath);
	if(original == null) {
		alert(config.messages.cantSaveError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
	}
	// var posDiv = locateStoreArea(original);
	// if(!posDiv) {
	// 	alert(config.messages.invalidFileError.format([localPath]));
	// 	return;
	// }
	saveMain(localPath,original);
	// if(config.options.chkSaveBackups)
	// 	saveBackup(localPath,original);
	// if(config.options.chkSaveEmptyTemplate)
	// 	saveEmpty(localPath,original,posDiv);
	// if(config.options.chkGenerateAnRssFeed && saveRss instanceof Function)
	// 	saveRss(localPath);
	// if(config.options.chkDisplayInstrumentation)
	// 	displayMessage("saveChanges " + (new Date()-t0) + " ms");
}

function saveMain(localPath,original)
{
	var save;
	try {
		var revised = updateOriginal(original,null,localPath);
		save = saveFile(localPath,revised);
	} catch (ex) {
		console.log('exception ', ex);
	}
	if(save) {
		// alert("Saved!");
	} else {
		alert("Save failed");
	}
}

// function saveBackup(localPath,original)
// {
// 	//# Save the backup
// 	var backupPath = getBackupPath(localPath);
// 	var backup = copyFile(backupPath,localPath);
// 	//# Browser does not support copy, so use save instead
// 	if(!backup)
// 		backup = saveFile(backupPath,original);
// 	if(backup)
// 		displayMessage(config.messages.backupSaved,"file://" + backupPath);
// 	else
// 		alert(config.messages.backupFailed);
// }
// 
// function saveEmpty(localPath,original,posDiv)
// {
// 	//# Save empty template
// 	var emptyPath,p;
// 	if((p = localPath.lastIndexOf("/")) != -1)
// 		emptyPath = localPath.substr(0,p) + "/";
// 	else if((p = localPath.lastIndexOf("\\")) != -1)
// 		emptyPath = localPath.substr(0,p) + "\\";
// 	else
// 		emptyPath = localPath + ".";
// 	emptyPath += "empty.html";
// 	var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
// 	var emptySave = saveFile(emptyPath,empty);
// 	if(emptySave)
// 		displayMessage(config.messages.emptySaved,"file://" + emptyPath);
// 	else
// 		alert(config.messages.emptyFailed);
// }

function getLocalPath(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

// function getBackupPath(localPath,title,extension)
// {
// 	var slash = "\\";
// 	var dirPathPos = localPath.lastIndexOf("\\");
// 	if(dirPathPos == -1) {
// 		dirPathPos = localPath.lastIndexOf("/");
// 		slash = "/";
// 	}
// 	var backupFolder = config.options.txtBackupFolder;
// 	if(!backupFolder || backupFolder == "")
// 		backupFolder = ".";
// 	var backupPath = localPath.substr(0,dirPathPos) + slash + backupFolder + localPath.substr(dirPathPos);
// 	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + ".";
// 	//# replace illegal filename characters(// \/:*?"<>|) and space with underscore 
// 	if(title)
// 		backupPath += title.replace(/[\\\/\*\?\":<> ]/g,"_") + ".";
// 	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
// 	return backupPath;
// }

//--
//-- Filesystem code
//--

function convertUTF8ToUnicode(u)
{
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s+fin : s;
}

function convertUnicodeToFileFormat(s)
{
	return config.browser.isOpera || !window.netscape ? convertUnicodeToHtmlEntities(s) : mozConvertUnicodeToUTF8(s);
}

function convertUnicodeToHtmlEntities(s)
{
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function convertUnicodeToUTF8(s)
{
// return convertUnicodeToFileFormat to allow plugin migration
	return convertUnicodeToFileFormat(s);
}

function manualConvertUnicodeToUTF8(s)
{
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}

function copyFile(dest,source)
{
	return config.browser.isIE ? ieCopyFile(dest,source) : false;
}

function saveFile(fileUrl,content)
{
	var r = mozillaSaveFile(fileUrl,content);
	if(!r)
		r = ieSaveFile(fileUrl,content);
	if(!r)
		r = javaSaveFile(fileUrl,content);
	return r;
}

function loadFile(fileUrl)
{
	var r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

function ieCreatePath(path)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	var pos = path.lastIndexOf("\\");
	if(pos!=-1)
		path = path.substring(0,pos+1);

	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	for(i=scan.length-1;i>=0;i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}


// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x20|0x02,00004,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,00004,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			var contents = sInputStream.read(sInputStream.available());
			sInputStream.close();
			inputStream.close();
			return contents;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	return i > 0 ? url.substring(i-1) : url;
}

function javaSaveFile(filePath,content)
{
	try {
		if(document.applets["TiddlySaver"])
			return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
	} catch(ex) {
	}
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	try {
		if(document.applets["TiddlySaver"])
			return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
	} catch(ex) {
	}
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
	} catch(ex) {
		return null;
	}
	return content.join("\n");
}

	</script>
