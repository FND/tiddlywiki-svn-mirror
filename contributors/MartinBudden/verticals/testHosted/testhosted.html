<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script type="text/javascript">
//<![CDATA[
var version = {major: 2, minor: 2, revision: 0, beta: 3, date: new Date("Jan 8, 2007"), extensions: {}};
//]]>
</script>
<!--
TiddlyWiki 2.2.0 beta 3 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Osmosoft Limited 2004-2007

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the Osmosoft Limited nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
-->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<!--PRE-HEAD-START-->
<!--PRE-HEAD-END-->
<title>Test remotely hosted tiddlers - test code</title>
<script type="text/javascript">
//<![CDATA[
//
// Please note:
// 
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project Subversion repository at http://svn.tiddlywiki.org/Trunk/core/
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
// 
//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animFast: 0.12, // Speed for animations (lower == slower)
	animSlow: 0.01, // Speed for EasterEgg animations
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	displayStartupTime: false // Whether to display startup time
};

// Messages
config.messages = {
	messageClose: {},
	dates: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	txtBackupFolder: "",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30",
	txtFileSystemCharSet: "UTF-8"
	};
	
// List of notification functions to be called when certain tiddlers are changed or deleted
config.notifyTiddlers = [
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
];

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that shouldn't really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

// Backstage tasks
config.backstageTasks = ["tidy","sync","importTask","copy","plugins"];

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	newTiddler: {},
	newJournal: {},
	sparkline: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {},
	edit: {},
	tagChooser: {},
	toolbar: {},
	br: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	sync: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {},
	jump: {}
};

// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /Gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(config.browser.isBadSafari) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.urlPattern = "[a-z]{3,8}:[^\\s:'\"][^\\s'\"]*(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" + 
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "<!--{{{-->\n<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'/>\n<!--}}}-->",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: ""
};

//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

config.tasks = {
	tidy: {text: "tidy up", tooltip: "Make bulk changes across groups of tiddlers", content: 'Coming soon...\n\nThis tab will allow bulk operations on tiddlers, and tags. It will be a generalised, extensible version of the plugins tab'},
	sync: {text: "sync", tooltip: "Synchronise changes with other TiddlyWiki files and servers", content: '<<sync>>'},
	importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
	copy: {text: "copy", tooltip: "Copy tiddlers to other TiddlyWiki files and servers", content: 'Coming soon...\n\nThis tab will allow tiddlers to be copied to remote servers'},
	plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
};

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	backstagePrompt: "backstage: "});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
		"th","th","th","th","th","th","th","th","th","th",
		"st","nd","rd","th","th","th","th","th","th","th",
		"st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.plugins,{
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>",
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate : {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Title', field: 'title', tiddlerLink: 'title', title: "Title", type: 'TiddlerLink'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]}
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the TiddlyWiki file",
	step1Html: "Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option</select>",
	fetchLabel: "fetch",
	fetchPrompt: "Fetch the tiddlywiki file",
	fetchError: "There were problems fetching the tiddlywiki file",
	step2Title: "Step 2: Loading TiddlyWiki file",
	step2Html: "Please wait while the file is loaded from: <strong><input type='hidden' name='markPath'></input></strong>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "%0 tiddler(s) imported",
	step4Html: "<input type='hidden' name='markReport'></input>",
	doneLabel: "done",
	donePrompt: "Close this wizard",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Title', field: 'title', title: "Title", type: 'String'},
			{name: 'Snippet', field: 'text', title: "Snippet", type: 'String'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			]}
	});

merge(config.macros.sync,{
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'selected', rowName: 'title', type: 'Selector'},
			{name: 'Title', field: 'title', tiddlerLink: 'title', title: "Title", type: 'TiddlerLink'},
			{name: 'Local Status', field: 'localStatus', title: "Changed on your computer?", type: 'String'},
			{name: 'Server Status', field: 'serverStatus', title: "Changed on server?", type: 'String'},
			{name: 'Server URL', field: 'serverUrl', title: "Server URL", text: "View", type: 'Link'}
			],
		rowClasses: [
			],
		buttons: [
			{caption: "Sync these tiddlers", name: 'sync'}
			]},
	wizardTitle: "Synchronize with external servers and files",
	step1Title: "Choose the tiddlers you want to synchronize",
	step1Html: '<input type="hidden" name="markList"></input>',
	syncLabel: "sync",
	syncPrompt: "Sync these tiddlers",
	hasChanged:	"Changed while unplugged",
	hasNotChanged: "Unchanged while unplugged"});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "GettingStarted",
	MainMenu: "GettingStarted",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "http://www.tiddlywiki.com/",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options Â»" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	PluginManager: '<<plugins>>',
	ImportTiddlers: '<<importTiddlers>>'});
//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
config.parsers = {}; // Hashmap of alternative parsers for the wikifier
var anim = new Animator(); // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether to use the JavaSaver applet
var useJavaSaver = config.browser.isSafari || config.browser.isOpera;

// Starting up
function main()
{
	var t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
	startingUp = true;
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki();
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	loadOptionsCookie();
	for(var s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	t1 = new Date();
	store.loadFromDiv("storeArea","store",true);
	t2 = new Date();
	loadShadowTiddlers();
	t3 = new Date();
	invokeParamifier(params,"onload");
	t4 = new Date();
	var pluginProblem = loadPlugins();
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
	invokeParamifier(params,"onconfig");
	t6 = new Date();
	store.notifyAll();
	t7 = new Date();
	restart();
	t8 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	for(var m in config.macros) {
		if(config.macros[m].init)
			config.macros[m].init();
	}
	if(!readOnly)
		backstage.init();
	t9 = new Date();
	if(config.displayStartupTime) {
		displayMessage("Load in " + (t2-t1) + " ms");
		displayMessage("Loadshadows in " + (t3-t2) + " ms");
		displayMessage("Loadplugins in " + (t5-t4) + " ms");
		displayMessage("Notify in " + (t7-t6) + " ms");
		displayMessage("Restart in " + (t8-t7) + " ms");
		displayMessage("Total startup in " + (t9-t0) + " ms");
	}
	startingUp = false;
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty()) {
		var defaultParams = store.getTiddlerText("DefaultTiddlers").parseParams("open",null,false);
		invokeParamifierAsync(defaultParams,"onstart");
	}
	window.scrollTo(0,0);
}

function saveTest()
{
	var saveTest = document.getElementById("saveTest");
	if(saveTest.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	saveTest.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea","shadows",true);
	shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
	delete shadows;
}

function loadPlugins()
{
	if(safeMode)
		return false;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	installedPlugins = [];
	var hadProblem = false;
	for(var t=0; t<configTiddlers.length; t++) {
		tiddler = configTiddlers[t];
		pluginInfo = getPluginInfo(tiddler);
		if(isPluginExecutable(pluginInfo)) {
			pluginInfo.executed = true;
			pluginInfo.error = false;
			try {
				if(tiddler.text && tiddler.text != "")
					window.eval(tiddler.text);
			} catch(ex) {
				pluginInfo.log.push(config.messages.pluginError.format([exceptionText(ex)]));
				pluginInfo.error = true;
				hadProblem = true;
			}
		} else {
			pluginInfo.warning = true;
		}
		installedPlugins.push(pluginInfo);
	}
	return hadProblem;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable"))
		return verifyTail(plugin,false,config.messages.pluginDisabled);
	if(plugin.tiddler.isTagged("systemConfigForce"))
		return verifyTail(plugin,true,config.messages.pluginForced);
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0]) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1]) - version.minor;
		if(w == 0 && coreVersion[2])
		 	w = parseInt(coreVersion[2]) - version.revision;
		if(w > 0)
			return verifyTail(plugin,false,config.messages.pluginVersionError);
		}
	return true;
}

function verifyTail(plugin,result,message)
{
	plugin.log.push(message);
	return result;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try {
		var m = config.macros[macro];
		if(m && m.handler)
			m.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);
		else
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
	} catch(ex) {
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
	}
}

//--
//-- Paramifiers
//--

function getParameters()
{
	var p = null;
	if(window.location.hash) {
		p = decodeURI(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
	}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	for(var t=1; t<params.length; t++) {
		var p = config.paramifiers[params[t].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[t].value);
	}
}

function AsyncParamifier(p,h)
{
	this.params = p;
	this.handler = h;
	this.index = 1; // p[0] is not used
	if(!p || p.length == undefined || p.length <= 1)
		this.params.length = 0;
	return this;
}

AsyncParamifier.prototype.tick = function()
{
	if(this.index<this.params.length) {
		var p = config.paramifiers[this.params[this.index].name];
		if(p && p[this.handler] instanceof Function)
			p[this.handler](this.params[this.index].value,this.index);
		this.index++;
		return true;
	}
	return false;
};

function invokeParamifierAsync(params,handler)
{
	anim.startAnimating(new AsyncParamifier(params,handler));
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(v,i) {
		story.displayTiddler(i == 1 ? null : "bottom",v,null,false,false);
	}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
	}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
	}
};

config.paramifiers.tag = {
	onstart: function(v) {
		var tagged = store.getTaggedTiddlers(v,"title");
		for(var t=0; t<tagged.length; t++)
			story.displayTiddler("bottom",tagged[t].title,null,false,false);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(!readOnly) {
			story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(v,"text");
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly) {
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
		}
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};
//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},
	
	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if(lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if (s=="bgcolor")
				s = "backgroundColor";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		for(var t=0; t< styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if (link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1){
			return true;
		}
		return false;
	}

};

//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},

	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if(nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if(currRowType == "c") {
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					this.rowHandler(w,createTiddlyElement(rowContainer,"tr",null,(rowCount&1)?"oddRow":"evenRow"),prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch) {
			if(cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if(last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[2]) {
				// End of row
				if(prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if(chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if(colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,5}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if(lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if(lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if(lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if(listLevel > currLevel) {
				for(t=currLevel; t<listLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],listType));
			} else if(listLevel < currLevel) {
				for(t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if(listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1],listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel) {
				for(t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if(newLevel < currLevel) {
				for(t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^\\{\\{\\{\\n",
	lookaheadRegExp: /^\{\{\{\n((?:^[^\n]*\n)+?)(^\}\}\}$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForCSS",
	match: "^/\\*\\{\\{\\{\\*/\\n",
	lookaheadRegExp: /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\/\*\}\}\}\*\/$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForPlugin",
	match: "^//\\{\\{\\{\\n",
	lookaheadRegExp: /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\/\/\}\}\}$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "monospacedByLineForTemplate",
	match: "^<!--\\{\\{\\{-->\\n",
	lookaheadRegExp: /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^<!--\}\}\}-->$\n?)/mg,
	element: "pre",
	handler: config.formatterHelpers.enclosedTextHelper
},

{
	name: "wikifyCommentForPlugin",
	match: "^/\\*\\*\\*\\n",
	termRegExp: /(^\*\*\*\/\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(w.output,this.termRegExp);
	}
},

{
	name: "wikifyCommentForTemplate",
	match: "^<!---\\n",
	termRegExp: /(^--->\n)/mg,
	handler: function(w) 
	{
		w.subWikifyTerm(w.output,this.termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e;
			var text = lookaheadMatch[1];
			if(lookaheadMatch[3]) {
				// Pretty bracketted link
				var link = lookaheadMatch[3];
				e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
						createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
			} else {
				// Simple bracketted link
				e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);
			}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "unWikiLink",
	match: config.textPrimitives.unWikiLink+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		w.outputText(w.output,w.matchStart+1,w.nextMatch);
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchStart > 0) {
			var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1) {
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
			}
		}
		if(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText)) {
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
			w.outputText(link,w.matchStart,w.nextMatch);
		} else {
			w.outputText(w.output,w.matchStart,w.nextMatch);
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[(<?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if(lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
				addClass(e,"imageLink");
			}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3])
				img.title = lookaheadMatch[3];
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "boldByChar",
	match: "''",
	termRegExp: /('')/mg,
	element: "strong",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "italicByChar",
	match: "//",
	termRegExp: /(\/\/)/mg,
	element: "em",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "underlineByChar",
	match: "__",
	termRegExp: /(__)/mg,
	element: "u",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "strikeByChar",
	match: "--(?!\\s|$)",
	termRegExp: /((?!\s)--|(?=\n\n))/mg,
	element: "strike",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "superscriptByChar",
	match: "\\^\\^",
	termRegExp: /(\^\^)/mg,
	element: "sup",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "subscriptByChar",
	match: "~~",
	termRegExp: /(~~)/mg,
	element: "sub",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "monospacedByChar",
	match: "\\{\\{\\{",
	lookaheadRegExp: /\{\{\{((?:.|\n)*?)\}\}\}/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "styleByChar",
	match: "@@",
	termRegExp: /(@@)/mg,
	handler: function(w)
	{
		var e = createTiddlyElement(w.output,"span");
		var styles = config.formatterHelpers.inlineCssHelper(w);
		if(styles.length == 0)
			e.className = "marked";
		else
			config.formatterHelpers.applyCssHelper(e,styles);
		w.subWikifyTerm(e,this.termRegExp);
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "rawText",
	match: "\\\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
},

{
	name: "customClasses",
	match: "\\{\\{",
	termRegExp: /(\}\}\})/mg,
	lookaheadRegExp: /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch) {
			var e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			w.subWikifyTerm(e,this.termRegExp);
		}
	}
}

];

//--
//-- Wikifier
//--

function getParser(tiddler)
{
	if(tiddler!=null) {
		for(var i in config.parsers) {
			if(tiddler.isTagged(config.parsers[i].formatTag) || (config.parsers[i].format && tiddler.fields["wikiformat"] == config.parsers[i].format)) {
				return config.parsers[i];
			}
		}
	}
	return formatter;
}

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "") {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		wikifier.subWikifyUnterm(output);
	}
}

function wikifyStatic(source,highlightRegExp,tiddler)
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	var html = "";
	if(source && source != "") {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikifyUnterm(e);
		html = e.innerHTML;
		e.parentNode.removeChild(e);
	}
	return html;
}

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		var text = theStore.getTiddlerText(title);
		if(limit > 0)
			text = text.substr(0,limit);
		var wikifier = new Wikifier(text,formatter,null,theStore.getTiddler(title));
		return wikifier.wikifyPlain();
	} else {
		return "";
	}
}

function highlightify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "") {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e);
	var text = getPlainText(e);
	e.parentNode.removeChild(e);
	return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
	if(terminator)
		this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
	else
		this.subWikifyUnterm(output);
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
	// subWikify() can be indirectly recursive, so we need to save the old output pointer
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	// subWikify() can be indirectly recursive, so we need to save the old output pointer
	var oldOutput = this.output;
	this.output = output;
	// Get the first matches for the formatter and terminator RegExps
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		for(var t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

//--
//-- Macro definitions
//--

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text;
	if(params[0])
		text = now.formatString(params[0].trim());
	else
		text = now.toLocaleString();
	createTiddlyElement(place,"span",null,null,text);
};

config.macros.version.handler = function(place)
{
	createTiddlyElement(place,"span",null,null,version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
};

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] ? params[0] : "all";
	var theList = document.createElement("ul");
	place.appendChild(theList);
	if(this[type].prompt)
		createTiddlyElement(theList,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for(var t = 0; t < results.length; t++) {
		var theListItem = document.createElement("li");
		theList.appendChild(theListItem);
		if(typeof results[t] == "string")
			createTiddlyLink(theListItem,results[t],true);
		else
			createTiddlyLink(theListItem,results[t].title,true);
	}
};

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
	return store.getTouched();
}

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
	for(var t=0; t<tags.length; t++) {
		var title = tags[t][0];
		var info = getTiddlyLinkInfo(title);
		var li =createTiddlyElement(ul,"li");
		var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
		btn.setAttribute("tag",title);
		btn.setAttribute("refresh","link");
		btn.setAttribute("tiddlyLink",title);
	}
};

config.macros.timeline.handler = function(place,macroName,params)
{
	var field = params[0] ? params[0] : "modified";
	var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
	var lastDay = "";
	var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
	for(var t=tiddlers.length-1; t>=last; t--) {
		var tiddler = tiddlers[t];
		var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay) {
			var theDateList = document.createElement("ul");
			place.appendChild(theDateList);
			createTiddlyElement(theDateList,"li",null,"listTitle",tiddler[field].formatString(this.dateFormat));
			lastDay = theDay;
		}
		var theDateListItem = createTiddlyElement(theDateList,"li",null,"listLink");
		theDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));
	}
};

config.macros.search.handler = function(place,macroName,params)
{
	var searchTimeout = null;
	var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick);
	var txt = createTiddlyElement(place,"input",null,"txtOptionInput");
	if(params[0])
		txt.value = params[0];
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",this.accessKey);
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
	if(config.browser.isSafari) {
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
	} else {
		txt.setAttribute("type","text");
	}
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0) {
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
	}
};

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(e)
{
	if(!e) var e = window.event;
	switch(e.keyCode) {
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			config.macros.search.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(this.value.length > 2) {
		if(this.value != this.getAttribute("lastSearchText")) {
			if(config.macros.search.timeout)
				clearTimeout(config.macros.search.timeout);
			var txt = this;
			config.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);
		}
	} else {
		if(config.macros.search.timeout)
			clearTimeout(config.macros.search.timeout);
	}
};

config.macros.search.onFocus = function(e)
{
	this.select();
};

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("name",null,true,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] ? names[1] : null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className);
	if(!args) {
		wrapper.setAttribute("refresh","content");
		wrapper.setAttribute("tiddler",tiddlerName);
	}
	var text = store.getTiddlerText(tiddlerName);
	if(text) {
		var stack = config.macros.tiddler.tiddlerStack;
		if(stack.indexOf(tiddlerName) !== -1)
			return;
		stack.push(tiddlerName);
		try {
			var n = args ? Math.min(args.length,9) : 0;
			for(var i=0; i<n; i++) {
				var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
				text = text.replace(placeholderRE,args[i]);
			}
			config.macros.tiddler.renderText(wrapper,text,tiddlerName,params);
		} finally {
			stack.pop();
		}
	}
};

config.macros.tiddler.renderText = function(place,text,tiddlerName,params) 
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0]);
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var theList = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([tiddler.title]));
	for(var t=0; t<tiddler.tags.length; t++) {
		createTagButton(createTiddlyElement(theList,"li"),tiddler.tags[t],tiddler.title);
		if(t<tiddler.tags.length-1)
			createTiddlyText(theList,sep);
	}
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var theList = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	theList.setAttribute("title",this.tooltip.format([title]));
	var tagged = store.getTaggedTiddlers(title);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([title,tagged.length]));
	for(var t=0; t<tagged.length; t++) {
		createTiddlyLink(createTiddlyElement(theList,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(theList,sep);
	}
};

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(e)
{
	if(!e) var e = window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n,!isOpen,e.shiftKey || e.altKey,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOptionCookie(cookie);
	return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var cookie = cookie ? cookie : "";
	var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",cookie);
	panel.style.display = config.options[cookie] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh","content");
	panel.setAttribute("tiddler",params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
};

config.macros.option.types = {
	'txt': {
		elementType: "input",
		valueField: "value",
		eventName: "onkeyup",
		className: "txtOptionInput",
		create: function(opt,place,params) { config.macros.option.createHelper(opt,place,params,this);}
	},
	'chk': {
		elementType: "input",
		valueField: "checked",
		eventName: "onclick",
		className: "chkOptionInput",
		typeValue: "checkbox",
		create: function(opt,place,params) { config.macros.option.createHelper(opt,place,params,this);}
	}
};

// @param def {elementType:, valueField:, eventName:, className:, typeValue: /*optional*/}
config.macros.option.createHelper = function(opt,place,params,def)
{
    var c = document.createElement(def.elementType);
    if (def.typeValue)
        c.setAttribute("type",def.typeValue);
    c[def.eventName] = config.macros.option.onChangeOption;
    c.setAttribute("option",opt);
	if (params[1])
		c.className = params[1];
	else
    	c.className = def.className;
    place.appendChild(c);
    c[def.valueField] = config.options[opt];
    return c;
};

config.macros.option.onChangeOption = function(e)
{
	var opt = this.getAttribute("option");
	if(opt) {
		var optType = opt.substr(0,3);
		var handler = config.macros.option.types[optType];
		if (handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt,handler.valueField, this[handler.valueField], handler.elementType)
		}
	return true;
};

config.macros.option.propagateOption = function(opt, valueField, value, elementType)
{
	config.options[opt] = value;
	saveOptionCookie(opt);
	var nodes = document.getElementsByTagName(elementType);
	for(var t=0; t<nodes.length; t++) {
		var optNode = nodes[t].getAttribute("option");
		if(opt == optNode)
			nodes[t][valueField] = value;
		}
};

config.macros.option.handler = function(place,macroName,params)
{
	var opt = params[0];
	if(config.options[opt] == undefined)
		return;
	var optType = opt.substr(0,3);
	var h = config.macros.option.types[optType];
	if (h && h.create) 
			h.create(opt,place,params);
};

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
	var tags = [];
	for(var t=1; t<params.length; t++) {
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	}
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var customFields = getParam(params,"fields",newFocus);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("isJournal",isJournal);
	btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	btn.setAttribute("customFields",customFields);
	var text = getParam(params,"text");
	if(text !== undefined) 
		btn.setAttribute("newText",text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal")) {
		var now = new Date();
		title = now.formatString(title.trim());
	}
	var params = this.getAttribute("params").split("|");
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	story.displayTiddler(null,title,template,false,false,customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string")
		story.getTiddlerField(title,"text").value = text.format([title]);
	for(var t=0;t<params.length;t++)
		story.setTiddlerTag(title,params[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
	}
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : "";
		title = getParam(params,"title",title);
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
	}
};

config.macros.sparkline.handler = function(place,macroName,params)
{
	var data = [];
	var min = 0;
	var max = 0;
	for(var t=0; t<params.length; t++) {
		var v = parseInt(params[t]);
		if(v < min)
			min = v;
		if(v > max)
			max = v;
		data.push(v);
	}
	if(data.length < 1)
		return;
	var box = createTiddlyElement(place,"span",null,"sparkline",String.fromCharCode(160));
	box.title = data.join(",");
	var w = box.offsetWidth;
	var h = box.offsetHeight;
	box.style.paddingRight = (data.length * 2 - w) + "px";
	box.style.position = "relative";
	for(var d=0; d<data.length; d++) {
		var tick = document.createElement("img");
		tick.border = 0;
		tick.className = "sparktick";
		tick.style.position = "absolute";
		tick.src = "data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B";
		tick.style.left = d*2 + "px";
		tick.style.width = "2px";
		var v = Math.floor(((data[d] - min)/(max-min)) * h);
		tick.style.top = (h-v) + "px";
		tick.style.height = v + "px";
		box.appendChild(tick);
	}
};

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++) {
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++) {
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if(theTab) {
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			tabset.parentNode.removeChild(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie) {
			config.options[cookie] = tab;
			saveOptionCookie(cookie);
		}
	}
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier)
{
	var terminator = ">>";
	var panel;
	if(wikifier)
		panel = createTiddlyElement(place,"div",null,"gradient");
	else
		panel = place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	var t;
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
	}
	var colours = [];
	for(t=1; t<params.length; t++) {
		var c = new RGB(params[t]);
		if(c)
			colours.push(c);
	}
	drawGradient(panel,params[0] != "vert",colours);
	if(wikifier)
		wikifier.subWikify(panel,terminator);
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0]) {
		var m = config;
		var p = params[0].split(".");
		for(var t=0; t<p.length; t++) {
			if(p[t] in m)
				m = m[p[t]];
			else
				break;
		}
		createTiddlyText(place,m.toString().format(params.splice(1)));
	}
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if(value != undefined) {
			switch(params[1]) {
				case undefined:
					highlightify(value,place,highlightHack,tiddler);
					break;
				case "link":
					createTiddlyLink(place,value,true);
					break;
				case "wikified":
					wikify(value,place,highlightHack,tiddler);
					break;
				case "date":
					value = Date.convertFromYYYYMMDDHHMM(value);
					createTiddlyText(place,value.formatString(params[2] ? params[2] : config.views.wikified.dateFormat));
					break;
			}
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	if((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		if(field != "text") {
			var e = createTiddlyElement(null,"input");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			e.setAttribute("edit",field);
			e.setAttribute("type","text");
			var v = store.getValue(tiddler,field);
			if(!v) 
				v = "";
			e.value = v;
			e.setAttribute("size","40");
			e.setAttribute("autocomplete","off");
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1,"div");
			var e = createTiddlyElement(wrapper2,"textarea");
			if(tiddler.isReadOnly())
				e.setAttribute("readOnly","readOnly");
			var v = store.getValue(tiddler,field);
			if(!v) 
				v = "";
			e.value = v;
			var rows = 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
			if(lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows,maxLines);
			e.setAttribute("rows",rows);
			e.setAttribute("edit",field);
			place.appendChild(wrapper1);
		}
	}
};

config.macros.tagChooser.onClick = function(e)
{
	if(!e) var e = window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags();
	if(tags.length == 0)
		createTiddlyText(createTiddlyElement(popup,"li"),lingo.popupNone);
	for(var t=0; t<tags.length; t++) {
		var theTag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		theTag.setAttribute("tag",tags[t][0]);
		theTag.setAttribute("tiddler",this.getAttribute("tiddler"));
	}
	Popup.show(popup,false);
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(e)
{
	if(!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler) {
		var title = tiddler.title;
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler",title);
	}
};

// Create a toolbar command button
// place - parent DOM element
// command - reference to config.commands[] member -or- name of member
// tiddler - reference to tiddler that toolbar applies to
// theClass - the class to give the button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,theClass)
{
	if(typeof commandName != "string") {
		var c = null;
		for(var t in config.commands) {
			if(config.commands[t] == commandName)
				c = t;
		}
		commandName = c;
	}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
		var command = config.commands[commandName];
		if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
			var btn = createTiddlyButton(null,text,tooltip,this.onClickCommand);
			btn.setAttribute("commandName",commandName);
			btn.setAttribute("tiddler",tiddler.title);
			if(theClass)
				addClass(btn,theClass);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyText ? command.readOnlyText : command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
	return tiddler.isReadOnly() && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;
};

config.macros.toolbar.onClickCommand = function(e)
{
	if(!e) var e = window.event;
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,theClass,event)
{
	var children = place.getElementsByTagName("a");
	for(var t=0; t<children.length; t++) {
		var c = children[t];
		if(hasClass(c,theClass) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
		}
	}
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	for(var t=0; t<params.length; t++) {
		var c = params[t];
		var theClass = "";
		switch(c.substr(0,1)) {
			case "+":
				theClass = "defaultCommand";
				c = c.substr(1);
				break;
			case "-":
				theClass = "cancelCommand";
				c = c.substr(1);
				break;
		}
		if(c in config.commands)
			this.createCommand(place,c,tiddler,theClass);
	}
};

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
};
//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
	story.closeTiddler(title,true,event.shiftKey || event.altKey);
	return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	var tiddlerElem = document.getElementById(story.idPrefix + title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,null,null,fields);
	story.focusTiddler(title,"text");
	return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
		story.displayTiddler(null,newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if (config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if (deleteIt) {
		store.removeTiddler(title);
		story.closeTiddler(title,true,event.shiftKey || event.altKey);
		if(config.options.chkAutoSave)
			saveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
};

config.commands.references.handler = function(event,src,title)
{
	var popup = Popup.create(src);
	if(popup) {
		var references = store.getReferringTiddlers(title);
		var c = false;
		for(var r=0; r<references.length; r++) {
			if(references[r].title != title && !references[r].isTagged("excludeLists")) {
				createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
				c = true;
			}
		}
		if(!c)
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),this.popupNone);
	}
	Popup.show(popup,false);
	event.cancelBubble = true;
	if (event.stopPropagation) event.stopPropagation();
	return false;
};

config.commands.jump.handler = function(event,src,title)
{
	var popup = Popup.create(src);
	if(popup) {
		story.forEachTiddler(function(title,element) {
			createTiddlyLink(createTiddlyElement(popup,"li"),title,true);
			});
	}
	Popup.show(popup,false);
	event.cancelBubble = true;
	if (event.stopPropagation)
		event.stopPropagation();
	return false;
};

//--
//-- Tiddler() object
//--

function Tiddler()
{
	this.title = null;
	this.text = null;
	this.modifier = null;
	this.modified = new Date();
	this.created = new Date();
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return this.links;
};

// Returns the fields that are inherited in string "field:value;field2:value2;" format
Tiddler.prototype.getInheritedFields = function()
{
	var ret = "";
	for(i in this.fields) {
		if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
			ret += i + ":" + this.fields[i] + ";";
		}
	}
	return ret=="" ? null : ret;
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
	var c = this.fields['changecount'];
	if(!c)
		c = 0;
	this.fields['changecount'] = String(c+1);
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
	var changeCount = this.fields['changecount'];
	if(changeCount === undefined)
		changeCount = 0;
	return changeCount > 0;
};

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(url)
{
	var s = [];
	s.push("<item>");
	s.push("<title" + ">" + this.title.htmlEncode() + "</title" + ">");
	s.push("<description>" + wikifyStatic(this.text,null,this).htmlEncode() + "</description>");
	for(var t=0; t<this.tags.length; t++)
		s.push("<category>" + this.tags[t] + "</category>");
	s.push("<link>" + url + "#" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + "</link>");
	s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
	s.push("</item>");
	return(s.join("\n"));
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields)
{
	this.assign(title,text,modifier,modified,tags,created,fields);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(this.text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(this.text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2-t] && (store.tiddlerExists(formatMatch[3-t]) || store.isShadowTiddler(formatMatch[3-t]))) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(this.text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
	var theModifier = this.modifier;
	if(!theModifier)
		theModifier = config.messages.subtitleUnknown;
	var theModified = this.modified;
	if(theModified)
		theModified = theModified.toLocaleString();
	else
		theModified = config.messages.subtitleUnknown;
	return config.messages.tiddlerLinkTooltip.format([this.title,theModifier,theModified]);
};

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};
//--
//-- TiddlyWiki() object contains Tiddler()s
//--

function TiddlyWiki()
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		return tiddlers[title];
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		for(var t in tiddlers) {
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
		}
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel) {
		for(var t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
		}
	}
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	for(var i=0; i<this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({name: title, notify: fn});
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return typeof config.shadowTiddlers[title] == "string";
};

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
};

TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		return tiddler.text;
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
	}
	if(this.isShadowTiddler(title))
		return config.shadowTiddlers[title];
	if(defaultText != undefined)
		return defaultText;
	return null;
};

TiddlyWiki.prototype.slicesRE = /(?:[\'\/]*~?(\w+)[\'\/]*\:[\'\/]*\s*(.*?)\s*$)|(?:\|[\'\/]*~?(\w+)\:?[\'\/]*\|\s*(.*?)\s*\|)/gm;

// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	do {
		var m = this.slicesRE.exec(text);
		if(m) {
			if(m[1])
				slices[m[1]] = m[2];
			else
				slices[m[3]] = m[4];
		}
	} while(m);
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var r = {};
	for(var t=0; t<sliceNames.length; t++) {
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match) {
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"[[" + match[1] + "]]",depth-1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		var t = tiddler.tags.indexOf(tag);
		if(t != -1)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		this.incChangeCount(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields)
{
	var tiddler = this.fetchTiddler(title);
	var created;
	if(tiddler) {
		created = tiddler.created; // Preserve created date
		this.deleteTiddler(title);
	} else {
		tiddler = new Tiddler();
		created = modified;
	}
	tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields);
	this.addTiddler(tiddler);
	this.incChangeCount(newTitle);
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler();
		tiddler.title = title;
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem)
		return;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		for(var i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
	}
};

// Load contents of a TiddlyWiki from a string
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
	// Crack out the content - will be refactored to share code with saveChanges()
	var posOpeningDiv = text.indexOf(startSaveArea);
	var limitClosingDiv = text.indexOf("<!--POST-BODY-END--"+">");
	var posClosingDiv = text.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? text.length : limitClosingDiv);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		return config.messages.invalidFileError.format([url]);
	var content = "<html><body>" + text.substring(posOpeningDiv,posClosingDiv + endSaveArea.length) + "</body></html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	return null;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
	});
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return store.getSaver().externalize(store);
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag)
{
	var candidates = this.reverseLookup("tags",excludeTag,false);
	var results = [];
	for(var t=0; t<candidates.length; t++) {
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
	}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		for(var g=0; g<tiddler.tags.length; g++) {
			var tag = tiddler.tags[g];
			if(excludeTag) {
				var t = store.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					return false;
			}
			var f = false;
			for(var c=0; c<results.length; c++) {
				if(results[c][0] == tag) {
					f = true;
					results[c][1]++;
				}
			}
			if(!f)
				results.push([tag,1]);
		}
	});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		for(var lookup=0; lookup<tiddler[lookupField].length; lookup++) {
			if(tiddler[lookupField][lookup] == lookupValue)
				f = lookupMatch;
		}
		if(f)
			results.push(tiddler);
	});
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		for(var n=0; n<tiddler.links.length;n++) {
			var link = tiddler.links[n];
			if(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiddlers) {
		if(typeof config.shadowTiddlers[t] == "string")
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
		});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
	var t = (typeof tiddler == 'string') ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

TiddlyWiki.prototype.getLoader = function()
{
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by '.'
TiddlyWiki.isValidFieldName = function(name)
{
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
	this.set = readOnly ?
			function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
			function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if(d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if(s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return;
	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		if(isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if(!h.set(t,value))
			return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp('^'+fieldName+'\\.');
				var dirty = false;
				for(var n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty)
					return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value)
				return;
			t.fields[fieldName] = value;
		}
	}
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	fieldName = fieldName.toLowerCase();
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		return accessor.get(t);
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	for(var n in t.fields) {
		var result = callback(t,n,t.fields[n]);
		if(result)
			return result;
		}
	if(onlyExtendedFields)
		return undefined;
	for(var n in TiddlyWiki.standardFieldAccess) {
		if(n == "tiddler")
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			continue;
		var result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
		if(result)
			return result;
	}
	return undefined;
};

//--
//-- Story functions
//--

function Story(container,idPrefix)
{
	this.container = container;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
}

Story.prototype.forEachTiddler = function(fn)
{
	var place = document.getElementById(this.container);
	if(!place)
		return;
	var e = place.firstChild;
	while(e) {
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		fn.call(this,title,e);
		e = n;
	}
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,slowly,customFields)
{
	for(var t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,slowly,customFields);
};

Story.prototype.displayTiddler = function(srcElement,title,template,animate,slowly,customFields)
{
	var place = document.getElementById(this.container);
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem) {
		this.refreshTiddler(title,template,false,customFields);
	} else {
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place,before,title,template,customFields);
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Cascade == "function" && typeof Scroller == "function")
			anim.startAnimating(new Cascade(title,srcElement,tiddlerElem,slowly),new Scroller(tiddlerElem,slowly));
		else
			window.scrollTo(0,ensureVisible(tiddlerElem));
	}
};

Story.prototype.positionTiddler = function(srcElement)
{
	var place = document.getElementById(this.container);
	var before;
	if(typeof srcElement == "string") {
		switch(srcElement) {
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null)
			before = place.firstChild;
		else if(after.nextSibling)
			before = after.nextSibling;
		else
			before = null;
	}
	return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
	var tiddlerElem = createTiddlyElement(null,"div",this.idPrefix + title,"tiddler");
	tiddlerElem.setAttribute("refresh","tiddler");
	place.insertBefore(tiddlerElem,before);
	this.refreshTiddler(title,template,false,customFields);
	return tiddlerElem;
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem) {
		if(tiddlerElem.getAttribute("dirty") == "true" && !force)
			return tiddlerElem;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = tiddlerElem.getAttribute("template");
		if((template != currTemplate) || force) {
			var tiddler = store.getTiddler(title);
			if(!tiddler) {
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title)) {
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);
				} else {
					var text = template=="EditTemplate" ?
								config.views.editor.defaultText.format([title]) :
								config.views.wikified.defaultText.format([title]);
					var fields = customFields ? convertCustomFieldsToHash(customFields) : null;
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
				}
			}
			tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
			tiddlerElem.setAttribute("tiddler",title);
			tiddlerElem.setAttribute("template",template);
			var me = this;
			tiddlerElem.onmouseover = this.onTiddlerMouseOver;
			tiddlerElem.onmouseout = this.onTiddlerMouseOut;
			tiddlerElem.ondblclick = this.onTiddlerDblClick;
			tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			var html = this.getTemplateForTiddler(title,template,tiddler);
			tiddlerElem.innerHTML = html;
			applyHtmlMacros(tiddlerElem,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				addClass(tiddlerElem,"isTag");
			else
				removeClass(tiddlerElem,"isTag");
			if(!store.tiddlerExists(title)) {
				if(store.isShadowTiddler(title))
					addClass(tiddlerElem,"shadow");
				else
					addClass(tiddlerElem,"missing");
			} else {
				removeClass(tiddlerElem,"shadow");
				removeClass(tiddlerElem,"missing");
			}
			if(customFields)
				this.addCustomFields(tiddlerElem,customFields);
		}
	}
	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
	var fieldsPattern = "([^:]*):([^;]*);";
	var fieldsRegExp = new RegExp(fieldsPattern,"mg");
	var fields = [];
	var lastMatch = 0;
	var match = fieldsRegExp.exec(customFields);
	while(match && match.index == lastMatch) {
		fields.push({field: match[1], value: match[2]});
		lastMatch = match.index + match[0].length;
		fieldsRegExp.lastIndex = lastMatch;
		match = fieldsRegExp.exec(customFields);
	}
	var w = document.createElement("div");
	w.style.display = "none";
	place.appendChild(w);
	for(var t=0; t<fields.length; t++) {
		var e = document.createElement("input");
		e.setAttribute("type","text");
		e.setAttribute("value",fields[t].value);
		w.appendChild(e);
		e.setAttribute("edit",fields[t].field);
	}
};

Story.prototype.refreshAllTiddlers = function() 
{
	var place = document.getElementById(this.container);
	var e = place.firstChild;
	if(!e)
		return;
	this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
	while((e = e.nextSibling) != null) 
		this.refreshTiddler(e.getAttribute("tiddler"),e.getAttribute("template"),true);
};

Story.prototype.onTiddlerMouseOver = function(e)
{
	if(window.addClass instanceof Function)
		addClass(this,"selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
	if(window.removeClass instanceof Function)
		removeClass(this,"selected");
};

Story.prototype.onTiddlerDblClick = function(e)
{
	if(!e) var e = window.event;
	var theTarget = resolveTarget(e);
	if(theTarget && theTarget.nodeName.toLowerCase() != "input" && theTarget.nodeName.toLowerCase() != "textarea") {
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if(e.stopPropagation) e.stopPropagation();
		return true;
	} else {
		return false;
	}
};

Story.prototype.onTiddlerKeyPress = function(e)
{
	if(!e) var e = window.event;
	clearMessage();
	var consume = false; 
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
		case 9: // Tab
			if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
				replaceSelection(target,String.fromCharCode(9));
				consume = true; 
			}
			if(config.isOpera) {
				target.onblur = function() {
					this.focus();
					this.onblur = null;
				};
			}
			break;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey) {
				blurElement(this);
				config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
				consume = true;
			}
			break; 
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
			consume = true;
			break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	var e = null;
	if(tiddlerElem != null) {
		var children = tiddlerElem.getElementsByTagName("*");
		for(var t=0; t<children.length; t++) {
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
			}
		}
	}
	return e;
};

Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = story.getTiddlerField(title,field);

	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	Story.prototype.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,slowly)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null) {
		clearMessage();
		this.scrubTiddler(tiddlerElem);
		if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
			anim.startAnimating(new Slider(tiddlerElem,false,slowly,"all"));
		else
			tiddlerElem.parentNode.removeChild(tiddlerElem);
	}
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
	tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null)
		tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null)
		return tiddlerElem.getAttribute("dirty") == "true";
	return null;
};

Story.prototype.areAnyDirty = function()
{
	var r = false;
	this.forEachTiddler(function(title,element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
	var place = document.getElementById(this.container);
	return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ?	 text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	var titles = [];
	for(var t=matches.length-1; t>=0; t--)
		titles.push(matches[t].title);
	this.displayTiddlers(null,titles);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([titles.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
	while(e && !hasClass(e,"tiddler"))
		e = e.parentNode;
	return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute) {
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");
		if(e.hasChildNodes()) {
			var c = e.childNodes;
			for(var t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields);
		}
	}
};

Story.prototype.hasChanges = function(title)
{
	var e = document.getElementById(this.idPrefix + title);
	if(e != null) {
		var fields = {};
		this.gatherSaveFields(e,fields);
		var tiddler = store.fetchTiddler(title);
		if(!tiddler)
			return false;
		for(var n in fields) {
			if(store.getValue(title,n) != fields[n])
				return true;
		}
	}
	return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddlerElem = document.getElementById(this.idPrefix + title);
	if(tiddlerElem != null) {
		var fields = {};
		this.gatherSaveFields(tiddlerElem,fields);
		var newTitle = fields.title ? fields.title : title;
		if(store.tiddlerExists(newTitle) && newTitle != title) {
			if(confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				this.closeTiddler(newTitle,false,false);
			else
				return null;
		}
		tiddlerElem.id = this.idPrefix + newTitle;
		tiddlerElem.setAttribute("tiddler",newTitle);
		tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddlerElem.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		var newDate = new Date();
		var tiddler = store.saveTiddler(title,newTitle,fields.text,config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags);
		for(var n in fields) {
			if(!TiddlyWiki.isStandardField(n))
				store.setValue(newTitle,n,fields[n]);
		}
		if(config.options.chkAutoSave)
			saveChanges(null,[tiddler]);
		return newTitle;
	}
	return null;
};

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
	});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
};

// ---------------------------------------------------------------------------------
// Backstage
// ---------------------------------------------------------------------------------

var backstage = {
	backstage: null,
	cloak: null,
	tabs: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,

	init: function() {
		this.cloak = document.getElementById("backstageCloak");
		this.backstage = document.getElementById("backstage");
		this.tabs = document.getElementById("backstageTabs");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
		createTiddlyButton(this.panelFooter,"close","Close backstage",backstage.hidePanel);
		this.backstage.onmouseover = function(e) {
			backstage.tabs.style.visibility = "visible";
		};
		this.backstage.onmouseout = function(e) {
			backstage.tabs.style.visibility = "hidden";
		};
		this.cloak.onmousedown = function(e) {
			backstage.switchTab(null);
		};
		createTiddlyText(this.tabs,config.messages.backstagePrompt);
		for(var t=0; t<config.backstageTasks.length; t++) {
			var taskName = config.backstageTasks[t];
			var task = config.tasks[taskName];
			var btn = createTiddlyButton(this.tabs,task.text,task.tooltip,this.onClickTab,"backstageTab");
			btn.setAttribute("task",taskName);
			}
		this.switchTab(null);
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.tabs.firstChild;
		while(e)
			{
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling
			}
		if(tabName == backstage.currTabName)
			return;
		if(backstage.currTabElem) {
			removeClass(this.currTabElem,"backstageSelTab");
			}
		if(tabElem && tabName) {
			backstage.preparePanel();
			addClass(tabElem,"backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content,backstage.panelBody,null,null)
			backstage.showPanel();
		} else if(backstage.currTabElem) {
			backstage.hidePanel();
		}
		backstage.currTabName = tabName;
		backstage.currTabElem = tabElem;
	},

	preparePanel: function() {
		backstage.cloak.style.height = document.documentElement.scrollHeight + "px";
		backstage.cloak.style.display = "block";
		removeChildren(backstage.panelBody);
		return backstage.panelBody;
	},
	
	showPanel: function() {
		if(anim && config.options.chkAnimate)
			anim.startAnimating(new Slider(backstage.panel,true,false,"none"),new Scroller(backstage.backstage,false));
		else
			{
			backstage.panel.style.display = "block";
			backstage.panel.style.height = "auto";
			}
		return backstage.panelBody;
	},
	
	hidePanel: function() {
		backstage.currTabName = null;
		backstage.currTabElem = null;
		if(anim && config.options.chkAnimate)
			anim.startAnimating(new Slider(backstage.panel,false,false,"none"));
		else
			backstage.panel.style.display = "none";
		backstage.cloak.style.display = "none";
	},
	
	setButtons: function(buttons,callback) {
		removeChildren(backstage.panelFooter);
		for(t=0; t<buttons.length; t++)
			{
			var a = buttons[t];
			if(a && a.name != "")
				createTiddlyButton(backstage.panelFooter,a.caption,a.tooltip,function (e) {a.onclick.apply(this,arguments); return false;});
			}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var backstageTask = config.tasks[params[0]];
	if(backstageTask)
		createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;})
}
// ---------------------------------------------------------------------------------
// ImportTiddlers macro
// ---------------------------------------------------------------------------------

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly)
		{
		createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
		return;
		}
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	this.restart(w);
}

config.macros.importTiddlers.onCancel = function(e)
{
	var wizard = new Wizard(this);
	var place = wizard.clear();
	config.macros.importTiddlers.restart(wizard);
}

config.macros.importTiddlers.restart = function(wizard)
{
	wizard.addStep(this.step1Title,this.step1Html);
	var s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(var t=0; t<feeds.length; t++)
		{
		var e = createTiddlyElement(s,"option",null,null,feeds[t].title);
		e.value = feeds[t].url;
		}
	s.onchange = config.macros.importTiddlers.onFeedChange;
	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = config.macros.importTiddlers.onBrowseChange;
	fileInput.onkeyup = config.macros.importTiddlers.onBrowseChange;
	wizard.setButtons([{caption: this.fetchLabel, tooltip: this.fetchPrompt, onClick: config.macros.importTiddlers.onFetch}]);
}

config.macros.importTiddlers.getFeeds = function()
{
	var feeds = [];
	var tagged = store.getTaggedTiddlers("contentPublisher","title");
	for(var t=0; t<tagged.length; t++)
		feeds.push({title: tagged[t].title, url: store.getTiddlerSlice(tagged[t].title,"URL")});
	return feeds;
}

config.macros.importTiddlers.onFeedChange = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = this.value;
	this.selectedIndex = 0;
}

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = "file://" + this.value;
}

config.macros.importTiddlers.onFetch = function(e)
{
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	wizard.addStep(config.macros.importTiddlers.step2Title,config.macros.importTiddlers.step2Html);
	var markPath = wizard.getElement("markPath");
	markPath.parentNode.insertBefore(document.createTextNode(url),markPath);
	loadRemoteFile(url,config.macros.importTiddlers.onLoad,wizard);
	wizard.setButtons([{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel}]);
}

config.macros.importTiddlers.onLoad = function(status,params,responseText,url,xhr)
{
	if(!status)
		{
		displayMessage(this.fetchError);
		return;
		}
	var wizard = params;
	// Check that the tiddler we're in hasn't been closed - doesn't work on IE
//	var p = importer;
//	while(p.parentNode)
//		p = p.parentNode;
//	if(!(p instanceof HTMLDocument))
//		return;
	// Load the content into a TiddlyWiki() object
	var importStore = new TiddlyWiki();
	var r = importStore.importTiddlyWiki(responseText);
	if(r != null)
		{
		displayMessage(r);
		return;
		}
	// Extract data for the listview
	var tiddlers = [];
	importStore.forEachTiddler(function(title,tiddler)
		{
		var t = {};
		t.title = title;
		t.modified = tiddler.modified;
		t.modifier = tiddler.modifier;
		t.text = wikifyPlain(title,importStore,100).substr(0,100);
		t.tags = tiddler.tags;
		tiddlers.push(t);
		});
	wizard.setValue("store",importStore);
	// Display the listview
	wizard.addStep(config.macros.importTiddlers.step3Title,config.macros.importTiddlers.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,tiddlers,config.macros.importTiddlers.listViewTemplate);
	wizard.setValue("listView",listView);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.cancelLabel, tooltip: config.macros.importTiddlers.cancelPrompt, onClick: config.macros.importTiddlers.onCancel},
			{caption: config.macros.importTiddlers.importLabel, tooltip: config.macros.importTiddlers.importPrompt, onClick:  config.macros.importTiddlers.doImport}
		]);
}

config.macros.importTiddlers.doImport = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var theStore = wizard.getValue("store");
	var overwrite = new Array();
	var t;
	for(t=0; t<rowNames.length; t++)
		{
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0)
		if(!confirm(config.macros.importTiddlers.confirmOverwriteText.format([overwrite.join(", ")])))
			return;
	for(t=0; t<rowNames.length; t++)
		{
		var inbound = theStore.fetchTiddler(rowNames[t]);
		store.saveTiddler(inbound.title, inbound.title, inbound.text, inbound.modifier, inbound.modified, inbound.tags);
		store.fetchTiddler(inbound.title).created = inbound.created;
		store.notify(rowNames[t],false);
		}
	store.notifyAll();
	store.setDirty(true);
	wizard.addStep(config.macros.importTiddlers.step4Title.format([rowNames.length]),config.macros.importTiddlers.step4Html);
	var reportList = wizard.getElement("markReport");
	var reportWrapper = document.createElement("div");
	reportList.parentNode.insertBefore(reportWrapper,reportList);
	for(t=0; t<rowNames.length; t++)
		{
		createTiddlyLink(reportWrapper,rowNames[t],true);
		createTiddlyElement(reportWrapper,"br");
		}
	if(config.options.chkAutoSave)
		saveChanges(true);
	wizard.setButtons([
			{caption: config.macros.importTiddlers.doneLabel, tooltip: config.macros.importTiddlers.donePrompt, onClick: config.macros.importTiddlers.onCancel}
		]);
}
// ---------------------------------------------------------------------------------
// Sync macro
// ---------------------------------------------------------------------------------

// Synchronisation handlers
config.syncers = {};

// Sync state. Members:
//	syncList - List of sync objects (title, tiddler, server, workspace, page, version)
//	listView - DOM element of the listView table
var currSync = null;

// sync macro
config.macros.sync.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(!wikifier.isStatic)
		config.macros.sync.startSync(place);
}

config.macros.sync.startSync = function(place)
{
	if(currSync)
		config.macros.sync.cancelSync();
	currSync = {};
	var syncer;
	for(syncer in config.syncers)
		if(config.syncers[syncer].init)
			config.syncers[syncer].init(currSync);
	currSync.syncList = [];
	store.forEachTiddler(function(title,tiddler) {
		var syncType = store.getValue(tiddler,"server.type");
		var syncItem = {title: title,
			tiddler: tiddler,
			syncType: syncType,
			isTouched: tiddler.isTouched(),
			serverStatus: "..."
			};
		syncItem.localStatus = syncItem.isTouched ? config.macros.sync.hasChanged : config.macros.sync.hasNotChanged;
		syncItem.selected = syncItem.isTouched;
		syncer = config.syncers[syncType];
		if(syncType && syncer)
			{
			if(syncer.addSyncable)
				syncer.addSyncable(currSync,tiddler,syncItem);
			currSync.syncList.push(syncItem);
			}
		});
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,currSync.syncList,this.listViewTemplate);
	wizard.setValue("listView",listView);
	wizard.setButtons([
			{caption: config.macros.sync.syncLabel, tooltip: config.macros.sync.syncPrompt, onClick: config.macros.sync.doSync}
		]);
}

config.macros.sync.cancelSync = function()
{
	currSync = null;
}

config.macros.sync.doSync = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	for(var t=0; t<rowNames.length; t++)
		{
		var f = currSync.syncList.findByField("title",rowNames[t])
		var s = currSync.syncList[f];
		var syncer = config.syncers[s.syncType];
		if(syncer.doSync)
			syncer.doSync(currSync,s);
		}
}
// ---------------------------------------------------------------------------------
// Manager UI for groups of tiddlers
// ---------------------------------------------------------------------------------

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	listWrapper.setAttribute("refresh","macro");
	listWrapper.setAttribute("macroName","plugins");
	listWrapper.setAttribute("params",paramString);
	this.refresh(listWrapper,paramString);
}

config.macros.plugins.refresh = function(listWrapper,params)
{
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	removeChildren(listWrapper);
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++)
		{
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null)
			{
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
			}
		}
	for(t=0; t<plugins.length; t++)
		{
		var p = plugins[t];
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
		}
	if(plugins.length == 0)
		{
		createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
		wizard.setButtons([]);
		}
	else
		{
		var listView = ListView.create(listWrapper,plugins,this.listViewTemplate,this.onSelectCommand);
		wizard.setValue("listView",listView);
		wizard.setButtons([
				{caption: config.macros.plugins.removeLabel, tooltip: config.macros.plugins.removePrompt, onClick:  config.macros.plugins.doRemoveTag},
				{caption: config.macros.plugins.deleteLabel, tooltip: config.macros.plugins.deletePrompt, onClick:  config.macros.plugins.doDelete}
			]);
		}
}

config.macros.plugins.doRemoveTag = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0)
		alert(config.messages.nothingSelected);
	else
		for(var t=0; t<rowNames.length; t++)
			store.setTiddlerTag(rowNames[t],false,"systemConfig");
}

config.macros.plugins.doDelete = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0)
		alert(config.messages.nothingSelected);
	else
		{
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")])))
			{
			for(t=0; t<rowNames.length; t++)
				{
				store.removeTiddler(rowNames[t]);
				story.closeTiddler(rowNames[t],true,false);
				}
			}
		}
}
// ---------------------------------------------------------------------------------
// Message area
// ---------------------------------------------------------------------------------

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e)
		{
		alert(text);
		return;
		}
	if(linkText)
		{
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
		}
	else
		e.appendChild(document.createTextNode(text));
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea)
		{
		removeChildren(msgArea);
		msgArea.style.display = "none";
		}
	return false;
}

// ---------------------------------------------------------------------------------
// Refresh mechanism
// ---------------------------------------------------------------------------------

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},
	
	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && changeList.indexOf(title) != -1 && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		if(force != null || changeList == null || changeList.indexOf(title) != -1)
			{
			removeChildren(e);
			wikify(store.getTiddlerText(title,title),e);
			return true;
			}
		else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

function refreshElements(root,changeList)
{
	var nodes = root.childNodes;
	for(var c=0; c<nodes.length; c++)
		{
		var e = nodes[c],type;
		if(e.getAttribute)
			type = e.getAttribute("refresh");
		else
			type = null;
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
		}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e)
		{
		var nextChild = e.nextSibling;
		if(e.getAttribute)
			{
			var macro = e.getAttribute("macro");
			if(macro)
				{
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1)
					{
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
					}
				invokeMacro(e,macro,params,null,tiddler);
				}
			}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
		}
}

function refreshPageTemplate(title)
{
	var stash = createTiddlyElement(document.body,"div");
	stash.style.display = "none";
	var display = document.getElementById("tiddlerDisplay");
	var nodes,t;
	if(display)
		{
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
		}
	var wrapper = document.getElementById("contentWrapper");
	if(!title)
		title = "PageTemplate";
	var html = store.getRecursiveTiddlerText(title,null,10);
	wrapper.innerHTML = html;
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = document.getElementById("tiddlerDisplay");
	removeChildren(display);
	if(!display)
		display = createTiddlyElement(wrapper,"div","tiddlerDisplay");
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	stash.parentNode.removeChild(stash);
}

function refreshDisplay(hint)
{
	var e = document.getElementById("contentWrapper");
	if(typeof hint == "string")
		hint = [hint];
	refreshElements(e,hint);
}

function refreshPageTitle()
{
	document.title = wikifyPlain("SiteTitle") + " - " + wikifyPlain("SiteSubtitle");
}

function refreshStyles(title,doc)
{
	if(!doc)
		doc = document
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles("StyleSheet");
	refreshStyles("StyleSheetPrint");
}

// ---------------------------------------------------------------------------------
// Options cookie stuff
// ---------------------------------------------------------------------------------

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? "true" : "false";},
		set: function(name,value) {config.options[name] = value == "true";}	
	}	
};

function loadOptionsCookie()
{
	if(safeMode)
		return;
	var cookies = document.cookie.split(";");
	for(var c=0; c<cookies.length; c++)
		{
		var p = cookies[c].indexOf("=");
		if(p != -1)
			{
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			var optType = name.substr(0,3);
			if (config.optionHandlers[optType] && config.optionHandlers[optType].set)
				config.optionHandlers[optType].set(name,value);
			}
		}
}

function saveOptionCookie(name)
{
	if(safeMode)
		return;
	var c = name + "=";
	var optType = name.substr(0,3);
	if (config.optionHandlers[optType] && config.optionHandlers[optType].get)
		c += config.optionHandlers[optType].get(name);
	c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
	document.cookie = c;
}

function encodeCookie(s)
{
	return escape(manualConvertUnicodeToUTF8(s));
}

function decodeCookie(s)
{	
	s=unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re, function($0) {return(String.fromCharCode(eval($0.replace(/[&#;]/g,""))));});
}
// ---------------------------------------------------------------------------------
// Saving
// ---------------------------------------------------------------------------------

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false)
		{
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
		}
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + store.getRecursiveTiddlerText(tiddlerName,"") + "\n");
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	// Get the URL of the document
	var originalPath = document.location.toString();
	// Check we were loaded from a file URL
	if(originalPath.substr(0,5) != "file:")
		{
		alert(config.messages.notFileUrlError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
		}
	var localPath = getLocalPath(originalPath);
	// Load the original file
	var original = loadFile(localPath);
	if(original == null)
		{
		alert(config.messages.cantSaveError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			story.displayTiddler(null,config.messages.saveInstructions);
		return;
		}
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var limitClosingDiv = original.indexOf("<"+"!--POST-BODY-END--"+">");
	var posClosingDiv = original.lastIndexOf(endSaveArea,limitClosingDiv == -1 ? original.length : limitClosingDiv);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		{
		alert(config.messages.invalidFileError.format([localPath]));
		return;
		}
	// Save the backup
	if(config.options.chkSaveBackups)
		{
		var backupPath = getBackupPath(localPath);
		var backup = config.browser.isIE ? ieCopyFile(backupPath,localPath) : saveFile(backupPath,original);
		if(backup)
			displayMessage(config.messages.backupSaved,"file://" + backupPath);
		else
			alert(config.messages.backupFailed);
		}
	// Save Rss
	if(config.options.chkGenerateAnRssFeed)
		{
		var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
		var rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));
		if(rssSave)
			displayMessage(config.messages.rssSaved,"file://" + rssPath);
		else
			alert(config.messages.rssFailed);
		}
	// Save empty template
	if(config.options.chkSaveEmptyTemplate)
		{
		var emptyPath,p;
		if((p = localPath.lastIndexOf("/")) != -1)
			emptyPath = localPath.substr(0,p) + "/empty.html";
		else if((p = localPath.lastIndexOf("\\")) != -1)
			emptyPath = localPath.substr(0,p) + "\\empty.html";
		else
			emptyPath = localPath + ".empty.html";
		var empty = original.substr(0,posOpeningDiv + startSaveArea.length) + original.substr(posClosingDiv);
		var emptySave = saveFile(emptyPath,empty);
		if(emptySave)
			displayMessage(config.messages.emptySaved,"file://" + emptyPath);
		else
			alert(config.messages.emptyFailed);
		}
	var save;
	try 
		{
		// Save new file
		var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + "\n" +
					convertUnicodeToUTF8(store.allTiddlersAsHtml()) + "\n" +
					original.substr(posClosingDiv);
		var newSiteTitle = convertUnicodeToUTF8((wikifyPlain("SiteTitle") + " - " + wikifyPlain("SiteSubtitle")).htmlEncode());
		revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
		revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
		revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
		revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
		revised = updateMarkupBlock(revised,"POST-BODY","MarkupPostBody");
		save = saveFile(localPath,revised);
		}
	catch (e) 
		{
		showException(e);
		}
	if(save)
		{
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
		}
	else
		alert(config.messages.mainFailed);
}

function getLocalPath(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath)
{
	var backSlash = true;
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1)
		{
		dirPathPos = localPath.lastIndexOf("/");
		backSlash = false;
		}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + (backSlash ? "\\" : "/") + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + "." + (new Date()).convertToYYYYMMDDHHMMSSMMM() + ".html";
	return backupPath;
}

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlain("SiteTitle").htmlEncode() + "</title" + ">");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
	s.push("<language>en-us</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for (var t=tiddlers.length-1; t>=n; t--)
		s.push(tiddlers[t].saveToRss(u));
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}



function convertUTF8ToUnicode(u)
{
	if(window.netscape == undefined)
		return manualConvertUTF8ToUnicode(u);
	else
		return mozConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s+fin : s;
}

function convertUnicodeToUTF8(s)
{
	if(window.netscape == undefined)
		return manualConvertUnicodeToUTF8(s);
	else
		return mozConvertUnicodeToUTF8(s);
}

function manualConvertUnicodeToUTF8(s)
{
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	if(fin.length > 0)
		return u + fin;
	else
		return u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}

function saveFile(fileUrl,content)
{
	var r = null;
	if((r == null) || (r == false))
		r = mozillaSaveFile(fileUrl,content);
	if((r == null) || (r == false))
		r = ieSaveFile(fileUrl,content);
	if((r == null) || (r == false))
		r = javaSaveFile(fileUrl,content);
	return r;
}

function loadFile(fileUrl)
{
	var r = null;
	if((r == null) || (r == false))
		r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x20|0x02,00004,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,00004,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			return sInputStream.read(sInputStream.available());
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	if(i > 0)
		return url.substring(i-1);
	return url;
}

function javaSaveFile(filePath,content)
{
	try {
		if(document.applets["TiddlySaver"])
			return document.applets["TiddlySaver"].saveFile(javaUrlToFilename(filePath),"UTF-8",content);
	} catch(ex) {
	}
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	try {
		if(document.applets["TiddlySaver"])
			return String(document.applets["TiddlySaver"].loadFile(javaUrlToFilename(filePath),"UTF-8"));
	} catch(ex) {
	}
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while ((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
	} catch(ex) {
		return null;
	}
	return content.join("\n");
}

//--
//-- Remote HTTP requests
//--

function loadRemoteFile(url,callback,params)
{
	return doHttp("GET",url,null,null,null,null,callback,params,null);
}

// HTTP status codes
var httpStatus = {
	OK: 200,
	ContentCreated: 201,
	NoContent: 204,
	Unauthorized: 401,
	Forbidden: 403,
	NotFound: 404,
	MethodNotAllowed: 405
};

function doHttp(type,url,data,contentType,username,password,callback,params,headers)
{
	// Get an xhr object
	var x;
	try {
		x = new XMLHttpRequest(); // Modern
	} catch(ex) {
		try {
			x = new ActiveXObject("Msxml2.XMLHTTP"); // IE 6
		} catch (ex2) {
			return "Can't create XMLHttpRequest object";
		}
	}
	// Install callback
	x.onreadystatechange = function() {
		if (x.readyState == 4 && callback && (x.status !== undefined)) {
			if([0, httpStatus.OK, httpStatus.ContentCreated, httpStatus.NoContent].contains(x.status))
				callback(true,params,x.responseText,url,x);
			else
				callback(false,params,null,url,x);
			x.onreadystatechange = function(){};
			x = null;
		}
	};
	// Send request
	if(window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
		window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	try {
		url = url + (url.indexOf("?") < 0 ? "?" : "&") + "nocache=" + Math.random();
		x.open(type,url,true,username,password);
		if (data)
			x.setRequestHeader("Content-Type", contentType ? contentType : "application/x-www-form-urlencoded");
		if (x.overrideMimeType)
			x.setRequestHeader("Connection", "close");
		if(headers) {
			for(n in headers)
				x.setRequestHeader(n,headers[n]);
		}
		x.setRequestHeader("X-Requested-With", "TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
		x.send(data);
	} catch (ex) {
		return exceptionText(ex);
	}
	return x;
}
//--
//-- TiddlyWiki-specific utility functions
//--

function createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)
{
	var theButton = document.createElement("a");
	if(theAction) {
		theButton.onclick = theAction;
		theButton.setAttribute("href","javascript:;");
	}
	if(theTooltip)
		theButton.setAttribute("title",theTooltip);
	if(theText)
		theButton.appendChild(document.createTextNode(theText));
	if(theClass)
		theButton.className = theClass;
	else
		theButton.className = "button";
	if(theId)
		theButton.id = theId;
	if(theParent)
		theParent.appendChild(theButton);
	if(theAccessKey)
		theButton.setAttribute("accessKey",theAccessKey);
	return theButton;
}

function createTiddlyLink(place,title,includeText,theClass,isStatic,linkedFromTiddler,link)
{
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,theClass);
	var btn = isStatic ? createExternalLink(place,"#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",link ? link : title);
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields) {
			btn.setAttribute("tiddlyFields",fields);
		}
	}
	return btn;
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			classes.pushUnique("shadow");
		} else {
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
			classes.remove("shadow");
		}
	}
	return {classes: classes.join(" "),subTitle: subTitle};
}

function createExternalLink(place,url)
{
	var theLink = document.createElement("a");
	theLink.className = "externalLink";
	theLink.href = url;
	theLink.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		theLink.target = "_blank";
	place.appendChild(theLink);
	return theLink;
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(e)
{
	if (!e) e = window.event;
	var theTarget = resolveTarget(e);
	var theLink = theTarget;
	var title = null;
	var fields = null;
	do {
		title = theLink.getAttribute("tiddlyLink");
		fields = theLink.getAttribute("tiddlyFields");
		theLink = theLink.parentNode;
	} while(title == null && theLink != null);
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		var opening;
		if(toggling && document.getElementById("tiddler" + title)) {
			story.closeTiddler(title,true,e.shiftKey || e.altKey);
		} else {
			story.displayTiddler(theTarget,title,null,true,e.shiftKey || e.altKey,fields);
			if(fields) {
				var tiddlerElem = document.getElementById(story.idPrefix + title);
				tiddlerElem.setAttribute("tiddlyFields",fields);
				if(!store.tiddlerExists(title))
					store.getMissingTiddler(title,convertCustomFieldsToHash(fields));
			}
		}
	}
	return false;
}

// Converts customFields in "field:value;field2:value2;" format into a hash
function convertCustomFieldsToHash(customFields)
{
	fields = {};
	var fieldsRegExp = /([^:]*):([^;]*);/mg;
	fieldsRegExp.lastIndex = 0;
	var match = fieldsRegExp.exec(customFields);
	while(match) {
		fields[match[1]] = match[2];
		match = fieldsRegExp.exec(customFields);
	}
	return fields;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler)
{
	var theTag = createTiddlyButton(place,tag,config.views.wikified.tag.tooltip.format([tag]),onClickTag);
	theTag.setAttribute("tag",tag);
	if(excludeTiddler)
		theTag.setAttribute("tiddler",excludeTiddler);
	return theTag;
}

// Event handler for clicking on a tiddler tag
function onClickTag(e)
{
	if(!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var popup = Popup.create(this);
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = store.getTaggedTiddlers(tag);
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++) {
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++) {
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
			}
		} else {
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
	}
	Popup.show(popup,false);
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(e)
{
	if(!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var tagged = store.getTaggedTiddlers(tag);
	var titles = [];
	for(var t=0; t<tagged.length; t++)
		titles.push(tagged[t].title);
	story.displayTiddlers(this,titles);
	return false;
}

function onClickError(e)
{
	if(!e) var e = window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show(popup,false);
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyDropDown(place,onchange,options)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	for(var t=0; t<options.length; t++) {
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
	}
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if(text) btn.setAttribute("errorText",text);
}

function merge(dst,src,preserveExisting)
{
	for(p in src) {
		if(!preserveExisting || dst[p] === undefined)
			dst[p] = src[p];
	}
	return dst;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
	var s = e.description ? e.description : e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
	alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
	alert(m);
	throw(m);
}

//-
//- Animation engine
//-

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() // Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},5);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length) {
		var animation = me.animations[a];
		if(animation.tick()) {
			a++;
		} else {
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

// Map a 0..1 value to 0..1, but slow down at the start and end
Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
};

//--
//-- Cascade animation
//--

function Cascade(text,startElement,targetElement,slowly)
{
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	this.elements = [];
	this.startElement = startElement;
	this.startLeft = findPosX(this.startElement);
	this.startTop = findPosY(this.startElement);
	this.startWidth = Math.min(this.startElement.offsetWidth,winWidth);
	this.startHeight = Math.min(this.startElement.offsetHeight,winHeight);
	this.targetElement = targetElement;
	targetElement.style.position = "relative";
	targetElement.style.zIndex = 2;
	this.targetLeft = findPosX(this.targetElement);
	this.targetTop = findPosY(this.targetElement);
	this.targetWidth = Math.min(this.targetElement.offsetWidth,winWidth);
	this.targetHeight = Math.min(this.targetElement.offsetHeight,winHeight);
	this.progress = -1;
	this.steps = slowly ? config.cascadeSlow : config.cascadeFast;
	this.text = text;
	this.tick();
	return this;
}

Cascade.prototype.tick = function()
{
	this.progress++;
	if(this.progress >= this.steps) {
		while(this.elements.length > 0)
			this.removeTail();
		this.targetElement.style.position = "static";
		this.targetElement.style.zIndex = "";
		return false;
	} else {
		if(this.elements.length > 0 && this.progress > config.cascadeDepth)
			this.removeTail();
		if(this.progress < (this.steps - config.cascadeDepth)) {
			var f = Animator.slowInSlowOut(this.progress/(this.steps - config.cascadeDepth - 1));
			var e = createTiddlyElement(document.body,"div",null,"cascade",this.text);
			e.style.zIndex = 1;
			e.style.left = this.startLeft + (this.targetLeft-this.startLeft) * f + "px";
			e.style.top = this.startTop + (this.targetTop-this.startTop) * f + "px";
			e.style.width = this.startWidth + (this.targetWidth-this.startWidth) * f + "px";
			e.style.height = this.startHeight + (this.targetHeight-this.startHeight) * f + "px";
			e.style.display = "block";
			this.elements.push(e);
		}
		return true;
	}
};

Cascade.prototype.removeTail = function()
{
	var e = this.elements[0];
	e.parentNode.removeChild(e);
	this.elements.shift();
};

//--
//-- Scroller animation
//--

function Scroller(targetElement,slowly)
{
	this.targetElement = targetElement;
	this.startScroll = findScrollY();
	this.targetScroll = ensureVisible(targetElement);
	this.progress = 0;
	this.step = slowly ? config.animSlow : config.animFast;
	return this;
}

Scroller.prototype.tick = function()
{
	this.progress += this.step;
	if(this.progress > 1) {
		window.scrollTo(0,this.targetScroll);
		return false;
	} else {
		var f = Animator.slowInSlowOut(this.progress);
		window.scrollTo(0,this.startScroll + (this.targetScroll-this.startScroll) * f);
		return true;
	}
};

//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,slowly,deleteMode)
{
	this.element = element;
	element.style.display = "block";
	this.deleteMode = deleteMode;
	this.element.style.height = "auto";
	this.realHeight = element.offsetHeight;
	this.opening = opening;
	this.step = slowly ? config.animSlow : config.animFast;
	if(opening) {
		this.progress = 0;
		element.style.height = "0px";
		element.style.display = "block";
	} else {
		this.progress = 1;
		this.step = -this.step;
	}
	element.style.overflow = "hidden";
	return this;
}

Slider.prototype.stop = function()
{
	if(this.opening) {
		this.element.style.height = "auto";
		this.element.style.opacity = 1;
		this.element.style.filter = "alpha(opacity:100)";
	} else {
		switch(this.deleteMode) {
			case "none":
				this.element.style.display = "none";
				this.element.style.opacity = 1;
				this.element.style.filter = "alpha(opacity:100)";
				break;
			case "all":
				this.element.parentNode.removeChild(this.element);
				break;
			case "children":
				removeChildren(this.element);
				break;
		}
	}
};

Slider.prototype.tick = function()
{
	this.progress += this.step;
	if(this.progress < 0 || this.progress > 1) {
		this.stop();
		return false;
	} else {
		var f = Animator.slowInSlowOut(this.progress);
		var h = this.realHeight * f;
		this.element.style.height = h + "px";
		this.element.style.opacity = f;
		this.element.style.filter = "alpha(opacity:" + f * 100 +")";
		return true;
	}
};

//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root)
{
	Popup.remove();
	var popup = createTiddlyElement(document.body,"ol","popup","popup");
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(e)
{
	if (!e) var e = window.event;
	var target = resolveTarget(e);
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(unused,slowly)
{
	var curr = Popup.stack[Popup.stack.length-1];
	var rootLeft = findPosX(curr.root);
	var rootTop = findPosY(curr.root);
	var rootHeight = curr.root.offsetHeight;
	var popupLeft = rootLeft;
	var popupTop = rootTop + rootHeight;
	var popupWidth = curr.popup.offsetWidth;
	var winWidth = findWindowWidth();
	if(popupLeft + popupWidth > winWidth)
		popupLeft = winWidth - popupWidth;
	curr.popup.style.left = popupLeft + "px";
	curr.popup.style.top = popupTop + "px";
	curr.popup.style.display = "block";
	addClass(curr.root,"highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup,slowly));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.remove = function()
{
	if(Popup.stack.length > 0) {
		Popup.removeFrom(0);
	}
};

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--) {
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		p.popup.parentNode.removeChild(p.popup);
	}
	Popup.stack = Popup.stack.slice(0,from);
};

//--
//-- Wizard support
//--

function Wizard(elem) {
	if(elem) {
		this.formElem = findRelated(elem,"wizard","className");
		this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
		this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name,value) {
	if(this.formElem)
		this.formElem[name] = value;
}

Wizard.prototype.getValue = function(name) {
	return this.formElem ? this.formElem[name] : null;
}

Wizard.prototype.createWizard = function(place,title) {
	this.formElem = createTiddlyElement(place,"form",null,"wizard");
	createTiddlyElement(this.formElem,"h1",null,null,title);
	this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
	this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
	createTiddlyButton(this.footElem,"close","Close backstage",backstage.hidePanel);
};

Wizard.prototype.clear = function() {
	removeChildren(this.bodyElem);
};


Wizard.prototype.setButtons = function(buttonInfo) {
	removeChildren(this.footElem);
	for(var t=0; t<buttonInfo.length; t++) {
		if(t != 0)
			insertSpacer(this.footElem);
		createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
		}
};

Wizard.prototype.addStep = function(stepTitle,html) {
	var w = createTiddlyElement(this.bodyElem,"div");
	createTiddlyElement(w,"h2",null,null,stepTitle);
	var step = createTiddlyElement(w,"div",null,"wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name) {
	return this.formElem.elements[name];
};
// ---------------------------------------------------------------------------------
// ListView gadget
// ---------------------------------------------------------------------------------

var ListView = {};

// Create a listview
//   place - where in the DOM tree to insert the listview
//   listObject - array of objects to be included in the listview
//   listTemplate - template for the listview
//   callback - callback for a command being selected
//   className - optional classname for the <table> element
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className ? className : "listView");
	var thead = createTiddlyElement(table,"thead");
	var r = createTiddlyElement(thead,"tr");
	for(var t=0; t<listTemplate.columns.length; t++)
		{
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader)
			colType.createHeader(c,columnTemplate,t);
		}
	var tbody = createTiddlyElement(table,"tbody");
	for(var rc=0; rc<listObject.length; rc++)
		{
		rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(var c=0; c<listTemplate.rowClasses.length; c++)
			{
			if(rowObject[listTemplate.rowClasses[c].field])
				addClass(r,listTemplate.rowClasses[c].className);
			}
		rowObject.rowElement = rowObject;
		rowObject.colElements = {};
		for(var cc=0; cc<listTemplate.columns.length; cc++)
			{
			var c = createTiddlyElement(r,"td");
			var columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			var colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem)
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
			rowObject.colElements[field] = c;
			}
		}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	if(callback && listTemplate.buttons)
		{
		for(t=0; t<listTemplate.buttons.length; t++)
			{
			var a = listTemplate.buttons[t];
			if(a && a.name != "")
				createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
			}
		}
	return table;
}

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
	return function(e)
		{
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0 && !allowEmptySelection)
			alert(config.messages.nothingSelected);
		else
			{
			if(this.nodeName.toLowerCase() == "select")
				{
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
				}
			else
				callback(view,name,tiddlers);
			}
		};
}

// Invoke a callback for each selector checkbox in the listview
//   view - <table> element of listView
//   callback(checkboxElement,rowName)
//     where
//       checkboxElement - DOM element of checkbox
//       rowName - name of this row as assigned by the column template
//   result: true if at least one selector was checked
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var hadOne = false;
	for(var t=0; t<checkboxes.length; t++)
		{
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox")
			{
			var rn = cb.getAttribute("rowName");
			if(rn)
				{
				callback(cb,rn);
				hadOne = true;
				}
			}
		}
	return hadOne;
}

ListView.getSelectedRows = function(view)
{
	var rowNames = [];
	ListView.forEachSelector(view,function(e,rowName) {
				if(e.checked)
					rowNames.push(rowName);
				});
	return rowNames;
}

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			var c = columnTemplate.text;
			if(v != undefined)
				createTiddlyText(createExternalLink(place,v),c ? c : v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				{
				for(var t=0; t<v.length; t++)
					{
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
					}
				}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				{
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
				}
		}
};
//--
//-- Augmented methods for the JavaScript Number(), Array(), String() and Date() objects
//--

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return c;
};

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	for(var i=from; i<this.length; i++) {
		if(this[i] === item)
			return i;
	}
	return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	for(var t=0; t<this.length; t++) {
		if(this[t][field] == value)
			return t;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.indexOf(value);
	if(mode == 0)
		mode = (p == -1) ? +1 : -1;
	if(mode == +1) {
		if(p == -1)
			this.push(value);
	} else if(mode == -1) {
		if(p != -1)
			this.splice(p,1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	for(var i=0; i<items.length; i++) {
		if (this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	for (var i = 0; i<items.length; i++) {
		if (this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique != undefined && unique == false) {
		this.push(item);
	} else {
		if(this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
};

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1) {
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1]) {
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
		}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var c = this;
	for(var t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return this.replace(/&amp;/mg,"&").replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"");
};

// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
String.prototype.toJSONString = function()
{
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"' : '\\"',
		'\\': '\\\\'
		};
	var replaceFn = function(a,b) {
		var c = m[b];
		if (c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
		}
	if (/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
	return '"' + this + '"';
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p) {
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try {
				n = match[p+3];
				if(allowEval)
					n = window.eval(n);
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		else if(match[p+5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var params = [];
	do {
		var match = re.exec(this);
		if(match) {
			var n = parseToken(match,1);
			if(noNames) {
				r.push({name:"",value:n});
			} else {
				var v = parseToken(match,8);
				if(v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if(v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if(cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while(match);
	// Summarise parameters into first element
	for(var t=1; t<r.length; t++) {
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function()
{
	var p = this.parseParams("list",null,true,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.pushUnique(p[t].value,unique);
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end) 
{
	var s = this.indexOf(start);
	if(s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if(r)
		return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list) {
		var results = [];
		for(var t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix) 
{
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
	if(!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
	return !!getParam(params,name,defaultValue);
}

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	return t;
};

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000); 
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if (d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4);
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(d.substr(8,2),10),
			parseInt(d.substr(10,2),10),0,0));
};

//--
//-- Crypto functions and associated conversion routines
//--

// Crypto "namespace"
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	var be = Array();
	var len = Math.floor(str.length/4);
	var i, j;
	for(i=0, j=0; i<len; i++, j+=4) {
		be[i] = ((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
	}
	while (j<str.length) {
		be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
		j++;
	}
	return be;
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	var str = "";
	for(var i=0;i<be.length*32;i+=8)
		str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
	return str;
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	var hex = "0123456789ABCDEF";
	var str = "";
	for(var i=0;i<be.length*4;i++)
		str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
	return str;
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return Crypto.be32sToHex(Crypto.sha1Str(str));
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return Crypto.sha1(Crypto.strToBe32s(str),str.length);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	// Add 32-bit integers, wrapping at 32 bits
	add32 = function(a,b)
	{
		var lsw = (a&0xFFFF)+(b&0xFFFF);
		var msw = (a>>16)+(b>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	};
	// Add five 32-bit integers, wrapping at 32 bits
	add32x5 = function(a,b,c,d,e)
	{
		var lsw = (a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
		var msw = (a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
		return (msw<<16)|(lsw&0xFFFF);
	};
	// Bitwise rotate left a 32-bit integer by 1 bit
	rol32 = function(n)
	{
		return (n>>>31)|(n<<1);
	};

	var len = blen*8;
	// Append padding so length in bits is 448 mod 512
	x[len>>5] |= 0x80 << (24-len%32);
	// Append length
	x[((len+64>>9)<<4)+15] = len;
	var w = Array(80);

	var k1 = 0x5A827999;
	var k2 = 0x6ED9EBA1;
	var k3 = 0x8F1BBCDC;
	var k4 = 0xCA62C1D6;

	var h0 = 0x67452301;
	var h1 = 0xEFCDAB89;
	var h2 = 0x98BADCFE;
	var h3 = 0x10325476;
	var h4 = 0xC3D2E1F0;

	for(var i=0;i<x.length;i+=16) {
		var j,t;
		var a = h0;
		var b = h1;
		var c = h2;
		var d = h3;
		var e = h4;
		for(j = 0;j<16;j++) {
			w[j] = x[i+j];
			t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=16;j<20;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),d^(b&(c^d)),w[j],k1);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=20;j<40;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k2);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=40;j<60;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),(b&c)|(d&(b|c)),w[j],k3);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}
		for(j=60;j<80;j++) {
			w[j] = rol32(w[j-3]^w[j-8]^w[j-14]^w[j-16]);
			t = add32x5(e,(a>>>27)|(a<<5),b^c^d,w[j],k4);
			e=d; d=c; c=(b>>>2)|(b<<30); b=a; a = t;
		}

		h0 = add32(h0,a);
		h1 = add32(h1,b);
		h2 = add32(h2,c);
		h3 = add32(h3,d);
		h4 = add32(h4,e);
	}
	return Array(h0,h1,h2,h3,h4);
};

//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0,1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	return "#" + ("0" + Math.floor(this.r.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.g.clamp(0,1) * 255).toString(16)).right(2) +
				 ("0" + Math.floor(this.b.clamp(0,1) * 255).toString(16)).right(2);
};

//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

function drawGradient(place,horiz,colours)
{
	for(var t=0; t<= 100; t+=2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var f = t/100;
		var p = f*(colours.length-1);
		bar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();
	}
}

function createTiddlyText(theParent,theText)
{
	return theParent.appendChild(document.createTextNode(theText));
}

function createTiddlyCheckbox(theParent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	theParent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,theParent);
	return cb;
}

function createTiddlyElement(theParent,theElement,theID,theClass,theText)
{
	var e = document.createElement(theElement);
	if(theClass != null)
		e.className = theClass;
	if(theID != null)
		e.setAttribute("id",theID);
	if(theText != null)
		e.appendChild(document.createTextNode(theText));
	if(theParent != null)
		theParent.appendChild(e);
	return e;
}

function addEvent(obj,type,fn)
{
	if(obj.attachEvent) {
		obj['e'+type+fn] = fn;
		obj[type+fn] = function(){obj['e'+type+fn](window.event);};
		obj.attachEvent('on'+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn)
{
	if(obj.detachEvent) {
		obj.detachEvent('on'+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}

function addClass(e,theClass)
{
	var currClass = e.className.split(" ");
	if(currClass.indexOf(theClass) == -1)
		e.className += " " + theClass;
}

function removeClass(e,theClass)
{
	var currClass = e.className.split(" ");
	var i = currClass.indexOf(theClass);
	while(i != -1) {
		currClass.splice(i,1);
		i = currClass.indexOf(theClass);
	}
	e.className = currClass.join(" ");
}

function hasClass(e,theClass)
{
	if(e.className) {
		if(e.className.split(" ").indexOf(theClass) != -1)
			return true;
	}
	return false;
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name ? name : "tagName";
	relative = relative ? relative : "parentNode";
	if(name == "className") {
		while(e && !hasClass(e,value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if(e.target)
		obj = e.target;
	else if(e.srcElement)
		obj = e.srcElement;
	if(obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	var text = "";
	if(e.innerText)
		text = e.innerText;
	else if(e.textContent)
		text = e.textContent;
	return text;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth()
{
	return window.innerWidth ? window.innerWidth : document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
	return window.innerHeight ? window.innerHeight : document.documentElement.clientHeight;
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return window.scrollX ? window.scrollX : document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
	return window.scrollY ? window.scrollY : document.documentElement.scrollTop;
}

function findPosX(obj)
{
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e != null && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Remove all children of a node
function removeChildren(e)
{
	while(e.hasChildNodes())
		e.removeChild(e.firstChild);
}

// Add a stylesheet, replacing any previous custom stylesheet
function setStylesheet(s,id,doc)
{
	if(!id)
		id = "customStyleSheet";
	if(!doc)
		doc = document;
	var n = doc.getElementById(id);
	if(doc.createStyleSheet) {
		// Test for IE's non-standard createStyleSheet method
		if(n)
			n.parentNode.removeChild(n);
		// This failed without the &nbsp;
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style id='" + id + "'>" + s + "</style>");
	} else {
		if(n) {
			n.replaceChild(doc.createTextNode(s),n.firstChild);
		} else {
			n = doc.createElement("style");
			n.type = "text/css";
			n.id = id;
			n.appendChild(doc.createTextNode(s));
			doc.getElementsByTagName("head")[0].appendChild(n);
		}
	}
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart + 1;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionStart);
		e.setSelectionRange( oldpos, oldpos);
		var linecount = e.value.split('\n').length;
		var thisline = e.value.substr(0,e.selectionStart).split('\n').length-1;
		e.scrollTop = Math.floor((thisline-e.rows/2)*e.scrollHeight/linecount);
	} else if(document.selection) {
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart('character', -text.length);
				range.select();
			}
		}
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = ""; 
	while(e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
	var title = this.getTitle(store,node);
	if(title) {
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store,tiddler,title,node);
		tiddlers.push(tiddler);
	}
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var tiddlers = [];
	for(var t = 0; t < nodes.length; t++) {
		try {
			this.loadTiddler(store,nodes[t],tiddlers);
		} catch(ex) {
			showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
		}
	}
	return tiddlers;
};


function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
	var results = [];
	var tiddlers = store.getTiddlers("title");
	for(var t = 0; t < tiddlers.length; t++)
		results.push(this.externalizeTiddler(store,tiddlers[t]));
	return results.join("\n");
};
//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title");
		if(!title)
			title = node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var lenPrefix = store.idPrefix.length;
		if (node.id.substr(0,lenPrefix) == store.idPrefix)
			title = node.id.substr(lenPrefix);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName!="PRE" && e.nodeName!="pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
	}
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMM(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMM(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var attrs = node.attributes;
	for(var i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if (attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created,fields);
	return tiddler;
};

//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
	try {
		var extendedAttributes = "";
		var usePre = config.usePreForStorage;
		store.forEachField(tiddler,
			function(tiddler,fieldName,value) {
				// don't store stuff from the temp namespace
				if (!fieldName.match(/^temp\./))
					extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
			},true);
		var created = tiddler.created.convertToYYYYMMDDHHMM();
		var modified = tiddler.modified.convertToYYYYMMDDHHMM();
		var vdate = version.date.convertToYYYYMMDDHHMM();
		var attributes = tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
		attributes += (usePre && modified == created) ? "" : ' modified="' + modified +'"';
		attributes += (usePre && created == vdate) ? "" :' created="' + created + '"';
		var tags = tiddler.getTags();
		if(!usePre || tags)
			attributes += ' tags="' + tags.htmlEncode() + '"';
		return '<div %0="%1"%2%3>%4</div>'.format([
				usePre ? "title" : "tiddler",
				tiddler.title.htmlEncode(),
				attributes,
				extendedAttributes,
				usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.escapeLineBreaks().htmlEncode()
			]);
	} catch (ex) {
		throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};

//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output,this.element),this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead,"mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
		var text = lookaheadMatch[1];
		if(config.browser.isIE)
			text = text.replace(/\n/g,"\r");
		createTiddlyElement(w.output,"pre",null,null,text);
		w.nextMatch = lookaheadRegExp.lastIndex;
	}
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br.handler = function(place)
{
	createTiddlyElement(place,"br");
};

// Find an entry in an array. Returns the array index or null
// @Deprecated: Use indexOf instead
Array.prototype.find = function(item)
{
	var i = this.indexOf(item);
	return i == -1 ? null : i;
};

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
	return store.getLoader().internalizeTiddler(store,this,title,divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store,this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement,titles,template,unused1,unused2,animate,slowly)
{
	story.displayTiddlers(srcElement,titles,template,animate,slowly);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement,title,template,unused1,unused2,animate,slowly)
{
	story.displayTiddler(srcElement,title,template,animate,slowly);
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");
// ---------------------------------------------------------------------------------
// End of scripts
// ---------------------------------------------------------------------------------
//]]>
</script>
<style type="text/css">

#saveTest {display:none;}

.zoomer {display:none;}

#messageArea {display:none;}

#copyright {display:none;}

.popup {position:absolute;}

#storeArea {display:none; margin:4em 10em 3em;}

#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}

#shadowArea {display:none;}

#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}

</style>
<!--POST-HEAD-START-->
<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.checkUnsavedChanges) checkUnsavedChanges();">
<!--PRE-BODY-START-->
<!--PRE-BODY-END-->
<script type="text/javascript">
//<![CDATA[
if (useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<div id="copyright">
Welcome to TiddlyWiki by Jeremy Ruston, Copyright &copy; 2007 Osmosoft Limited
</div>
<noscript>
	<div id="javascriptWarning">This page requires JavaScript to function properly.<br><br>If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstage">
	<div id="backstageTabs"></div>
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5 {color:[[ColorPalette::SecondaryDark]]; background:[[ColorPalette::PrimaryPale]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected{color:[[ColorPalette::PrimaryDark]];
	background:[[ColorPalette::TertiaryPale]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::TertiaryDark]]; border-top:1px solid [[ColorPalette::Foreground]];
	border-bottom:1px solid [[ColorPalette::Foreground]]; border-left:1px solid [[ColorPalette::Foreground]];}
.wizard h1 {color:[[ColorPalette::Foreground]];}
.wizard h2 {color:[[ColorPalette::Background]];}
.wizardStep {background:[[ColorPalette::TertiaryLight]]; color:[[ColorPalette::Foreground]];
	border-top:1px solid [[ColorPalette::Foreground]];
	border-bottom:1px solid [[ColorPalette::Foreground]]; border-left:1px solid [[ColorPalette::Foreground]];}
.wizardFooter {background:[[ColorPalette::TertiaryDark]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryMid]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryLight]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryLight]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryLight]] [[ColorPalette::SecondaryLight]] [[ColorPalette::SecondaryDark]];}

#messageArea {border:1px solid [[ColorPalette::SecondaryDark]]; background:[[ColorPalette::SecondaryMid]]; color:[[ColorPalette::PrimaryDark]];}
#messageArea .button {padding:0.2em 0.2em 0.2em 0.2em; color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::Background]];}

.popup {background:[[ColorPalette::PrimaryLight]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}

.listBreak div {border-bottom:1px solid [[ColorPalette::PrimaryDark]];}

.popup li.disabled {color:[[ColorPalette::PrimaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::TertiaryPale]]; border:none;}
.popup li a:hover {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]]; border:none;}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.sparkline {background:[[ColorPalette::PrimaryPale]]; border:0;}
.sparktick {background:[[ColorPalette::PrimaryDark]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}

.cascade {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryMid]]; border:1px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

table {border:2px solid [[ColorPalette::TertiaryDark]];}
th, thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
td, tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}

.backstageSelTab {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]];}
#backstagePanel {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Background]]; opacity:0.5; filter:'alpha(opacity:50)';}
/*}}}*/</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5 {font-weight:bold; text-decoration:none; padding-left:0.4em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
	#mainMenu .tiddlyLinkNonExisting,
	#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0em 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0em 1em 1em; left:0px; top:0px;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0em 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 .3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 0em 0em 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0em 0em 0em 0em; margin:0.4em 0em 0.2em 0em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0em 0em 0em; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0em;}
.wizard .button {padding:0.1em 0.2em 0.1em 0.2em;}

#messageArea {position:absolute; top:2em; right:0; margin:0.5em; padding:0.5em; z-index:200;}
*[id='messageArea'] {position:fixed !important; z-index:200;}
.messageToolbar {display:block; text-align:right;}
#messageArea a {text-decoration:underline;}

.popup {z-index:100; font-size:.9em; padding:0.2em; list-style:none; margin:0;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0em;}

.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.popup li.disabled {padding:0.2em;}
.popup li a {display:block; padding:0.2em;}

.tabset {padding:1em 0em 0em 0.5em;}
.tab {margin:0em 0em 0em 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#displayArea {margin:1em 17em 0em 14em;}

.toolbar {text-align:right; font-size:.9em; visibility:hidden;}
.selected .toolbar {visibility:visible;}

.tiddler {padding:1em 1em 0em 1em;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0em 0.25em; padding:0em 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

table {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0px 3px 0px 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0em; font-size:.9em;}
.editorFooter .button {padding-top:0px; padding-bottom:0px;}

.fieldsetFix {border:0; padding:0; margin:1px 0px 1px 0px;}

.sparkline {line-height:1em;}
.sparktick {outline:0;}

.zoomer {font-size:1.1em; position:absolute; padding:1em;}

.cascade {font-size:1.1em; position:absolute; overflow:hidden;}

#backstage {position:absolute; z-index:100; width:100%;}
#backstageTabs {visibility:hidden; position:relative; margin:0.5em 3em 0.2em 3em; font-size:1.1em; background:none; text-align:right;}
#backstageTabs a {font-weight:bold; padding:0.2em 0.5em 0.2em 0.5em;}
#backstagePanel {display:none; position:relative; margin:0em 3em 0em 3em; padding:1em 1em 1em 1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em 0.2em 0.4em;}
#backstageCloak {display:none; z-index:50; position:absolute; width:100%; height:100px;}
/*}}}*/</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which use a logographic writing system and need larger font sizes.
***/

/*{{{*/
body {font-size:0.8em;}

#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}

.subtitle {font-size:0.8em;}

.viewer table.listView {font-size:0.95em;}

.htmlarea .toolbarHA table {border:1px solid ButtonFace; margin:0em 0em;}
/*}}}*/</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar {display: none ! important;}
#displayArea {margin: 1em 1em 0em 1em;}
/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
noscript {display:none;}
}
/*}}}*/</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:
* SiteTitle &amp; SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* MainMenu: The menu (usually on the left)
* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;</pre>
</div>
<div title="OptionsPanel">
<pre>These InterfaceOptions for customising TiddlyWiki are saved in your browser

Your username for signing your edits. Write it as a WikiWord (eg JoeBloggs)

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; SaveBackups
&lt;&lt;option chkAutoSave&gt;&gt; AutoSave
&lt;&lt;option chkRegExpSearch&gt;&gt; RegExpSearch
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; CaseSensitiveSearch
&lt;&lt;option chkAnimate&gt;&gt; EnableAnimations

----
Also see AdvancedOptions</pre>
</div>
<div title="AdvancedOptions">
<pre>&lt;&lt;option chkGenerateAnRssFeed&gt;&gt; GenerateAnRssFeed
&lt;&lt;option chkOpenInNewWindow&gt;&gt; OpenLinksInNewWindow
&lt;&lt;option chkSaveEmptyTemplate&gt;&gt; SaveEmptyTemplate
&lt;&lt;option chkToggleLinks&gt;&gt; Clicking on links to tiddlers that are already open causes them to close
^^(override with Control or other modifier key)^^
&lt;&lt;option chkHttpReadOnly&gt;&gt; HideEditingFeatures when viewed over HTTP
&lt;&lt;option chkForceMinorUpdate&gt;&gt; Treat edits as MinorChanges by preserving date and time
^^(override with Shift key when clicking 'done' or by pressing Ctrl-Shift-Enter^^
&lt;&lt;option chkConfirmDelete&gt;&gt; ConfirmBeforeDeleting
Maximum number of lines in a tiddler edit box: &lt;&lt;option txtMaxEditRows&gt;&gt;
Folder name for backup files: &lt;&lt;option txtBackupFolder&gt;&gt;
&lt;&lt;option chkInsertTabs&gt;&gt; Use tab key to insert tab characters instead of jumping to next field
&lt;&lt;option txtFileSystemCharSet&gt;&gt; Character set to use for saving (Firefox/Mozilla only)</pre>
</div>
</div>
<div id="storeArea">
<div title="MD4" modifier="www.wikipedia.org" server.host="www.wikipedia.org" wikiformat="MediaWiki">
<pre>Click on &quot;download&quot; to get the full text of the wikipedia article about MD4

'''MD4''' is a message digest [[algorithm]] (the fourth in a series) designed by Professor [[Ronald Rivest]] of [[Massachusetts Institute of Technology|MIT]] in 1990. It implements a [[cryptographic hash function]] for use in message integrity checks. The digest length is 128 bits. The algorithm has influenced later designs, such as the [[MD5]], [[SHA]] and [[RIPEMD]] algorithms.</pre>
</div>
<div title="Wikipedia:Sandbox" created="www.wikipedia.org" server.host="www.wikipedia.org" server.wikiformat="MediaWiki">
<pre>Click on &quot;download&quot; to get the current contents of the wikipedia Sandbox</pre>
</div>
<div title="SandBox29" modified="200612161930" server.host="twiki.org" downloaded="200612161930" wikiformat="TWiki" server.workspace="Sandbox">
<pre>Click on &quot;download&quot; to get the current contents of TWiki SandBox29</pre>
</div>
<div title="TWikiSuccessStoryOfBritishTelecommunications" created="200612161930" server.host="twiki.org" downloaded="200612161930" wikiformat="TWiki" server.workspace="Main">
<pre>Since the summer of 2002 we have actively been using TWiki within our development and design areas. Recently this spawned another TWiki for one of the major Lines of Business who are now using the TWiki to manage their CIO Architecture and Design assurance processes and documentation.

Within the Development Area we now have about 40-50 active users with 92 registered users (as at May 2003).  This all started with one project using it for their own project management from daily washup reports to general operational documentation.  During presentations about this project, the use of the TWiki helping development was always promoted and where possible demonstrated.  The results speak for themselves.  We now have quite a list of projects using it.  In my own area of XML interfaces we have used it to implement a change control mechanism (similar to the TWiki Support Web) which is light weight yet highly efficient.

The Development TWik is still on the Dec 2001 release on Windows with Cygwin using the Koala Skin, which has been great to give a highly professional look and give ease of management to the various projects.  Projects generallly begin within a Project Web and we migrate them to a Web when they become large enough to need the space.

The Line of Business TWiki is on Linux still running the Dec 2001 version.

Recently we have launched along with others in the industry a public web site for managing the interface between the various companies within the industry.  The [[http://www.telcob2b.org.uk][Telco B2B]] Web site is now able to be managed by the members directly rather than one party as before.  It is hoped that this will not only help the management of the web site but also encourage participation from more parties.

TWiki has been introduced from the ground roots up and the response has been extremely positive.  We have had times when the openess of the TWiki has been questioned, but with only a few exceptions we have managed to pursude most users that it is safe to use.  The ability to show old versions of documents is crucial.  Within the company we have other tools for document management yet the Twiki ability to be used by anyone for anything has proved very persuasive.

We are looking forward to its continued success and feel confident that the support we receive from the TWiki community is part of the success.  Thanks.

-- Main.MartinRoberts - 19 May 2003

---+++ Update 2005

Recently there has been a push to use Livelink for major documentation, however this has been conteracted by the encouragement to use Wiki technology more as the company embraces Agile methods.  This is good news as it is finally acknowledging that there is a role for both Document Repositories and Collaborative Web environments. 

-- Main.MartinRoberts - 09 Sep 2005

---+++ Further Update 2005

Also been using it informally to document our research activities and more formally to publish external websites such as the [[http://labs.bt.com/ftg/][Future Technologies Group]] website (using Plugins.PublishAddOn) since June 2003. 53 registered users.

Since that original installation, a newer May 2005 formally managed and hosted service has been launched to serve the whole of [[http://labs.bt.com/][BT Labs]].

-- Main.CefnHoile 17 Oct 2005</pre>
</div>
<div title="TWikiSuccessStoryOfCmed" created="200612161930" server.host="twiki.org" downloaded="200612161930" wikiformat="TWiki" server.workspace="Main">
<pre>The technology arm of Cmed Ltd started using TWiki to record
discussions at the beginning of 2003. This quickly evolved into the
place to record our (formalised) http://www.extremeprogramming.org
stories, although for over a year we maintained physical story cards
alongside TWiki pages.

Halfway through 2003 Cmed adopted TWiki as its company
intranet. Although there was a little initial reluctance from people
unfamiliar with an open environment, using TWiki in this way has been
a complete sucesss.

Most recently Cmed has used TWiki to place all of its Standard
Operating Procedures and Working Practices (SOPs and WPs)
online. Judicious use of &lt;nop&gt;%INCLUDE directives, restricted write
access, and compulsary login (no guest account), has enabled us to
separate authorship from publication and keep logs of readership.

Cmed works in the pharmaceutical industry; we run clinical trials and
develop new technology. This is a heavily regulated environment, which
means we undergo client audits. In every case, auditors have been
extremely impressed by our use of TWiki.

Use of TWiki at Cmed has:

   * significantly reduced reliance upon unmaintained rambling file shares;
   * introduced and enforced document versioning to the whole company
     (not just the technologists);
   * improved communication and increased the quantity (and through
     peer review, the quality) of documentation;
   * removed the use of paper for formal SOPs and WPs without
     compromising the necessary controls demanded by a regulated
     industry;
   * created a more collaborative and friendly environment,
     e.g. through the organisation of social events.

About a third of the company use Linux on the Desktop (with the rest
using Windows). Successful adoption of a platform-neutral
documentation system knocks down another hurdle on the track to
company-wide adoption of Linux.


-- Main.TimothyCorbettClark - 02 Sep 2004</pre>
</div>
<div title="socialtext_2_0_preview" server.host="www.eu.socialtext.net" wikiformat="Socialtext" server.workspace="st-rest-docs">
<pre>Click on &quot;download&quot; to get the current contents of the Socialtext 2.0 Preview page</pre>
</div>
<div title="workspace" server.host="www.eu.socialtext.net" wikiformat="Socialtext" server.workspace="st-rest-docs">
<pre>Click on &quot;download&quot; to get the current contents of the Socialtext workspace definition page</pre>
</div>
<div title="About" server.host="www.jspwiki.org" wikiformat="JSPWiki">
<pre>Click on &quot;download&quot; to get the current contents of the JSPWiki &quot;About&quot; page</pre>
</div>
<div title="ZiddlyWiki" server.host="www.ziddlywiki.com" server.type="ZiddlyWiki">
<pre>Click on &quot;download&quot; to get the full text of this tiddler
[[TiddlyWikiDev]]</pre>
</div>
<div title="HowTo" server.host="cctiddly.sourceforge.net" server.type="cctiddly">
<pre>Click on &quot;download&quot; to get the full text of this tiddler</pre>
</div>
<div title="Home" server.host="confluence.atlassian.com" wikiformat="confluence" server.workspace="TEST">
<pre>Click on &quot;download&quot; to get the current contents of the Confluence TEST &quot;Home&quot; page</pre>
</div>
<div title="MainMenu" tags="excludeLists">
<pre>[[Home]]</pre>
</div>
<div title="StyleSheet" modifier="MartinBudden" tags="styles">
<pre>/***
Place your custom CSS here
***/
[[Styles HorizontalMainMenu]]
/*{{{*/
.header {background:#007766;}
#topMenu {background:#007777;}
/*}}}*/</pre>
</div>
<div title="DefaultTiddlers" tags="excludeLists">
<pre>[[Home]][[MD4]][[ZiddlyWiki]][[HowTo]]</pre>
</div>
<div title="Home">
<pre>[[Wikipedia:Sandbox]]
[[Wikipedia MD4|MD4]]

[[TWiki Sandbox|SandBox29]]
[[TWikiSuccessStoryOfBritishTelecommunications]]

[[socialtext_2_0_preview]]
[[Socialtext workspace definition|workspace]]

[[JSPWiki About|About]]

[[ZiddlyWiki]]

[[ccTiddly HowTo|HowTo]]</pre>
</div>
<div title="SiteSubtitle" tags="excludeLists">
<pre>- test code</pre>
</div>
<div title="SiteTitle" tags="excludeLists">
<pre>Test remotely hosted tiddlers</pre>
</div>
<div tiddler="settings" modifier="MartinBudden" modified="200607300000" created="200607300000" tags="systemConfig excludeLists">/***\n|''Name:''|settings|\n|''Description:''|set preferences|\n|''~CoreVersion:''|2.1.0|\n***/\n\n/*{{{*/\nconfig.views.editor.defaultText = '';\nconfig.options.chkAnimate = false;\nconfig.options.chkSaveBackups = false;\nconfig.options.chkAutoSave = false;\nconfig.options.txtBackupFolder = &quot;backup&quot;,\nconfig.options.txtMaxEditRows = 20;\n\nconfig.options.chkDisableWikiLinks = true;\n\nconfig.usePreForStorage = true;\n\nconfig.displayStartupTime = true;\nconfig.options.chkSinglePageMode = false;\nconfig.options.chkTopOfPageMode = false;\n/*}}}*/\n</div>
<div title="OptionsPanel" tags="excludeLists">
<pre>These ~InterfaceOptions for customising ~TiddlyWiki are saved in your browser

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; ~SaveBackups
&lt;&lt;option chkAutoSave&gt;&gt; ~AutoSave
&lt;&lt;option chkRegExpSearch&gt;&gt; ~RegExpSearch
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; ~CaseSensitiveSearch
----
AdvancedOptions
PluginManager
ImportTiddlers</pre>
</div>
<div title="PageTemplate" tags="excludeLists">
<pre>&lt;div class='header'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;div id='topMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;

&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;

&lt;div id='displayArea'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;</pre>
</div>
<div title="SideBarOptions" tags="excludeLists">
<pre>&lt;&lt;search&gt;&gt;&lt;&lt;closeAll&gt;&gt;&lt;&lt;permaview&gt;&gt;&lt;&lt;newTiddler &quot;New Tiddler&quot; MediaWikiFormat&gt;&gt;&lt;&lt;saveChanges&gt;&gt;&lt;&lt;slider chkSliderOptionsPanel OptionsPanel &quot;options Â»&quot; &quot;Change TiddlyWiki advanced options&quot;&gt;&gt;</pre>
</div>
<div title="SideBarTabs" tags="excludeLists">
<pre>&lt;&lt;tabs txtMainTab &quot;Articles&quot; &quot;All articles&quot; TabAll &quot;Tags&quot; &quot;All tags&quot; TabTags &quot;More&quot; &quot;More lists&quot; TabMore&gt;&gt;</pre>
</div>
<div title="StyleSheet" tags="styles excludeLists">
<pre>/***
Place your custom CSS here.
See http://www.w3schools.com/css/css_colors.asp for a color chart.
***/
[[Styles HorizontalMainMenu]]
[[wikipediaStyle]]
[[wikipediaAbridged/Skins-1.5.monobook/main.css]]
[[wikipedia.MediaWiki.Common.css]]
/*{{{*/
.header {background:#007766;}
#topMenu {background:#007777;}
/*}}}*/</pre>
</div>
<div title="TabMore" tags="excludeLists">
<pre>&lt;&lt;tabs txtMoreTab &quot;Updated&quot; &quot;Updated off line&quot; TabUpdated &quot;Shadowed&quot; &quot;Shadowed tiddlers&quot; TabMoreShadowed&gt;&gt;</pre>
</div>
<div title="TabTags" tags="excludeLists">
<pre>&lt;&lt;allTags excludeLists&gt;&gt;</pre>
</div>
<div title="TabTemplates" tags="excludeLists">
<pre>&lt;&lt;list templates&gt;&gt;</pre>
</div>
<div title="TabUpdated" tags="excludeLists">
<pre>&lt;&lt;list updatedOffline&gt;&gt;</pre>
</div>
<div tiddler="Tiddlypedia" modifier="MartinBudden" created="200608120000" tags="">This is an example [[Tiddlypedia]] - a collection of articles gathered into a [[TiddlyWiki|http://www.tiddlywiki.com/]].</div>
<div title="ViewTemplate" tags="excludeLists">
<pre>&lt;div class='toolbar' macro='toolbar download upload -closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='viewTiddlerFields'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='toolbar' macro='toolbar -closeTiddler closeOthers +editTiddler'&gt;&lt;/div&gt;</pre>
</div>
<div title="EditTemplate" tags="excludeLists">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='viewTiddlerFields'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="Styles HorizontalMainMenu" modifier="MartinBudden" tags="styles excludeLists">
<pre>/***
Copied from: [[tiddlywikitips.com|http://tiddlywikitips.com/#%5B%5BStyles%20HorizontalMainMenu%5D%5D]]
To use, add {{{[[Styles HorizontalMainMenu]]}}} to your StyleSheet tiddler.
You must also copy the contents of [[PageTemplate HorizontalMenu]] to PageTemplate.
See http://www.w3schools.com/css/css_colors.asp for a color chart.
***/
/*{{{*/
.header {background:#330099;}
.headerShadow {padding:.5em 0em .5em 1em;}
.headerForeground {padding:.5em 0em .5em 1em;}

.header {background:darkblue;}
.headerShadow {color:white;}

/*#displayArea {margin:1em 15.7em 0em 1em;}*/
/* The bit that contains all tiddlers */
#displayArea {
/* background-color:#eef;*/
	margin-top:0;margin-right:15.5em;margin-bottom:0;margin-left:1em;
	padding-top:.1em;padding-bottom:.1em;
	-moz-border-radius:1em;
}

/* Tiddler title */
.title {color:black;border-bottom:2px solid #ddd;}
/* Tiddler subtitle */
.subtitle {font-size:0.9em;text-align:right;border-bottom:1px solid #ddd;}
.toolbar {padding-top:0px;padding-bottom:0px;color:#04b;}
/* Tiddler body */
.tiddler {-moz-border-radius:1em;border:1px solid #ccc;margin:0.5em;background:#fff;padding:0.5em;}


#topMenu br {display:none;}
#topMenu {background:#336699;}
#topMenu {padding:2px;}
#topMenu .button, #topMenu .tiddlyLink {padding-left:1em;padding-right:1em;color:white;font-size:115%;}

/* just in case want some QuickOpenTags in your topMenu */
#topMenu .quickopentag {padding:0px;margin:0px;border:0px;}
#topMenu .quickopentag .tiddlyLink {padding-right:1px;}
#topMenu .quickopentag .button {padding-left:1px;border:0px;}

@media print {#topMenu {display:none ! important;}}
/*}}}*/</pre>
</div>
<div tiddler="@ToCorePlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|ToCore|\n|''Description:''|Candidates for moving into TiddlyWiki core|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|None|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/experimental/ToCore.js|\n|''Version:''|0.1.2|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n***/\n\n//{{{\n// Ensure that the plugin is only installed once.\nif(!version.extensions.ToCore) {\nversion.extensions.ToCore = {installed:true};\n\nconfig.macros.list.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n	var type = params[0] ? params[0] : &quot;all&quot;;\n	var theList = document.createElement(&quot;ul&quot;);\n	place.appendChild(theList);\n	if(this[type].prompt)\n		createTiddlyElement(theList,&quot;li&quot;,null,&quot;listTitle&quot;,this[type].prompt);\n	var results;\n	if(this[type].handler)\n		results = this[type].handler(params,wikifier,paramString,tiddler);\n	for(var t = 0; t &lt; results.length; t++) {\n		var theListItem = document.createElement(&quot;li&quot;);\n		theList.appendChild(theListItem);\n		var title = typeof results[t] == &quot;string&quot; ? results[t] : results[t].title;\n		createTiddlyLink(theListItem,title,true,null,false,tiddler);\n	}\n};\n\nfunction onClickTiddlerLink(e)\n{\n	if (!e) e = window.event;\n	var theTarget = resolveTarget(e);\n	var theLink = theTarget;\n	var title = null;\n	var fields = null;\n	do {\n		title = theLink.getAttribute(&quot;tiddlyLink&quot;);\n		fields = theLink.getAttribute(&quot;tiddlyFields&quot;);\n		theLink = theLink.parentNode;\n	} while(title == null &amp;&amp; theLink != null);\n	if(!fields)\n		fields = store.getDefaultCustomFields();\n	if(title) {\n		var toggling = e.metaKey || e.ctrlKey;\n		if(config.options.chkToggleLinks)\n			toggling = !toggling;\n		var opening;\n		if(toggling &amp;&amp; document.getElementById(&quot;tiddler&quot; + title)) {\n			story.closeTiddler(title,true,e.shiftKey || e.altKey);\n		} else {\n			story.displayTiddler(theTarget,title,null,true,e.shiftKey || e.altKey,fields);\n			if(fields) {\n				var tiddlerElem = document.getElementById(story.idPrefix + title);\n				tiddlerElem.setAttribute(&quot;tiddlyFields&quot;,fields);\n				if(!store.tiddlerExists(title))\n					store.getMissingTiddler(title,convertCustomFieldsToHash(fields));\n			}\n		}\n	}\n	clearMessage();\n	return false;\n}\n\n// function redirectors\nconfig.hostFunctions = {\n	getTiddler: {},\n	getTiddlerList: {},\n	getTiddlerRevisionList: {},\n	getTiddlerRevision: {},\n	getWorkspace: {},\n	putTiddler: {},\n	lockTiddler: {},\n	unlockTiddler: {}\n};\n\nTiddlyWiki.prototype.setDefaultCustomFields = function(fields)\n{\n	this.defaultCustomFields = fields;\n};\n\nTiddlyWiki.prototype.getDefaultCustomFields = function()\n{\n	return this.defaultCustomFields;\n};\n\nTiddlyWiki.prototype.getServerType = function(fields)\n{\n	if(!fields)\n		return null;\n	var serverType = fields['server.type'];\n	if(!serverType)\n		serverType = fields['wikiformat'];\n	return serverType ? serverType.toLowerCase() : null;\n};\n\nTiddlyWiki.prototype.getMissingTiddler = function(title,fields)\n{\n	if(!fields)\n		return false;\n	if(!fields['server.host'])\n		return false;\n	var serverType = this.getServerType(fields);\n	if(!serverType)\n		return false;\n	var fn = config.hostFunctions.getTiddler[serverType];\n	if(fn) {\n		var params = {};\n		params.serverHost = fields['server.host'];\n		params.serverWorkspace = fields['server.workspace'];\n		fn(title,params);\n	}\n	return true;\n};\n\nTiddlyWiki.prototype.getHostedTiddler = function(title,params)\n{\n	var tiddler = this.fetchTiddler(title);\n	if(tiddler) {\n		var fields = tiddler.fields;\n		var serverType = tiddler.getServerType();\n	} else {\n		fields = convertCustomFieldsToHash(document.getElementById(story.idPrefix + title).getAttribute(&quot;tiddlyFields&quot;));\n		serverType = this.getServerType(fields);\n	}\n	if(!serverType)\n		return false;\n	var fn = config.hostFunctions.getTiddler[serverType];\n	if(fn) {\n		if(!params)\n			params = {};\n		params.title = title;\n		params.serverHost = fields['server.host'];\n		params.serverWorkspace = fields['server.workspace'];\n		fn(title,params);\n		return true;\n	}\n	return false;\n};\n\nTiddlyWiki.prototype.putHostedTiddler = function(title,params)\n{\n	var tiddler = this.fetchTiddler(title);\n	if(!tiddler)\n		return false;\n	var serverType = tiddler.getServerType();\n	if(!serverType)\n		return false;\n	var fn = config.hostFunctions.putTiddler[serverType];\n	if(fn) {\n		if(!params)\n			params = {};\n		params.title = title;\n		params.serverHost = fields['server.host'];\n		params.serverWorkspace = fields['server.workspace'];\n		fn(title,params);\n		return true;\n	}\n	return false;\n};\n\nTiddler.prototype.getServerType = function()\n{\n	var serverType = this.fields['server.type'];\n	if(!serverType)\n		serverType = this.fields['wikiformat'];\n	for(i in config.parsers) {\n		var format = config.parsers[i].format;\n		if(this.isTagged(format+'Format')) {\n			serverType = format;\n			break;\n		}\n	}\n	return serverType ? serverType.toLowerCase() : null;\n};\n\nTiddler.prototype.getRevisionList = function(params)\n{\n	var serverType = this.getServerType();\n	if(!serverType)\n		return false;\n	var fn = config.hostFunctions.getTiddlerRevisionList[serverType];\n	if(fn) {\n		if(!params)\n			params = {};\n		params.title = this.title;\n		params.serverHost = this.fields['server.host'];\n		params.serverWorkspace = this.fields['server.workspace'];\n		fn(this.title,params);\n	}\n	return true;\n};\n\n} // end of 'install only once'\n//}}}\n\n</div>
<div tiddler="HostedCommandsPlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|HostedCommandsPlugin|\n|''Description:''|Commands to access hosted TiddlyWiki data|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/martinsprereleases.html#HostedCommandsPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/experimental/HostedCommandsPlugin.js|\n|''Version:''|0.1.2|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n\n|''Enable download article on click empty link''|&lt;&lt;option chkDownloadEmptyArticle&gt;&gt;|\n\n////{{{&lt;&lt;tiddler HostedCommandsPluginDocumentation&gt;&gt;}}}\n\n***/\n\n//{{{\n// Ensure that the plugin is only installed once.\nif(!version.extensions.HostedCommandsPlugin) {\nversion.extensions.HostedCommandsPlugin = {installed:true};\n\n// params.wikiformat\n// params.serverHost\n// params.serverType\n// params.serverWorkspace\n// params.serverPageId\n// params.serverPageName\n// params.serverPageRevision\n// params.token\n\nTiddler.prototype.isFunctionSupported = function(fnName)\n{\n	if(!this.fields['server.host'])\n		return false;\n	var serverType = this.getServerType();\n	if(!serverType)\n		return false;\n	if(config.hostFunctions[fnName][serverType]) {\n		return true;\n	}\n	return false;\n};\n\nTiddler.prototype.updateFieldsAndContent = function(params,content)\n{\n	if(content)\n		this.text = content;\n	if(params.wikiformat)\n		this.fields['wikiformat'] = params.wikiformat;\n	this.fields['server.host'] = params.serverHost;\n	if(params.serverType)\n		this.fields['server.type'] = params.serverType;\n	if(params.serverWorkspace)\n		this.fields['server.workspace'] = params.serverWorkspace;\n	if(params.serverPageId)\n		this.fields['server.page.id'] = params.serverPageId;\n	if(params.serverPageName)\n		this.fields['server.page.name'] = params.serverPageName;\n	if(params.serverPageRevision)\n		this.fields['server.page.revision'] = params.serverPageRevision;\n	var downloaded = new Date();\n	this.created = params.created ? params.created : downloaded;\n	this.modified = params.modified ? params.modified : this.created;\n	this.modifier = params.modifier ? params.modifier : params.serverHost;\n	if(params.tags)\n		tiddler.tags = params.tags;\n	this.fields['downloaded'] = downloaded.convertToYYYYMMDDHHMM();\n	this.fields['changecount'] = -1;\n	store.saveTiddler(this.title,this.title,this.text,this.modifier,this.modified,this.tags,this.fields);\n	if(config.options.chkAutoSave)\n		saveChanges();\n};\n\n/*TiddlyWiki.prototype.updateStory = function(tiddler)\n{\n	this.saveTiddler(tiddler.title,tiddler.title,tiddler.text,tiddler.modifier,tiddler.modified,tiddler.tags,tiddler.fields);\n	if(config.options.chkAutoSave) {\n		saveChanges();\n	}\n};*/\n\nTiddlyWiki.prototype.updatedOffline = function()\n{\n	var results = [];\n	this.forEachTiddler(function(title,tiddler) {\n		if(tiddler.fields['server.host'] &amp;&amp; tiddler.isTouched())\n			results.push(tiddler);\n		});\n	results.sort();\n	return results;\n};\n\nconfig.macros.list.updatedOffline = {};\nconfig.macros.list.updatedOffline.handler = function(params)\n{\n	return store.updatedOffline();\n};\n\nconfig.macros.viewTiddlerFields = {};\nconfig.macros.viewTiddlerFields.handler = function(place,macroName,params,wikifier,paramString,tiddler)\n{\n	if(tiddler instanceof Tiddler) {\n		var value = '';\n		var comma = '';\n		for(i in tiddler.fields) {\n			value += comma + i + '=' + tiddler.fields[i];\n			comma = ', ';\n		}\n		value += comma + 'created=' + tiddler.created.convertToYYYYMMDDHHMM();\n		comma = ', ';\n		value += comma+ 'modified=' + tiddler.modified.convertToYYYYMMDDHHMM();\n		highlightify(value,place,highlightHack,tiddler);\n	}\n};\n\n// download command definition\nconfig.commands.download = {};\nmerge(config.commands.download,{\n	text: &quot;download&quot;,\n	tooltip:&quot;Download this tiddler&quot;,\n	readOnlyText: &quot;download&quot;,\n	readOnlyTooltip: &quot;Download this tiddler&quot;}\n);\n\nconfig.commands.download.isEnabled = function(tiddler)\n{\n	return tiddler.isFunctionSupported('getTiddler',tiddler);\n};\n\nconfig.commands.download.handler = function(event,src,title)\n{\n	store.getHostedTiddler(title);\n};\n\n// upload command definition\nconfig.commands.upload = {};\nmerge(config.commands.upload,{\n	text: &quot;upload&quot;,\n	tooltip: &quot;Upload this tiddler&quot;,\n	uploaded: &quot;uploaded&quot;,\n	readOnlyText: &quot;upload&quot;,\n	readOnlyTooltip: &quot;Upload this tiddler&quot;});\n\nconfig.commands.upload.isEnabled = function(tiddler)\n{\n	return tiddler &amp;&amp; tiddler.isTouched() &amp;&amp; tiddler.isFunctionSupported('putTiddler');\n};\n\nconfig.commands.upload.handler = function(event,src,title)\n{\n	var params = {server:{}};\n	params.title = title;\n	params.callback = config.commands.upload.callback;\n	store.putHostedTiddler(title,params);\n};\n\nconfig.commands.upload.callback = function(params)\n{\n	displayMessage(config.commands.upload.uploaded);\n};\n\n// revisions command definition\nconfig.commands.revisions = {};\nmerge(config.commands.revisions,{\n	text: &quot;revisions&quot;,\n	tooltip: &quot;View another revision of this tiddler&quot;,\n	loading: &quot;loading...&quot;,\n	revisionTooltip: &quot;View this revision&quot;,\n	popupNone: &quot;No revisions&quot;});\n\nconfig.commands.revisions.isEnabled = function(tiddler)\n{\n	return tiddler.isFunctionSupported('getTiddlerRevisionList');\n};\n\nconfig.commands.revisions.handler = function(event,src,title)\n{\n	var params = {server:{}};\n	params.title = title;\n	params.callback = config.commands.revisions.callback;\n	params.popup = Popup.create(src);\n	Popup.show(params.popup,false);\n	var tiddler = store.fetchTiddler(title);\n	tiddler.getRevisionList(title,params);\n	event.cancelBubble = true;\n	if(event.stopPropagation)\n		event.stopPropagation();\n	return true;\n};\n\nconfig.commands.revisions.callback = function(params)\n// The revisions are returned in the params.revisions array\n{\n	if(params.popup) {\n		if(params.revisions.length==0) {\n			createTiddlyText(createTiddlyElement(params.popup,'li',null,'disabled'),config.commands.revisions.popupNone);\n		} else {\n			for(var i=0; i&lt;params.revisions.length; i++) {\n				var modified = params.revisions[i].modified;\n				var key = params.revisions[i].key;\n				var btn = createTiddlyButton(createTiddlyElement(params.popup,'li'),\n						modified.toLocaleString(),\n						config.commands.revisions.revisionTooltip,\n						function() {\n							displayTiddlerRevision(this.getAttribute('tiddlerTitle'),this.getAttribute('revisionKey'),this);\n							return false;\n							},\n						'tiddlyLinkExisting tiddlyLink');\n				btn.setAttribute('tiddlerTitle',params.title);\n				btn.setAttribute('revisionKey',key);\n				var tiddler = store.fetchTiddler(params.title);\n				if(tiddler.revisionKey == key || (!tiddler.revisionKey &amp;&amp; i==0))\n					btn.className = 'revisionCurrent';\n			}\n		}\n	}\n};\n\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="JSPWikiFormatterPlugin" modifier="MartinBudden" modified="200612220000" created="200612220000" tags="systemConfig excludeLists">/***\n|''Name:''|JSPWikiFormatterPlugin|\n|''Description:''|Allows Tiddlers to use [[JSPWiki|http://www.jspwiki.org/wiki/TextFormattingRules]] text formatting|\n|''Author:''|MartinBudden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/prereleases.html#JSPWikiFormatterPlugin|\n|''Subversion:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins|\n|''Version:''|0.0.2|\n|''Date:''|Dec 28, 2006|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.1.0|\n\n|''Display unsupported macros''|&lt;&lt;option chkJSPWikiFormatterDisplayUnsupportedMacros&gt;&gt;|\n\nThis is an early release of the JSPWikiFormatterPlugin, which allows you to insert JSPWiki formated text into\na TiddlyWiki.\n\nThe aim is not to fully emulate JSPWiki, but to allow you to create JSPWiki content off-line and then paste\nthe content into your JSPWiki later on, with the expectation that only minor edits will be required.\n\nTo use JSPWiki format in a Tiddler, tag the Tiddler with JSPWikiFormat. See [[testJSPWikiFormat]] for an example.\n\nPlease report any defects you find at http://groups.google.co.uk/group/TiddlyWikiDev\n***/\n\n//{{{\n// Ensure that the JSPWikiFormatterPlugin is only installed once.\nif(!version.extensions.JSPWikiFormatterPlugin) {\nversion.extensions.JSPWikiFormatterPlugin = {installed:true};\n\nif(version.major &lt; 2 || (version.major == 2 &amp;&amp; version.minor &lt; 1))\n	{alertAndThrow('JSPWikiFormatterPlugin requires TiddlyWiki 2.1 or later.');}\n\nif(config.options.chkJspFormatterDisplayUnsupportedMacros == undefined)\n	{config.options.chkJspFormatterDisplayUnsupportedMacros = false;}\n\nconfig.macros.list.jspWikiTalkPages = {};\nconfig.macros.list.jspWikiTalkPages.handler = function(params)\n{\n	return store.getJSPWikiTalkPages();\n};\n\nTiddlyWiki.prototype.getJSPWikiTalkPages = function()\n{\n	var results = [];\n	this.forEachTiddler(function(title,tiddler) {\n		if(tiddler.title.substr(0,5)=='Talk.')\n			results.push(tiddler);\n		});\n	results.sort(function(a,b) {return a.title &lt; b.title ? -1 : (a.title == b.title ? 0 : +1);});\n	return results;\n};\n\nTiddlyWiki.prototype.getJSPWikiPages = function()\n{\n	var results = [];\n	this.forEachTiddler(function(title,tiddler) {\n		if(!tiddler.isTagged(&quot;excludeLists&quot;) &amp;&amp; tiddler.title.substr(0,5)!='Talk.')\n			results.push(tiddler);\n		});\n	results.sort(function(a,b) {return a.title &lt; b.title ? -1 : (a.title == b.title ? 0 : +1);});\n	return results;\n};\n\n\nconfig.commands.jspWikiDiscussion = {};\n\nmerge(config.commands.jspWikiDiscussion,{\n	text: &quot;discussion&quot;,\n	tooltip: &quot;Discussion&quot;,\n	readOnlyText: &quot;discussion&quot;,\n	readOnlyTooltip: &quot;Discussion&quot;});\n\nconfig.commands.jspWikiDiscussion.handler = function(event,src,title)\n{\n	clearMessage();\n	story.displayTiddler(null,&quot;Talk.&quot;+title,DEFAULT_VIEW_TEMPLATE);\n	//story.focusTiddler(title,&quot;text&quot;);\n	return false;\n};\n\nconfig.commands.jspWikiDiscussion.isEnabled = function(tiddler)\n{\n	if(!tiddler)\n		return false;\n	if(tiddler.isTagged(config.parsers.jspWikiFormatter.formatTag)||(tiddler.fields&amp;&amp;config.parsers.jspWikiFormatter.format&amp;&amp;tiddler.fields[&quot;wikiformat&quot;]==config.parsers.jspWikiFormatter.format)) {\n		if(tiddler.title.indexOf(&quot;Talk.&quot;) != 0)\n			return true;\n	}\n	return false;\n};\n\njspWikiFormatter = {}; // 'namespace' for local functions\njspWikiFormatter.hijackListAll = function ()\n{\n	jspWikiFormatter.oldListAll = config.macros.list.all.handler;\n	config.macros.list.all.handler = function(params) {\n		return store.getJSPWikiPages();\n	};\n};\n\njspWikiFormatter.hijackListAll();\n\njspDebug = function(out,str)\n{\n	createTiddlyText(out,str.replace(/\sn/mg,'\s\sn').replace(/\sr/mg,'RR'));\n	createTiddlyElement(out,'br');\n};\n\njspWikiFormatter.isExternalLink = function(link)\n{\n	if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {\n		return false;\n	}\n	var urlRegExp = new RegExp(config.textPrimitives.urlPattern,'mg');\n	if(urlRegExp.exec(link)) {\n		return true;\n	}\n	if (link.indexOf('\s\s')!=-1){\n		return true;\n	}\n	return false;\n};\n\njspWikiFormatter.inlineCssHelper = function(e,fm)\n{\n	cssRegExp = /(?:([a-z_\s-]+):([^;\s|\sn]+);)/mg;\n	var nm = 0;\n	cssRegExp.lastIndex = nm;\n	var lookaheadMatch = cssRegExp.exec(fm);\n	while(lookaheadMatch &amp;&amp; lookaheadMatch.index == nm) {\n		var s = lookaheadMatch[1];\n		var v = lookaheadMatch[2];\n		s = s=='bgcolor' ? 'backgroundColor' : s.unDash();\n		e.style[s] = v;\n		nm = cssRegExp.lastIndex;\n		lookaheadMatch = cssRegExp.exec(fm);\n	}\n};\n\njspWikiFormatter.wikiStyle = function(w)\n// see http://www.jspwiki.org/wiki/JSPWikiStyles\n{\n	this.lookaheadRegExp.lastIndex = w.matchStart;\n	var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n	if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n		var lm1 = lookaheadMatch[1];\n		var lm2 = lookaheadMatch[2];\n		if(lm2) {\n			e = createTiddlyElement(w.output,'span');\n			jspWikiFormatter.inlineCssHelper(e,lm2);\n			w.subWikifyTerm(e,this.termRegExp);\n			return;\n		}\n		switch(lm1) {\n		case 'sortable':\n			w.subWikifyTerm(w.output,this.termRegExp);\n			break;\n		case 'information':\n		case 'warning':\n		case 'error':\n		case 'commentbox':\n		case 'center':\n		case 'ltr':\n		case 'rtl':\n		case 'small':\n			w.subWikifyTerm(createTiddlyElement(w.output,'span',null,lm1),this.termRegExp);\n			break;\n		case 'sup':\n			w.subWikifyTerm(createTiddlyElement(w.output,'sup'),this.termRegExp);\n			break;\n		case 'sub':\n			w.subWikifyTerm(createTiddlyElement(w.output,'sub'),this.termRegExp);\n			break;\n		case 'strike':\n			w.subWikifyTerm(createTiddlyElement(w.output,'strike'),this.termRegExp);\n			break;\n		default:\n			w.outputText(w.output,w.matchStart,w.nextMatch);\n			break;\n		}\n	} else {\n		w.outputText(w.output,w.matchStart,w.nextMatch);\n	}\n};\n\njspWikiFormatter.macros = function(w)\n// see http://www.jspwiki.org/wiki/JSPWikiPlugins\n{\n	this.lookaheadRegExp.lastIndex = w.matchStart;\n	var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n	if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n		var lm1 = lookaheadMatch[1];\n		switch(lm1) {\n		default:\n			if(config.options.chkJspFormatterDisplayUnsupportedMacros)\n				w.outputText(w.output,w.matchStart,w.nextMatch);\n			else\n				w.nextMatch = this.lookaheadRegExp.lastIndex;\n			break;\n		}\n	}\n};\n\nconfig.jspWikiFormatters = [\n{\n	name: 'jspHeading',\n	match: '^!{1,3}',\n	termRegExp: /($\sn)/mg,\n	handler: function(w)\n	{\n		w.subWikifyTerm(createTiddlyElement(w.output,'h'+(4-w.matchLength)),this.termRegExp);\n	}\n},\n\n{\n	name: 'jspList',\n	match: '^(?:[\s\s*#;:]+)',\n	lookaheadRegExp: /^(?:(?:(\s*)|(#)|(;)|(:))+)/mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n		var stack = [w.output];\n		var currLevel = 0, currType = null;\n		var listLevel, listType, itemType;\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			if(lookaheadMatch[1]) {\n				listType = 'ul';\n				itemType = 'li';\n			} else if(lookaheadMatch[2]) {\n				listType = 'ol';\n				itemType = 'li';\n			} else if(lookaheadMatch[3]) {\n				listType = 'dl';\n				itemType = 'dt';\n			} else if(lookaheadMatch[4]) {\n				listType = 'dl';\n				itemType = 'dd';\n			}\n			listLevel = lookaheadMatch[0].length;\n			w.nextMatch += lookaheadMatch[0].length;\n			var t;\n			if(listLevel &gt; currLevel) {\n				for(t=currLevel; t&lt;listLevel; t++)\n					stack.push(createTiddlyElement(stack[stack.length-1],listType));\n			} else if(listLevel &lt; currLevel) {\n				for(t=currLevel; t&gt;listLevel; t--)\n					stack.pop();\n			} else if(listLevel == currLevel &amp;&amp; listType != currType) {\n				stack.pop();\n				stack.push(createTiddlyElement(stack[stack.length-1],listType));\n			}\n			currLevel = listLevel;\n			currType = listType;\n			var e = createTiddlyElement(stack[stack.length-1],itemType);\n			w.subWikifyTerm(e,this.termRegExp);\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	}\n},\n\n{\n	name: 'jspTable',\n	match: '^\s\s|',\n	lookaheadRegExp: /^\s|/mg,\n	cellRegExp: /\s|.*?\s|?[$\sn]?/mg,\n	cellTermRegExp: /($|\sn|\s|)/mg,\n	debug: null,\n	handler: function(w)\n	{\n		var table = createTiddlyElement(w.output,'table',null,'wikitable');\n		var prevColumns = [];\n		var rowContainer = createTiddlyElement(table,'tbody');\n		var rowIndex = 0;\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			rowIndex++;\n			var r = this.rowHandler(w,createTiddlyElement(rowContainer,'tr',null,rowIndex&amp;1?'odd':null),prevColumns);\n			if(!r) {\n				w.nextMatch++;\n				break;\n			}\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	},\n	rowHandler: function(w,e,prevColumns)\n	{\n		this.cellRegExp.lastIndex = w.nextMatch;\n		var cellMatch = this.cellRegExp.exec(w.source);\n		while(cellMatch &amp;&amp; cellMatch.index == w.nextMatch) {\n			w.nextMatch++;// skip the |\n			var chr = w.source.substr(w.nextMatch,1);\n			// another | indicates a table heading\n			if(chr == '|') {\n				cell = createTiddlyElement(e,'th');\n				w.nextMatch++;\n			} else {\n				cell = createTiddlyElement(e,'td');\n			}\n			w.subWikifyTerm(cell,this.cellTermRegExp);\n			chr = w.source.substr(w.nextMatch,1);\n			if(!chr||chr=='\sn') {\n				// End of row\n				w.nextMatch++; // skip over the \sn\n				return true;\n			}\n			// Cell\n			w.nextMatch--;// rewind to before the |\n			this.cellRegExp.lastIndex = w.nextMatch;\n			cellMatch = this.cellRegExp.exec(w.source);\n		}\n		return false;\n	}\n},\n\n{\n	name: 'jspRule',\n	match: '^---+$\s\sn?',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'hr');\n	}\n},\n\n{\n	name: 'jspMonospacedByLine',\n	match: '^\s\s{\s\s{\s\s{\s\sn',\n	lookaheadRegExp: /^\s{\s{\s{\sn((?:^[^\sn]*\sn)+?)(^\s}\s}\s}$\sn?)/mg,\n	element: 'pre',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'macro',\n	match: '&lt;&lt;',\n	lookaheadRegExp: /&lt;&lt;([^&gt;\ss]+)(?:\ss*)((?:[^&gt;]|(?:&gt;(?!&gt;)))*)&gt;&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart &amp;&amp; lookaheadMatch[1]) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);\n		}\n	}\n},\n\n{\n	name: 'jspMacro',\n	match: '\s\s[\s\s{',\n	lookaheadRegExp: /\s[\s{(.*?)\s}\s]/mg,\n	handler: jspWikiFormatter.macros\n},\n\n{\n	name: 'jspExplicitLink',\n	match: '\s\s[',\n	lookaheadRegExp: /\s[(.*?)(?:\s|(.*?))?\s]/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var text = lookaheadMatch[1];\n			var link = lookaheadMatch[2] ? lookaheadMatch[2] : text;\n			var e = jspWikiFormatter.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);\n			createTiddlyText(e,text);\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'jspUnWikiLink',\n	match: config.textPrimitives.unWikiLink+config.textPrimitives.wikiLink,\n	handler: function(w)\n	{\n		w.outputText(w.output,w.matchStart+1,w.nextMatch);\n	}\n},\n\n{\n	name: 'jspWikiLink',\n	match: config.textPrimitives.wikiLink,\n	handler: function(w)\n	{\n		if(w.matchStart &gt; 0) {\n			var preRegExp = new RegExp(config.textPrimitives.anyLetter,'mg');\n			preRegExp.lastIndex = w.matchStart-1;\n			var preMatch = preRegExp.exec(w.source);\n			if(preMatch.index == w.matchStart-1) {\n				w.outputText(w.output,w.matchStart,w.nextMatch);\n				return;\n			}\n		}\n		var output = w.output;\n		if(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText)) {\n			output = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);\n		}\n		w.outputText(output,w.matchStart,w.nextMatch);\n	}\n},\n\n{\n	name: 'jspUrlLink',\n	match: config.textPrimitives.urlPattern,\n	handler: function(w)\n	{\n		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);\n	}\n},\n\n{\n	name: 'jspBold',\n	match: '__',\n	termRegExp: /(__|(?=\sn\sn))/mg,\n	element: 'strong',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'jspItalic',\n	match: &quot;''&quot;,\n	termRegExp: /(''|(?=\sn\sn))/mg,\n	element: 'em',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'jspMonospaced',\n	match: '\s\s{\s\s{\s\s{',\n	lookaheadRegExp: /\s{\s{\s{((?:.|\sn)*?)\s}\s}\s}/mg,\n	element: 'code',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'jspWikiStyle',\n	match: '%%(?:(?:[a-z]+)|(?:\s\s([a-z:;\s\s-]+\s\s)))',\n	lookaheadRegExp: /%%(?:([a-z]+)|(?:\s(([a-z:;\s-]+)\s)))/mg,\n	termRegExp: /(\s%\s%)/mg,\n	handler: jspWikiFormatter.wikiStyle\n},\n\n{\n	name: 'jspParagraph',\n	match: '\s\sn\s\sn',\n	handler: function(w)\n	{\n		w.output = createTiddlyElement(w.output,'p');\n	}\n},\n\n{\n	name: 'jspLineBreak',\n	match: '\s\s\s\s|&lt;br ?/?&gt;',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'br');\n	}\n},\n\n{\n	name: 'jspComment',\n	match: '&lt;!\s\s-\s\s-',\n	lookaheadRegExp: /&lt;!\s-\s-((?:.|\sn)*?)\s-\s-!&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'jspHtmlEntitiesEncoding',\n	match: '&amp;#?[a-zA-Z0-9]{2,8};',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'span').innerHTML = w.matchText;\n	}\n}\n\n];\n\nconfig.parsers.jspWikiFormatter = new Formatter(config.jspWikiFormatters);\nconfig.parsers.jspWikiFormatter.format = 'JSPWiki';\nconfig.parsers.jspWikiFormatter.formatTag = 'JSPWikiFormat';\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="JSPWikiAdaptorPlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|JSPWikiAdaptorPlugin|\n|''Description:''|Adaptor for moving and converting data to and from JSP Wikis|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/martinsprereleases.html#JSPWikiAdaptorPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/JSPWikiAdaptorPlugin.js|\n|''Version:''|0.1.2|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n\n''For debug:''\n|''Default JSPWiki Server''|&lt;&lt;option txtJSPWikiDefaultServer&gt;&gt;|\n|''Default JSPWiki Web(workspace)''|&lt;&lt;option txtJSPWikiDefaultWorkspace&gt;&gt;|\n|''Default JSPWiki username''|&lt;&lt;option txtJSPWikiUsername&gt;&gt;|\n|''Default JSPWiki password''|&lt;&lt;option txtJSPWikiPassword&gt;&gt;|\n\n***/\n\n//{{{\nif(!config.options.txtJSPWikiDefaultServer)\n	{config.options.txtJSPWikiDefaultServer = 'www.JSPWiki.org';}\nif(!config.options.txtJSPWikiDefaultWorkspace)\n	{config.options.txtJSPWikiDefaultWorkspace = '';}\nif(!config.options.txtJSPWikiUsername)\n	{config.options.txtJSPWikiUsername = '';}\nif(!config.options.txtJSPWikiPassword)\n	{config.options.txtJSPWikiPassword = '';}\nif(!config.options.chkJSPWikiPasswordRequired)\n	{config.options.chkJSPWikiPasswordRequired = true;}\n//}}}\n\n// Ensure that the plugin is only installed once.\nif(!version.extensions.JSPWikiAdaptorPlugin) {\nversion.extensions.JSPWikiAdaptorPlugin = {installed:true};\n\nJSPWikiAdaptor = {}; // 'namespace' for local functions\n\nJSPWikiAdaptor.getTiddler = function(title,params)\n{\n// http://JSPWiki.org/wiki/WikiRPCInterface\n// http://www.JSPWiki.org/RPCU/\n\n	var fn = 'wiki.getPage';\n	var urlTemplate = 'http://%0/RPCU/';\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace,title]);\n\n	var fnParamsTemplate ='&lt;params&gt;&lt;param&gt;&lt;value&gt;&lt;string&gt;%0&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;&lt;/params&gt;';\n	var fnParams = fnParamsTemplate.format([title]);\n	var fnTemplate = '&lt;?xml version=&quot;1.0&quot;?&gt;&lt;methodCall&gt;&lt;methodName&gt;%0&lt;/methodName&gt;%1&lt;/methodCall&gt;';\n	var payload = fnTemplate.format([fn,fnParams]);\n\n	params.title = title;\n	params.wikiformat = 'JSPWiki';\n	params.serverType = 'JSPWiki';\n	var req =doHttp('POST',url,payload,null,params.username,params.password,JSPWikiAdaptor.getTiddlerCallback,params);\n};\n\nJSPWikiAdaptor.getTiddlerCallback = function(status,params,responseText,xhr)\n{\n	var content = responseText;\n	content = content.replace('&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;methodResponse&gt;&lt;params&gt;&lt;param&gt;&lt;value&gt;','');\n	content = content.replace('&lt;/value&gt;&lt;/param&gt;&lt;/params&gt;&lt;/methodResponse&gt;','');\n	var tiddler = store.createTiddler(params.title);\n	tiddler.updateFieldsAndContent(params,content);\n};\n\nJSPWikiAdaptor.putTiddler = function(title,params)\n{\n// http://www.JSPWiki.org/wiki/WikiRPCInterface2\n// http://www.JSPWiki.org/RPC2/\n	var text = store.fetchTiddler(title).text;\n\n	var fn = 'wiki.putPage';\n	var urlTemplate = 'http://%0/RPC2/';\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace,title]);\n\n	var fnParamsTemplate ='&lt;params&gt;';\n	fnParamsTemplate += '&lt;param&gt;&lt;value&gt;&lt;string&gt;%0&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;';\n	fnParamsTemplate += '&lt;param&gt;&lt;value&gt;&lt;string&gt;%1&lt;/string&gt;&lt;/value&gt;&lt;/param&gt;';\n	fnParamsTemplate += '&lt;/params&gt;';\n	var fnParams = fnParamsTemplate.format([title,text]);\n	var fnTemplate = '&lt;?xml version=&quot;1.0&quot;?&gt;&lt;methodCall&gt;&lt;methodName&gt;%0&lt;/methodName&gt;%1&lt;/methodCall&gt;';\n	var payload = fnTemplate.format([fn,fnParams]);\n\n	params.title = title;\n	params.wikiformat = 'JSPWiki';\n	params.serverType = 'JSPWiki';\n	var req =doHttp('POST',url,payload,null,username,password,JSPWikiAdaptor.putTiddlerCallback,params);\n};\n\nJSPWikiAdaptor.putTiddlerCallback = function(status,params,responseText,xhr)\n{\n	displayMessage('putTiddlerCallback status:'+status);\n	displayMessage('rt:'+responseText.substr(0,50));\n};\n\nconfig.hostFunctions.getTiddler['jspwiki'] = JSPWikiAdaptor.getTiddler;\nconfig.hostFunctions.putTiddler['jspwiki'] = JSPWikiAdaptor.putTiddler;\n\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="MediaWikiFormatterPlugin" modifier="MartinBudden" modified="200608170000" created="200608170000" tags="systemConfig excludeLists">/***\n|''Name:''|MediaWikiFormatterPlugin|\n|''Description:''|Allows Tiddlers to use [[MediaWiki|http://meta.wikimedia.org/wiki/Help:Wikitext]] ([[WikiPedia|http://meta.wikipedia.org/]]) text formatting|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinplugins.tiddlywiki.com/#MediaWikiFormatterPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/MediaWikiFormatterPlugin.js|\n|''Version:''|0.3.12|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.1.0|\n\n|''Display instrumentation''|&lt;&lt;option chkDisplayInstrumentation&gt;&gt;|\n|''Display empty template links:''|&lt;&lt;option chkMediaWikiDisplayEmptyTemplateLinks&gt;&gt;|\n|''Allow zooming of thumbnail images''|&lt;&lt;option chkMediaWikiDisplayEnableThumbZoom&gt;&gt;|\n|''List references''|&lt;&lt;option chkMediaWikiListReferences&gt;&gt;|\n\nThis is the MediaWikiFormatterPlugin, which allows you to insert MediaWiki formated text into a TiddlyWiki.\n\nThe aim is not to fully emulate MediaWiki, but to allow you to create MediaWiki content off-line\nand then paste the content into your MediaWiki later on, with the expectation that only minor\nedits will be required.\n\nTo use MediaWiki format in a Tiddler, tag the Tiddler with MediaWikiFormat. See [[testMediaWikiFormat]]\nfor an example.\n\n!!!Issues\nThere are (at least) the following known issues:\n# Not all styles from http://meta.wikimedia.org/wiki/MediaWiki:Common.css incorporated\n## Styles for tables don't yet match Wikipedia styles.\n## Styles for image galleries don't yet match Wikipedia styles.\n# Anchors not yet supported.\n\n!!!Not supported\n# Magic words and variables http://meta.wikimedia.org/wiki/Help:Magic_words\n# Template substitution http://meta.wikimedia.org/wiki/Help:Substitution\n# Template colon functions http://meta.wikimedia.org/wiki/Help:Colon_function\n# Template parser functions (eg #if) http://meta.wikimedia.org/wiki/ParserFunctions\n# {{{^''}}} (italic at start of line) indents, makes italic and quotes with guilmot quote\n\n***/\n\n//{{{\n// Ensure that the MediaWikiFormatter Plugin is only installed once.\nif(!version.extensions.MediaWikiFormatterPlugin) {\nversion.extensions.MediaWikiFormatterPlugin = {installed:true};\n\nif(version.major &lt; 2 || (version.major == 2 &amp;&amp; version.minor &lt; 1))\n	{alertAndThrow('MediaWikiFormatterPlugin requires TiddlyWiki 2.1 or later.');}\n\nif(config.options.chkDisplayInstrumentation == undefined)\n	{config.options.chkDisplayInstrumentation = false;}\n\nif(config.options.chkMediaWikiDisplayEmptyTemplateLinks == undefined)\n	{config.options.chkMediaWikiDisplayEmptyTemplateLinks = false;}\nif(config.options.chkMediaWikiDisplayEnableThumbZoom == undefined)\n	{config.options.chkMediaWikiDisplayEnableThumbZoom = false;}\nif(config.options.chkMediaWikiListReferences == undefined)\n	{config.options.chkMediaWikiListReferences = false;}\n\nMediaWikiFormatter = {}; // 'namespace' for local functions\n\nmwDebug = function(out,str)\n{\n	createTiddlyText(out,str.replace(/\sn/mg,'\s\sn').replace(/\sr/mg,'RR'));\n	createTiddlyElement2(out,'br');\n};\n\nMediaWikiFormatter.Tiddler_changed = Tiddler.prototype.changed;\nTiddler.prototype.changed = function()\n{\n	if((this.fields &amp;&amp; this.fields.wikiformat==config.parsers.mediaWikiFormatter.format) || this.isTagged(config.parsers.mediaWikiFormatter.formatTag)) {\n		// update the links array, by checking for MediaWiki format links\n		this.links = [];\n		var tiddlerLinkRegExp = /\s[\s[(?::?([A-Za-z]{2,}:)?)(#?)([^\s|\s]]*?)(?:(\s]\s])|(\s|(.*?)\s]\s]))/mg;\n		tiddlerLinkRegExp.lastIndex = 0;\n		var match = tiddlerLinkRegExp.exec(this.text);\n		while(match) {\n			if(!match[1] &amp;&amp; !match[2])\n				this.links.pushUnique(match[3]);\n			match = tiddlerLinkRegExp.exec(this.text);\n		}\n	} else if(!this.isTagged('systemConfig')) {\n		return MediaWikiFormatter.Tiddler_changed.apply(this,arguments);\n	}\n	this.linksUpdated = true;\n};\n\nconfig.macros.list.templates = {};\nconfig.macros.list.templates.handler = function(params)\n{\n	return store.getTemplates();\n};\n\nTiddlyWiki.prototype.getTemplates = function()\n{\n	var results = [];\n	this.forEachTiddler(function(title,tiddler) {\n		if(tiddler.title.substr(0,9)=='Template:')\n			results.push(tiddler);\n		});\n	results.sort(function(a,b) {return a.title &lt; b.title ? -1 : (a.title == b.title ? 0 : +1);});\n	return results;\n};\n\nTiddlyWiki.prototype.getMediaWikiArticles = function()\n{\n	var results = [];\n	this.forEachTiddler(function(title,tiddler) {\n		if(!tiddler.isTagged('excludeLists') &amp;&amp; tiddler.title.substr(0,9)!='Template:')\n			results.push(tiddler);\n		});\n	results.sort(function(a,b) {return a.title &lt; b.title ? -1 : (a.title == b.title ? 0 : +1);});\n	return results;\n};\n\nwikify = function(source,output,highlightRegExp,tiddler)\n{\n	if(source &amp;&amp; source != '') {\n		var w = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);\n		w.linkCount = 0;\n		w.tableDepth = 0;\n		w.output = tiddler==null ? output : createTiddlyElement2(output,'p');\n		var time1,time0 = new Date();\n		w.subWikifyUnterm(w.output);\n		if(tiddler &amp;&amp; config.options.chkDisplayInstrumentation) {\n			time1 = new Date();\n			var t = tiddler ? tiddler.title : source.substr(0,10);\n			displayMessage('Wikify &quot;'+t+'&quot; in ' + (time1-time0) + ' ms');\n		}\n	}\n};\n\nfunction createTiddlyElement2(parent,element)\n{\n	return parent.appendChild(document.createElement(element));\n}\n\nconfig.formatterHelpers.createElementAndWikify = function(w)\n{\n	w.subWikifyTerm(createTiddlyElement2(w.output,this.element),this.termRegExp);\n};\n\nMediaWikiFormatter.hijackListAll = function ()\n{\n	MediaWikiFormatter.oldListAll = config.macros.list.all.handler;\n	config.macros.list.all.handler = function(params) {\n		return store.getMediaWikiArticles();\n	};\n};\n\nMediaWikiFormatter.hijackListAll();\n\nMediaWikiFormatter.getTemplateParams = function(w)\n{\n	var params = {};\n\n	var i = 1;\n	var text = w.source + '|';\n	var pRegExp = /(?:([^\s|]*)=)?([^\s|]*)\s|/mg;\n	var match = pRegExp.exec(text);\n	if(match) {\n		// skip template name\n		match = pRegExp.exec(text);\n	}\n	while(match) {\n		//params[match[1] ? match[1] : i++] = match[2];\n		if(match[1]) {\n			params[match[1]] = match[2];\n		} else {\n			params[i] = match[2];\n			i++;\n		}\n		match = pRegExp.exec(text);\n	}\n	return params;\n};\n\nMediaWikiFormatter.expandTemplate = function(w,tiddler,params)\n// see http://meta.wikimedia.org/wiki/Help:Template\n{\n	var text = tiddler.text;\n	text = text.replace(/&lt;noinclude&gt;((?:.|\sn)*?)&lt;\s/noinclude&gt;/mg,'');// remove text between noinclude tags\n	var ioRegExp = /&lt;includeonly&gt;((?:.|\sn)*?)&lt;\s/includeonly&gt;/mg;\n	var t = '';\n	var match = ioRegExp.exec(text);\n	while(match) {\n		t += match[1];\n		match = ioRegExp.exec(text);\n	}\n	text = t == '' ? text : t;\n\n	var paramsRegExp = /\s{\s{\s{(.*?)(?:\s|(.*?))?\s}\s}\s}/mg;\n	t = '';\n	var pi = 0;\n	match = paramsRegExp.exec(text);\n	while(match) {\n		var name = match[1];\n		var def = match[2];\n		var val = params[name];\n		if(!val) {\n			val = def;\n		}\n		if(!val) {\n			val = match[0];\n		}\n		t += text.substring(pi,match.index) + val;\n		pi = paramsRegExp.lastIndex;\n		match = paramsRegExp.exec(text);\n	}\n	return t == '' ? text : t;\n};\n\nMediaWikiFormatter.endOfParams = function(w,text)\n{\n	var p = 0;\n	var i = text.indexOf('|');\n	if(i==-1) {return -1;}\n	var n = text.indexOf('\sn');\n	if(n!=-1 &amp;&amp; n&lt;i) {return -1;}\n	var b = text.indexOf('[[');\n	if(b!=-1 &amp;&amp; b&lt;i) {return -1;}// can't have [[ in parameters\n	\n	b = text.indexOf('{{');\n	while(b!=-1 &amp;&amp; b&lt;i) {\n		// have {{ before |, so need to find first '|' after '{{..}}' pairs\n		//cut off the ..{{, find the }} cut off and repeat\n		p += b;\n		text = text.substr(b);\n		var c = text.indexOf('}}');\n		p += c;\n		text = text.substr(c);\n		i = text.indexOf('|');\n		if(i==-1) {return -1;}\n		n = text.indexOf('\sn');\n		if(n!=-1 &amp;&amp; n&lt;i) {return -1;}\n		b = text.indexOf('{{');\n		i = -1;\n	}\n	return i;\n};\n\nMediaWikiFormatter.readToDelim = function(w)\n//!!! this is a bit rubish, needs doing properly.\n{\n	var dRegExp = /\s|/mg;\n	var sRegExp = /\s[\s[/mg;\n	var tRegExp = /\s]\s]/mg;\n\n	dRegExp.lastIndex = w.startMatch;\n	var dMatch = dRegExp.exec(w.source);\n	sRegExp.lastIndex = w.startMatch;\n	var sMatch = sRegExp.exec(w.source);\n	tRegExp.lastIndex = w.startMatch;\n	var tMatch = tRegExp.exec(w.source);\n	if(!tMatch) {\n		return false;\n	}\n\n	while(sMatch &amp;&amp; sMatch.index&lt;tMatch.index) {\n		if(dMatch &amp;&amp; dMatch.index&lt;sMatch.index) {\n			w.nextMatch = dRegExp.lastIndex;\n			w.matchLength = dMatch.index - w.startMatch;\n			return true;\n		}\n		// found eg [[, so look for ]]\n		tRegExp.lastIndex = sRegExp.lastIndex;\n		tMatch = tRegExp.exec(w.source);\n		\n		// and look for another [[\n		w.nextMatch = tRegExp.lastIndex;\n		dRegExp.lastIndex = w.nextMatch;\n		dMatch = dRegExp.exec(w.source);\n		sRegExp.lastIndex = w.nextMatch;\n		sMatch = sRegExp.exec(w.source);\n		tRegExp.lastIndex = w.nextMatch;\n		tMatch = tRegExp.exec(w.source);\n	}\n		\n	if(dMatch &amp;&amp; dMatch.index&lt;tMatch.index) {\n		w.nextMatch = dRegExp.lastIndex;\n		w.matchLength = dMatch.index - w.startMatch;\n		return true;\n	}\n	if(tMatch) {\n		w.nextMatch = tRegExp.lastIndex;\n		w.matchLength = tMatch.index - w.startMatch;\n		return false;\n	}\n	w.nextMatch = tRegExp.lastIndex;\n	w.matchLength = -1;\n	return false;\n};\n\nMediaWikiFormatter.getParams = function(w)\n{\n	var params = [];\n	var i = 1;\n	w.startMatch = w.nextMatch;\n	var read = MediaWikiFormatter.readToDelim(w);\n	if(w.matchLength!=-1) {\n		params[i] = w.source.substr(w.startMatch,w.matchLength);\n	}\n	while(read) {\n		i++;\n		w.startMatch = w.nextMatch;\n		read = MediaWikiFormatter.readToDelim(w);\n		if(w.matchLength!=-1) {\n			params[i] = w.source.substr(w.startMatch,w.matchLength);\n		}\n	}\n	return params;\n};\n\nMediaWikiFormatter.setFromParams = function(w,p)\n{\n	var r = {};\n	var re = /\ss*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\sw|%|#)*))/mg;\n	var match = re.exec(p);\n	while(match)\n		{\n		var s = match[1].unDash();\n		if(match[2]) {\n			r[s] = match[2];\n		} else if(match[3]) {\n			r[s] = match[3];\n		} else {\n			r[s] = match[4];\n		}\n		match = re.exec(p);\n	}\n	return r;\n};\n\nMediaWikiFormatter.setAttributesFromParams = function(e,p)\n{\n	var re = /\ss*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\sw|%|#)*))/mg;\n	var match = re.exec(p);\n	while(match) {\n		var s = match[1].unDash();\n		if(s == 'bgcolor') {\n			s = 'backgroundColor';\n		}\n		try {\n			if(match[2]) {\n				e.setAttribute(s,match[2]);\n			} else if(match[3]) {\n				e.setAttribute(s,match[3]);\n			} else {\n				e.setAttribute(s,match[4]);\n			}\n		}\n		catch(ex) {}\n		match = re.exec(p);\n	}\n};\n\nconfig.mediaWikiFormatters = [\n{\n	name: 'mediaWikiHeading',\n	match: '^={2,6}(?!=)\s\sn?',\n	termRegExp: /(={2,6}\sn?)/mg,\n	handler: function(w)\n	{\n		var output = w.output;\n		var e = createTiddlyElement2(output,'h' + w.matchLength);\n		var a = createTiddlyElement2(e,'a');// drop anchor\n		var t = w.tiddler ? w.tiddler.title + ':' : '';\n		var len = w.source.substr(w.nextMatch).indexOf('=');\n		a.setAttribute('name',t+w.source.substr(w.nextMatch,len));\n		w.subWikifyTerm(e,this.termRegExp);\n	}\n},\n\n{\n	name: 'mediaWikiTable',\n	match: '^\s\s{\s\s|', // ^{|\n	tableTerm: '\s\sn\s\s|\s\s}', // |}\n	rowStart: '\s\sn\s\s|\s\s-', // \sn|-\n	cellStart: '\s\sn!|!!|\s\s|\s\s||\s\sn\s\s|', //\sn! or !! or || or \sn|\n	caption: '\s\sn\s\s|\s\s+',\n	rowTerm: null,\n	cellTerm: null,\n	inCellTerm: null,\n	tt: 0,\n	debug: null,\n	rowTermRegExp: null,\n	handler: function(w)\n	{\n		if(!this.rowTermRegExp) {\n			this.rowTerm = '(' + this.tableTerm +')|(' + this.rowStart + ')';\n			this.cellTerm = this.rowTerm + '|(' + this.cellStart + ')';\n			this.inCellTerm = '(' + this.match + ')|' + this.rowTerm + '|(' + this.cellStart + ')';\n			this.caption = '(' + this.caption + ')|' + this.cellTerm;\n\n			this.rowTermRegExp = new RegExp(this.rowTerm,'mg');\n			this.cellTermRegExp = new RegExp(this.cellTerm,'mg');\n			this.inCellTermRegExp = new RegExp(this.inCellTerm,'mg');\n			this.captionRegExp = new RegExp(this.caption,'mg');\n		}\n		this.captionRegExp.lastIndex = w.nextMatch;\n		var match = this.captionRegExp.exec(w.source);\n		if(!match) {return;}\n		var output = w.output;\n		var table = createTiddlyElement2(output,'table');\n		var rowContainer = table;\n\n		var i = w.source.indexOf('\sn',w.nextMatch);\n		if(i&gt;w.nextMatch) {\n			MediaWikiFormatter.setAttributesFromParams(table,w.source.substring(w.nextMatch,i));\n			w.nextMatch = i;\n		}\n\n		var rowCount = 0;\n		var eot = false;\n		if(match[1]) {\n			// caption\n			var caption = createTiddlyElement2(table,'caption');\n			w.nextMatch = this.captionRegExp.lastIndex;\n			var captionText = w.source.substring(w.nextMatch);\n			var n = captionText.indexOf('\sn');\n			captionText = captionText.substr(0,n);\n			i = MediaWikiFormatter.endOfParams(w,captionText);\n			if(i!=-1) {\n				captionText = w.source.substr(w.nextMatch,i);\n				//captionText = captionText.replace(/^\s+/mg,'')//!!hack until I fix this properly\n				//MediaWikiFormatter.setAttributesFromParams(caption,captionText);\n				w.nextMatch += i+1;\n			}\n			if(caption != table.firstChild) {\n				table.insertBefore(caption,table.firstChild);\n			}\n			w.subWikify(caption,this.cellTerm);\n			w.nextMatch -= w.matchLength;// rewind to before the match\n			this.cellTermRegExp.lastIndex = w.nextMatch;\n			var match2 = this.cellTermRegExp.exec(w.source);\n			if(match2) {\n				if(match2[3]) {\n					// no first row marker\n					eot = this.rowHandler(w,createTiddlyElement2(rowContainer,'tr'));\n					rowCount++;\n				}\n			}\n		} else if(match[3]) {\n			// row\n			w.nextMatch = this.captionRegExp.lastIndex-match[3].length;// rewind to before the match\n		} else if(match[4]) {\n			// cell, no first row marker in table\n			w.nextMatch = this.captionRegExp.lastIndex-match[4].length;// rewind to before the match\n			eot = this.rowHandler(w,createTiddlyElement2(rowContainer,'tr'));\n			rowCount++;\n		}\n\n		this.rowTermRegExp.lastIndex = w.nextMatch;\n		match = this.rowTermRegExp.exec(w.source);\n		while(match &amp;&amp; eot==false) {\n			if(match[1]) {\n				// end table\n				w.nextMatch = this.rowTermRegExp.lastIndex;\n				if(w.tableDepth==0) {\n					return;\n				}\n			} else if(match[2]) {\n				// row\n				var rowElement = createTiddlyElement2(rowContainer,'tr');\n				w.nextMatch += match[2].length;// skip over the match\n				i = w.source.indexOf('\sn',w.nextMatch);\n				if(i&gt;w.nextMatch) {\n					MediaWikiFormatter.setAttributesFromParams(rowElement,w.source.substring(w.nextMatch,i));\n					w.nextMatch = i;\n				}\n				eot = this.rowHandler(w,rowElement);\n			}\n			rowCount++;\n			this.rowTermRegExp.lastIndex = w.nextMatch;\n			match = this.rowTermRegExp.exec(w.source);\n		}//# end while\n		if(w.tableDepth==0) {\n			w.nextMatch +=3;// skip over tableterm, \sn|}\n		}\n	},//# end handler\n\n	rowHandler: function(w,e)\n	{\n		var cell;\n		this.inCellTermRegExp.lastIndex = w.nextMatch;\n		var match = this.inCellTermRegExp.exec(w.source);\n		while(match) {\n			if(match[1])\n				{// nested table\n				w.tableDepth++;\n				w.subWikify(cell,this.tableTerm);\n				w.nextMatch = this.tt;\n				w.tableDepth--;\n				return false;\n			} else if(match[2]) {\n				this.tt = this.inCellTermRegExp.lastIndex;\n				return true;\n			} else if(match[3]) {\n				return false;\n			} else if(match[4]) {\n				var len = match[4].length;\n				cell = createTiddlyElement2(e,match[4].substr(len-1)=='!'?'th':'td');\n				w.nextMatch += len;//skip over the match\n\n				this.inCellTermRegExp.lastIndex = w.nextMatch;\n				var lookahead = this.inCellTermRegExp.exec(w.source);\n				if(!lookahead) {\n					return false;\n				}\n				var cellText = w.source.substr(w.nextMatch,lookahead.index-w.nextMatch);\n				var oldSource = w.source;\n				var i = MediaWikiFormatter.endOfParams(w,cellText);//cellText.indexOf('|');\n				if(i!=-1) {\n					cellText = cellText.replace(/^\s+/mg,'');  //!!hack until I fix this properly\n					MediaWikiFormatter.setAttributesFromParams(cell,cellText.substr(0,i-1));\n					cellText = cellText.substring(i+1);\n				}\n				cellText = cellText.replace(/^\ss*/mg,''); //# remove leading spaces so not treated as preformatted\n				w.source = cellText;\n				w.nextMatch = 0;\n				w.subWikifyUnterm(cell);\n				w.source = oldSource;\n				w.nextMatch = lookahead.index;\n			}\n			this.inCellTermRegExp.lastIndex = w.nextMatch;\n			match = this.inCellTermRegExp.exec(w.source);\n		}//# end while\n		return false;\n	}//# end rowHandler\n},\n\n{\n	name: 'mediaWikiList',\n	match: '^[\s\s*#;:]+',\n	lookaheadRegExp: /(?:(?:(\s*)|(#)|(;)|(:))+)(?: ?)/mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n		var stack = [w.output];\n		var currLevel = 0, currType = null;\n		var listType, itemType;\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			if(lookaheadMatch[1]) {\n				listType = 'ul';\n				itemType = 'li';\n			} else if(lookaheadMatch[2]) {\n				listType = 'ol';\n				itemType = 'li';\n			} else if(lookaheadMatch[3]) {\n				listType = 'dl';\n				itemType = 'dt';\n			} else if(lookaheadMatch[4]) {\n				listType = 'dl';\n				itemType = 'dd';\n			}\n			var listLevel = lookaheadMatch[0].length;\n			w.nextMatch += listLevel;\n			if(listLevel &gt; currLevel) {\n				for(var i=currLevel; i&lt;listLevel; i++) {\n					stack.push(createTiddlyElement2(stack[stack.length-1],listType));\n				}\n			} else if(listLevel &lt; currLevel) {\n				for(i=currLevel; i&gt;listLevel; i--) {\n					stack.pop();\n				}\n			} else if(listLevel == currLevel &amp;&amp; listType != currType) {\n				stack.pop();\n				stack.push(createTiddlyElement2(stack[stack.length-1],listType));\n			}\n			currLevel = listLevel;\n			currType = listType;\n			var e = createTiddlyElement2(stack[stack.length-1],itemType);\n			var ci = w.source.indexOf(':',w.nextMatch);\n			var ni = w.source.indexOf('\sn',w.nextMatch);\n			if(itemType=='dt' &amp;&amp; (ni==-1 || (ci!=-1 &amp;&amp; ci&lt;ni))) {\n				// deal with ':' on same line as ';'\n				w.subWikifyTerm(e,/(:)/mg);\n				w.nextMatch--;\n			} else {\n				w.subWikifyTerm(e,this.termRegExp);\n			}\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	}\n},\n\n{\n	name: 'mediaWikiRule',\n	match: '^----+$\s\sn?',\n	handler: function(w)\n	{\n		createTiddlyElement2(w.output,'hr');\n	}\n},\n\n{\n	name: 'mediaWikiLeadingSpaces',\n	match: '^ ',\n	lookaheadRegExp: /^ /mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n		var e = createTiddlyElement2(w.output,'pre');\n		while(true) {\n			w.subWikifyTerm(e,this.termRegExp);\n			createTiddlyElement2(e,'br');\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n			if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n				w.nextMatch += lookaheadMatch[0].length;\n			} else {\n				break;\n			}\n		}\n	}\n},\n\n\n{\n	name: 'mediaWikiImage',\n	match: '\s\s[\s\s[(?:[Ii]mage|Bild):',\n	lookaheadRegExp: /\s[\s[(?:[Ii]mage|Bild):/mg,\n	defaultPx: 180,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var params = MediaWikiFormatter.getParams(w);\n			var src = params[1];\n			src = src.trim().replace(/ /mg,'_');\n			src = src.substr(0,1).toUpperCase() + src.substring(1);\n			var palign = null;\n			var ptitle = null;\n			var psrc = false;\n			var px = null;\n			var pthumb = false;\n			var pframed = false;\n			for(var i=2;i&lt;params.length;i++) {\n				var p = params[i];\n				if(p=='right'||p=='left'||p=='center'||p=='none') {\n					palign = p;\n				} else if(p=='thumbnail'||p=='thumb') {\n					pthumb = true;\n				} else if(p=='framed') {\n					pframed = true;\n				} else if(/\sd{1,4} ?px/.exec(p)) {\n					px = p.substr(0,p.length-2).trim();\n				} else {\n					ptitle = p;\n				}\n			}//#end for\n			if(pthumb) {\n				var output = w.output;\n				if(!palign) {\n					palign = 'right';\n				}\n				if(!px) {\n					px = 180;\n				}\n				psrc = px + 'px-' + src;\n				var t = createTiddlyElement(output,'div',null,'thumb'+(palign?' t'+palign:''));\n				var s = createTiddlyElement2(t,'div');\n				s.style['width'] = Number(px) + 2 + 'px';\n				var a = createTiddlyElement(s,'a',null,'internal');\n				if(config.options.chkMediaWikiDisplayEnableThumbZoom) {\n					a.href = src;\n				}\n				a.title = ptitle;\n				var img = createTiddlyElement2(a,'img');\n				img.src = 'images/' + psrc;\n				img.width = px;\n				img.longdesc = 'Image:' + src;\n				img.alt = ptitle;\n\n				var tc = createTiddlyElement(s,'div',null,'thumbcaption');\n				var oldSource = w.source; var oldMatch = w.nextMatch;\n				w.source = ptitle; w.nextMatch = 0;\n				w.subWikifyUnterm(tc);\n				w.source = oldSource; w.nextMatch = oldMatch;\n\n				if(config.options.chkMediaWikiDisplayEnableThumbZoom) {\n					var tm = createTiddlyElement(tc,'div',null,'magnify');\n					tm.style['float'] = 'right';\n					var ta = createTiddlyElement(tm,'a',null,'internal');\n					ta.title = 'Enlarge';\n					timg = createTiddlyElement2(ta,'img'); timg.src = 'magnify-clip.png'; timg.alt = 'Enlarge'; timg.width = '15'; timg.height = '11';\n					ta.href = src;\n				}\n			} else {\n				// not pthumb\n				a = createTiddlyElement(w.output,'a',null,'image');\n				a.title = ptitle;\n				img = createTiddlyElement2(a,'img');\n				if(palign) {img.align = palign;}\n				img.src = px ? 'images/' + px + 'px-' + src : 'images/' + src;\n				if(px) {img.width = px;}\n				img.longdesc = 'Image:' + src;\n				img.alt = ptitle;\n			}\n		}\n	}//#end image handler\n},\n\n{\n	name: 'mediaWikiExplicitLink',\n	match: '\s\s[\s\s[',\n	lookaheadRegExp: /\s[\s[(?:([a-z]{2,3}:)?)(#?)([^\s|\s]]*?)(?:(\s]\s](\sw*))|(\s|(.*?)\s]\s]))/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			if(!lookaheadMatch[1]) {\n				// not (eg) [[en:...]]\n				var e;\n				var link = lookaheadMatch[3];\n				var text = link;\n				//var link2 = link;\n				link = link.substr(0,1).toUpperCase() + link.substring(1);\n				if(lookaheadMatch[4]) {\n					// Simple bracketted link\n					if(lookaheadMatch[2]) {\n						var a = createTiddlyElement2(e,'a');// drop anchor\n						a.setAttribute('name',link);\n					} else {\n						e = createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);\n						if(lookaheadMatch[5]) {\n							text += lookaheadMatch[5];//add any non-space after the ]]\n						}\n						createTiddlyText(e,text);\n					}\n				} else if(lookaheadMatch[6]) {\n					// Piped link\n					if(config.formatterHelpers.isExternalLink(link)) {\n						e = createExternalLink(w.output,link);\n					} else {\n						e = createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);\n					}\n					var oldSource = w.source; var oldMatch = w.nextMatch;\n					w.source = lookaheadMatch[7].trim(); w.nextMatch = 0;\n					w.subWikifyUnterm(e);\n					w.source = oldSource; w.nextMatch = oldMatch;\n				}\n			}\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n//**tem//\n{\n	name: 'mediaWikiTemplate',\n	match: '\s\s{\s\s{[^\s\s{]',\n	lookaheadRegExp: /\s{\s{((?:.|\sn)*?)\s}\s}/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var lastIndex = this.lookaheadRegExp.lastIndex;\n			var contents = lookaheadMatch[1];\n			// see http://meta.wikimedia.org/wiki/Help:Variable\n			if(contents=='PAGENAME') {\n				createTiddlyText(w.output,w.tiddler.title);\n				w.nextMatch = lastIndex;\n				return;\n			}\n			var i = contents.indexOf('|');\n			var title = i==-1 ? contents : contents.substr(0,i);\n			title = title.trim().replace(/_/mg,' ');// Underscore in template name is equivalent to space\n			title = 'Template:' + title.substr(0,1).toUpperCase() + title.substring(1);\n			var tiddler = store.fetchTiddler(title);\n			var oldSource = w.source;\n			if(tiddler) {\n				params = {};\n				w.source = lookaheadMatch[1];\n				if(i!=-1) {\n					w.nextMatch = 0;\n					params = MediaWikiFormatter.getTemplateParams(w);\n				}\n				w.source = MediaWikiFormatter.expandTemplate(w,tiddler,params);\n				w.nextMatch = 0;\n				w.subWikifyUnterm(w.output);\n			} else {\n				if(config.options.chkMediaWikiDisplayEmptyTemplateLinks) {\n					// for conveniece, output the name of the template so can click on it and create tiddler\n					w.source = '[['+title+']]';\n					w.nextMatch = 0;\n					w.subWikifyUnterm(w.output);\n				}\n			}\n			w.source = oldSource;\n			w.nextMatch = lastIndex;\n		}\n	}\n},\n\n{\n	name: 'mediaWikiParagraph',\n	match: '\s\sn{2,}',\n	handler: function(w)\n	{\n		w.output = createTiddlyElement2(w.output,'p');\n	}\n},\n\n{\n	name: 'mediaWikiExplicitLineBreak',\n	match: '&lt;br ?/?&gt;',\n	handler: function(w)\n	{\n		createTiddlyElement2(w.output,'br');\n	}\n},\n\n{\n	name: 'mediaWikiExplicitLineBreakWithParams',\n	match: &quot;&lt;br(?:\s\ss*(?:(?:.*?)=[\s&quot;']?(?:.*?)[\s&quot;']?))*?\s\ss*/?&gt;&quot;,\n	lookaheadRegExp: /&lt;br((?:\ss+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)*?)?\ss*\s/?&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var e =createTiddlyElement2(w.output,'br');\n			if(lookaheadMatch[1]) {\n				MediaWikiFormatter.setAttributesFromParams(e,lookaheadMatch[1]);\n			}\n			w.nextMatch = this.lookaheadRegExp.lastIndex;// empty tag\n		}\n	}\n},\n\n{\n	name: 'mediaWikiTitledUrlLink',\n	match: '\s\s[' + config.textPrimitives.urlPattern + '(?:\s\ss+[^\s\s]]+)?' + '\s\s]',\n	handler: function(w)\n	{\n		var lookaheadRegExp = new RegExp('\s\s[(' + config.textPrimitives.urlPattern + ')(?:\s\ss+([^\s[]+))?' + '\s\s]','mg');\n		lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index==w.matchStart) {\n			var link = lookaheadMatch[1];\n			var s = createTiddlyElement2(w.output,'sup');\n			var e = createExternalLink(s,link);\n			if(lookaheadMatch[2]) {\n				var oldSource = w.source; var oldMatch = w.nextMatch;\n				w.source = lookaheadMatch[2].trim(); w.nextMatch = 0;\n				w.subWikifyUnterm(e);\n				w.source = oldSource; w.nextMatch = oldMatch;\n			} else {\n				w.linkCount++;\n				createTiddlyText(e,'['+w.linkCount+']');\n			}\n			w.nextMatch = lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'mediaWikiUrlLink',\n	match: config.textPrimitives.urlPattern,\n	handler: function(w)\n	{\n		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);\n	}\n},\n\n{\n	name: 'mediaWikiBoldItalic',\n	match: &quot;'''''&quot;,\n	termRegExp: /('''''|(?=\sn))/mg,\n	element: 'strong',\n	handler: function(w)\n	{\n		var e = createTiddlyElement(w.output,this.element);\n		w.subWikifyTerm(createTiddlyElement(e,'em'),this.termRegExp);\n	}\n},\n\n{\n	name: 'mediaWikiBold',\n	match: &quot;'''&quot;,\n	termRegExp: /('''|(?=\sn))/mg,\n	element: 'strong',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'mediaWikiItalic',\n	match: &quot;''&quot;,\n	termRegExp: /((?:[^']''(?!'))|(?=\sn))/mg,\n	element: 'em',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'mediaWikiUnderline',\n	match: '&lt;u&gt;',\n	termRegExp: /(&lt;\s/u&gt;|(?=\sn))/mg,\n	element: 'u',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'mediaWikiStrike',\n	match: '&lt;s&gt;',\n	termRegExp: /(&lt;\s/s&gt;|(?=\sn))/mg,\n	element: 'strike',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'mediaWikiBoldTag',\n	match: '&lt;b&gt;',\n	termRegExp: /(&lt;\s/b&gt;|(?=\sn))/mg,\n	element: 'b',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'mediaWikiTemplateParam',// note, this only gets invoked when viewing the template\n	match: '\s\s{\s\s{\s\s{',\n	lookaheadRegExp: /(\s{\s{\s{(?:.|\sn)*?\s}\s}\s})/mg,\n	element: 'span',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'mediaWikiInsertReference',\n	match: '&lt;ref[^/]*&gt;',\n	lookaheadRegExp: /&lt;ref(\ss+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)?&gt;([^&lt;]*?)&lt;\s/ref&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var x = {id:'',value:''};\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n			if(!w.referenceCount) {\n				w.referenceCount = 0;\n				w.references = {};\n			}\n			var s = createTiddlyElement(w.output,'sup',null,'reference');\n			var a = createTiddlyElement2(s,'a');\n			var prefix = w.tiddler ? w.tiddler.title + ':' : '';\n			if(lookaheadMatch[1]) {\n				var r = {};\n				r = MediaWikiFormatter.setFromParams(w,lookaheadMatch[1]);\n				var name = r.name ? r.name.trim() : '';\n				name = name.replace(/ /g,'_');\n				s.id = prefix + '_ref-' + name;// + '_' + nameCount;(w.referenceCount+1);\n				if(!w.references[name]) {\n					w.references[name] = x;\n					w.references[name].id = w.referenceCount;\n					w.references[name].value = lookaheadMatch[2].trim();\n				}\n			} else {\n				w.references[w.referenceCount] = x;\n				w.references[w.referenceCount].id = w.referenceCount;\n				w.references[w.referenceCount].value = lookaheadMatch[2].trim();\n				name = w.referenceCount;\n				s.id = prefix + '_ref-' + w.referenceCount;\n			}\n			w.referenceCount++;\n			a.title = lookaheadMatch[2].trim();//mb, extra to wikipedia\n			a.href = '#' + prefix + '_note-' + name;\n			a.innerHTML = '['+w.referenceCount+']';\n		}\n	}\n},\n\n{\n	name: 'mediaWikiListReferences',\n	match: '&lt;references ?/&gt;',\n	lookaheadRegExp: /&lt;references ?\s/&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(config.options.chkMediaWikiListReferences &amp;&amp; w.referenceCount) {\n			var ol = createTiddlyElement(w.output,'ol',null,'references');\n			var oldSource = w.source;\n			if(w.referenceCount&gt;0) {\n				for(var i in w.references) {\n					var li = createTiddlyElement2(ol,'li');\n					var prefix = w.tiddler ? w.tiddler.title + ':' : '';\n					var b = createTiddlyElement2(li,'b');\n					var a = createTiddlyElement2(b,'a');\n					li.id = prefix + '_note-' + i;\n					a.href = '#' + prefix + '_ref-' + i;\n					a.innerHTML = '^';\n					w.source = w.references[i].value;\n					w.nextMatch = 0;\n					w.subWikifyUnterm(li);\n				}\n			}\n			w.source = oldSource;\n		}\n		w.nextMatch = this.lookaheadRegExp.lastIndex;\n	}\n},\n\n{\n	name: 'mediaWikiRepeatReference',\n	match: '&lt;ref[^/]*/&gt;',\n	lookaheadRegExp: /&lt;ref(\ss+(?:.*?)=[&quot;'](?:.*?)[&quot;'])?\ss*\s/&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var x = {id:'',value:''};\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n			var s = createTiddlyElement(w.output,&quot;sup&quot;,null,&quot;reference&quot;);\n			var a = createTiddlyElement2(s,&quot;a&quot;);\n			var prefix = w.tiddler ? w.tiddler.title : '';\n			if(lookaheadMatch[1]) {\n				var r = {};\n				r = MediaWikiFormatter.setFromParams(w,lookaheadMatch[1]);\n				var name = r.name ? r.name.trim() : '';\n				name = name.replace(/ /g,'_');\n				s.id = prefix + '_ref-' + name +'_' + (w.referenceCount+1);\n				var count = w.references &amp;&amp; w.references[name] ? (w.references[name].id+1) : '?';\n			}\n			a.href = '#' + prefix + '_note-' + name;\n			a.innerHTML = '['+count+']';\n			a.title = name;\n		}\n	}//# end handler\n},\n\n{\n	name: 'mediaWikiHtmlEntitiesEncoding',\n	match: '&amp;#?[a-zA-Z0-9]{2,8};',\n	handler: function(w)\n	{\n		createTiddlyElement2(w.output,'span').innerHTML = w.matchText;\n	}\n},\n\n{\n	name: 'mediaWikiComment',\n	match: '&lt;!\s\s-\s\s-',\n	lookaheadRegExp: /&lt;!\s-\s-((?:.|\sn)*?)\s-\s-&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'mediaWikiIncludeOnly',\n	match: '&lt;includeonly&gt;',\n	lookaheadRegExp: /&lt;includeonly&gt;((?:.|\sn)*?)&lt;\s/includeonly&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'mediaWikiNoWiki',\n	match: '&lt;nowiki&gt;',\n	lookaheadRegExp: /&lt;nowiki&gt;((?:.|\sn)*?)&lt;\s/nowiki&gt;/mg,\n	element: 'span',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'mediaWikiPreNoWiki',\n	match: '&lt;pre&gt;\ss*&lt;nowiki&gt;',\n	lookaheadRegExp: /&lt;pre&gt;\ss*&lt;nowiki&gt;((?:.|\sn)*?)&lt;\s/nowiki&gt;\ss*&lt;\s/pre&gt;/mg,\n	element: 'pre',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'mediaWikiPre',\n	match: '&lt;pre&gt;',\n	lookaheadRegExp: /&lt;pre&gt;((?:.|\sn)*?)&lt;\s/pre&gt;/mg,\n	element: 'pre',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'mediaWikiGallery',\n	match: '&lt;gallery&gt;',\n	lookaheadRegExp: /[Ii]mage:(.*?)\sn/mg,\n	handler: function(w)\n	{\n		var table = createTiddlyElement(w.output,'table',null,'gallery');\n		table.cellspacing = '0';\n		table.cellpadding = '0';\n		var rowElem = createTiddlyElement2(table,'tr');\n		var col = 0;\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var nM = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		var oldSource = w.source;\n		while(lookaheadMatch) {\n			nM += lookaheadMatch[1].length;\n			w.source = lookaheadMatch[1] +']]';//!! ]] is hack until getParams is working\n			w.nextMatch = 0;\n			var params = MediaWikiFormatter.getParams(w);\n			var src = params[1];\n			src = src.trim().replace(/ /mg,'_');\n			src = src.substr(0,1).toUpperCase() + src.substring(1);\n			var palign = 'right'; \n			var psrc = '120px-'+src;\n			var px = 120;\n			var pframed = false;\n			ptitle = null;\n			for(var i=2;i&lt;params.length;i++) {\n				//right, left, center, none, sizepx, thumbnail (thumb), frame, and alternate (caption) text.\n				var p = params[i];\n				if(p=='right'||p=='left'||p=='center'||p=='none') {\n					palign = p;\n				} else if(p=='framed') {\n					pframed = true;\n				} else if(/\sd{1,4}px/.exec(p)) {\n					px = p.substr(0,p.length-2).trim();\n					psrc = px + 'px-' + src;\n				} else {\n					ptitle = p;\n				}\n			}//#end for\n			var td = createTiddlyElement2(rowElem,'td');\n			var gb = createTiddlyElement(td,'div',null,'gallerybox');\n			var t = createTiddlyElement(gb,'div',null,'thumb');\n			t.style['padding'] = '26px 0';\n\n			var a = createTiddlyElement2(t,'a');\n			if(config.options.chkMediaWikiDisplayEnableThumbZoom) {\n				a.href = src;\n			}\n			a.title = ptitle;\n			var img = createTiddlyElement2(a,'img');\n			img.src = psrc;\n			img.width = px;\n			img.alt = '';//ptitle;\n\n			var gt = createTiddlyElement(gb,'div',null,'gallerytext');\n			p = createTiddlyElement2(gt,'p');\n			var oldSource2 = w.source; var oldMatch = w.nextMatch;\n			w.source = ptitle; w.nextMatch = 0;\n			w.subWikifyUnterm(p);\n			w.source = oldSource2; w.nextMatch = oldMatch;\n\n			col++;\n			if(col&gt;3) {\n				rowElem = createTiddlyElement2(table,'tr');\n				col = 0;\n			}\n			w.source = oldSource;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n		w.nextMatch = nM + '&lt;gallery&gt;'.length*2+1+'Image:'.length;//!! hack\n	}\n},\n\n{\n	name: 'mediaWikiHtmlTag',\n	match: &quot;&lt;[a-zA-Z]{2,}(?:\s\ss*(?:(?:.*?)=[\s&quot;']?(?:.*?)[\s&quot;']?))*?&gt;&quot;,\n	lookaheadRegExp: /&lt;([a-zA-Z]{2,})((?:\ss+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)*?)?\ss*(\s/)?&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var e =createTiddlyElement2(w.output,lookaheadMatch[1]);\n			if(lookaheadMatch[2]) {\n				MediaWikiFormatter.setAttributesFromParams(e,lookaheadMatch[2]);\n			}\n			if(lookaheadMatch[3]) {\n				w.nextMatch = this.lookaheadRegExp.lastIndex;// empty tag\n			} else {\n				w.subWikify(e,'&lt;/'+lookaheadMatch[1]+'&gt;');\n			}\n		}\n	}\n}\n];\n\nconfig.parsers.mediaWikiFormatter = new Formatter(config.mediaWikiFormatters);\nconfig.parsers.mediaWikiFormatter.format = 'MediaWiki';\nconfig.parsers.mediaWikiFormatter.formatTag = 'MediaWikiFormat';\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="MediaWikiAdaptorPlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|MediaWikiAdaptorPlugin|\n|''Description:''|Adaptor for moving and converting data to and from MediaWikis|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/martinsprereleases.html#MediaWikiAdaptorPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/MediaWikiAdaptorPlugin.js|\n|''Version:''|0.1.2|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n\n''For debug:''\n|''Default MediaWiki Server''|&lt;&lt;option txtmediaWikiDefaultServer&gt;&gt;|\n\n***/\n\n//{{{\nif(!config.options.txtmediaWikiDefaultServer)\n	{config.options.txtmediaWikiDefaultServer = 'www.wikipedia.org';}\n//}}}\n\n//{{{\n// Ensure that the plugin is only installed once.\nif(!version.extensions.MediaWikiAdaptorPlugin) {\nversion.extensions.MediaWikiAdaptorPlugin = {installed:true};\n\nMediaWikiAdaptor = {}; // 'namespace' for local functions\n\nMediaWikiAdaptor.anyChild = function(obj)\n{\n	for(var key in obj) {\n		return obj[key];\n	}\n	return null;\n};\n\nMediaWikiAdaptor.canonicalTitle = function(title)\n{\n	var canonicalTitle = title.charAt(0).toUpperCase() + title.substr(1);\n	return canonicalTitle.replace(/\ss/g,'_');\n};\n\nMediaWikiAdaptor.getTiddler = function(title,params)\n{\n	var canonicalTitle = MediaWikiAdaptor.canonicalTitle(title);\n	params.title = title;\n	params.serverWorkspace = null;\n	params.wikiformat = 'MediaWiki';\n	params.serverType = 'mediawiki';\n	var urlTemplate = '%0/w/api.php?format=json&amp;action=%1&amp;prop=revisions&amp;rvprop=content&amp;titles=%2';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var url = urlTemplate.format([params.serverHost,'query',canonicalTitle]);\n	var req = doHttp('GET',url,null,null,null,null,MediaWikiAdaptor.getTiddlerCallback,params,null);\n};\n\nMediaWikiAdaptor.getTiddlerCallback = function(status,params,responseText,xhr)\n{\n	var content = null;\n	try {\n		eval('var queryResult=' + responseText);\n		var page = MediaWikiAdaptor.anyChild(queryResult.query.pages);\n		var revision = MediaWikiAdaptor.anyChild(page.revisions);\n		content = revision['*'];\n		var revid = revision['revid'];\n	} catch (ex) {\n		alert('Oh dear, the JSON stuff went awry');\n		displayMessage('Response:'+responseText);\n		// do something drastic here\n	}\n\n	/*var links = page.links;\n	if (links &amp;&amp; links.length) {\n		alert(links[0]['*'] + ' is linked from ' + title);\n		tiddler.text += links[0]['*'];\n	} else {\n		alert('No links on ' + title + ' found');\n	}*/\n\n	if(content) {\n		var tiddler = store.createTiddler(params.title);\n		tiddler.fields['mediawiki.revid'] = String(revid);\n		tiddler.updateFieldsAndContent(params,content);\n	}\n};\n\nMediaWikiAdaptor.putTiddler = function(title,params)\n{\n	displayMessage('MediaWiki does not have a REST API for PUT yet');\n};\n\nMediaWikiAdaptor.putTiddlerCallback = function(status,params,responseText,xhr)\n{\n};\n\nconfig.hostFunctions.getTiddler['mediawiki'] = MediaWikiAdaptor.getTiddler;\n//config.hostFunctions.putTiddler['mediawiki'] = MediaWikiAdaptor.putTiddler;\n\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="TWikiFormatterPlugin" modifier="MartinBudden" modified="200607210000" created="200607210000" tags="systemConfig excludeLists">/***\n|''Name:''|TWikiFormatterPlugin|\n|''Description:''|Allows Tiddlers to use [[TWiki|http://twiki.org/cgi-bin/view/TWiki/TextFormattingRules]] text formatting|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinplugins.tiddlywiki.com/#TWikiFormatterPlugin|\n|''Subversion:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins|\n|''Version:''|0.2.1|\n|''Status:''|beta release|\n|''Date:''|Nov 5, 2006|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.1.3|\n\n|''Display unsupported TWiki variables''|&lt;&lt;option chkDisplayTWikiVariables&gt;&gt;|\n\nThis the TWikiFormatterPlugin, which allows you to insert TWiki formated text into a TiddlyWiki.\n\nThe aim is not to fully emulate TWiki, but to allow you to create TWiki content off-line and then paste\nthe content into your TWiki later on, with the expectation that only minor edits will be required.\n\nTo use TWiki format in a Tiddler, tag the Tiddler with TWikiFormat. See [[testTwikiFormat]] for an example.\n\nPlease report any defects you find at http://groups.google.co.uk/group/TiddlyWikiDev\n\nThis is a beta release, with (at least) the following known issues:\n# Table code is incomplete.\n## Table headings not yet supported.\n# Anchors not yet supported.\n# TWiki variables not supported\n\n***/\n\n//{{{\n// Ensure that the TWikiFormatter Plugin is only installed once.\nif(!version.extensions.TWikiFormatterPlugin) {\nversion.extensions.TWikiFormatterPlugin = {installed:true};\n\nif(version.major &lt; 2 || (version.major == 2 &amp;&amp; version.minor &lt; 1))\n	{alertAndThrow('TWikiFormatterPlugin requires TiddlyWiki 2.1 or later.');}\n\nif(config.options.chkDisplayTWikiVariables == undefined)\n	{config.options.chkDisplayTWikiVariables = false;}\n\nTWikiFormatter = {}; // 'namespace' for local functions\n\ntwDebug = function(out,str)\n{\n	createTiddlyText(out,str.replace(/\sn/mg,'\s\sn').replace(/\sr/mg,'RR'));\n	createTiddlyElement(out,'br');\n};\n\nTiddler.prototype.escapeLineBreaks = function()\n{\n	var r = this.text.escapeLineBreaks();\n	if(this.isTagged('TWikiFormat')) {\n		r = r.replace(/\sx20\sx20\sx20/mg,'\s\sb \s\sb');\n		r = r.replace(/\sx20\sx20/mg,'\s\sb ');\n	}\n	return r;\n};\n\nconfig.textPrimitives.twikiLink = '(?:' + \n		config.textPrimitives.upperLetter + '+' + config.textPrimitives.lowerLetter + '+' +\n		config.textPrimitives.upperLetter + config.textPrimitives.anyLetter + '*)';\n\nTWikiFormatter.setAttributesFromParams = function(e,p)\n{\n	var re = /\ss*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\sw|%|#)*))/mg;\n	var match = re.exec(p);\n	while(match) {\n		var s = match[1].unDash();\n		if(s == 'bgcolor') {\n			s = 'backgroundColor';\n		}\n		try {\n			if(match[2]) {\n				e.setAttribute(s,match[2]);\n			} else if(match[3]) {\n				e.setAttribute(s,match[3]);\n			} else {\n				e.setAttribute(s,match[4]);\n			}\n		}\n		catch(ex) {}\n		match = re.exec(p);\n	}\n};\n\nconfig.formatterHelpers.singleCharFormat = function(w)\n{\n	this.lookaheadRegExp.lastIndex = w.matchStart;\n	var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n	if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart &amp;&amp; lookaheadMatch[0].substr(lookaheadMatch[0].length-2,1) != ' ') {\n		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);\n		w.nextMatch = this.lookaheadRegExp.lastIndex;\n	} else {\n		w.outputText(w.output,w.matchStart,w.nextMatch);\n	}\n};\n\nconfig.formatterHelpers.doubleCharFormat = function(w)\n{\n	this.lookaheadRegExp.lastIndex = w.matchStart;\n	var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n//twDebug(w.output,'dcmt:'+w.matchText);\n//twDebug(w.output,'lm:'+lookaheadMatch);\n//twDebug(w.output,'lm0:'+lookaheadMatch[0]+' lm:'+lookaheadMatch[0].length);\n	if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart &amp;&amp;\n			lookaheadMatch[0].substr(lookaheadMatch[0].length-3,1) != ' ') {\n		var e = createTiddlyElement(w.output,this.element);\n		w.subWikifyTerm(createTiddlyElement(e,this.element2),this.termRegExp);\n		w.nextMatch = this.lookaheadRegExp.lastIndex;\n	} else {\n		w.outputText(w.output,w.matchStart,w.nextMatch);\n	}\n};\n\nconfig.twikiFormatters = [\n{\n	name: 'twikiTable',\n	match: '^\s\s|(?:[^\s\sn]*)\s\s|$',\n	lookaheadRegExp: /^\s|([^\sn]*)\s|$/mg,\n	rowTermRegExp: /(\s|$\sn?)/mg,\n	cellRegExp: /(?:\s|([^\sn\s|]*)\s|)|(\s|$\sn?)/mg,\n	cellTermRegExp: /((?:\sx20*)\s|)/mg,\n	handler: function(w)\n	{\n		var table = createTiddlyElement(w.output,'table');\n		var rowContainer = table;//createTiddlyElement(table,'tbody');\n		var prevColumns = [];\n		var rowCount = 0;\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			var rowClass = (rowCount&amp;1) ? 'TD.odd' : 'TD.even';\n			if(rowCount==1) rowClass = 'TD.heading';\n			if(rowCount==3) rowClass = 'TD.third';\n			this.rowHandler(w,createTiddlyElement(rowContainer,'tr',null,rowClass),prevColumns);\n			rowCount++;\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	},\n	rowHandler: function(w,e,prevColumns)\n	{\n		var col = 0;\n		var colSpanCount = 1;\n		var prevCell = null;\n		this.cellRegExp.lastIndex = w.nextMatch;\n		var cellMatch = this.cellRegExp.exec(w.source);\n		while(cellMatch &amp;&amp; cellMatch.index == w.nextMatch) {\n			if(cellMatch[1] == '^') {\n				// Rowspan\n				var last = prevColumns[col];\n				if(last) {\n					last.rowSpanCount++;\n					last.element.setAttribute('rowspan',last.rowSpanCount);\n					last.element.setAttribute('rowSpan',last.rowSpanCount); // Needed for IE\n					last.element.valign = 'center';\n				}\n				w.nextMatch = this.cellRegExp.lastIndex-1;\n			} else if(cellMatch[1] === '') {\n				// Colspan\n				colSpanCount++;\n				w.nextMatch = this.cellRegExp.lastIndex-1;\n			} else if(cellMatch[2]) {\n				// End of row\n				if(prevCell &amp;&amp; colSpanCount &gt; 1) {\n					prevCell.setAttribute('colspan',colSpanCount);\n					prevCell.setAttribute('colSpan',colSpanCount); // Needed for IE\n				}\n				w.nextMatch = this.cellRegExp.lastIndex;\n				break;\n			} else {\n				// Cell\n				w.nextMatch++;\n				var spaceLeft = false;\n				var chr = w.source.substr(w.nextMatch,1);\n				while(chr == ' ') {\n					spaceLeft = true;\n					w.nextMatch++;\n					chr = w.source.substr(w.nextMatch,1);\n				}\n				var cell = createTiddlyElement(e,'td');\n				prevCell = cell;\n				prevColumns[col] = {rowSpanCount:1, element:cell};\n				if(colSpanCount &gt; 1) {\n					cell.setAttribute('colspan',colSpanCount);\n					cell.setAttribute('colSpan',colSpanCount); // Needed for IE\n					colSpanCount = 1;\n				}\n				\n				w.subWikifyTerm(cell,this.cellTermRegExp);\n				if(w.matchText.substr(w.matchText.length-2,1) == ' ') {\n					// spaceRight\n					cell.align = spaceLeft ? 'center' : 'left';\n				} else if(spaceLeft) {\n					cell.align = 'right';\n				}\n				w.nextMatch--;\n			}\n			col++;\n			this.cellRegExp.lastIndex = w.nextMatch;\n			cellMatch = this.cellRegExp.exec(w.source);\n		}\n	}\n},\n\n{\n	name: 'twikiRule',\n	match: '^---+$\s\sn?',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'hr');\n	}\n},\n\n{\n//&lt;h1&gt;&lt;a name='TWiki_Text_Formatting'&gt;&lt;/a&gt; TWiki Text Formatting &lt;/h1&gt;\n	name: 'twikiHeading',\n	match: '^---[\s\s+#]{0,5}',\n	lookaheadRegExp: /^---[\s+#]{0,5}(?:!!)? ?(.*?)\sn/mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n		var h = createTiddlyElement(w.output,'h' + (w.matchLength-2));\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var a = createTiddlyElement(w.output,'a');\n			var prefix = w.tiddler ? w.tiddler.title : '';\n			var name = '#'+ prefix + lookaheadMatch[1];\n			name = name.replace(/ /g,'_');\n			a.name = name;\n			w.nextMatch = this.lookaheadRegExp.lastIndex - lookaheadMatch[1].length - 1;\n			w.subWikifyTerm(h,this.termRegExp);\n		}\n	}\n},\n\n{\n	name: 'twikiAnchor',\n	match: '^#' + config.textPrimitives.wikiLink + '\s\ss',\n	lookaheadRegExp: /^#(.*?)\ss/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var a = createTiddlyElement(w.output,'a');\n			var prefix = w.tiddler ? w.tiddler.title : '';\n			var name = '#'+ prefix + lookaheadMatch[1];\n			name = name.replace(/ /g,'_');\n			a.name = name;\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'twikiDefinitionList',\n	match: '^   \s\s$ .+?:.+?\s\sn',\n	lookaheadRegExp: /^   \s$ (.+?):(.+?)\sn/mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n		var li = createTiddlyElement(w.output,'dl');\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			w.nextMatch += 5;\n			w.subWikifyTerm(createTiddlyElement(li,'dt'),/(:)/mg);\n			w.subWikifyTerm(createTiddlyElement(li,'dd'),this.termRegExp);\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	}\n},\n\n{\n	name: 'twikiList',\n	match: '^(?:   )+(?:(?:\s\s*)|(?:[1AaIi](?:\s\s.)?)) ',\n	lookaheadRegExp: /^(?:   )+(?:(\s*)|(?:([1AaIi])(\s.)?)) /mg,\n	//termRegExp: /(\sn\sn|\sn(?=(?:   )+[\s\s*1AaIi]))/mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n//twDebug(w.output,'mt:'+w.matchText);\n		var stack = [w.output];\n		var currLevel = 0;\n		var currType = null;\n		var listLevel, listType;\n		var itemType = 'li';\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n//twDebug(w.output,'lm0:'+lookaheadMatch[0]);\n			listType = 'ol';\n			listLevel = (lookaheadMatch[0].length-(lookaheadMatch[3]?3:2))/3;\n			var style = null;\n			if(lookaheadMatch[1]=='*') {\n				listType = 'ul';\n			} else if(lookaheadMatch[2]=='1') {\n				style = 'decimal';\n			} else if(lookaheadMatch[2]=='A') {\n				style = 'upper-alpha';\n			} else if(lookaheadMatch[2]=='a') {\n				style = 'lower-alpha';\n			} else if(lookaheadMatch[2]=='I') {\n				style = 'upper-roman';\n			} else if(lookaheadMatch[2]=='i') {\n				style = 'lower-roman';\n			}\n			w.nextMatch += lookaheadMatch[0].length;\n			if(listLevel &gt; currLevel) {\n				for(var i=currLevel; i&lt;listLevel; i++) {\n					stack.push(createTiddlyElement(stack[stack.length-1],listType));\n				}\n			} else if(listLevel &lt; currLevel) {\n				for(i=currLevel; i&gt;listLevel; i--) {\n					stack.pop();\n				}\n			} else if(listLevel == currLevel &amp;&amp; listType != currType) {\n				stack.pop();\n				stack.push(createTiddlyElement(stack[stack.length-1],listType));\n			}\n			currLevel = listLevel;\n			currType = listType;\n			var e = createTiddlyElement(stack[stack.length-1],itemType);\n			e.style[config.browser.isIE ? 'list-style-type' : 'listStyleType'] = style;\n			w.subWikifyTerm(e,this.termRegExp);\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	}\n},\n\n{\n	name: 'twikiNoAutoLink',\n	match: '^\s\ss*&lt;noautolink&gt;',\n	lookaheadRegExp: /\ss*&lt;noautolink&gt;((?:.|\sn)*?)&lt;\s/noautolink&gt;/mg,\n	termRegExp: /(&lt;\s/noautolink&gt;)/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var autoLinkWikiWords = w.autoLinkWikiWords;\n			w.autoLinkWikiWords = false;\n			w.subWikifyTerm(w.output,this.termRegExp);\n			w.autoLinkWikiWords = autoLinkWikiWords;\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		} else {\n			w.outputText(w.output,w.matchStart,w.nextMatch);\n		}\n	}\n},\n\n{\n	name: 'macro',\n	match: '&lt;&lt;',\n	lookaheadRegExp: /&lt;&lt;([^&gt;\ss]+)(?:\ss*)((?:[^&gt;]|(?:&gt;(?!&gt;)))*)&gt;&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart &amp;&amp; lookaheadMatch[1]) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);\n		}\n	}\n},\n\n{\n	name: 'twikiNotExplicitLink',\n	match: '!\s\s[\s\s[',\n	handler: function(w)\n	{\n		w.outputText(w.output,w.matchStart+1,w.nextMatch);\n	}\n},\n\n//[[WikiWord#NotThere]]\n//[[#MyAnchor][Jump]]\n//&lt;a href='/cgi-bin/view/Sandbox/WebHome#Sandbox_Web_Site_Tools'&gt; Sandbox Web Site Tools &lt;/a&gt;\n//&lt;a href='/cgi-bin/view/Sandbox/MeetingMinutes' class='twikiLink'&gt;MeetingMinutes&lt;/a&gt;\n{\n	name: 'twikiAnchorLink',\n	match: '\s\s[\s\s[(?:'+ config.textPrimitives.twikiLink +')?#',\n	lookaheadRegExp: /\s[\s[(.*?)?#(.*?)(?:\s]\s[(.*?))?\s]\s]/mg,\n	handler: function(w)\n	{\n//twDebug(w.output,'al:'+w.matchText);\n//twDebug(w.output,'lm:'+lookaheadMatch);\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n//twDebug(w.output,'lm0:'+lookaheadMatch[0]);\n			var a = createTiddlyElement(w.output,'a');\n			var prefix = w.tiddler ? w.tiddler.title : '';\n			var href = lookaheadMatch[1] ? lookaheadMatch[1] : '';\n			href += '#' + prefix + lookaheadMatch[2];\n			href = href.replace(/ /g,'_');\n//twDebug(w.output,'hr:'+href);\n			a.href = href;\n			a.innerHTML = lookaheadMatch[3] ? lookaheadMatch[3] : lookaheadMatch[2];\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'twikiExplicitLink',\n	match: '\s\s[\s\s[',\n	lookaheadRegExp: /\s[\s[(.*?)(?:\s]\s[(.*?))?\s]\s]/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var e = null;\n			var link = lookaheadMatch[1];\n			if (lookaheadMatch[2]) {\n				// titled bracketted link\n				var text = lookaheadMatch[2];\n				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);\n			} else {\n				// simple bracketted link\n				text = link;\n				var s = text.indexOf(' ');\n				if(s!=-1) {\n					link = text.substring(0,s).trim();\n					if(config.formatterHelpers.isExternalLink(link)) {\n						e = createExternalLink(w.output,link);\n						text = text.substring(s+1).trim();\n					} else {\n						e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);\n					}\n				} else {\n					e = createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);\n				}\n			}\n			createTiddlyText(e,text);\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'twikiNotWikiLink',\n	match: '(?:!|&lt;nop&gt;)' + config.textPrimitives.wikiLink,\n	handler: function(w)\n	{\n		w.outputText(w.output,w.matchStart+(w.matchText.substr(0,1)=='!'?1:5),w.nextMatch);\n	}\n},\n\n{\n	name: 'twikiWikiLink',\n	match: config.textPrimitives.twikiLink,\n	handler: function(w)\n	{\n		if(w.matchStart &gt; 0) {\n			var preRegExp = new RegExp(config.textPrimitives.anyLetter,'mg');\n			preRegExp.lastIndex = w.matchStart-1;\n			var preMatch = preRegExp.exec(w.source);\n			if(preMatch.index == w.matchStart-1) {\n				w.outputText(w.output,w.matchStart,w.nextMatch);\n				return;\n			}\n		}\n		if(w.autoLinkWikiWords == true || store.isShadowTiddler(w.matchText)) {\n			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);\n			w.outputText(link,w.matchStart,w.nextMatch);\n		} else {\n			w.outputText(w.output,w.matchStart,w.nextMatch);\n		}\n	}\n},\n\n{\n	name: 'twikiUrlLink',\n	match: config.textPrimitives.urlPattern,\n	handler: function(w)\n	{\n		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);\n	}\n},\n\n{\n	name: 'twikiBoldByChar',\n	match: '\s\s*(?!\s\ss)',\n	lookaheadRegExp: /\s*(?!\ss)(?:.*?)(?!\ss)\s*(?=\sW)/mg,\n	termRegExp: /((?!\ss)\s*(?=\sW))/mg,\n	element: 'strong',\n	handler: config.formatterHelpers.singleCharFormat\n},\n\n{\n	name: 'twikiBoldTag',\n	match: '&lt;b&gt;',\n	termRegExp: /(&lt;\s/b&gt;)/mg,\n	element: 'b',\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: 'twikiBoldItalicByChar',\n	match: '__(?!\s\ss)',\n	lookaheadRegExp: /__(?!\ss)(?:.*?)(?!\ss)__(?=\sW)/mg,\n	termRegExp: /((?!\ss)__(?=\sW))/mg,\n	element: 'strong',\n	element2: 'em',\n	handler: config.formatterHelpers.doubleCharFormat\n},\n\n{\n	name: 'twikiItalicByChar',\n	match: '_(?![\s\ss|_])',\n	lookaheadRegExp: /_(?!\ss)(?:.*?)(?!\ss)_(?=\sW)/mg,\n	termRegExp: /((?!\ss)_(?=\sW))/mg,\n	element: 'em',\n	handler: config.formatterHelpers.singleCharFormat\n},\n\n{\n	name: 'twikiBoldMonoSpacedByChar',\n	match: '==(?!\s\ss)',\n	lookaheadRegExp: /==(?!\ss)(?:.*?)(?!\ss)==(?=\sW)/mg,\n	termRegExp: /((?!\ss)==(?=\sW))/mg,\n	element: 'strong',\n	element2: 'code',\n	handler: config.formatterHelpers.doubleCharFormat\n},\n\n{\n	name: 'twikiMonoSpacedByChar',\n	match: '=(?![\s\ss=])',\n	lookaheadRegExp: /=(?!\ss)(?:.*?)(?!\ss)=(?!\sw|\s'|\s&quot;)/mg,\n	termRegExp: /((?!\ss)=(?!\sw|\s'|\s&quot;))/mg,\n	element: 'code',\n	handler: config.formatterHelpers.singleCharFormat\n},\n\n{\n	name: 'twikiPreByChar',\n	match: '&lt;pre&gt;',\n	lookaheadRegExp: /&lt;pre&gt;((?:.|\sn)*?)&lt;\s/pre&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			createTiddlyElement(w.output,'pre',null,null,lookaheadMatch[1]);\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'twikiVerbatimByChar',\n	match: '&lt;verbatim&gt;',\n	lookaheadRegExp: /\s&lt;verbatim&gt;((?:.|\sn)*?)&lt;\s/verbatim&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			createTiddlyElement(w.output,'span',null,null,lookaheadMatch[1]);\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'twikiParagraph',\n	match: '\s\sn{2,}',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'p');\n	}\n},\n\n{\n	name: 'twikiNop',\n	match: '&lt;nop&gt;',\n	handler: function(w)\n	{\n		w.outputText(w.output,w.matchStart+5,w.nextMatch);\n	}\n},\n\n{\n	name: 'twikiExplicitLineBreak',\n	match: '%BR%|&lt;br ?/?&gt;',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'br');\n	}\n},\n\n{\n	name: 'twikiColorByChar',\n	match: '%(?:YELLOW|ORANGE|RED|PINK|PURPLE|TEAL|NAVY|BLUE|AQUA|LIME|GREEN|OLIVE|MAROON|BROWN|BLACK|GRAY|SILVER|WHITE)%',\n	lookaheadRegExp: /%(YELLOW|ORANGE|RED|PINK|PURPLE|TEAL|NAVY|BLUE|AQUA|LIME|GREEN|OLIVE|MAROON|BROWN|BLACK|GRAY|SILVER|WHITE)/mg,\n	termRegExp: /(%ENDCOLOR%)/mg,\n	handler:  function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var e = createTiddlyElement(w.output,'span');\n			e.style.color = lookaheadMatch[1];\n			w.subWikifyTerm(e,this.termRegExp);\n		}\n	}\n},\n\n{\n	name: 'twikiVariable',\n	match: '(?:!)?%(?:&lt;nop&gt;)?[A-Z]+(?:\s\s{.*?\s\s})?%',\n	lookaheadRegExp: /(!)?%(&lt;nop&gt;)?([A-Z]+)(?:\s{(.*?)\s})?%/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			if(lookaheadMatch[1]) {\n				// ! - escape variable\n				w.outputText(w.output,w.matchStart+1,w.nextMatch);\n			} else if(lookaheadMatch[2]) {\n				//nop\n				var text = w.matchText.replace(/&lt;nop&gt;/g,'');\n				createTiddlyText(w.output,text);\n			} else {\n				// deal with variables by name here\n				if(lookaheadMatch[3]=='BB') {\n					createTiddlyElement(w.output,'br');\n					createTiddlyElement(w.output,'span').innerHTML = '&amp;bull;';\n				} else if(config.options.chkDisplayTWikiVariables) {\n					// just output the text of any variables that are not understood\n					w.outputText(w.output,w.matchStart,w.nextMatch);\n				}\n			}\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'twikiHtmlEntitiesEncoding',\n	match: '&amp;#?[a-zA-Z0-9]{2,8};',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'span').innerHTML = w.matchText;\n	}\n},\n\n{\n	name: 'twikiComment',\n	match: '&lt;!\s\s-\s\s-',\n	lookaheadRegExp: /&lt;!\s-\s-((?:.|\sn)*?)\s-\s-&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'twikiHtmlTag',\n	match: &quot;&lt;(?:[a-zA-Z]{2,}|a)(?:\s\ss*(?:[a-zA-Z]*?=[\s&quot;']?[^&gt;]*?[\s&quot;']?))*?&gt;&quot;,\n	lookaheadRegExp: /&lt;([a-zA-Z]+)((?:\ss+[a-zA-Z]*?=[&quot;']?[^&gt;\s/\s&quot;\s']*?[&quot;']?)*?)?\ss*(\s/)?&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var e =createTiddlyElement(w.output,lookaheadMatch[1]);\n			if(lookaheadMatch[2]) {\n				TWikiFormatter.setAttributesFromParams(e,lookaheadMatch[2]);\n			}\n			if(lookaheadMatch[3]) {\n				w.nextMatch = this.lookaheadRegExp.lastIndex;// empty tag\n			} else {\n				w.subWikify(e,'&lt;/'+lookaheadMatch[1]+'&gt;');\n			}\n		}\n	}\n}\n];\n\nconfig.parsers.twikiFormatter = new Formatter(config.twikiFormatters);\nconfig.parsers.twikiFormatter.format = 'TWiki';\nconfig.parsers.twikiFormatter.formatTag = 'TWikiFormat';\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="TWikiAdaptorPlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|TWikiAdaptorPlugin|\n|''Description:''|Adaptor for moving and converting data to and from TWikis|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/martinsprereleases.html#TWikiAdaptorPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/TWikiAdaptorPlugin.js|\n|''Version:''|0.1.5|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n\n''For debug:''\n|''Default TWiki Server''|&lt;&lt;option txttwikiDefaultServer&gt;&gt;|\n|''Default TWiki Web(workspace)''|&lt;&lt;option txttwikiDefaultWorkspace&gt;&gt;|\n|''Default TWiki username''|&lt;&lt;option txttwikiUsername&gt;&gt;|\n|''Default TWiki password''|&lt;&lt;option txttwikiPassword&gt;&gt;|\n\n\n***/\n\n//{{{\nif(!config.options.txttwikiDefaultServer)\n	{config.options.txttwikiDefaultServer = 'twiki.org';}\nif(!config.options.txttwikiDefaultWorkspace)\n	{config.options.txttwikiDefaultWorkspace = 'Main';}\nif(!config.options.txttwikiUsername)\n	{config.options.txttwikiUsername = '';}\nif(!config.options.txttwikiPassword)\n	{config.options.txttwikiPassword = '';}\n//}}}\n\n// Ensure that the plugin is only installed once.\nif(!version.extensions.TWikiAdaptorPlugin) {\nversion.extensions.TWikiAdaptorPlugin = {installed:true};\n\nTWikiAdaptor = {}; // 'namespace' for local functions\n\nTWikiAdaptor.getTiddler = function(title,params)\n{\n// http://twiki.org/cgi-bin/view/TWiki04/TWikiScripts\n// http://twiki.org/cgi-bin/view/TWiki04/TWikiScripts?raw=text\n\n	var urlTemplate = '%0/view/%1/%2?raw=text';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var serverHost = params.serverHost;\n	if(!serverHost.match(/\s/bin$/))\n		serverHost += '/cgi-bin';\n	var url = urlTemplate.format([serverHost,params.serverWorkspace,title]);\n\n	params.title = title;\n	params.wikiformat = 'TWiki';\n	var req = doHttp('GET',url,null,null,null,null,TWikiAdaptor.getTiddlerCallback,params,null);\n};\n\nTWikiAdaptor.getTiddlerCallback = function(status,params,responseText,xhr)\n{\n	var content = responseText;\n//&lt;form&gt;&lt;textarea readonly=&quot;readonly&quot; wrap=&quot;virtual&quot; rows=&quot;50&quot; cols=&quot;80&quot;&gt;\n	var contentRegExp = /&lt;textarea.*?&gt;((?:.|\sn)*?)&lt;\s/textarea&gt;/mg;\n	contentRegExp.lastIndex = 0;\n	var match = contentRegExp.exec(responseText);\n	if(match) {\n		content = match[1].htmlDecode();\n	}\n\n	var tiddler = store.createTiddler(params.title);\n	tiddler.updateFieldsAndContent(params,content);\n};\n\nTWikiAdaptor.putTiddler = function(title,params)\n{\n	var text = store.fetchTiddler(title).text;\n	//var urlTemplate = 'http://%0/cgi-bin/save/%1/%2?text=%3';\n	//var urlTemplate = 'http://%0/cgi-bin/edit/%1/%2?text=%3';\n\n	var urlTemplate = '%0/save/%1/%2?text=%3';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var serverHost = params.serverHost;\n	if(!serverHost.match(/\s/bin$/))\n		serverHost += '/cgi-bin';\n	var url = urlTemplate.format([serverHost,params.serverWorkspace,title,text]);\n\n	params.title = title;\n	var req = doHttp('GET',url,null,null,params.username,params.password,TWikiAdaptor.putTiddlerCallback,params,null);\n};\n\nTWikiAdaptor.putTiddlerCallback = function(status,params,responseText,xhr)\n{\n	displayMessage('TWiki put status:'+status);\n};\n\nconfig.hostFunctions.getTiddler['twiki'] = TWikiAdaptor.getTiddler;\nconfig.hostFunctions.putTiddler['twiki'] = TWikiAdaptor.putTiddler;\n\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="SocialtextFormatterPlugin" modifier="MartinBudden" modified="200701210000" created="200701210000" tags="systemConfig excludeLists">/***\n|''Name:''|SocialtextFormatterPlugin|\n|''Description:''|Allows Tiddlers to use [[Socialtext|http://www.socialtext.com/]] text formatting|\n|''Author:''|MartinBudden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinplugins.tiddlywiki.com/#SocialtextFormatterPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/SocialtextFormatterPlugin.js|\n|''Version:''|0.9.3|\n|''Date:''|Jan 21, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.1.0|\n\nThis is the SocialtextFormatterPlugin, which allows you to insert Socialtext formated text into a TiddlyWiki.\n\nThe aim is not to fully emulate Socialtext, but to allow you to work with Socialtext content off-line and then resynch the content with your Socialtext wiki later on, with the expectation that only minor edits will be required.\n\nTo use Socialtext format in a Tiddler, tag the Tiddler with SocialtextFormat.\n\nPlease report any defects you find at http://groups.google.co.uk/group/TiddlyWikiDev\n***/\n\n//{{{\n// Ensure that the SocialtextFormatter Plugin is only installed once.\nif(!version.extensions.SocialtextFormatterPlugin) {\nversion.extensions.SocialtextFormatterPlugin = {installed:true};\n\nif(version.major &lt; 2 || (version.major == 2 &amp;&amp; version.minor &lt; 1))\n	{alertAndThrow('SocialtextFormatterPlugin requires TiddlyWiki 2.1 or later.');}\n\nwikify = function(source,output,highlightRegExp,tiddler)\n{\n	if(source &amp;&amp; source != '') {\n		var w = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);\n		var out = output;\n		if(tiddler &amp;&amp; (tiddler.isTagged('SocialtextFormat') || (tiddler.fields &amp;&amp; tiddler.fields.wikiformat=='socialtext')) ) {\n			var d1 = createTiddlyElement(output,'div','content-display-body','content-section-visible');\n			var d2 = createTiddlyElement(d1,'div','wikipage');\n			out = createTiddlyElement(d2,'div',null,'wiki');\n		}\n		var time1,time0 = new Date();\n		w.subWikifyUnterm(out);\n		if(tiddler &amp;&amp; config.options.chkDisplayInstrumentation) {\n			time1 = new Date();\n			var t = tiddler ? tiddler.title : source.substr(0,10);\n			displayMessage(&quot;Wikify '&quot;+t+&quot;' in &quot; + (time1-time0) + &quot; ms&quot;);\n		}\n	}\n};\n\nsocialtextFormatter = {}; // 'namespace' for local functions\n\nstDebug = function(out,str)\n{\n	createTiddlyText(out,str.replace(/\sn/mg,'\s\sn').replace(/\sr/mg,'RR'));\n	createTiddlyElement(out,'br');\n};\n\nsocialtextFormatter.Tiddler_changed = Tiddler.prototype.changed;\nTiddler.prototype.changed = function()\n{\n	if((this.fields &amp;&amp; this.fields.wikiformat=='Socialtext') || this.isTagged('SocialtextFormat')) {\n		// update the links array, by checking for Socialtext format links\n		this.links = [];\n		var tiddlerLinkRegExp = /(?:\s&quot;(.*?)\s&quot; ?)?\s[([^\s]]*?)\s]/mg;\n		tiddlerLinkRegExp.lastIndex = 0;\n		var match = tiddlerLinkRegExp.exec(this.text);\n		while(match) {\n			var link = match[2];\n			this.links.pushUnique(link);\n			match = tiddlerLinkRegExp.exec(this.text);\n		}\n	}/* else {\n		return socialtextFormatter.Tiddler_changed.apply(this,arguments);\n	}*/\n	this.linksUpdated = true;\n};\n\nsocialtextFormatter.wafl = function(w)\n{\n	this.lookaheadRegExp.lastIndex = w.matchStart;\n	var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n	if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n		var lm2 = lookaheadMatch[2];\n		switch(lookaheadMatch[1]) {\n		case 'image':\n			var img = createTiddlyElement(w.output,'img');\n			img.src = w.tiddler.title + '/' + lm2;\n			createTiddlyText(img,lm2);\n			break;\n		case 'file':\n			var s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			var a = createTiddlyElement(s,'a');\n			a.href = w.tiddler.title + '/' + lm2;\n			createTiddlyText(a,lm2);\n			break;\n		case 'link':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createTiddlyElement(s,'a');\n			var t = w.tiddler ? w.tiddler.title + ':' : '';\n			a.setAttribute('href','#' + t + lm2);\n			a.title = 'section link';\n			createTiddlyText(a,lm2);\n			break;\n		case 'weblog':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			var text = lm2;\n			var link = 'Weblog: ' + lm2;\n			createTiddlyText(createTiddlyLink(s,link,false,null,w.isStatic),text);\n			break;\n		case 'section':\n			a = createTiddlyElement(w.output,'a');// drop anchor\n			t = w.tiddler ? w.tiddler.title + ':' : '';\n			a.setAttribute('name',t + lm2);\n			break;\n		case 'date':\n			createTiddlyText(w.output,lm2);\n			break;\n		case 'user':\n			var oldSource = w.source;\n			w.source = lm2;\n			w.nextMatch = 0;\n			w.subWikifyUnterm(w.output);\n			w.source = oldSource;\n			break;\n// Shortcut expansions - not strictly syntax\n		case 'google':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createExternalLink(s,'http://www.google.com/search?q='+lm2);\n			createTiddlyText(a,lm2);\n			break;\n		case 'fedex':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createExternalLink(s,'http://www.fedex.com/Tracking?tracknumbers='+lm2);\n			createTiddlyText(a,lm2);\n			break;\n		case 'map':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createExternalLink(s,'http://maps.google.com/maps?q='+lm2);\n			createTiddlyText(a,lm2);\n			break;\n		case 'wikipedia':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createExternalLink(s,'http://en.wikipedia.org/wiki/'+lm2);\n			createTiddlyText(a,lm2);\n			break;\n		case 'rt':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createExternalLink(s,'http://rt.socialtext.net/Ticket/Display.html?id='+lm2);\n			createTiddlyText(a,lm2);\n			break;\n		case 'stcal':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createExternalLink(s,'https://calendar.socialtext.net:445/view_t.php?timeb=1&amp;id=3&amp;date='+lm2);\n			createTiddlyText(a,lm2);\n			break;\n		case 'svn':\n			s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n			a = createExternalLink(s,'https://repo.socialtext.net/listing.php?rev='+lm2+'sc=1');\n			createTiddlyText(a,lm2);\n			break;\n		default:\n			w.outputText(w.output,w.matchStart,w.nextMatch);\n			return;\n		}\n		w.nextMatch = this.lookaheadRegExp.lastIndex;\n	} else {\n		w.outputText(w.output,w.matchStart,w.nextMatch);\n	}\n};\n\nsocialtextFormatter.presence = function(w)\n{\n	this.lookaheadRegExp.lastIndex = w.matchStart;\n	var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n	if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n		var p = lookaheadMatch[1];\n		var text = lookaheadMatch[2];\n		var link;\n		var src;\n		if(p=='aim') {\n			link = 'aim:goim?screenname=' + text + '&amp;message=hello';\n			src = 'http://big.oscar.aol.com/sleepleft?on_url=http://www.aim.com/remote/gr/MNB_online.gif&amp;amp;off_url=http://www.aim.com/remote/gr/MNB_offline.gif';\n		} else if(p=='yahoo'||p=='ymsgr') {\n			link = 'ymsgr:sendIM?'+text;\n			src = 'http://opi.yahoo.com/online?u=chrislondonbridge&amp;f=.gif';\n		} else if(p=='skype'||p=='callto') {\n			link = 'callto:'+text;\n			src = 'http://goodies.skype.com/graphics/skypeme_btn_small_green.gif';\n		} else if(p=='asap') {\n			link = 'http://asap2.convoq.com/AsapLinks/Meet.aspx?l='+text;\n			src = 'http://asap2.convoq.com/AsapLinks/Presence.aspx?l='+text;\n		}\n		var s = createTiddlyElement(w.output,'span',null,'nlw_phrase');\n		var a = createExternalLink(s,link);\n		var img = createTiddlyElement(a,'img');\n		createTiddlyText(a,text);\n		img.src = src;\n		img.border='0';\n		img.alt = '(' + lookaheadMatch[1] + ')';\n		if(p=='aim') {\n			img.width='11'; img.height='13';\n		}\n		w.nextMatch = this.lookaheadRegExp.lastIndex;\n	}\n};\n\nconfig.formatterHelpers.singleCharFormat = function(w)\n{\n	this.lookaheadRegExp.lastIndex = w.matchStart;\n	var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n	if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart &amp;&amp; lookaheadMatch[0].substr(lookaheadMatch[0].length-2,1) != ' ') {\n		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);\n	} else {\n		w.outputText(w.output,w.matchStart,w.nextMatch);\n	}\n};\n\nconfig.socialTextFormatters = [\n{\n	name: 'socialtextHeading',\n	match: '^\s\s^{1,6} ?',\n	termRegExp: /(\sn+)/mg,\n	handler: function(w)\n	{\n		var len = w.matchText.trim().length;\n		var e = createTiddlyElement(w.output,'h' + len);\n		var a = createTiddlyElement(e,'a');// drop anchor\n		var t = w.tiddler ? w.tiddler.title + ':' : '';\n		len = w.source.substr(w.nextMatch).indexOf('\sn');\n		a.setAttribute('name',t+w.source.substr(w.nextMatch,len));\n		w.subWikifyTerm(e,this.termRegExp);\n	}\n},\n\n{\n	name: 'socialtextTable',\n	match: '^\s\s|(?:(?:.|\sn)*)\s\s|$',\n	lookaheadRegExp: /^\s|(?:(?:.|\sn)*)\s|$/mg,\n	cellRegExp: /(?:\s|(?:[^\s|]*)\s|)(\sn|$)?/mg,\n	cellTermRegExp: /((?:\sx20*)\s|)/mg,\n	handler: function(w)\n	{\n		var table = createTiddlyElement(w.output,'table');\n		var rowContainer = createTiddlyElement(table,'tbody');\n		var prevColumns = [];\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			var r = this.rowHandler(w,createTiddlyElement(rowContainer,'tr'),prevColumns);\n			if(!r) {\n				w.nextMatch++;\n				break;\n			}\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	},\n	rowHandler: function(w,e,prevColumns)\n	{\n		this.cellRegExp.lastIndex = w.nextMatch;\n		var cellMatch = this.cellRegExp.exec(w.source);\n		while(cellMatch &amp;&amp; cellMatch.index == w.nextMatch) {\n			w.nextMatch++;\n			var cell = createTiddlyElement(e,'td');\n			w.subWikifyTerm(cell,this.cellTermRegExp);\n			if(cellMatch[1]) {\n				// End of row\n				w.nextMatch = this.cellRegExp.lastIndex;\n				return true;\n			}\n			// Cell\n			w.nextMatch--;\n			this.cellRegExp.lastIndex = w.nextMatch;\n			cellMatch = this.cellRegExp.exec(w.source);\n		}\n		return false;\n	}\n},\n\n{\n	name: 'socialtextList',\n	match: '^[\s\s*#]+ ',\n	lookaheadRegExp: /^([\s*#])+ /mg,\n	termRegExp: /(\sn+)/mg,\n	handler: function(w)\n	{\n		var stack = [w.output];\n		var currLevel = 0, currType = null;\n		var itemType = 'li';\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			var listType = lookaheadMatch[1] == '*' ? 'ul' : 'ol';\n			var listLevel = lookaheadMatch[0].length;\n			w.nextMatch += listLevel;\n			if(listLevel &gt; currLevel) {\n				for(var i=currLevel; i&lt;listLevel; i++) {\n					stack.push(createTiddlyElement(stack[stack.length-1],listType));\n				}\n			} else if(listLevel &lt; currLevel) {\n				for(i=currLevel; i&gt;listLevel; i--) {\n					stack.pop();\n				}\n			} else if(listLevel == currLevel &amp;&amp; listType != currType) {\n				stack.pop();\n				stack.push(createTiddlyElement(stack[stack.length-1],listType));\n			}\n			currLevel = listLevel;\n			currType = listType;\n			var e = createTiddlyElement(stack[stack.length-1],itemType);\n			w.subWikifyTerm(e,this.termRegExp);\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n	}\n},\n\n{\n	name: 'socialtextQuoteByLine',\n	match: '^&gt;+',\n	lookaheadRegExp: /^&gt;+/mg,\n	termRegExp: /(\sn)/mg,\n	element: 'blockquote',\n	handler: function(w)\n	{\n		var stack = [w.output];\n		var currLevel = 0;\n		var newLevel = w.matchLength;\n		var i;\n		do {\n			if(newLevel &gt; currLevel) {\n				for(i=currLevel; i&lt;newLevel; i++) {\n					stack.push(createTiddlyElement(stack[stack.length-1],this.element));\n				}\n			} else if(newLevel &lt; currLevel) {\n				for(i=currLevel; i&gt;newLevel; i--) {\n					stack.pop();\n				}\n			}\n			currLevel = newLevel;\n			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);\n			createTiddlyElement(stack[stack.length-1],'br');\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n			var matched = lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch;\n			if(matched) {\n				newLevel = lookaheadMatch[0].length;\n				w.nextMatch += newLevel;\n			}\n		} while(matched);\n	}\n},\n\n{\n	name: 'socialtextRule',\n	match: '^----+$\s\sn+',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'hr');\n	}\n},\n\n{\n	name: 'socialtextPreformatted',\n	match: '^\s\s.pre\s\ss*\s\sn',\n	lookaheadRegExp: /^.pre\ss*\sn((?:.|\sn)*?)\sn.pre\ss*\sn/mg,\n	element: 'pre',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'socialtextHtml',\n	match: '^\s\s.html',\n	lookaheadRegExp: /\s.html((?:.|\sn)*?)\s.html/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			createTiddlyElement(w.output,'span').innerHTML = lookaheadMatch[1];\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'macro',\n	match: '&lt;&lt;',\n	lookaheadRegExp: /&lt;&lt;([^&gt;\ss]+)(?:\ss*)((?:[^&gt;]|(?:&gt;(?!&gt;)))*)&gt;&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart &amp;&amp; lookaheadMatch[1]) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);\n		}\n	}\n},\n\n{\n	name: 'socialtextExplicitLink',\n	match: '(?:&quot;.*?&quot; ?)?\s\s[',\n	lookaheadRegExp: /(?:\s&quot;(.*?)\s&quot; ?)?\s[([^\s]]*?)\s]/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var link = lookaheadMatch[2];\n			var text = lookaheadMatch[1] ? lookaheadMatch[1] : link;\n			createTiddlyText(createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler),text);\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'socialtextExternalLink',\n	match: '(?:&quot;.*?&quot; ?)?&lt;[a-z]{2,8}:',\n	lookaheadRegExp: /(?:\s&quot;(.*?)\s&quot; ?)?&lt;([a-z]{2,8}:.*?)&gt;/mg,\n	imgRegExp: /\s.(?:gif|ico|jpg|png)/g,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var link = lookaheadMatch[2];\n			var text = lookaheadMatch[1] ? lookaheadMatch[1] : link;\n			this.imgRegExp.lastIndex = 0;\n			if(this.imgRegExp.exec(link)) {\n				var img = createTiddlyElement(w.output,'img');\n				if(lookaheadMatch[1]) {\n					img.title = text;\n				}\n				img.alt = text;\n				img.src = link;\n			} else {\n				createTiddlyText(createExternalLink(w.output,link),text);\n			}\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'socialtextUrlLink',\n	match: config.textPrimitives.urlPattern,\n	handler: function(w)\n	{\n		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);\n	}\n},\n\n{\n	name: 'socialtextBold',\n	match: '\s\s*(?![\s\ss\s\s*])',\n	lookaheadRegExp: /\s*(?!\ss)(?:.*?)(?!\ss)\s*(?=[$\ss\s._\s-])/mg,\n	termRegExp: /((?!\ss)\s*(?=[$\ss\s.\s-_]))/mg,\n	element: 'strong',\n	handler: config.formatterHelpers.singleCharFormat\n},\n\n{\n	name: 'socialtextItalic',\n	match: '_(?![\s\ss_])',\n	lookaheadRegExp: /_(?!\ss)(?:.*?)(?!\ss)_(?=[$\ss\s.\s*\s-])/mg,\n	termRegExp: /((?!\ss)_(?=[$\ss\s.\s*\s-]))/mg,\n	element: 'em',\n	handler: config.formatterHelpers.singleCharFormat\n},\n\n{\n	name: 'socialtextStrike',\n	match: '-(?![\s\ss\s\s-])',\n	lookaheadRegExp: /-(?!\ss)(?:.*?)(?!\ss)-(?=[$\ss\s.\s*_])/mg,\n	termRegExp: /((?!\ss)-(?=[$\ss\s.\s*_]))/mg,\n	element: 'del',\n	handler: config.formatterHelpers.singleCharFormat\n},\n\n{\n	name: 'socialtextMonoSpaced',\n	match: '`(?![\s\ss`])',\n	lookaheadRegExp: /`(?!\ss)(?:.*?)(?!\ss)`(?=[$\ss\s.\s*\s-_,])/mg,\n	termRegExp: /((?!\ss)`(?=[$\ss\s.\s*\s-_,]))/mg,\n	element: 'tt',\n	handler: config.formatterHelpers.singleCharFormat\n},\n\n{\n	name: 'socialtextParagraph',\n	match: '\s\sn{2,}',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'p');\n	}\n},\n\n{\n	name: 'socialtextLineBreak',\n	match: '\s\sn',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'br');\n	}\n},\n\n{\n	name: 'socialtextNoWiki',\n	match: '\s\s{\s\s{',\n	lookaheadRegExp: /\s{\s{((?:.|\sn)*?)\s}\s}/mg,\n	element: 'span',\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: 'socialtextTrademark',\n	match: '\s\s{tm\s\s}',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'span').innerHTML = '&amp;trade;';\n	}\n},\n\n{\n	name: 'socialtextWafl',\n	match: '\s\s{(?:[a-z]{2,16}): ?.*?\s\s}',\n	lookaheadRegExp: /\s{([a-z]{2,16}): ?(.*?)\s}/mg,\n	handler: socialtextFormatter.wafl\n},\n\n{\n	name: 'socialtextPresence',\n	match: '(?:aim|yahoo|ymsgr|skype|callto|asap):\s\sw+',\n	lookaheadRegExp: /(aim|yahoo|ymsgr|skype|callto|asap):(\sw+)/mg,\n	handler: socialtextFormatter.presence\n},\n\n{\n	name: 'socialtextMailTo',\n	match: '[\s\sw\s.]+@[\s\sw]+\s.[\s\sw\s.]+',\n	lookaheadRegExp: /([\sw\s.]+@[\sw]+\s.[\sw\s.]+)/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var text = lookaheadMatch[1];\n			createTiddlyText(createExternalLink(w.output,'mailto:'+text),text);\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: 'socialtextHtmlEntitiesEncoding',\n	match: '&amp;#?[a-zA-Z0-9]{2,8};',\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,'span').innerHTML = w.matchText;\n	}\n}\n];\n\nconfig.parsers.socialTextFormatter = new Formatter(config.socialTextFormatters);\nconfig.parsers.socialTextFormatter.format = 'Socialtext';\nconfig.parsers.socialTextFormatter.formatTag = 'SocialtextFormat';\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="SocialtextAdaptorPlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|SocialtextAdaptorPlugin|\n|''Description:''|Adaptor for moving and converting data to and from Socialtext Wikis|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/martinsprereleases.html#SocialtextAdaptorPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/SocialtextAdaptorPlugin.js|\n|''Version:''|0.1.5|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n\n''For debug:''\n|''Default Socialtext Server''|&lt;&lt;option txtsocialtextDefaultServer&gt;&gt;|\n|''Default Socialtext Workspace''|&lt;&lt;option txtsocialtextDefaultWorkspace&gt;&gt;|\n|''Default Socialtext username''|&lt;&lt;option txtsocialtextUsername&gt;&gt;|\n|''Default Socialtext password''|&lt;&lt;option txtsocialtextPassword&gt;&gt;|\n|''Socialtext password required''|&lt;&lt;option chksocialtextPasswordRequired&gt;&gt;|\n\n***/\n\n//{{{\nif(!config.options.txtsocialtextDefaultServer)\n	{config.options.txtsocialtextDefaultServer = 'Socialtext.org';}\nif(!config.options.txtsocialtextDefaultWorkspace)\n	{config.options.txtsocialtextDefaultWorkspace = 'Main';}\nif(!config.options.txtsocialtextUsername)\n	{config.options.txtsocialtextUsername = '';}\nif(!config.options.txtsocialtextPassword)\n	{config.options.txtsocialtextPassword = '';}\nif(!config.options.chksocialtextPasswordRequired)\n	{config.options.chksocialtextPasswordRequired = false;}\n//}}}\n\n//{{{\n// Ensure that the plugin is only installed once.\nif(!version.extensions.SocialtextAdaptorPlugin) {\nversion.extensions.SocialtextAdaptorPlugin = {installed:true};\n\nSocialtextAdaptor = {}; // 'namespace' for local functions\n\nSocialtextAdaptor.mimeType = 'text/x.socialtext-wiki';\n\nSocialtextAdaptor.normalizedId = function(title)\n{\n	var id = title.toLowerCase();\n	id = id.replace(/\ss/g,'_').replace(/\s//g,'_').replace(/\s./g,'_').replace(/:/g,'').replace(/\s?/g,'');\n	if(id.charAt(0)=='_')\n		id = id.substr(1);\n	return String(id);\n};\n\nSocialtextAdaptor.dateFromEditTime = function(editTime)\n{\n	var dt = editTime;\n	return new Date(Date.UTC(dt.substr(0,4),dt.substr(5,2)-1,dt.substr(8,2),dt.substr(11,2),dt.substr(14,2)));\n};\n\nSocialtextAdaptor.getTiddler = function(title,params)\n{\n\n	// request the page in json format to get the page attributes\n	var urlTemplate = '%0/data/workspaces/%1/pages/%2?accept=application/json';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var pageId = SocialtextAdaptor.normalizedId(title);\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace,pageId]);\n\n	params.title = title;\n	params.wikiformat = 'Socialtext';\n	params.serverType = 'socialtext';\n	var req = doHttp('GET',url,null,null,null,null,SocialtextAdaptor.getTiddlerCallback,params);\n};\n\nSocialtextAdaptor.getTiddlerCallback = function(status,params,responseText,xhr)\n{\n\n/*\n{&quot;page_uri&quot;:&quot;http://www.socialtext.net/st-rest-docs/index.cgi?representation&quot;,\n&quot;modified_time&quot;:1163021802,\n&quot;name&quot;:&quot;Representation&quot;,\n&quot;page_id&quot;:&quot;representation&quot;,\n&quot;uri&quot;:&quot;representation&quot;,\n&quot;tags&quot;:[0.91],\n&quot;revision_id&quot;:20061108213642,\n&quot;last_edit_time&quot;:&quot;2006-11-08 21:36:42 GMT&quot;,\n&quot;revision_count&quot;:7,\n&quot;last_editor&quot;:&quot;matt.liggett@socialtext.com&quot;}\n*/\n\n	try {\n		eval('var queryResult=' + responseText);\n		params.tags = queryResult.tags;\n		params.serverPageId = queryResult.page_id;\n		params.serverPageName = queryResult.name;\n		params.modifier = queryResult.last_editor;\n		params.modified = SocialtextAdaptor.dateFromEditTime(queryResult.last_edit_time)\n	} catch (ex) {\n		//alert('SocialtextAdaptor.getTiddlerCallback: JSON error');\n		displayMessage('Response:'+responseText.substr(0,50));\n		return;\n	}\n	// request the page's text\n	var urlTemplate = '%0/data/workspaces/%1/pages/%2?accept=%3';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace,params.serverPageId,SocialtextAdaptor.mimeType]);\n	var req = doHttp('GET',url,null,null,null,null,SocialtextAdaptor.getTiddlerCallback2,params);\n};\n\nSocialtextAdaptor.getTiddlerCallback2 = function(status,params,responseText,xhr)\n{\n	var content = responseText;\n	if(content) {\n		var tiddler = store.createTiddler(params.title);\n		tiddler.updateFieldsAndContent(params,content);\n	}\n};\n\nSocialtextAdaptor.putTiddler = function(title,params)\n{\n	var tiddler = store.fetchTiddler(title);\n	var text = tiddler.text;\n	var pageId = tiddler.fields.serverPageId ? tiddler.fields.serverPageId : SocialtextAdaptor.normalizedId(title);\n	var urlTemplate = '%0/data/workspaces/%1/pages/%2';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace,title,text]);\n\n	params.title = title;\n	var req = doHttp('POST',url,text,SocialtextAdaptor.mimeType,null,null,SocialtextAdaptor.putTiddlerCallback,params,{&quot;X-Http-Method&quot;: &quot;PUT&quot;});\n};\n\nSocialtextAdaptor.putTiddlerCallback = function(status,params,responseText,xhr)\n{\n	if(!status)\n		displayMessage('Status text:'+xhr.statusText);\n	if(params.callback)\n		params.callback(params);\n};\n\nSocialtextAdaptor.getTiddlerList = function(params)\n{\n	var urlTemplate = '%0/data/workspaces/%1/pages?accept=application/json';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace]);\n	var req = doHttp('GET',url,null,null,null,null,SocialtextAdaptor.getTiddlerListCallback,params);\n};\n\n/*\n[\n{&quot;page_uri&quot;:&quot;http://www.socialtext.net/st-rest-docs/index.cgi?rest_api_version_0_9x&quot;,\n&quot;name&quot;:&quot;REST API version 0.9x&quot;,\n&quot;page_id&quot;:&quot;rest_api_version_0_9x&quot;,\n&quot;modified_time&quot;:1162933753,\n&quot;uri&quot;:&quot;rest_api_version_0_9x&quot;,\n&quot;tags&quot;:[],\n&quot;revision_id&quot;:20061107210913,\n&quot;last_edit_time&quot;:&quot;2006-11-07 21:09:13 GMT&quot;,\n&quot;revision_count&quot;:1,\n&quot;last_editor&quot;:\n&quot;chris.dent@socialtext.com&quot;},\n...\n]\n*/\n\nSocialtextAdaptor.getTiddlerListCallback = function(status,params,responseText,xhr)\n{\n	if(!status)\n		displayMessage('Status text:'+xhr.statusText);\n	try {\n		eval('var queryResult=' + responseText);\n		var list = [];\n		for(var i=0; i&lt; queryResult.length; i++) {\n			list[i] = {title:queryResult[i].name,\n						id:queryResult[i].page_id,\n						modified:SocialtextAdaptor.dateFromEditTime(queryResult[i].last_edit_time),\n						revCount:queryResult[i].revision_count};\n			//list[i] = {title:queryResult[i].page_id};\n		}\n		if(!store.hostedTiddlers)\n			store.hostedTiddlers = {};\n		if(!store.hostedTiddlers[params.serverHost])\n			store.hostedTiddlers[params.serverHost] = {};\n		store.hostedTiddlers[params.serverHost][params.serverWorkspace] = list;\n	} catch (ex) {\n		//alert('SocialtextAdaptor.getTiddlerCallback: JSON error');\n		displayMessage('Response:'+responseText.substr(0,50));\n	}\n	if(params.callback)\n		params.callback(params);\n};\n\nSocialtextAdaptor.getWorkspace = function(params)\n{\n	var urlTemplate = '%0/data/workspaces/%1/pages?accept=application/json';\n	if(!params.serverHost.match(/:\s/\s//))\n		urlTemplate = 'http://' + urlTemplate;\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace]);\n	var req = doHttp('GET',url,null,null,null,null,SocialtextAdaptor.getTiddlerListCallback,params);\n};\n\nSocialtextAdaptor.getWorkspaceCallback = function(status,params,responseText,xhr)\n{\n	if(!status)\n		displayMessage('Status text:'+xhr.statusText);\n	try {\n		eval('var queryResult=' + responseText);\n		var list = [];\n		for(var i=0; i&lt; queryResult.length; i++) {\n			list[i] = {title:queryResult[i].name,\n						id:queryResult[i].page_id,\n						modified:SocialtextAdaptor.dateFromEditTime(queryResult[i].last_edit_time),\n						revCount:queryResult[i].revision_count};\n			//list[i] = {title:queryResult[i].page_id};\n		}\n		if(!store.hostedTiddlers)\n			store.hostedTiddlers = {};\n		if(!store.hostedTiddlers[params.serverHost])\n			store.hostedTiddlers[params.serverHost] = {};\n		store.hostedTiddlers[params.serverHost][params.serverWorkspace] = list;\n	} catch (ex) {\n		//alert('SocialtextAdaptor.getTiddlerCallback: JSON error');\n		displayMessage('Response:'+responseText.substr(0,50));\n	}\n	for(i=0; i&lt; list.length; i++) {\n		SocialtextAdaptor.getTiddler(list[i].title,params)\n	}\n	if(params.callback)\n		params.callback(params);\n};\n// following gets list of workspaces\n\nconfig.hostFunctions.getTiddler['socialtext'] = SocialtextAdaptor.getTiddler;\nconfig.hostFunctions.putTiddler['socialtext'] = SocialtextAdaptor.putTiddler;\nconfig.hostFunctions.getTiddlerList['socialtext'] = SocialtextAdaptor.getTiddlerList;\nconfig.hostFunctions.getWorkspace['socialtext'] = SocialtextAdaptor.getWorkspace;\n\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="ZiddlyWikiAdaptorPlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|ZiddlyWikiAdaptorPlugin|\n|''Description:''|Adaptor for moving and converting data to and from ZiddlyWikis|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/martinsprereleases.html#ZiddlyWikiAdaptorPlugin|\n|''Subversion:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/ZiddlyWikiAdaptorPlugin.js|\n|''Version:''|0.1.4|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n\n''For debug:''\n|''Default ZiddlyWiki Server''|&lt;&lt;option txtZiddlyWikiDefaultServer&gt;&gt;|\n|''Default ZiddlyWiki Web(workspace)''|&lt;&lt;option txtZiddlyWikiDefaultWorkspace&gt;&gt;|\n|''Default ZiddlyWiki username''|&lt;&lt;option txtZiddlyWikiUsername&gt;&gt;|\n|''Default ZiddlyWiki password''|&lt;&lt;option txtZiddlyWikiPassword&gt;&gt;|\n\n***/\n\n//{{{\nif(!config.options.txtZiddlyWikiDefaultServer)\n	{config.options.txtZiddlyWikiDefaultServer = 'www.Ziddlywiki.org';}\nif(!config.options.txtZiddlyWikiDefaultWorkspace)\n	{config.options.txtZiddlyWikiDefaultWorkspace = '';}\nif(!config.options.txtZiddlyWikiUsername)\n	{config.options.txtZiddlyWikiUsername = '';}\nif(!config.options.txtZiddlyWikiPassword)\n	{config.options.txtZiddlyWikiPassword = '';}\n//}}}\n\n// Ensure that the plugin is only installed once.\nif(!version.extensions.ZiddlyWikiAdaptorPlugin) {\nversion.extensions.ZiddlyWikiAdaptorPlugin = {installed:true};\n\nZiddlyWikiAdaptor = {}; // 'namespace' for local functions\n\n// get\n// http://www.ziddlywiki.com/ZiddlyWiki?action=get&amp;id=News\n/*\nNews\n[[Version 2.0.11.4]] has been released.\sn\sn[[Version 2.0.11.3]] has been released.\sn\sn[[Version 2.0.11.2]] has been released.\sn\snWith this version the maintainership has changed.  Tim Morgan has retired and development has merged with the main TiddlyWiki systems at http://trac.tiddlywiki.org.  We are thankful to retain hosting by [[Zettai|http://zettai.net]].\sn\nBobMcElrath\n200609051750\n200601051659\nabout protected\n\n871.64174.18161.45875\n*/\nZiddlyWikiAdaptor.getTiddler = function(title,params)\n{\n	title = encodeURIComponent(title);\n// http://www.ziddlywiki.com/ZiddlyWiki?action=get&amp;id=News\n\n	var urlTemplate = 'http://%0/ZiddlyWiki?action=get&amp;id=%1';\n	var url = urlTemplate.format([params.serverHost,title]);\n// http://www.ziddlywiki.org/ZiddlyWiki?action=get&amp;id=ZiddlyWiki\n\n	params.title = title;\n	params.serverType = 'ziddlywiki';\n	var req = doHttp('GET',url,null,null,null,null,ZiddlyWikiAdaptor.getTiddlerCallback,params,null);\n};\n\n/*\nNews\n[[Version 2.0.11.4]] has been released.\sn\sn[[Version 2.0.11.3]] has been released.\sn\sn[[Version 2.0.11.2]] has been released.\sn\snWith this version the maintainership has changed.  Tim Morgan has retired and development has merged with the main TiddlyWiki systems at http://trac.tiddlywiki.org.  We are thankful to retain hosting by [[Zettai|http://zettai.net]].\sn\nBobMcElrath\n200609051750\n200601051659\nabout protected\n*/\nZiddlyWikiAdaptor.getTiddlerCallback = function(status,params,responseText,xhr)\n{\n	if(status &amp;&amp; responseText.substr(0,1)!='-') {\n		var x = responseText.split('\sn');\n		var content = x[1];\n		content = content.unescapeLineBreaks();\n		var tiddler = store.createTiddler(params.title);\n		try {\n			params.modifier = x[2];\n			if(x[3])\n				params.created = Date.convertFromYYYYMMDDHHMM(x[3]);\n			if(x[4])\n				params.modified = Date.convertFromYYYYMMDDHHMM(x[4]);\n			params.tags = x[5];\n		} catch(ex) {\n		}\n		tiddler.updateFieldsAndContent(params,content);\n	}\n};\n\nZiddlyWikiAdaptor.getTiddlerRevisionList = function(title,params)\n// get a list of the revisions for a tiddler\n{\n	title = encodeURIComponent(title);\n// http://www.ziddlywiki.com/ZiddlyWiki?action=get_revisions&amp;id=News\n	//ajax.get('?action=get_revisions&amp;id=' + encodeURIComponent(title) + '&amp;' + zw.no_cache(), callback);\n\n	var urlTemplate = 'http://%0/ZiddlyWiki?action=get_revisions&amp;id=%1';\n	var url = urlTemplate.format([params.serverHost,title]);\n// http://www.ziddlywiki.org/ZiddlyWiki?action=get_revisions&amp;id=ZiddlyWiki\n\n	params.title = title;\n	params.serverWorkspace = null;\n	params.serverType = 'ziddlywiki';\n	var req = doHttp('GET',url,null,null,null,null,ZiddlyWikiAdaptor.getTiddlerRevisionListCallback,params,null);\n};\n\nZiddlyWikiAdaptor.getTiddlerRevisionListCallback = function(status,params,responseText,xhr)\n{\n	params.revisions = [];\n	var r =  responseText;\n	if(r != '-') {\n		var revs = r.split('\sn');\n		for(var i=0; i&lt;revs.length; i++) {\n			var parts = revs[i].split(' ');\n			if(parts.length&gt;1) {\n				params.revisions[i] = {};\n				params.revisions[i].modified = Date.convertFromYYYYMMDDHHMM(parts[0]);\n				params.revisions[i].key = parts[1];\n			}\n		}\n	}\n	params.callback(params);\n};\n\nZiddlyWikiAdaptor.getTiddlerRevision = function(title,revision,src,updateTimeline)\n{\n	title = encodeURIComponent(title);\n	var tiddler = store.fetchTiddler(title);\n	if(tiddler.fields.serverPageRevision == revision)\n		return;\n	zw.status('loading...');\n	revision = revision ? '&amp;revision=' + revision : '';\n	updateTimeline = updateTimeline ? '&amp;updatetimeline=1' : '';\n	//ajax.get('?action=get&amp;id=' + encodeURIComponent(title) + revision + updateTimeline + '&amp;' + zw.no_cache(),displayTiddlerRevisionCallback)\n};\n\nZiddlyWikiAdaptor.getTiddlerRevisionCallback = function(status,params,responseText,xhr)\n{\n	var encoded = responseText;\n	if(encoded.indexOf('\sn') &gt; -1) {\n		var parts = encoded.split('\sn');\n		var tiddler = new Tiddler();\n		var title = parts[0];\n		tiddler.set(title,Tiddler.unescapeLineBreaks(parts[1].htmlDecode()),parts[2],\n				Date.convertFromYYYYMMDDHHMM(parts[3]),parts[5],\n				Date.convertFromYYYYMMDDHHMM(parts[4]));\n		tiddler.revisionKey = parts[7];\n		store.addTiddler(tiddler);\n		story.refreshTiddler(title,DEFAULT_VIEW_TEMPLATE,true);\n		if(parts[6] == 'update timeline')\n			store.notify('TabTimeline',true);\n	} else if(encoded != '-') {\n		alert(encoded); // error message\n	}\n	zw.status(false);\n};\n\nZiddlyWikiAdaptor.putTiddler = function(title,params)\n{\n	var content = store.fetchTiddler(title).text;\n	title = encodeURIComponent(title);\n	var urlTemplate = 'http://%0/RPC2/';\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace,encodeURIComponent(title)]);\n\n	params.title = title;\n	params.serverType = 'ziddlywiki';\n	var req =doHttp('POST',url,payload,null,params.username,params.password,ZiddlyWikiAdaptor.putTiddlerCallback,params);\n};\n\nZiddlyWikiAdaptor.putTiddlerCallback = function(status,params,responseText,xhr)\n{\n	displayMessage('putTiddlerCallback status:'+status);\n	displayMessage('rt:'+responseText.substr(0,50));\n};\n\n\nconfig.hostFunctions.getTiddler['ziddlywiki'] = ZiddlyWikiAdaptor.getTiddler;\nconfig.hostFunctions.getTiddlerRevisionList['ziddlywiki'] = ZiddlyWikiAdaptor.getTiddlerRevisionList;\nconfig.hostFunctions.getTiddlerRevision['ziddlywiki'] = ZiddlyWikiAdaptor.getTiddlerRevision;\n//config.hostFunctions.putTiddler['ziddlywiki'] = ZiddlyWikiAdaptor.putTiddler;\n\n} // end of 'install only once'\n//}}}\n</div>
<div tiddler="ccTiddlyAdaptorPlugin" modifier="MartinBudden" modified="200612170000" created="200612170000" tags="systemConfig excludeLists">/***\n|''Name:''|ccTiddlyAdaptorPlugin|\n|''Description:''|Adaptor for moving and converting data to and from ccTiddly wikis|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Source:''|http://martinswiki.com/martinsprereleases.html#ccTiddlyAdaptorPlugin|\n|''CodeRepository:''|http://svn.tiddlywiki.org/Trunk/contributors/MartinBudden/plugins/ccTiddlyAdaptorPlugin.js|\n|''Version:''|0.1.5|\n|''Date:''|Feb 4, 2007|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.2.0|\n\n|''Default ccTiddly Server''|&lt;&lt;option txtccTiddlyDefaultServer&gt;&gt;|\n|''Default ccTiddly Web(workspace)''|&lt;&lt;option txtccTiddlyDefaultWorkspace&gt;&gt;|\n|''Default ccTiddly username''|&lt;&lt;option txtccTiddlyUsername&gt;&gt;|\n|''Default ccTiddly password''|&lt;&lt;option txtccTiddlyPassword&gt;&gt;|\n\n***/\n\n//{{{\nif(!config.options.txtccTiddlyDefaultServer)\n	{config.options.txtccTiddlyDefaultServer = 'cctiddly.sourceforge.net';}\nif(!config.options.txtccTiddlyDefaultWorkspace)\n	{config.options.txtccTiddlyDefaultWorkspace = '';}\nif(!config.options.txtccTiddlyUsername)\n	{config.options.txtccTiddlyUsername = '';}\nif(!config.options.txtccTiddlyPassword)\n	{config.options.txtccTiddlyPassword = '';}\n//}}}\n\n// Ensure that the plugin is only installed once.\nif(!version.extensions.ccTiddlyAdaptorPlugin) {\nversion.extensions.ccTiddlyAdaptorPlugin = {installed:true};\n\nccTiddlyAdaptor = {}; // 'namespace' for local functions\n\nccTiddlyAdaptor.getTiddler = function(title,params)\n// get a list of the revisions for a page\n{\n	//title = encodeURIComponent(title);\n\n	var urlTemplate = 'http://%0/msghandle.php?action=revisionList&amp;title=%1';\n	var url = urlTemplate.format([params.serverHost,title]);\n\n	params.title = title;\n	params.serverWorkspace = null;\n	params.serverType = 'cctiddly';\n	var req = doHttp('GET',url,null,null,null,null,ccTiddlyAdaptor.getTiddlerCallback1,params,null);\n};\n\n/*\n200610221408 6 ccTiddly\n200610221357 5 ccTiddly\n200609082012 4 ccTiddly\n200609081946 3 ccTiddly\n200608162039 2 ccTiddly\n200603111654 1 ccTiddly\n*/\nccTiddlyAdaptor.getTiddlerCallback1 = function(status,params,responseText,xhr)\n{\n	var revs = responseText.split('\sn');\n	var parts = revs[0].split(' ');\n	var pageRevision = parts[1];\n// http://cctiddly.sourceforge.net/msghandle.php?action=revisionDisplay&amp;title=About&amp;revision=6\n	var urlTemplate = 'http://%0/msghandle.php?action=revisionDisplay&amp;title=%1&amp;revision=%2';\n	var url = urlTemplate.format([params.serverHost,params.title,pageRevision]);\n	var req = doHttp('GET',url,null,null,null,null,ccTiddlyAdaptor.getTiddlerCallback2,params,null);\n};\n\n// http://cctiddly.sourceforge.net/msghandle.php?action=revisionDisplay&amp;title=About&amp;revision=6\n/*\nAbout\nAbout\n!About\snccTiddly is a tiddly adaptation based on PHP and MySQL to store tiddlers. This is a server side adaptation which allow its user to change their TiddlyWiki over HTTP. It is also possible to generate a standalone version with this!\sn\sn!Target audiance/uses\sn*Online edittable TW\sn**Blog\sn**news site\sn**personal ToDo list\sn**online bookmark (with TiddlySnip, still in development)\sn*As a collaboration tool\sn\sn!Features\sn|!Add/Edit/Save tiddler over the web|basic tiddly wiki functions allow user to create, edit and delete tiddler but over the internet|\sn|!Standalone generation|allow generation of standalone version if required, which is the one available on http://tiddlywiki.com|\sn|!Access control|password protect the tiddly so only certain user can change its content over the net, hide ones you don't want anyone but you to see. All in the new privilege system!|\sn|!Multiple config file|multiple config file for multiple ccT. One setup, multiple ccTiddly!|\sn|!Select particular config file|ability to use a certain config file, which allow multiple tiddly host with one URL|\sn|!Versioning|All versions of tiddlers kept|\sn|!Import your TW|you can import your TW into ccT fo use and convert back to original TW when you need to bring it around on flashdisk|\sn|!Multi-lingual|It may not be in your language now but you can easily translate to your own language|\sn|!Tag filter|You can filter out your tiddlers by tag|\nccTiddly\n200610221408\n200601140131\nother\n6\n*/\nccTiddlyAdaptor.getTiddlerCallback2 = function(status,params,responseText,xhr)\n{\n	var x = responseText.split('\sn');\n	var content = x[2];\n	content = content.unescapeLineBreaks();\n	try {\n		//params.modifier = x[2];\n		/*if(x[4])\n			params.created = Date.convertFromYYYYMMDDHHMM(x[4]);\n		if(x[5])\n			params.modified = Date.convertFromYYYYMMDDHHMM(x[5]);\n		params.tags = x[6];*/\n	} catch(ex) {\n	}\n	var tiddler = store.createTiddler(params.title);\n	tiddler.updateFieldsAndContent(params,content);\n};\n\n\nccTiddlyAdaptor.getTiddlerRevisionList = function(title,params)\n// get a list of the revisions for a page\n{\n	//title = encodeURIComponent(title);\n// http://cctiddly.sourceforge.net/msghandle.php?action=revisionList&amp;title=About\n\n	var urlTemplate = 'http://%0/msghandle.php?action=revisionList&amp;title=%1';\n	var url = urlTemplate.format([params.serverHost,title]);\n\n	params.title = title;\n	params.serverWorkspace = null;\n	params.serverType = 'cctiddly';\n	var req = doHttp('GET',url,null,null,null,null,ccTiddlyAdaptor.getTiddlerRevisionListCallback,params,null);\n};\n\nccTiddlyAdaptor.getTiddlerRevisionListCallback = function(status,params,responseText,xhr)\n{\n	params.revisions = [];\n	var r =  responseText;\n	if(r != '-') {\n		var revs = r.split('\sn');\n		for(var i=0; i&lt;revs.length; i++) {\n			var parts = revs[i].split(' ');\n			if(parts.length&gt;1) {\n				params.revisions[i] = {};\n				params.revisions[i].modified = Date.convertFromYYYYMMDDHHMM(parts[0]);\n				params.revisions[i].key = parts[1];\n			}\n		}\n	}\n	params.callback(params);\n};\n\nccTiddlyAdaptor.getTiddlerRevision = function(title,revision,src,updateTimeline)\n{\n	//title = encodeURIComponent(title);\n	var tiddler = store.fetchTiddler(title);\n	if(tiddler.fields.serverPageRevision == revision)\n		return;\n	zw.status('loading...');\n	revision = revision ? '&amp;revision=' + revision : '';\n	updateTimeline = updateTimeline ? '&amp;updatetimeline=1' : '';\n	//ajax.get('?action=get&amp;id=' + encodeURIComponent(title) + revision + updateTimeline + '&amp;' + zw.no_cache(),displayTiddlerRevisionCallback)\n};\n\nccTiddlyAdaptor.getTiddlerRevisionCallback = function(status,params,responseText,xhr)\n{\n	var encoded = responseText;\n	if(encoded.indexOf('\sn') &gt; -1) {\n		var parts = encoded.split('\sn');\n		var tiddler = new Tiddler();\n		var title = parts[0];\n		tiddler.set(title,Tiddler.unescapeLineBreaks(parts[1].htmlDecode()),parts[2],\n				Date.convertFromYYYYMMDDHHMM(parts[3]),parts[5],\n				Date.convertFromYYYYMMDDHHMM(parts[4]));\n		tiddler.revisionKey = parts[7];\n		store.addTiddler(tiddler);\n		story.refreshTiddler(title,DEFAULT_VIEW_TEMPLATE,true);\n		if(parts[6] == 'update timeline')\n			store.notify('TabTimeline',true);\n	} else if(encoded != '-') {\n		alert(encoded); // error message\n	}\n	zw.status(false);\n};\n\nccTiddlyAdaptor.putTiddler = function(title,params)\n{\n	var content = store.fetchTiddler(title).text;\n	title = encodeURIComponent(title);\n	var urlTemplate = 'http://%0/RPC2/';\n	var url = urlTemplate.format([params.serverHost,params.serverWorkspace,encodeURIComponent(title)]);\n\n	params.title = title;\n	params.serverType = 'cctiddly';\n	var req =doHttp('POST',url,payload,null,params.username,params.password,ccTiddlyAdaptor.putTiddlerCallback,params);\n};\n\nccTiddlyAdaptor.putTiddlerCallback = function(status,params,responseText,xhr)\n{\n	displayMessage('putTiddlerCallback status:'+status);\n	displayMessage('rt:'+responseText.substr(0,50));\n};\n\n\nconfig.hostFunctions.getTiddler['cctiddly'] = ccTiddlyAdaptor.getTiddler;\n//config.hostFunctions.getTiddlerRevisionList['cctiddly'] = ccTiddlyAdaptor.getTiddlerRevisionList;\n//config.hostFunctions.getTiddlerRevision['cctiddly'] = ccTiddlyAdaptor.getTiddlerRevision;\n//config.hostFunctions.putTiddler['cctiddly'] = ccTiddlyAdaptor.putTiddler;\n\n} // end of 'install only once'\n//}}}\n</div>
<div title="Configuration" modifier="MartinBudden" tags="excludeLists">
<pre>PageTemplate
|&gt;|&gt;|SiteTitle - SiteSubtitle|
|MainMenu|DefaultTiddlers&lt;&lt;br&gt;&gt;&lt;&lt;br&gt;&gt;&lt;&lt;br&gt;&gt;&lt;&lt;br&gt;&gt;ViewTemplate&lt;&lt;br&gt;&gt;&lt;&lt;br&gt;&gt;EditTemplate|SideBarOptions|
|~|~|OptionsPanel|
|~|~|AdvancedOptions|
|~|~|&lt;&lt;tiddler Configuration.SideBarTabs&gt;&gt;|

''StyleSheet:'' StyleSheetColors - StyleSheetLayout - StyleSheetPrint

SiteUrl</pre>
</div>
<div title="Configuration.SideBarTabs" modifier="MartinBudden" tags="excludeLists">
<pre>SideBarTabs
|[[Timeline|TabTimeline]]|[[All|TabAll]]|[[Tags|TabTags]]|&gt;|&gt;|[[More|TabMore]] |
|&gt;|&gt;||[[Missing|TabMoreMissing]]|[[Orphans|TabMoreOrphans]]|[[Shadowed|TabMoreShadowed]]|</pre>
</div>
<div tiddler="TagCloudPlugin" modifier="MartinBudden" modified="200608011801" created="200605020551" tags="systemConfig excludeLists">/***\n|''Plugin:''|Tag Cloud Plugin|\n|''Author:''|Clint Checketts|\n|''Source:''|http://checkettsweb.com/styles/themes.htm#TagCloud|\n\n!!Usage\n\n&lt;&lt;tagCloud&gt;&gt;\n\n!!Code\n***/\n//{{{\nversion.extensions.tagCloud = {major: 1, minor: 0 , revision: 0, date: new Date(2006,2,04)};\n//Created by Clint Checketts, contributions by Jonny Leroy and Eric Shulman\n\nconfig.macros.tagCloud = {\n noTags: &quot;No tag cloud created because there are no tags.&quot;,\n tooltip: &quot;%1 tiddlers tagged with '%0'&quot;\n};\n\nconfig.macros.tagCloud.handler = function(place,macroName,params) {\n\nvar tagCloudWrapper = createTiddlyElement(place,&quot;div&quot;,null,&quot;tagCloud&quot;,null);\n\nvar tags = store.getTags();\nfor (var t=0; t&lt;tags.length; t++) {\n for (var p=0;p&lt;params.length; p++) if (tags[t][0] == params[p]) tags[t][0] = &quot;&quot;;\n}\n\nif(tags.length == 0)\n createTiddlyElement(tagCloudWrapper,&quot;span&quot;,null,null,this.noTags);\n//Findout the maximum number of tags\nvar mostTags = 0;\nfor (var t=0; t&lt;tags.length; t++) if (tags[t][0].length &gt; 0){\n if (tags[t][1] &gt; mostTags) mostTags = tags[t][1];\n}\n\n//divide the mostTags into 4 segments for the 4 different tagCloud sizes\nvar tagSegment = mostTags/4;\n\nfor (var t=0; t&lt;tags.length; t++) if (tags[t][0].length &gt; 0){\n var tagCloudElement = createTiddlyElement(tagCloudWrapper,&quot;span&quot;);\n tagCloudWrapper.appendChild(document.createTextNode(&quot; &quot;));\n var theTag = createTiddlyButton(tagCloudElement,tags[t][0],this.tooltip.format(tags[t]),onClickTag,&quot;tagCloudtag tagCloud&quot; + (Math.round(tags[t][1]/tagSegment)+1));\n theTag.setAttribute(&quot;tag&quot;,tags[t][0]);\n}\n\n};\n\nsetStylesheet(&quot;.tagCloud span{height: 1.8em;margin: 3px;}.tagCloud1{font-size: 1.2em;}.tagCloud2{font-size: 1.4em;}.tagCloud3{font-size: 1.6em;}.tagCloud4{font-size: 1.8em;}.tagCloud5{font-size: 1.8em;font-weight: bold;}&quot;,&quot;tagCloudsStyles&quot;);\n//}}}</div>
<div tiddler="TiddlerAliasPlugin" modifier="UdoBorkowski" modified="200609230000" created="200609230000" tags="UdoBorkowski systemConfig excludeLists">/***\n|''Name:''|TiddlerAliasPlugin|\n|''Version:''|1.0.0 BETA 3 (2006-09-23)|\n|''Source:''|http://tiddlywiki.abego-software.de/Beta.html#TiddlerAliasPlugin|\n|''Author:''|UdoBorkowski (ub [at] abego-software [dot] de)|\n|''Licence:''|[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]|\n|''Copyright:''|&amp;copy; 2006 [[abego Software|http://www.abego-software.de]]|\n|''~CoreVersion:''|2.1.0|\n|''Browser:''|Firefox 1.5.0.7 or better; InternetExplorer 6.0|\n!Description\n\nReference a tiddler through an alias (or even through many aliases). E.g. a tiddler &quot;William Shakespeare&quot; may also be referenced as {{{[[Shaxper]]}}}.\n\nWhen editing a tiddler you may enter alternative names for the tiddler in the &quot;Alias&quot; field (below the tags field), similar to the way you enter tags. You may even specify multiple alias names, separated by spaces. Alias names containing spaces must be written as {{{[[...]]}}}\n\nAlso this plugin implements the &quot;Auto Non-Space Alias&quot; feature: for tiddlers with titles containing whitespaces an alias is automatically created that has every whitespace replaced by a dash (&quot;-&quot;). E.g. a tiddler called [[Tiddler with no alias defined]] can also be referenced by [[Tiddler-with-no-alias-defined]].\n\n!Revision history\n* v1.0.0 Beta 3 (2006-09-23)\n** Support &quot;Auto Non-Space Alias&quot; feature: For tiddler with titles containing whitespaces an alias is automatically created that has every whitespace replaced by a dash (&quot;-&quot;)\n* v1.0.0 Beta 2 (2006-09-22)\n** Bugfix: Tiddler is displayed more than once when opened both through title and alias (Thanks to KenGirard for reporting)\n* v1.0.0 Beta 1 (2006-09-21)\n** Beta 1 release\n!Code\n***/\n//{{{\n	\n//============================================================================\n//============================================================================\n//		   TiddlerAliasPlugin\n//============================================================================\n//============================================================================\n\n// Only install once\nif (!version.extensions.TiddlerAliasPlugin) {\n\nversion.extensions.TiddlerAliasPlugin = {\n	major: 1, minor: 0, revision: 0, beta: 3,\n	date: new Date(2006,8,23), \n	source: &quot;http://tiddlywiki.abego-software.de/Beta.html#TiddlerAliasPlugin&quot;,\n	licence: &quot;[[BSD open source license (abego Software)|http://www.abego-software.de/legal/apl-v10.html]]&quot;,\n	copyright: &quot;Copyright (c) abego Software GmbH, 2005-2006 (www.abego-software.de)&quot;\n};\n\n(function() {\n\nwindow.abegoTiddlerAlias = {\n	lingo:  {\n		aliasPrompt: &quot;Type alias names (i.e. alternative names for this tiddler) separated with spaces, [[use double square brackets]] if necessary&quot;\n	}, \n	\n	editTemplateExtension: &quot;&lt;div class='editor' macro='edit alias'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message abegoTiddlerAlias.lingo.aliasPrompt'&gt;&lt;/span&gt;&lt;/div&gt;&quot;\n};\n\nvar oldFetchTiddler;\nvar oldSaveTiddler;\nvar oldDisplayTiddler;\n\nvar fWithAutoNonSpaceAlias = true;\n\nfunction withAutoNonSpaceAlias() {\n	return fWithAutoNonSpaceAlias;\n}\n\nfunction addNonSpaceAlias(map, title) {\n	var s = title.replace(/\ss/g,&quot;-&quot;);\n	if (s != title)\n		map[s] = title;\n}\n\nfunction calcAliases() {\n	var result = {};\n	store.forEachTiddler(function(title,tiddler) {\n		var s = store.getValue(tiddler,&quot;alias&quot;);\n		if (s) {\n			var p = s.parseParams(&quot;list&quot;,null,false,true);\n			for(var i=1; i&lt;p.length; i++)\n				result[p[i].value] = title;\n		}\n		if (withAutoNonSpaceAlias())\n			addNonSpaceAlias(result,title);\n	});\n	return result;\n}\n\n// Returns a map that maps an alias name to the title of the tiddler\nabegoTiddlerAlias.getAliases = function() {\n	if (!store.aliases)\n		store.aliases = calcAliases();\n	return store.aliases;\n}\n\n// Returns the title of the tiddler for the given alias.\n// When no such alias is defined but a tiddler with that name exists the alias is returned.\n// Otherwise null is returned.\nabegoTiddlerAlias.getAliasTitle = function(alias) {\n	var t = abegoTiddlerAlias.getAliases()[alias];\n	return t ? t : (store.fetchTiddler(alias) ? alias : null)\n}\n\nfunction hasEditTemplateExtension(s) {\n	return s.indexOf(abegoTiddlerAlias.editTemplateExtension) &gt;= 0;\n}\n\nfunction addEditTemplateExtension(s) {\n	if (s &amp;&amp; !hasEditTemplateExtension(s)) {\n		var i = s.lastIndexOf(&quot;&lt;/div&gt;&quot;);\n		if (i &gt;= 0)\n			return s.slice(0,i+6)+&quot;\sn&quot;+abegoTiddlerAlias.editTemplateExtension+s.slice(i+6);\n	}\n	return null;\n}\n\nfunction hijackFetchTiddler() {\n	oldFetchTiddler = store.fetchTiddler;\n\n	store.fetchTiddler = function(title) {\n		var result = oldFetchTiddler.apply(this, arguments);\n		if (!result &amp;&amp; title) {\n			title = abegoTiddlerAlias.getAliases()[title];\n			if (title)\n				result = oldFetchTiddler.apply(this, [title])\n		}\n		return result;\n	};\n}\n\nfunction hijackSaveTiddler() {\n	oldSaveTiddler = TiddlyWiki.prototype.saveTiddler;\n	TiddlyWiki.prototype.saveTiddler = function() {\n		var result = oldSaveTiddler.apply(this, arguments);\n		delete store.aliases;\n		return result;\n	}\n}\n\n\nfunction hijackDisplayTiddler() {\n	oldDisplayTiddler = Story.prototype.displayTiddler;\n	Story.prototype.displayTiddler = function(srcElement,title,template,animate,slowly,customFields) {\n		// Ensure that a tiddler is always opened with its &quot;original&quot; title (not an alias)\n		var tiddler = store.fetchTiddler(title);\n		if (tiddler) \n			title = tiddler.title;\n		return oldDisplayTiddler.apply(this, [srcElement,title,template,animate,slowly,customFields]);\n	}\n}\n	\n\nfunction modifyEditTemplate() {\n	// The shadow tiddler\n	var s = addEditTemplateExtension(config.shadowTiddlers[&quot;EditTemplate&quot;]);\n	if (s) \n		config.shadowTiddlers[&quot;EditTemplate&quot;] = s;\n	\n	// The &quot;real&quot; tiddler (if defined)\n	var t = store.getTiddler(&quot;EditTemplate&quot;);\n	if (t &amp;&amp; !hasEditTemplateExtension(t.text))\n		t.set(null,addEditTemplateExtension(t.text));\n}\n\n// Requires store is defined.\nfunction doHijacking() {\n	hijackFetchTiddler();\n	hijackSaveTiddler();\n	hijackDisplayTiddler();\n	modifyEditTemplate();\n}\n\n// for debugging the plugin is not loaded through the systemConfig mechanism but via a script tag. \n// At that point in the &quot;store&quot; is not yet defined. In that case hijackFetchTiddler through the restart function.\n// Otherwise hijack now.\nif (!store) {\n	var oldRestartFunc = restart;\n	window.restart = function() {\n		doHijacking();\n		oldRestartFunc.apply(this,arguments);\n	};\n} else\n	doHijacking();\n\n// To support the access through the &quot;message&quot; macro\nconfig.abegoTiddlerAlias = abegoTiddlerAlias;\n})();\n} // of &quot;install only once&quot;\n\n\n/***\n!Licence and Copyright\nCopyright (c) abego Software ~GmbH, 2005 ([[www.abego-software.de|http://www.abego-software.de]])\n\nRedistribution and use in source and binary forms, with or without modification,\nare permitted provided that the following conditions are met:\n\nRedistributions of source code must retain the above copyright notice, this\nlist of conditions and the following disclaimer.\n\nRedistributions in binary form must reproduce the above copyright notice, this\nlist of conditions and the following disclaimer in the documentation and/or other\nmaterials provided with the distribution.\n\nNeither the name of abego Software nor the names of its contributors may be\nused to endorse or promote products derived from this software without specific\nprior written permission.\n\nTHIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND ANY\nEXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES\nOF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT\nSHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,\nINCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED\nTO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR\nBUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN\nCONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN\nANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH\nDAMAGE.\n***/\n\n//}}}\n</div>
<div tiddler="SinglePageModePlugin" modifier="ELSDesignStudios" modified="200607041731" created="200512271815" tags="systemConfig addon includeNew excludeLists">/***\n''Single Page Mode Plugin for TiddlyWiki version 2.0 or above''\n^^author: Eric Shulman - ELS Design Studios\nsource: http://www.TiddlyTools.com/#SinglePageModePlugin\nlicense: [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]^^\n\nNormally, as you click on the links in TiddlyWiki, more and more tiddlers are displayed on the page. The order of this tiddler display depends upon when and where you have clicked. Some people like this non-linear method of reading the document, while others have reported that when many tiddlers have been opened, it can get somewhat confusing.\n\n!!!!!Usage\n&lt;&lt;&lt;\nSinglePageMode allows you to configure TiddlyWiki to navigate more like a traditional multipage web site with only one item displayed at a time.  When SinglePageMode is enabled, the title of the current tiddler is automatically displayed in the browser window's titlebar and the browser's location URL is updated with a 'permalink' for the current tiddler so that it is easier to create a browser 'bookmark' for the current tiddler.\n\nEven when SinglePageMode is disabled (i.e., displaying multiple tiddlers is permitted), you can reduce the potential for confusion by enable TopOfPageMode, which forces tiddlers to always open at the top of the page instead of being displayed following the tiddler containing the link that was clicked.\n&lt;&lt;&lt;\n!!!!!Configuration\n&lt;&lt;&lt;\nWhen installed, this plugin automatically adds checkboxes in the AdvancedOptions tiddler so you can enable/disable the plugin behavior.  For convenience, these checkboxes are also included here:\n\n&lt;&lt;option chkSinglePageMode&gt;&gt; Display one tiddler at a time\n&lt;&lt;option chkTopOfPageMode&gt;&gt; Always open tiddlers at the top of the page\n&lt;&lt;&lt;\n!!!!!Installation\n&lt;&lt;&lt;\nimport (or copy/paste) the following tiddlers into your document:\n''SinglePageModePlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)\n^^documentation and javascript for SinglePageMode handling^^\n\nWhen installed, this plugin automatically adds checkboxes in the ''shadow'' AdvancedOptions tiddler so you can enable/disable this behavior.  However, if you have customized your AdvancedOptions, you will need to ''manually add these checkboxes to your customized tiddler.''\n&lt;&lt;&lt;\n!!!!!Revision History\n&lt;&lt;&lt;\n''2006.07.04 [2.2.1]'' in hijack for displayTiddlers(), suspend TPM as well as SPM so that DefaultTiddlers displays in the correct order.\n''2006.06.01 [2.2.0]'' added chkTopOfPageMode (TPM) handling\n''2006.02.04 [2.1.1]'' moved global variable declarations to config.* to avoid FireFox 1.5.0.1 crash bug when assigning to globals\n''2005.12.27 [2.1.0]'' hijack displayTiddlers() so that SPM can be suspended during startup while displaying the DefaultTiddlers (or #hash list).  Also, corrected initialization for undefined SPM flag to &quot;false&quot;, so default behavior is to display multiple tiddlers\n''2005.12.27 [2.0.0]'' Update for TW2.0\n''2005.11.24 [1.1.2]'' When the back and forward buttons are used, the page now changes to match the URL.  Based on code added by Clint Checketts\n''2005.10.14 [1.1.1]'' permalink creation now calls encodeTiddlyLink() to handle tiddler titles with spaces in them\n''2005.10.14 [1.1.0]'' added automatic setting of window title and location bar ('auto-permalink').  feature suggestion by David Dickens.\n''2005.10.09 [1.0.1]'' combined documentation and code in a single tiddler\n''2005.08.15 [1.0.0]'' Initial Release\n&lt;&lt;&lt;\n!!!!!Credits\n&lt;&lt;&lt;\nThis feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]].\nSupport for BACK/FORWARD buttons adapted from code developed by Clint Checketts\n&lt;&lt;&lt;\n!!!!!Code\n***/\n//{{{\nversion.extensions.SinglePageMode= {major: 2, minor: 2, revision: 1, date: new Date(2006,7,3)};\n\nif (config.options.chkSinglePageMode==undefined) config.options.chkSinglePageMode=false;\nconfig.shadowTiddlers.AdvancedOptions += &quot;\ssn&lt;&lt;option chkSinglePageMode&gt;&gt; Display one tiddler at a time&quot;;\n\nif (config.options.chkTopOfPageMode==undefined) config.options.chkTopOfPageMode=false;\nconfig.shadowTiddlers.AdvancedOptions += &quot;\ssn&lt;&lt;option chkTopOfPageMode&gt;&gt; Always open tiddlers at the top of the page&quot;;\n\nconfig.SPMTimer = 0;\nconfig.lastURL = window.location.hash;\nfunction checkLastURL()\n{\n	if (!config.options.chkSinglePageMode)\n		{ window.clearInterval(config.SPMTimer); config.SPMTimer=0; return; }\n	if (config.lastURL == window.location.hash)\n		return;\n	var tiddlerName = convertUTF8ToUnicode(decodeURI(window.location.hash.substr(1)));\n	tiddlerName=tiddlerName.replace(/\ss[\ss[/,&quot;&quot;).replace(/\ss]\ss]/,&quot;&quot;); // strip any [[ ]] bracketing\n	if (tiddlerName.length) story.displayTiddler(null,tiddlerName,1,null,null);\n}\n\nif (Story.prototype.SPM_coreDisplayTiddler==undefined) Story.prototype.SPM_coreDisplayTiddler=Story.prototype.displayTiddler;\nStory.prototype.displayTiddler = function(srcElement,title,template,animate,slowly)\n{\n	if (config.options.chkSinglePageMode) {\n		window.location.hash = encodeURIComponent(String.encodeTiddlyLink(title));\n		config.lastURL = window.location.hash;\n		document.title = wikifyPlain(&quot;SiteTitle&quot;) + &quot; - &quot; + title;\n		story.closeAllTiddlers();\n		if (!config.SPMTimer) config.SPMTimer=window.setInterval(function() {checkLastURL();},1000);\n	}\n	if (config.options.chkTopOfPageMode) { story.closeTiddler(title); window.scrollTo(0,0); srcElement=null; }\n	this.SPM_coreDisplayTiddler(srcElement,title,template,animate,slowly)\n}\n\nif (Story.prototype.SPM_coreDisplayTiddlers==undefined) Story.prototype.SPM_coreDisplayTiddlers=Story.prototype.displayTiddlers;\nStory.prototype.displayTiddlers = function(srcElement,titles,template,unused1,unused2,animate,slowly)\n{\n	// suspend single-page mode when displaying multiple tiddlers\n	var saveSPM=config.options.chkSinglePageMode; config.options.chkSinglePageMode=false;\n	var saveTPM=config.options.chkTopOfPageMode; config.options.chkTopOfPageMode=false;\n	this.SPM_coreDisplayTiddlers(srcElement,titles,template,unused1,unused2,animate,slowly);\n	config.options.chkSinglePageMode=saveSPM; config.options.chkTopOfPageMode=saveTPM;\n}\n//}}}</div>
</div>
<!--POST-BODY-START-->
<!--POST-BODY-END-->
</body>
</html>
