<div tiddler="MediaWikiFormatterPlugin" modifier="MartinBudden" modified="200611102231" created="200609240701" tags="systemConfig excludeLists" alias="">/***\n|''Name:''|MediaWikiFormatterPlugin|\n|''Description:''|Allows Tiddlers to use [[MediaWiki|http://meta.wikimedia.org/wiki/Help:Wikitext]] ([[WikiPedia|http://meta.wikipedia.org/]]) text formatting|\n|''Source:''|http://martinswiki.com/prereleases.html#MediaWikiFormatterPlugin|\n|''Author:''|Martin Budden (mjbudden (at) gmail (dot) com)|\n|''Version:''|0.3.9|\n|''Status:''|alpha release|\n|''Date:''|Now 11, 2006|\n|''Comments:''|Please make comments at http://groups.google.co.uk/group/TiddlyWikiDev|\n|''License:''|[[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|\n|''~CoreVersion:''|2.1.0|\n\n|''Display instrumentation''|&lt;&lt;option chkDisplayInstrumentation&gt;&gt;|\n|''Display empty template links:''|&lt;&lt;option chkMediaWikiDisplayEmptyTemplateLinks&gt;&gt;|\n|''Allow zooming of thumbnail images''|&lt;&lt;option chkMediaWikiDisplayEnableThumbZoom&gt;&gt;|\n|''List references''|&lt;&lt;option chkMediaWikiListReferences&gt;&gt;|\n\nThis is an early release of the MediaWikiFormatterPlugin, which allows you to insert MediaWiki\nformated text into a TiddlyWiki.\n\nThe aim is not to fully emulate MediaWiki, but to allow you to create MediaWiki content off-line\nand then paste the content into your MediaWiki later on, with the expectation that only minor\nedits will be required.\n\nTo use MediaWiki format in a Tiddler, tag the Tiddler with MediaWikiFormat. See [[testMediaWikiFormat]]\nfor an example.\n\n!!!Issues\nThis is an early alpha release, with (at least) the following known issues:\n# Not all styles from http://meta.wikimedia.org/wiki/MediaWiki:Common.css incorporated\n## Styles for tables don't yet match Wikipedia styles.\n## Styles for image galleries don't yet match Wikipedia styles.\n# Anchors not yet supported.\n\n!!!Not supported\n# Magic words and variables http://meta.wikimedia.org/wiki/Help:Magic_words\n# Template substitution http://meta.wikimedia.org/wiki/Help:Substitution\n# Template colon functions http://meta.wikimedia.org/wiki/Help:Colon_function\n# Template parser functions (eg #if) http://meta.wikimedia.org/wiki/ParserFunctions\n\n***/\n\n//{{{\n// Ensure that the MediaWikiFormatter Plugin is only installed once.\nif(!version.extensions.MediaWikiFormatterPlugin) {\nversion.extensions.MediaWikiFormatterPlugin = {installed:true};\n\nif(version.major &lt; 2 || (version.major == 2 &amp;&amp; version.minor &lt; 1))\n	{alertAndThrow(&quot;MediaWikiFormatterPlugin requires TiddlyWiki 2.1 or later.&quot;);}\n\nif(config.options.chkDisplayInstrumentation == undefined)\n	{config.options.chkDisplayInstrumentation = false;}\n\nif(config.options.chkMediaWikiDisplayEmptyTemplateLinks == undefined)\n	{config.options.chkMediaWikiDisplayEmptyTemplateLinks = false;}\nif(config.options.chkMediaWikiDisplayEnableThumbZoom == undefined)\n	{config.options.chkMediaWikiDisplayEnableThumbZoom = false;}\nif(config.options.chkMediaWikiListReferences == undefined)\n	{config.options.chkMediaWikiListReferences = false;}\n\nMediaWikiFormatter = {}; // &quot;namespace&quot; for local functions\n\nmwDebug = function(out,str)\n{\n	createTiddlyText(out,str.replace(/\sn/mg,&quot;\s\sn&quot;).replace(/\sr/mg,&quot;RR&quot;));\n	createTiddlyElement(out,&quot;br&quot;);\n};\n\nwikify = function(source,output,highlightRegExp,tiddler)\n{\n	if(source &amp;&amp; source != &quot;&quot;) {\n		var w = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);\n		w.linkCount = 0;\n		w.tableDepth = 0;\n		w.output = tiddler==null ? output : createTiddlyElement(output,&quot;p&quot;);\n		var time1,time0 = new Date();\n		w.subWikifyUnterm(w.output);\n		if(tiddler &amp;&amp; config.options.chkDisplayInstrumentation) {\n			time1 = new Date();\n			var t = tiddler ? tiddler.title : source.substr(0,10);\n			displayMessage(&quot;Wikify '&quot;+t+&quot;' in &quot; + (time1-time0) + &quot; ms&quot;);\n		}\n	}\n//#at point of usage can use:\n//#var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName==&quot;P&quot; ? w.output.parentNode : w.output;\n};\n\nMediaWikiFormatter.getTemplateParams = function(w)\n{\n//#{{test|a|b}}\n//#{{test|n=a|m=b}}\n	var params = {};\n\n	var i = 1;\n	var text = w.source + &quot;|&quot;;\n	var pRegExp = /(?:([^\s|]*)=)?([^\s|]*)\s|/mg;\n	var match = pRegExp.exec(text);\n	if(match) {\n		// skip template name\n		match = pRegExp.exec(text);\n	}\n	while(match) {\n		//params[match[1] ? match[1] : i++] = match[2];\n		if(match[1]) {\n			params[match[1]] = match[2];\n		} else {\n			params[i] = match[2];\n			i++;\n		}\n		match = pRegExp.exec(text);\n	}\n	return params;\n};\n\nMediaWikiFormatter.expandTemplate = function(w,tiddler,params)\n// see http://meta.wikimedia.org/wiki/Help:Template\n{\n	var text = tiddler.text;\n	text = text.replace(/&lt;noinclude&gt;((?:.|\sn)*?)&lt;\s/noinclude&gt;/mg,&quot;&quot;);// remove text between noinclude tags\n	var ioRegExp = /&lt;includeonly&gt;((?:.|\sn)*?)&lt;\s/includeonly&gt;/mg;\n	var t = &quot;&quot;;\n	var match = ioRegExp.exec(text);\n	while(match) {\n		t += match[1];\n		match = ioRegExp.exec(text);\n	}\n	text = t == &quot;&quot; ? text : t;\n\n	var paramsRegExp = /\s{\s{\s{(.*?)(?:\s|(.*?))?\s}\s}\s}/mg;\n	t = &quot;&quot;;\n	var pi = 0;\n	match = paramsRegExp.exec(text);\n	while(match) {\n		var name = match[1];\n		var def = match[2];\n		var val = params[name];\n		if(!val) {\n			val = def;\n		}\n		if(!val) {\n			val = match[0];\n		}\n		t += text.substring(pi,match.index) + val;\n		pi = paramsRegExp.lastIndex;\n		match = paramsRegExp.exec(text);\n	}\n	return t == &quot;&quot; ? text : t;\n};\n\nMediaWikiFormatter.endOfParams = function(w,text)\n{\n	var p = 0;\n	var i = text.indexOf(&quot;|&quot;);\n	if(i==-1) {return -1;}\n	var n = text.indexOf(&quot;\sn&quot;);\n	if(n!=-1 &amp;&amp; n&lt;i) {return -1;}\n	var b = text.indexOf(&quot;[[&quot;);\n	if(b!=-1 &amp;&amp; b&lt;i) {return -1;}// can't have [[ in parameters\n	\n	b = text.indexOf(&quot;{{&quot;);\n	while(b!=-1 &amp;&amp; b&lt;i) {\n		// have {{ before |, so need to find first &quot;|&quot; after &quot;{{..}}&quot; pairs\n		//cut off the ..{{, find the }} cut off and repeat\n		p += b;\n		text = text.substr(b);\n		var c = text.indexOf(&quot;}}&quot;);\n		p += c;\n		text = text.substr(c);\n		i = text.indexOf(&quot;|&quot;);\n		if(i==-1) {return -1;}\n		n = text.indexOf(&quot;\sn&quot;);\n		if(n!=-1 &amp;&amp; n&lt;i) {return -1;}\n		b = text.indexOf(&quot;{{&quot;);\n		i = -1;\n	}\n	return i;\n};\n\nMediaWikiFormatter.readToDelim = function(w)\n//!!! this is a bit rubish, needs doing properly.\n{\n//#delimiter, startBracket terminatorBracket\n	var dRegExp = /\s|/mg;\n	var sRegExp = /\s[\s[/mg;\n	var tRegExp = /\s]\s]/mg;\n\n	dRegExp.lastIndex = w.startMatch;\n	var dMatch = dRegExp.exec(w.source);\n	sRegExp.lastIndex = w.startMatch;\n	var sMatch = sRegExp.exec(w.source);\n	tRegExp.lastIndex = w.startMatch;\n	var tMatch = tRegExp.exec(w.source);\n	if(!tMatch) {\n		//mwDebug(w.output,&quot;ERROR1&quot;);\n		return false;\n	}\n\n	while(sMatch &amp;&amp; sMatch.index&lt;tMatch.index) {\n		if(dMatch &amp;&amp; dMatch.index&lt;sMatch.index) {\n			//# delim is before startBracket, so return it\n//mwDebug(w.output,&quot;di:&quot;+dMatch.index+&quot; dl:&quot;+sRegExp.lastIndex);\n			w.nextMatch = dRegExp.lastIndex;\n			w.matchLength = dMatch.index - w.startMatch;\n			return true;\n		}\n//mwDebug(w.output,&quot;si:&quot;+sMatch.index+&quot; sl:&quot;+sRegExp.lastIndex);\n//mwDebug(w.output,&quot;ti:&quot;+tMatch.index+&quot; tl:&quot;+tRegExp.lastIndex);\n		//# startBracket before termBracket, so skip over bracket pairs\n		// found eg [[, so look for ]]\n		tRegExp.lastIndex = sRegExp.lastIndex;\n		tMatch = tRegExp.exec(w.source);\n//mwDebug(w.output,&quot;xti:&quot;+tMatch.index+&quot; tl:&quot;+tRegExp.lastIndex);\n		\n		// and look for another [[\n		w.nextMatch = tRegExp.lastIndex;\n		dRegExp.lastIndex = w.nextMatch;\n		dMatch = dRegExp.exec(w.source);\n		sRegExp.lastIndex = w.nextMatch;\n		sMatch = sRegExp.exec(w.source);\n		tRegExp.lastIndex = w.nextMatch;\n		tMatch = tRegExp.exec(w.source);\n	}\n		\n	if(dMatch &amp;&amp; dMatch.index&lt;tMatch.index) {\n		//# delim is before term, so return it\n//mwDebug(w.output,&quot;2di:&quot;+dMatch.index+&quot; dl:&quot;+sRegExp.lastIndex);\n		w.nextMatch = dRegExp.lastIndex;\n		w.matchLength = dMatch.index - w.startMatch;\n		return true;\n	}\n	if(tMatch) {\n		//# delim is before term, so return it\n//mwDebug(w.output,&quot;2ti:&quot;+tMatch.index+&quot; tl:&quot;+tRegExp.lastIndex);\n		w.nextMatch = tRegExp.lastIndex;\n		w.matchLength = tMatch.index - w.startMatch;\n		return false;\n	}\n	//mwDebug(w.output,&quot;ERROR2&quot;);\n	//# return term\n	w.nextMatch = tRegExp.lastIndex;\n	w.matchLength = -1;\n	return false;\n};\n\nMediaWikiFormatter.getParams = function(w)\n{\n	var params = [];\n	var i = 1;\n	w.startMatch = w.nextMatch;\n	var read = MediaWikiFormatter.readToDelim(w);\n	if(w.matchLength!=-1) {\n		params[i] = w.source.substr(w.startMatch,w.matchLength);\n	}\n	while(read) {\n		i++;\n		w.startMatch = w.nextMatch;\n		read = MediaWikiFormatter.readToDelim(w);\n		if(w.matchLength!=-1) {\n			params[i] = w.source.substr(w.startMatch,w.matchLength);\n		}\n	}\n	return params;\n};\n\nMediaWikiFormatter.setFromParams = function(w,p)\n{\n	var r = {};\n	var re = /\ss*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\sw|%|#)*))/mg;\n	var match = re.exec(p);\n	while(match)\n		{\n		var s = match[1].unDash();\n		if(match[2]) {\n			r[s] = match[2];\n		} else if(match[3]) {\n			r[s] = match[3];\n		} else {\n			r[s] = match[4];\n		}\n		match = re.exec(p);\n	}\n	return r;\n};\n\nMediaWikiFormatter.setAttributesFromParams = function(e,p)\n{\n	var re = /\ss*(.*?)=(?:(?:&quot;(.*?)&quot;)|(?:'(.*?)')|((?:\sw|%|#)*))/mg;\n	var match = re.exec(p);\n	while(match) {\n		var s = match[1].unDash();\n		if(s == &quot;bgcolor&quot;) {\n			s = &quot;backgroundColor&quot;;\n		}\n		try {\n			if(match[2]) {\n				e.setAttribute(s,match[2]);\n			} else if(match[3]) {\n				e.setAttribute(s,match[3]);\n			} else {\n				e.setAttribute(s,match[4]);\n			}\n		}\n		catch(ex) {}\n		match = re.exec(p);\n	}\n};\n\nconfig.mediaWikiFormatters = [\n{\n	name: &quot;mediaWikiHeading&quot;,\n	match: &quot;^={2,6}(?!=)\s\sn?&quot;,\n	termRegExp: /(={2,6}\sn?)/mg,\n	handler: function(w)\n	{\n		//var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName==&quot;P&quot; ? w.output.parentNode : w.output;\n		var output = w.output;\n		var e = createTiddlyElement(output,&quot;h&quot; + w.matchLength);\n		var a = createTiddlyElement(e,&quot;a&quot;);// drop anchor\n		var t = w.tiddler ? w.tiddler.title + &quot;:&quot; : &quot;&quot;;\n		var len = w.source.substr(w.nextMatch).indexOf(&quot;=&quot;);\n		a.setAttribute(&quot;name&quot;,t+w.source.substr(w.nextMatch,len));\n		w.subWikifyTerm(e,this.termRegExp);\n		//w.output = createTiddlyElement(output,&quot;p&quot;);\n	}\n},\n\n{\n	name: &quot;mediaWikiTable&quot;,\n	match: &quot;^\s\s{\s\s|&quot;, // ^{|\n	tableTerm: &quot;\s\sn\s\s|\s\s}&quot;, // |}\n	rowStart: &quot;\s\sn\s\s|\s\s-&quot;, // \sn|-\n	cellStart: &quot;\s\sn!|!!|\s\s|\s\s||\s\sn\s\s|&quot;, //\sn! or !! or || or \sn|\n	caption: &quot;\s\sn\s\s|\s\s+&quot;,\n	rowTerm: null,\n	cellTerm: null,\n	inCellTerm: null,\n	tt: 0,\n	debug: null,\n	rowTermRegExp: null,\n	handler: function(w)\n	{\n		if(!this.rowTermRegExp) {\n			this.rowTerm = &quot;(&quot; + this.tableTerm +&quot;)|(&quot; + this.rowStart + &quot;)&quot;;\n			this.cellTerm = this.rowTerm + &quot;|(&quot; + this.cellStart + &quot;)&quot;;\n			this.inCellTerm = &quot;(&quot; + this.match + &quot;)|&quot; + this.rowTerm + &quot;|(&quot; + this.cellStart + &quot;)&quot;;\n			this.caption = &quot;(&quot; + this.caption + &quot;)|&quot; + this.cellTerm;\n\n			this.rowTermRegExp = new RegExp(this.rowTerm,&quot;mg&quot;);\n			this.cellTermRegExp = new RegExp(this.cellTerm,&quot;mg&quot;);\n			this.inCellTermRegExp = new RegExp(this.inCellTerm,&quot;mg&quot;);\n			this.captionRegExp = new RegExp(this.caption,&quot;mg&quot;);\n		}\n//this.debug = createTiddlyElement(w.output,&quot;p&quot;);\n//mwDebug(this.debug,&quot;start table&quot;);\n		this.captionRegExp.lastIndex = w.nextMatch;\n		var match = this.captionRegExp.exec(w.source);\n		if(!match) {return;}\n		//var inPara = w.output.nodeType==1 &amp;&amp; w.output.nodeName==&quot;P&quot; ? true : false;\n		//var output = inPara ? w.output.parentNode : w.output;\n		var output = w.output;\n		var table = createTiddlyElement(output,&quot;table&quot;);\n		var rowContainer = table;\n\n		var i = w.source.indexOf(&quot;\sn&quot;,w.nextMatch);\n		if(i&gt;w.nextMatch) {\n			MediaWikiFormatter.setAttributesFromParams(table,w.source.substring(w.nextMatch,i));\n			w.nextMatch = i;\n		}\n\n		var rowCount = 0;\n		var eot = false;\n		if(match[1]) {\n			// caption\n			var caption = createTiddlyElement(table,&quot;caption&quot;);\n			w.nextMatch = this.captionRegExp.lastIndex;\n			var captionText = w.source.substring(w.nextMatch);\n			var n = captionText.indexOf(&quot;\sn&quot;);\n			captionText = captionText.substr(0,n);\n			i = MediaWikiFormatter.endOfParams(w,captionText);\n			if(i!=-1) {\n				captionText = w.source.substr(w.nextMatch,i);\n				//captionText = captionText.replace(/^\s+/mg,&quot;&quot;)//!!hack until I fix this properly\n				//MediaWikiFormatter.setAttributesFromParams(caption,captionText);\n				w.nextMatch += i+1;\n			}\n			if(caption != table.firstChild) {\n				table.insertBefore(caption,table.firstChild);\n			}\n			w.subWikify(caption,this.cellTerm);\n			w.nextMatch -= w.matchLength;// rewind to before the match\n			this.cellTermRegExp.lastIndex = w.nextMatch;\n			var match2 = this.cellTermRegExp.exec(w.source);\n			if(match2) {\n				if(match2[3]) {\n					// no first row marker\n					eot = this.rowHandler(w,createTiddlyElement(rowContainer,&quot;tr&quot;));\n					rowCount++;\n				}\n			}\n		} else if(match[3]) {\n			// row\n			w.nextMatch = this.captionRegExp.lastIndex-match[3].length;// rewind to before the match\n		} else if(match[4]) {\n			// cell, no first row marker in table\n			w.nextMatch = this.captionRegExp.lastIndex-match[4].length;// rewind to before the match\n			eot = this.rowHandler(w,createTiddlyElement(rowContainer,&quot;tr&quot;));\n			rowCount++;\n		}\n\n		this.rowTermRegExp.lastIndex = w.nextMatch;\n		match = this.rowTermRegExp.exec(w.source);\n		while(match &amp;&amp; eot==false) {\n			if(match[1]) {\n				// end table\n				w.nextMatch = this.rowTermRegExp.lastIndex;\n				if(w.tableDepth==0) {\n					return;\n				}\n			} else if(match[2]) {\n				// row\n				var rowElement = createTiddlyElement(rowContainer,&quot;tr&quot;);\n				w.nextMatch += match[2].length;// skip over the match\n				i = w.source.indexOf(&quot;\sn&quot;,w.nextMatch);\n				if(i&gt;w.nextMatch) {\n					MediaWikiFormatter.setAttributesFromParams(rowElement,w.source.substring(w.nextMatch,i));\n					w.nextMatch = i;\n				}\n				eot = this.rowHandler(w,rowElement);\n			}\n			rowCount++;\n			this.rowTermRegExp.lastIndex = w.nextMatch;\n			match = this.rowTermRegExp.exec(w.source);\n		}//# end while\n		if(w.tableDepth==0) {\n			w.nextMatch +=3;// skip over tableterm, \sn|}\n		}\n		//if(inPara)\n		//	w.output = createTiddlyElement(output,&quot;p&quot;);\n	},//# end handler\n\n	rowHandler: function(w,e)\n	{// assumes w.nextMatch points to first cell terminator, returns false if any improperly terminated element\n		var cell;\n		this.inCellTermRegExp.lastIndex = w.nextMatch;\n		var match = this.inCellTermRegExp.exec(w.source);\n		while(match) {\n			if(match[1])\n				{// nested table\n				w.tableDepth++;\n				w.subWikify(cell,this.tableTerm);\n				w.nextMatch = this.tt;\n				w.tableDepth--;\n				return false;\n			} else if(match[2]) {\n				//# end table\n				this.tt = this.inCellTermRegExp.lastIndex;\n				return true;\n			} else if(match[3]) {\n				//# end row\n				return false;\n			} else if(match[4]) {\n				//# cell\n				var len = match[4].length;\n				cell = createTiddlyElement(e,match[4].substr(len-1)==&quot;!&quot;?&quot;th&quot;:&quot;td&quot;);\n				w.nextMatch += len;//skip over the match\n\n				this.inCellTermRegExp.lastIndex = w.nextMatch;\n				var lookahead = this.inCellTermRegExp.exec(w.source);\n				if(!lookahead) {\n					return false;// improperly terminated table\n				}\n				var cellText = w.source.substr(w.nextMatch,lookahead.index-w.nextMatch);\n				var oldSource = w.source;\n				var i = MediaWikiFormatter.endOfParams(w,cellText);//cellText.indexOf(&quot;|&quot;);\n				if(i!=-1) {\n					cellText = cellText.replace(/^\s+/mg,&quot;&quot;);  //!!hack until I fix this properly\n					MediaWikiFormatter.setAttributesFromParams(cell,cellText.substr(0,i-1));\n					cellText = cellText.substring(i+1);\n				}\n				cellText = cellText.replace(/^\ss*/mg,&quot;&quot;); //# remove leading spaces so not treated as preformatted\n				w.source = cellText;\n				w.nextMatch = 0;\n				w.subWikifyUnterm(cell);\n				w.source = oldSource;\n				w.nextMatch = lookahead.index;\n			}\n			this.inCellTermRegExp.lastIndex = w.nextMatch;\n			match = this.inCellTermRegExp.exec(w.source);\n		}//# end while\n		return false;\n	}//# end rowHandler\n},\n\n{\n	name: &quot;mediaWikiList&quot;,\n	match: &quot;^[\s\s*#;:]+&quot;,\n	lookaheadRegExp: /^([\s*#;:])+(?: ?)/mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n		var output = w.output.parentNode;\n		var stack = [output];\n		var currLevel = 0, currType = null;\n		var listType, itemType;\n		w.nextMatch = w.matchStart;\n		this.lookaheadRegExp.lastIndex = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		while(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n			switch(lookaheadMatch[1]) {\n			case &quot;*&quot;:\n				listType = &quot;ul&quot;;\n				itemType = &quot;li&quot;;\n				break;\n			case &quot;#&quot;:\n				listType = &quot;ol&quot;;\n				itemType = &quot;li&quot;;\n				break;\n			case &quot;;&quot;:\n				listType = &quot;dl&quot;;\n				itemType = &quot;dt&quot;;\n				break;\n			case &quot;:&quot;:\n				listType = &quot;dl&quot;;\n				itemType = &quot;dd&quot;;\n				break;\n			default:\n				break;\n			}\n			var listLevel = lookaheadMatch[0].length;\n			w.nextMatch += listLevel;\n			if(listLevel &gt; currLevel) {\n				for(var i=currLevel; i&lt;listLevel; i++) {\n					stack.push(createTiddlyElement(stack[stack.length-1],listType));\n				}\n			} else if(listLevel &lt; currLevel) {\n				for(i=currLevel; i&gt;listLevel; i--) {\n					stack.pop();\n				}\n			} else if(listLevel == currLevel &amp;&amp; listType != currType) {\n				stack.pop();\n				stack.push(createTiddlyElement(stack[stack.length-1],listType));\n			}\n			currLevel = listLevel;\n			currType = listType;\n			var e = createTiddlyElement(stack[stack.length-1],itemType);\n			w.subWikifyTerm(e,this.termRegExp);\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n		w.output = createTiddlyElement(output,&quot;p&quot;);\n	}\n},\n\n{\n	name: &quot;mediaWikiRule&quot;,\n	match: &quot;^----+$\s\sn?&quot;,\n	handler: function(w)\n	{\n		var output = w.output.parentNode;\n		createTiddlyElement(output,&quot;hr&quot;);\n		w.output = createTiddlyElement(output,&quot;p&quot;);\n	}\n},\n\n{\n	name: &quot;mediaWikiLeadingSpaces&quot;,\n	match: &quot;^ &quot;,\n	lookaheadRegExp: /^ /mg,\n	termRegExp: /(\sn)/mg,\n	handler: function(w)\n	{\n		var e = createTiddlyElement(w.output,&quot;pre&quot;);\n		while(true) {\n			w.subWikifyTerm(e,this.termRegExp);\n			createTiddlyElement(e,&quot;br&quot;);\n			this.lookaheadRegExp.lastIndex = w.nextMatch;\n			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n			if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.nextMatch) {\n				w.nextMatch += lookaheadMatch[0].length;\n			} else {\n				break;\n			}\n		}\n	}\n},\n\n/*\n[[Image:Westminstpalace.jpg|frame|none|caption text]]\n//http://en.wikipedia.org/wiki/Image:Westminstpalace.jpg\n&lt;a href=&quot;/wiki/Image:Westminstpalace.jpg&quot; class=&quot;internal&quot; title=&quot;caption text&quot;&gt;\n&lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/3/39/Westminstpalace.jpg&quot;\n alt=&quot;caption text&quot; width=&quot;400&quot; height=&quot;300&quot; longdesc=&quot;/wiki/Image:Westminstpalace.jpg&quot; /&gt;\n&lt;/a&gt;\n\n[[image:Stockholm.jpg|right|350px|thumb|Stockholm panorama from the City Hall]]\n&lt;div class=&quot;thumb tright&quot;&gt;\n	&lt;div style=&quot;width:352px;&quot;&gt;\n		&lt;a href=&quot;/wiki/Image:Stockholm.jpg&quot; class=&quot;internal&quot; title=&quot;Stockholm panorama from the City Hall&quot;&gt;\n			&lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Stockholm.jpg/350px-Stockholm.jpg&quot; alt=&quot;Stockholm panorama from the City Hall&quot; width=&quot;350&quot; height=&quot;84&quot; longdesc=&quot;/wiki/Image:Stockholm.jpg&quot; /&gt;\n		&lt;/a&gt;\n		&lt;div class=&quot;thumbcaption&quot;&gt;\n			&lt;div class=&quot;magnify&quot; style=&quot;float:right&quot;&gt;\n				&lt;a href=&quot;/wiki/Image:Stockholm.jpg&quot; class=&quot;internal&quot; title=&quot;Enlarge&quot;&gt;\n				&lt;img src=&quot;/skins-1.5/common/images/magnify-clip.png&quot; width=&quot;15&quot; height=&quot;11&quot; alt=&quot;Enlarge&quot; /&gt;\n				&lt;/a&gt;\n			&lt;/div&gt;\n			Stockholm panorama from the City Hall\n		&lt;/div&gt;\n	&lt;/div&gt;\n&lt;/div&gt;\n*/\n\n{\n	name: &quot;mediaWikiImage&quot;,\n	match: &quot;\s\s[\s\s[(?:[Ii]mage|Bild):&quot;,\n	lookaheadRegExp: /\s[\s[(?:[Ii]mage|Bild):/mg,\n	defaultPx: 180,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var params = MediaWikiFormatter.getParams(w);\n			var src = params[1];\n			src = src.trim().replace(/ /mg,&quot;_&quot;);\n			src = src.substr(0,1).toUpperCase() + src.substring(1);\n			var palign = null;\n			var ptitle = null;\n			var psrc = false;\n			var px = null;\n			var pthumb = false;\n			var pframed = false;\n			for(var i=2;i&lt;params.length;i++) {\n				//# right, left, center, none, sizepx, thumbnail (thumb), frame, and alternate (caption) text.\n				var p = params[i];\n				if(p==&quot;right&quot;||p==&quot;left&quot;||p==&quot;center&quot;||p==&quot;none&quot;) {\n					palign = p;\n				} else if(p==&quot;thumbnail&quot;||p==&quot;thumb&quot;) {\n					pthumb = true;\n				} else if(p==&quot;framed&quot;) {\n					pframed = true;\n				} else if(/\sd{1,4} ?px/.exec(p)) {\n					px = p.substr(0,p.length-2).trim();\n				} else {\n					ptitle = p;\n				}\n			}//#end for\n			if(pthumb) {\n				var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName==&quot;P&quot; ? w.output.parentNode : w.output;\n				if(!palign) {\n					palign = &quot;right&quot;;\n				}\n				if(!px) {\n					px = 180;\n				}\n				psrc = px + &quot;px-&quot; + src;\n				var t = createTiddlyElement(output,&quot;div&quot;,null,&quot;thumb&quot;+(palign?&quot; t&quot;+palign:&quot;&quot;));\n				var s = createTiddlyElement(t,&quot;div&quot;);\n				s.style[&quot;width&quot;] = Number(px) + 2 + &quot;px&quot;;\n				var a = createTiddlyElement(s,&quot;a&quot;,null,&quot;internal&quot;);\n				if(config.options.chkMediaWikiDisplayEnableThumbZoom) {\n					a.href = src;\n				}\n				a.title = ptitle;\n				var img = createTiddlyElement(a,&quot;img&quot;);\n				img.src = &quot;images/&quot; + psrc;\n//mwDebug(w.output,&quot;s1:&quot;+psrc);\n				img.width = px;\n				img.longdesc = &quot;Image:&quot; + src;\n				img.alt = ptitle;\n\n				var tc = createTiddlyElement(s,&quot;div&quot;,null,&quot;thumbcaption&quot;);\n				var oldSource = w.source; var oldMatch = w.nextMatch;\n				w.source = ptitle; w.nextMatch = 0;\n				w.subWikifyUnterm(tc);\n				w.source = oldSource; w.nextMatch = oldMatch;\n\n				if(config.options.chkMediaWikiDisplayEnableThumbZoom) {\n					var tm = createTiddlyElement(tc,&quot;div&quot;,null,&quot;magnify&quot;);\n					tm.style[&quot;float&quot;] = &quot;right&quot;;\n					var ta = createTiddlyElement(tm,&quot;a&quot;,null,&quot;internal&quot;);\n					ta.title = &quot;Enlarge&quot;;\n					timg = createTiddlyElement(ta,&quot;img&quot;); timg.src = &quot;magnify-clip.png&quot;; timg.alt = &quot;Enlarge&quot;; timg.width = &quot;15&quot;; timg.height = &quot;11&quot;;\n					ta.href = src;\n				}\n			} else {\n				// not pthumb\n				a = createTiddlyElement(w.output,&quot;a&quot;,null,&quot;image&quot;);\n				a.title = ptitle;\n				img = createTiddlyElement(a,&quot;img&quot;);\n				if(palign) {img.align = palign;}\n				img.src = px ? &quot;images/&quot; + px + &quot;px-&quot; + src : &quot;images/&quot; + src;\n//mwDebug(w.output,&quot;s2:&quot;+img.src);\n				if(px) {img.width = px;}\n				img.longdesc = &quot;Image:&quot; + src;\n				img.alt = ptitle;\n			}\n		}\n	}//#end image handler\n},\n\n{\n	name: &quot;mediaWikiExplicitLink&quot;,\n	match: &quot;\s\s[\s\s[&quot;,\n	lookaheadRegExp: /\s[\s[(?:([a-z]{2,3}:)?)(#?)([^\s|\s]]*?)(?:(\s]\s](\sw)*)|(\s|(.*?)\s]\s]))/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			if(!lookaheadMatch[1]) {\n				// not (eg) [[en:...]]\n				var e;\n				var link = lookaheadMatch[3];\n				var text = link;\n				link = link.substr(0,1).toUpperCase() + link.substring(1);\n				if(lookaheadMatch[4]) {\n					// Simple bracketted link\n					if(lookaheadMatch[2]) {\n						var a = createTiddlyElement(e,&quot;a&quot;);// drop anchor\n						a.setAttribute(&quot;name&quot;,link);\n					} else {\n						e = createTiddlyLink(w.output,link,false,null,w.isStatic);\n						if(lookaheadMatch[5]) {\n							text += lookaheadMatch[5];//add any non-space after the ]]\n						}\n						createTiddlyText(e,text);\n					}\n				} else if(lookaheadMatch[6]) {\n					// Piped link\n					if(config.formatterHelpers.isExternalLink(link)) {\n						e = createExternalLink(w.output,link);\n					} else {\n						e = createTiddlyLink(w.output,link,false,null,w.isStatic);\n					}\n					var oldSource = w.source; var oldMatch = w.nextMatch;\n					w.source = lookaheadMatch[7].trim(); w.nextMatch = 0;\n					w.subWikifyUnterm(e);\n					w.source = oldSource; w.nextMatch = oldMatch;\n				}\n			}\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n//#{{Audio|sv-Stockholm.ogg|Stockholm}}\n//**tem//\n{\n	name: &quot;mediaWikiTemplate&quot;,\n	match: &quot;\s\s{\s\s{[^\s\s{]&quot;,\n	lookaheadRegExp: /\s{\s{((?:.|\sn)*?)\s}\s}/mg,\n	handler: function(w)\n	{\n//mwDebug(w.output,&quot;wt:&quot;+w.matchText+&quot; ws:&quot;+w.matchStart+&quot; wn:&quot;+w.nextMatch+&quot; wl:&quot;+w.matchLength);\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n//mwDebug(w.output,&quot;lm:&quot;+lookaheadMatch);\n//mwDebug(w.output,&quot;lmi:&quot;+lookaheadMatch.index+&quot; lI:&quot;+this.lookaheadRegExp.lastIndex);\n//mwDebug(w.output,&quot;lm1:&quot;+lookaheadMatch[1]);\n//mwDebug(w.output,&quot;lm2:&quot;+lookaheadMatch[2]);\n			var lastIndex = this.lookaheadRegExp.lastIndex;\n			var contents = lookaheadMatch[1];\n			// see http://meta.wikimedia.org/wiki/Help:Variable\n			if(contents==&quot;PAGENAME&quot;) {\n				createTiddlyText(w.output,w.tiddler.title);\n				w.nextMatch = lastIndex;\n				return;\n			}\n			var i = contents.indexOf(&quot;|&quot;);\n			var title = i==-1 ? contents : contents.substr(0,i);\n			title = title.trim().replace(/_/mg,&quot; &quot;);// Underscore in template name is equivalent to space\n			title = &quot;Template:&quot; + title.substr(0,1).toUpperCase() + title.substring(1);\n			var tiddler = store.fetchTiddler(title);\n			var oldSource = w.source;\n			if(tiddler) {\n				params = {};\n				w.source = lookaheadMatch[1];\n				if(i!=-1) {\n					w.nextMatch = 0;\n					params = MediaWikiFormatter.getTemplateParams(w);\n				}\n				w.source = MediaWikiFormatter.expandTemplate(w,tiddler,params);\n				w.nextMatch = 0;\n				w.subWikifyUnterm(w.output);\n			} else {\n				if(config.options.chkMediaWikiDisplayEmptyTemplateLinks) {\n					// for conveniece, output the name of the template so can click on it and create tiddler\n					w.source = &quot;[[&quot;+title+&quot;]]&quot;;\n					w.nextMatch = 0;\n					w.subWikifyUnterm(w.output);\n				}\n			}\n			w.source = oldSource;\n			w.nextMatch = lastIndex;\n		}\n	}\n},\n\n{\n	name: &quot;mediaWikiParagraph&quot;,\n	match: &quot;\s\sn{2,}&quot;,\n	handler: function(w)\n	{\n		var output = w.output.nodeType==1 &amp;&amp; w.output.nodeName==&quot;P&quot; ? w.output.parentNode : w.output;\n		w.output = createTiddlyElement(output,&quot;p&quot;);\n	}\n},\n\n{\n	name: &quot;mediaWikiExplicitLineBreak&quot;,\n	match: &quot;&lt;br ?/?&gt;&quot;,\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,&quot;br&quot;);\n	}\n},\n\n{\n	name: &quot;mediaWikiExplicitLineBreakWithParams&quot;,\n	match: &quot;&lt;br(?:\s\ss*(?:(?:.*?)=[\s&quot;']?(?:.*?)[\s&quot;']?))*?\s\ss*/?&gt;&quot;,\n	lookaheadRegExp: /&lt;br((?:\ss+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)*?)?\ss*\s/?&gt;/mg,\n	handler: function(w)\n	{\n		//# copes with erroneous &lt;br clear=&quot;right&quot;&gt;\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var e =createTiddlyElement(w.output,&quot;br&quot;);\n			if(lookaheadMatch[1]) {\n				MediaWikiFormatter.setAttributesFromParams(e,lookaheadMatch[1]);\n			}\n			w.nextMatch = this.lookaheadRegExp.lastIndex;// empty tag\n		}\n	}\n},\n\n{\n	name: &quot;mediaWikiTitledUrlLink&quot;,\n	match: &quot;\s\s[&quot; + config.textPrimitives.urlPattern + &quot;(?:\s\ss+[^\s\s]]+)?&quot; + &quot;\s\s]&quot;,\n	//# eg [http://www.nupedia.com] or [http://www.nupedia.com Nupedia]\n	//# &lt;sup id=&quot;_ref-1&quot; class=&quot;reference&quot;&gt;&lt;a href=&quot;#_note-1&quot; title=&quot;&quot;&gt;[2]&lt;/a&gt;\n	handler: function(w)\n	{\n		var lookaheadRegExp = new RegExp(&quot;\s\s[(&quot; + config.textPrimitives.urlPattern + &quot;)(?:\s\ss+([^\s[]+))?&quot; + &quot;\s\s]&quot;,&quot;mg&quot;);\n		lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index==w.matchStart) {\n			var link = lookaheadMatch[1];\n			var s = createTiddlyElement(w.output,&quot;sup&quot;);\n			var e = createExternalLink(s,link);\n			if(lookaheadMatch[2]) {\n				var oldSource = w.source; var oldMatch = w.nextMatch;\n				w.source = lookaheadMatch[2].trim(); w.nextMatch = 0;\n				w.subWikifyUnterm(e);\n				w.source = oldSource; w.nextMatch = oldMatch;\n			} else {\n				w.linkCount++;\n				createTiddlyText(e,&quot;[&quot;+w.linkCount+&quot;]&quot;);\n			}\n			w.nextMatch = lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: &quot;mediaWikiUrlLink&quot;,\n	match: config.textPrimitives.urlPattern,\n	handler: function(w)\n	{\n		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);\n	}\n},\n\n{\n	name: &quot;mediaWikiBold&quot;,\n	match: &quot;'''&quot;,\n	termRegExp: /('''|\sn)/mg,\n	element: &quot;strong&quot;,\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: &quot;mediaWikiItalic&quot;,\n	match: &quot;''(?!')&quot;,\n	termRegExp: /(''(?!')|\sn)/mg,\n	element: &quot;em&quot;,\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: &quot;mediaWikiUnderline&quot;,\n	match: &quot;&lt;u&gt;&quot;,\n	termRegExp: /(&lt;\s/u&gt;|\sn)/mg,\n	element: &quot;u&quot;,\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: &quot;mediaWikiStrike&quot;,\n	match: &quot;&lt;s&gt;&quot;,\n	termRegExp: /(&lt;\s/s&gt;|\sn)/mg,\n	element: &quot;strike&quot;,\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: &quot;mediaWikiBoldTag&quot;,\n	match: &quot;&lt;b&gt;&quot;,\n	termRegExp: /(&lt;\s/b&gt;|\sn)/mg,\n	element: &quot;b&quot;,\n	handler: config.formatterHelpers.createElementAndWikify\n},\n\n{\n	name: &quot;mediaWikiTemplateParam&quot;,// note, this only gets invoked when viewing the template\n	match: &quot;\s\s{\s\s{\s\s{&quot;,\n	lookaheadRegExp: /(\s{\s{\s{(?:.|\sn)*?\s}\s}\s})/mg,\n	element: &quot;span&quot;,\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n//# See http://en.wikipedia.org/wiki/Wikipedia:Footnotes\n//# for an explanation of how to generate footnotes using the &lt;ref(erences/)&gt; tags\n{\n	name: &quot;mediaWikiInsertReference&quot;,\n	match: &quot;&lt;ref[^/]*&gt;&quot;,\n	lookaheadRegExp: /&lt;ref(\ss+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)?&gt;([^&lt;]*?)&lt;\s/ref&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var x = {id:&quot;&quot;,value:&quot;&quot;};\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n			if(!w.referenceCount) {\n				w.referenceCount = 0;\n				w.references = {};\n			}\n			var s = createTiddlyElement(w.output,&quot;sup&quot;,null,&quot;reference&quot;);\n			var a = createTiddlyElement(s,&quot;a&quot;);\n			var prefix = w.tiddler ? w.tiddler.title + &quot;:&quot; : &quot;&quot;;\n			if(lookaheadMatch[1]) {\n				var r = {};\n				r = MediaWikiFormatter.setFromParams(w,lookaheadMatch[1]);\n				var name = r.name ? r.name.trim() : &quot;&quot;;\n				name = name.replace(/ /g,&quot;_&quot;);\n				s.id = prefix + &quot;_ref-&quot; + name;// + &quot;_&quot; + nameCount;(w.referenceCount+1);\n				if(!w.references[name]) {\n					w.references[name] = x;\n					w.references[name].id = w.referenceCount;\n					w.references[name].value = lookaheadMatch[2].trim();\n				}\n			} else {\n				w.references[w.referenceCount] = x;\n				w.references[w.referenceCount].id = w.referenceCount;\n				w.references[w.referenceCount].value = lookaheadMatch[2].trim();\n				name = w.referenceCount;\n				s.id = prefix + &quot;_ref-&quot; + w.referenceCount;\n			}\n			w.referenceCount++;\n			a.title = lookaheadMatch[2].trim();//mb, extra to wikipedia\n			a.href = &quot;#&quot; + prefix + &quot;_note-&quot; + name;\n			a.innerHTML = &quot;[&quot;+w.referenceCount+&quot;]&quot;;\n//#&lt;sup id=&quot;_ref-0&quot; class=&quot;reference&quot;&gt;&lt;a href=&quot;#_note-0&quot; title=&quot;&quot;&gt;[1]&lt;/a&gt;&lt;/sup&gt;\n//#&lt;sup id=&quot;_ref-foreign_ministry_0&quot; class=&quot;reference&quot;&gt;&lt;a href=&quot;#_note-foreign_ministry&quot; title=&quot;&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt;\n		}\n	}\n},\n\n{\n	name: &quot;mediaWikiListReferences&quot;,\n	match: &quot;&lt;references ?/&gt;&quot;,\n	lookaheadRegExp: /&lt;references ?\s/&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(config.options.chkMediaWikiListReferences &amp;&amp; w.referenceCount) {\n			var ol = createTiddlyElement(w.output,&quot;ol&quot;,null,&quot;references&quot;);\n			var oldSource = w.source;\n			if(w.referenceCount&gt;0) {\n				for(var i in w.references) {\n					var li = createTiddlyElement(ol,&quot;li&quot;);\n					var prefix = w.tiddler ? w.tiddler.title + &quot;:&quot; : &quot;&quot;;\n					var b = createTiddlyElement(li,&quot;b&quot;);\n					var a = createTiddlyElement(b,&quot;a&quot;);\n					li.id = prefix + &quot;_note-&quot; + i;\n					a.href = &quot;#&quot; + prefix + &quot;_ref-&quot; + i;\n					a.innerHTML = &quot;^&quot;;\n					w.source = w.references[i].value;\n					w.nextMatch = 0;\n					w.subWikifyUnterm(li);\n				}\n			}\n			w.source = oldSource;\n		}\n		w.nextMatch = this.lookaheadRegExp.lastIndex;\n	}\n},\n\n{\n	name: &quot;mediaWikiRepeatReference&quot;,\n	match: &quot;&lt;ref[^/]*/&gt;&quot;,\n	lookaheadRegExp: /&lt;ref(\ss+(?:.*?)=&quot;(?:.*?)&quot;)?\ss*\s/&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var x = {id:&quot;&quot;,value:&quot;&quot;};\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n//#&lt;ref name=&quot;foreign ministry&quot;&gt;\n//#&lt;sup id=&quot;_ref-foreign_ministry_1&quot; class=&quot;reference&quot;&gt;&lt;a href=&quot;#_note-foreign_ministry&quot; title=&quot;&quot;&gt;[2]&lt;/a&gt;&lt;/sup&gt;\n			var s = createTiddlyElement(w.output,&quot;sup&quot;,null,&quot;reference&quot;);\n			var a = createTiddlyElement(s,&quot;a&quot;);\n			var prefix = w.tiddler ? w.tiddler.title : &quot;&quot;;\n			if(lookaheadMatch[1]) {\n				var r = {};\n				r = MediaWikiFormatter.setFromParams(w,lookaheadMatch[1]);\n				var name = r.name ? r.name.trim() : &quot;&quot;;\n				name = name.replace(/ /g,&quot;_&quot;);\n				s.id = prefix + &quot;_ref-&quot; + name +&quot;_&quot; + (w.referenceCount+1);\n				var count = w.references &amp;&amp; w.references[name] ? (w.references[name].id+1) : &quot;?&quot;;\n			}\n			a.href = &quot;#&quot; + prefix + &quot;_note-&quot; + name;\n			a.innerHTML = &quot;[&quot;+count+&quot;]&quot;;\n			a.title = name;\n		}\n	}//# end handler\n},\n\n{\n	name: &quot;mediaWikiHtmlEntitiesEncoding&quot;,\n	match: &quot;&amp;#?[a-zA-Z0-9]{2,8};&quot;,\n	handler: function(w)\n	{\n		createTiddlyElement(w.output,&quot;span&quot;).innerHTML = w.matchText;\n	}\n},\n\n{\n	name: &quot;mediaWikiComment&quot;,\n	match: &quot;&lt;!\s\s-\s\s-&quot;,\n	lookaheadRegExp: /&lt;!\s-\s-((?:.|\sn)*?)\s-\s-&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: &quot;mediaWikiIncludeOnly&quot;,\n	match: &quot;&lt;includeonly&gt;&quot;,\n	lookaheadRegExp: /&lt;includeonly&gt;((?:.|\sn)*?)&lt;\s/includeonly&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			w.nextMatch = this.lookaheadRegExp.lastIndex;\n		}\n	}\n},\n\n{\n	name: &quot;mediaWikiNoWiki&quot;,\n	match: &quot;&lt;nowiki&gt;&quot;,\n	lookaheadRegExp: /&lt;nowiki&gt;((?:.|\sn)*?)&lt;\s/nowiki&gt;/mg,\n	element: &quot;span&quot;,\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: &quot;mediaWikiPreNoWiki&quot;,\n	match: &quot;&lt;pre&gt;\ss*&lt;nowiki&gt;&quot;,\n	lookaheadRegExp: /&lt;pre&gt;\ss*&lt;nowiki&gt;((?:.|\sn)*?)&lt;\s/nowiki&gt;\ss*&lt;\s/pre&gt;/mg,\n	element: &quot;pre&quot;,\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: &quot;mediaWikiPre&quot;,\n	match: &quot;&lt;pre&gt;&quot;,\n	lookaheadRegExp: /&lt;pre&gt;((?:.|\sn)*?)&lt;\s/pre&gt;/mg,\n	element: &quot;pre&quot;,\n	handler: config.formatterHelpers.enclosedTextHelper\n},\n\n{\n	name: &quot;mediaWikiGallery&quot;,\n	match: &quot;&lt;gallery&gt;&quot;,\n	lookaheadRegExp: /[Ii]mage:(.*?)\sn/mg,\n	handler: function(w)\n	{\n//#basic syntax is:\n//#&lt;gallery&gt;\n//#Image:Wiki.png\n//#Image:Wiki.png|Captioned\n//#Image:Wiki.png|[[Help:Contents/Links|Links]] can be put in captions.\n//#Image:Wiki.png|Full [[MediaWiki]]&lt;br /&gt;[[syntax]] may now be used…\n//#&lt;/gallery&gt;\n//#&lt;table class=&quot;gallery&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;\n//#&lt;tr&gt;\n//#...\n//#&lt;/tr&gt;\n//#&lt;/table&gt;\n		var table = createTiddlyElement(w.output,&quot;table&quot;,null,&quot;gallery&quot;);\n		table.cellspacing = &quot;0&quot;;\n		table.cellpadding = &quot;0&quot;;\n		var rowElem = createTiddlyElement(table,&quot;tr&quot;);\n		var col = 0;\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var nM = w.nextMatch;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		var oldSource = w.source;\n		while(lookaheadMatch) {\n			nM += lookaheadMatch[1].length;\n			w.source = lookaheadMatch[1] +&quot;]]&quot;;//!! ]] is hack until getParams is working\n			w.nextMatch = 0;\n			var params = MediaWikiFormatter.getParams(w);\n			var src = params[1];\n			src = src.trim().replace(/ /mg,&quot;_&quot;);\n			src = src.substr(0,1).toUpperCase() + src.substring(1);\n			var palign = &quot;right&quot;; \n			var psrc = &quot;120px-&quot;+src;\n			var px = 120;\n			var pframed = false;\n			ptitle = null;\n			for(var i=2;i&lt;params.length;i++) {\n				//right, left, center, none, sizepx, thumbnail (thumb), frame, and alternate (caption) text.\n				var p = params[i];\n				if(p==&quot;right&quot;||p==&quot;left&quot;||p==&quot;center&quot;||p==&quot;none&quot;) {\n					palign = p;\n				} else if(p==&quot;framed&quot;) {\n					pframed = true;\n				} else if(/\sd{1,4}px/.exec(p)) {\n					px = p.substr(0,p.length-2).trim();\n					psrc = px + &quot;px-&quot; + src;\n				} else {\n					ptitle = p;\n				}\n			}//#end for\n//#&lt;td&gt;\n//#&lt;div class=&quot;gallerybox&quot;&gt;\n//#	&lt;div class=&quot;thumb&quot; style=&quot;padding: 26px 0;&quot;&gt;\n//#		&lt;a href=&quot;/wiki/Image:Paul_C%C3%A9zanne_184.jpg&quot; title=&quot;Image:Paul Cézanne 184.jpg&quot;&gt;\n//#		&lt;img src=&quot;http://upload.wikimedia.org/wikipedia/commons/thumb/6/60/Paul_C%C3%A9zanne_184.jpg/120px-Paul_C%C3%A9zanne_184.jpg&quot; width=&quot;120&quot; height=&quot;94&quot; alt=&quot;&quot; /&gt;\n//#		&lt;/a&gt;\n//#	&lt;/div&gt;\n//#	&lt;div class=&quot;gallerytext&quot;&gt;\n//#		&lt;p&gt;&lt;i&gt;La Pain et les Oeufs&lt;/i&gt; (Bread and Eggs), thought to present austerity, 1865. Signed and dated. Possibly in Spanish style.&lt;/p&gt;\n//#	&lt;/div&gt;\n//#&lt;/div&gt;\n//#&lt;/td&gt;\n			var td = createTiddlyElement(rowElem,&quot;td&quot;);\n			var gb = createTiddlyElement(td,&quot;div&quot;,null,&quot;gallerybox&quot;);\n			var t = createTiddlyElement(gb,&quot;div&quot;,null,&quot;thumb&quot;);\n			t.style[&quot;padding&quot;] = &quot;26px 0&quot;;\n\n			var a = createTiddlyElement(t,&quot;a&quot;);\n			if(config.options.chkMediaWikiDisplayEnableThumbZoom) {\n				a.href = src;\n			}\n			a.title = ptitle;\n			var img = createTiddlyElement(a,&quot;img&quot;);\n			img.src = psrc;\n			img.width = px;\n			img.alt = &quot;&quot;;//ptitle;\n\n			var gt = createTiddlyElement(gb,&quot;div&quot;,null,&quot;gallerytext&quot;);\n			p = createTiddlyElement(gt,&quot;p&quot;);\n			var oldSource2 = w.source; var oldMatch = w.nextMatch;\n			w.source = ptitle; w.nextMatch = 0;\n			w.subWikifyUnterm(p);\n			w.source = oldSource2; w.nextMatch = oldMatch;\n\n			col++;\n			if(col&gt;3) {\n				rowElem = createTiddlyElement(table,&quot;tr&quot;);\n				col = 0;\n			}\n			w.source = oldSource;\n			lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		}\n		w.nextMatch = nM + &quot;&lt;gallery&gt;&quot;.length*2+1+&quot;Image:&quot;.length;//!! hack\n	}\n},\n\n{\n	name: &quot;mediaWikiHtmlTag&quot;,\n	match: &quot;&lt;[a-zA-Z]{2,}(?:\s\ss*(?:(?:.*?)=[\s&quot;']?(?:.*?)[\s&quot;']?))*?&gt;&quot;,\n	lookaheadRegExp: /&lt;([a-zA-Z]{2,})((?:\ss+(?:.*?)=[&quot;']?(?:.*?)[&quot;']?)*?)?\ss*(\s/)?&gt;/mg,\n	handler: function(w)\n	{\n		this.lookaheadRegExp.lastIndex = w.matchStart;\n		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);\n		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {\n			var e =createTiddlyElement(w.output,lookaheadMatch[1]);\n			if(lookaheadMatch[2]) {\n				MediaWikiFormatter.setAttributesFromParams(e,lookaheadMatch[2]);\n			}\n			if(lookaheadMatch[3]) {\n				w.nextMatch = this.lookaheadRegExp.lastIndex;// empty tag\n			} else {\n				w.subWikify(e,&quot;&lt;/&quot;+lookaheadMatch[1]+&quot;&gt;&quot;);\n			}\n		}\n	}\n}\n];\n\nconfig.parsers.mediaWikiFormatter = new Formatter(config.mediaWikiFormatters);\nconfig.parsers.mediaWikiFormatter.formatTag = &quot;MediaWikiFormat&quot;;\n} // end of &quot;install only once&quot;\n//}}}\n</div>
