<html>
<head>

<script src="jquery.js" type="text/javascript"></script>
<script src="canvasMaps3D.js" type="text/javascript"></script>
<script src="proj4js.js" type="text/javascript"></script>
<script src="merc.js" id="lib/projCode/merc.js" type="text/javascript"></script>



<script src="geojsons/whereLegal.js" type="text/javascript"></script>


<script>
var eMap = null;
function init(){
	eMap = new EasyMap('wrapper');
	eMap.wrapper.onmouseup = function(e){
	

		var s = eMap.utils.getShapeAtClick(e);
		console.log("clicked", s);
		if(s){
			alert(s.properties.name);
			}
	};
	eMap.settings.background = "#000000";
	eMap.utils = EasyMapUtils;
	//eMap.utils._testCanvas(eMap.canvas.getContext('2d'));


	eMap.addControl("pan");
	eMap.addControl("zoom");
	eMap.addControl("mousepanning");
	eMap.addControl("mousewheelzooming");
	


var that = eMap;
eMap.clear();
eMap._fittocanvas = false;

var ctx = eMap.canvas.getContext('2d');



var p = {};
p.source = new Proj4js.Proj('WGS84');//
p.dest = new Proj4js.Proj('GOOGLE');
p.inversexy = function(x,y){
	x /= 0.0000063;
	y /= 0.0000063;
	var pointSource = new Proj4js.Point(x ,y);
	var pointDest = Proj4js.transform(p.dest,p.source, pointSource);

	return pointDest;
}
	
p.xy = function(x,y){
		var pointSource = new Proj4js.Point(x,y);
		var pointDest = Proj4js.transform(p.source,p.dest, pointSource);


		
		var newx =pointDest.x;
		var newy = pointDest.y;
		//newx /= Math.pow(2,17);
		//newy /=Math.pow(2,17);
		//19 zoom levels in google
		//console.log(newx,newy);
		newx *= 0.0000063;
		newy *= 0.0000063;

		var res = {x:newx , y:newy};
				
		return res;
}


eMap.settings.projection = p;



eMap.controller.oldtransform = eMap.controller.transform;
eMap.controller.transform = function(){
console.log(this._googlezoomer);
	if(!this._googlezoomer) {
		this._googlezoomer = 0;
		this._oldscale = 0;
		console.log("initzoom");
	}


	var x =0;
	var y =0;

	var  t= this.transformation.translate;
	var  scale= this.transformation.scale;

	var res = p.inversexy(t.x,t.y);
	x = -res.x;
	y = res.y;

	if(this._oldscale > scale.x){
		this._googlezoomer -= 1;
	}
	else if(this._oldscale < scale.x){
		this._googlezoomer += 1;
	}
	var zoomL = this._googlezoomer;
	eMap.settings.backgroundimg = "http://maps.google.com/staticmap?center="+y+","+x+"&zoom="+zoomL+"&size=600x400&key=YOUR_KEY_HERE";


	this._oldscale = scale.x;
	this.oldtransform();

};

eMap._fittocanvas = false;

//eMap.settings.backgroundimg = "http://maps.google.com/staticmap?center=0,0&zoom=0&size=600x400&key=YOUR_KEY_HERE";


eMap.drawFromGeojsonFile('geojsons/myjson.json');
eMap.controller.setTransformation({translate:{x:0,y:0},scale: {x:1, y:1},rotate: {x:1,y:1}});



}

</script>
</head>
<body onload="window.setTimeout(init,0)">

<div id='wrapper' style="width:600; height:400;position:relative;">
	<div id ='caption'></div>
	<div id='wrapper_statustext'>please wait while we load... </div>
</div>
<div id='time'></div>
<br>
<br>
<br>
<a href="javascript:eMap.zoom(0.5,0.5)">zoom in</a> <a href="javascript:eMap.zoom(-0.5,-0.5)">zoom out</a>


<a href="javascript:eMap.pan(0,20)">up</a> <a href="javascript:eMap.pan(0,-20)">down</a>

<a href="javascript:eMap.pan(20,0)">left</a> <a href="javascript:eMap.pan(-20,0)">right</a>


<div id='consolelogger'></div>


</body>
</html>