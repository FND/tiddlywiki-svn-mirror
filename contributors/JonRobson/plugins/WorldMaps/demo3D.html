<html>
<head>


<script src="jquery.js" type="text/javascript"></script>

<script src="../../verticals/GeoTiddlyWiki/EasyThingsLib/EasyController.js" type="text/javascript"></script>
<script src="../../verticals/GeoTiddlyWiki/EasyThingsLib/EasyMaps.js" type="text/javascript"></script>
<script src="../../verticals/GeoTiddlyWiki/EasyThingsLib/EasyShapes.js" type="text/javascript"></script>
<script src="../../verticals/GeoTiddlyWiki/EasyThingsLib/EasyClickingUtils.js" type="text/javascript"></script>
<script src="../../verticals/GeoTiddlyWiki/EasyThingsLib/EasyFileUtils.js" type="text/javascript"></script>

<script src="../../verticals/GeoTiddlyWiki/EasyThingsLib/EasyMapUtils.js" type="text/javascript"></script>
<script src="../../verticals/GeoTiddlyWiki/EasyThingsLib/EasyClicking.js" type="text/javascript"></script>
<script src="geojsons/whereLegal.js" type="text/javascript"></script>

<script>
var eMap = null;
function init(){
	eMap = new EasyMap('wrapper');
	eMap.utils = EasyMapUtils;
	
	var that = eMap;
	var myElement = document.getElementById('caption');
	

	
	function highlight(shape){
		that.oldcolor = shape.fillStyle;
		that.oldstrokecolor = shape.strokeStyle;
		shape.fillStyle = "#FFFFFF";
		shape.strokeStyle = "#FFFFFF";
		var el = myElement;
		if(el.style.display == 'none'){
			el.style.position = "absolute";
			el.style.display = "";
			var legal = "";
			if(shape.properties.legality == 1) legal = " (legal)";
			else if(shape.properties.legality == 0) legal = "(illegal)";
			else legal = "(no data)";
			el.innerHTML = shape.tooltip + legal;
			el.style.left =0;
			el.style.top = 300;

		}	
		that.redrawShape(shape);
	}
	
	function dehighlight(shape){
		if(!shape) return;
		if(that.oldcolor)shape.fillStyle = that.oldcolor;
		if(that.oldstrokecolor)shape.strokeStyle = that.oldstrokecolor;
		that.redrawShape(shape);
		myElement.style.display = "none";
	}
	
	var shapeHighlighted;
	eMap.mousemoveHandler = function(e){
		try{
		var t1 = new Date();
		var shape = eMap.getShapeAt(e);
		var t2 = new Date();
		var time = t2-t1;
	
		if(!shape) {
			dehighlight(shapeHighlighted);
			shapeHighlighted = null;
			return;
		}
		
		if(shapeHighlighted) dehighlight(shapeHighlighted);
			highlight(shape);
			shapeHighlighted = shape;
		}
		catch(e){
			document.getElementById('time').innerHTML += e + ",";
		}

	};

	eMap.wrapper.onclick = function(e){

		var s = eMap.easyClicking.getShapeAtClick(e);
		console.log(s);
		
		if(s)
			alert(s.properties.name);
	};

	eMap.controller.addControl("zoom");
	eMap.controller.addControl("rotation");
	eMap.controller.addControl("mousepanning");
	console.log(eMap.canvas.transformation);
	
	eMap.setProjection("GLOBE");
		//c = shape.spherify(this.canvas.transformation);
	
	
	
	eMap.drawFromGeojsonFile('geojsons/wherelegal2.json');

	function spin(){
	
		var transformation = eMap.controller.transformation;
		transformation.rotate.z += 0.1;
		if(transformation.rotate.z > EasyMapUtils._degToRad(360))
		transformation.rotate.z = 0;
		
	
		//transformation.rotate= {x:0,y:0};
		eMap.controller.setTransformation(transformation);
	
		window.setTimeout(spin,1000);
	}
	window.setTimeout(spin,10);
}

</script>
</head>
<h1>3D demo</h1>
<body onload="window.setTimeout(init,0)">

<div id='wrapper' style="width:800; height:400;position:relative;">
	<div id ='caption'></div>
	<div id='wrapper_statustext'>please wait while we load... </div>
</div>
<div id='time'></div>







</body>
</html>