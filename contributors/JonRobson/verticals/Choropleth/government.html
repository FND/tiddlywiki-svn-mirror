<html>
<head>
	<style type="text/css">
	textarea {width:100%;height:100px;}
	    </style>
	
<script src='jquery-1.3.2.min.js' type="text/javascript"></script>	
<script src='coloringrules.js' type="text/javascript"></script>
<script src='choropleth.js' type="text/javascript"></script>
<script src='data.js.data' type="text/javascript"></script>
<script src='counciltax.json' type="text/javascript"></script>

<script type="text/javascript">
var map,data;
function colorData(data,rule,params){
	if(typeof rule == 'string'){
		if(rule == "") return;
		rule = library.rules[rule];
	}
	
	if(!data.features) return;
	for(var i=0; i < data.features.length;i++){
		var p =data.features[i].properties;
		p.fill = rule(p,params);
	}
	return data;
}

function drawData(drawdata,clearNeeded){
	data = drawdata;
	map.clear(true);
	map.drawFromGeojson(drawdata,false);
	
}

function loadData(params){
	var rule = library.rules.councilRule;
	var newdata = colorData(data,rule,params);	
	drawData(newdata,false);
	
	var mm= function(e,shape,mousepos,ll,feature,key,easymap){
		if(mousepos){
			var wid =easymap.wrapper.id+'_tooltip';
			var tt =document.getElementById(wid);
			if(!tt){
				tt = document.createElement('div');
				tt.style.position = "absolute";
				tt.id = wid;
				tt.style.zIndex = 4;
				tt.setAttribute("class","easymaptooltip");
				easymap.wrapper.appendChild(tt);
			}

			var text ="";
			if(shape){
				text =shape.properties.name +"<br>";
				if(library.data.councilTax[shape.properties.name]) text += "price: "+library.data.councilTax[shape.properties.name][params][1];
				tt.innerHTML = text;
				tt.style.display = "";
			}
			else{
				tt.style.display = "none";
			}
		
			var x = mousepos.x + 10;
			var y = mousepos.y + 10;
		
			tt.style.left = x + "px";
			tt.style.top = y +"px";
			tt.style["z-index"] = 2;
		}
	};
	
	map.setMouseFunctions(false,mm);
}

function init(){
	
	var newfeatures =[];
	for(var i =0; i < library.geojsons.counciluk.features.length; i++){
		var  f= library.geojsons.counciluk.features[i];
		var name = f.properties.name
		if(name && library.data.councilTax[name]){
			newfeatures.push(f);
		}
	}
	library.geojsons.counciluk.features = newfeatures;
	
	//library.geojsons.counciluk = EasyConversion.niaveGeoJsonFlatten(library.geojsons.counciluk,2);
	data =library.geojsons.counciluk;
	//console.log(data.toSource());
	var eMap = new EasyMap(document.getElementById('map'));
	map = new EasySlippyMap(eMap);
	map.controller.addControls(["pan","zoom","mousewheelzooming","mousepanning"]);
	map.drawFromGeojson(library.geojsons.counciluk,false);
	loadData([0]);
}
</script>
</head>
<body onload= "init()">
	
	<div id='map' style="width:800px; height:350px;"></div>
	<a href='javascript:loadData([0])'>1994</a> <a href='javascript:loadData([1])'>1995</a> <a href='javascript:loadData([2])'>1996</a> <a href='javascript:loadData([3])'>1997</a> <a href='javascript:loadData([4])'>1998</a> <a href='javascript:loadData([5])'>1999</a> <a href='javascript:loadData([6])'>2000</a> <a href='javascript:loadData([7])'>2001</a> <a href='javascript:loadData([8])'>2002</a> <a href='javascript:loadData([9])'>2003</a> <a href='javascript:loadData([10])'>2004</a> <a href='javascript:loadData([11])'>2005</a> <a href='javascript:loadData([12])'>2006</a> <a href='javascript:loadData([13])'>2007</a> 
</body>
</html>