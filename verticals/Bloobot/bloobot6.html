<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<script type="text/javascript">
var version = {major: 2, minor: 0, revision: 10, date: new Date("Apr 19, 2006"), extensions: {}};
</script>
<!--
TiddlyWiki 2.0.10 by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Osmosoft Limited 2004-2006

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the Osmosoft Limited nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<!--PRE-HEAD-START-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'>
<!--PRE-HEAD-END-->
<title> Bloobot -  Â smart money for progressive causes </title>
<script type="text/javascript">

// ---------------------------------------------------------------------------------
// Configuration repository
// ---------------------------------------------------------------------------------

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animFast: 0.12, // Speed for animations (lower == slower)
	animSlow: 0.01, // Speed for EasterEgg animations
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5 // Depth of cascade animation
	};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkAnimate: true,
	txtUserName: "YourName",
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	txtBackupFolder: "",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30"
	};
	
// List of notification functions to be called when certain tiddlers are changed or deleted
config.notifyTiddlers = [
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: null, notify: refreshDisplay}
	];

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
	};

// Messages
config.messages = {
	customConfigError: "Error in systemConfig tiddler '%1' - %0",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#DownloadSoftware for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. This could be because your browser doesn't support saving (instead, use FireFox if you can), or because the pathname to your TiddlyWiki file contains illegal characters",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	messageClose: {text: "close", tooltip: "close this message area"},
	dates: {
		months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"],
		days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
		}
	};

// More messages (rather a legacy layout that shouldn't really be like this)
config.views = {
	wikified: {
		tag: {labelNoTags: "no tags", labelTags: "tags: ", openTag: "Open tag '%0'", tooltip: "Show tiddlers tagged with '%0'", openAllText: "Open all", openAllTooltip: "Open all of these tiddlers", popupNone: "No other tiddlers tagged with '%0'"},
		defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
		defaultModifier: "(missing)",
		shadowModifier: "(shadow)"
		},
	editor: {
		tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
		tagChooser: {text: "tags", tooltip: "Choose existing tags to add to this tiddler", popupNone: "There are no tags defined", tagTooltip: "Add the tag '%0'"},
		defaultText: "Type the text for '%0'"
		}
	};
		
// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {label: "search", prompt: "Search this TiddlyWiki", sizeTextbox: 15, accessKey: "F", successMsg: "%0 tiddlers found matching %1", failureMsg: "No tiddlers found matching %0"},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {label: "tagging:", labelNotTag: "not tagging", tooltip: "List of tiddlers tagged with '%0'"},
	timeline: {dateFormat: "DD MMM YYYY"},
	allTags: {tooltip: "Show tiddlers tagged with '%0'", noTags: "There are no tagged tiddlers"},
	list: {
		all: {prompt: "All tiddlers in alphabetical order"},
		missing: {prompt: "Tiddlers that have links to them but are not defined"},
		orphans: {prompt: "Tiddlers that are not linked to from any other tiddlers"},
		shadowed: {prompt: "Tiddlers shadowed with default contents"}
		},
	closeAll: {label: "close all", prompt: "Close all displayed tiddlers (except any that are being edited)"},
	permaview: {label: "permaview", prompt: "Link to an URL that retrieves all the currently displayed tiddlers"},
	saveChanges: {label: "save changes", prompt: "Save all tiddlers to create a new TiddlyWiki", accessKey: "S"},
	slider: {},
	option: {},
	newTiddler: {label: "new tiddler", prompt: "Create a new tiddler", title: "New Tiddler", accessKey: "N"},
	newJournal: {label: "new journal", prompt: "Create a new tiddler from the current date and time", accessKey: "J"},
	sparkline: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {},
	edit: {},
	tagChooser: {},
	toolbar: {},
	br: {}
	};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {text: "close", tooltip: "Close this tiddler"},
	closeOthers: {text: "close others", tooltip: "Close all other tiddlers"},
	editTiddler: {text: "edit", tooltip: "Edit this tiddler", readOnlyText: "view", readOnlyTooltip: "View the source of this tiddler"},
	saveTiddler: {text: "done", tooltip: "Save changes to this tiddler", hideReadOnly: true},
	cancelTiddler: {text: "cancel", tooltip: "Undo changes to this tiddler", warning: "Are you sure you want to abandon your changes to '%0'?", readOnlyText: "done", readOnlyTooltip: "View this tiddler normally"},
	deleteTiddler: {text: "delete", tooltip: "Delete this tiddler", warning: "Are you sure you want to delete '%0'?", hideReadOnly: true},
	permalink: {text: "permalink", tooltip: "Permalink for this tiddler"},
	references: {text: "references", tooltip: "Show tiddlers that link to this one", popupNone: "No references"},
	jump: {text: "jump", tooltip: "Jump to another open tiddler"}
	};
	
// Browser detection... In a very few places, there's nothing else for it but to
// know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /Gecko\/(\d{8})/i.exec(config.userAgent),
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
	};

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z\u00df-\u00ff_0-9\\-\u0151\u0171]",
	anyLetter: "[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-\u0150\u0170\u0151\u0171]"
	};
if(config.browser.isBadSafari)
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z\u00df-\u00ff_0-9\\-]",
		anyLetter: "[A-Za-z\u00c0-\u00de\u00df-\u00ff_0-9\\-]"
		}
config.textPrimitives.anyDigit = "[0-9]";
config.textPrimitives.anyNumberChar = "[0-9\\.E]";
config.textPrimitives.urlPattern = "(?:file|http|https|mailto|ftp):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:" + config.textPrimitives.unWikiLink + "{0,1})(?:(?:" + config.textPrimitives.upperLetter + "+" +
												  config.textPrimitives.lowerLetter + "+" +
												  config.textPrimitives.upperLetter +
												  config.textPrimitives.anyLetter + "*)|(?:" +
												  config.textPrimitives.upperLetter + "{2,}" +
												  config.textPrimitives.lowerLetter + "+))";

// ---------------------------------------------------------------------------------
// Shadow tiddlers for emergencies
// ---------------------------------------------------------------------------------

config.shadowTiddlers = {
	DefaultTiddlers: "GettingStarted",
	MainMenu: "GettingStarted",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "http://www.tiddlywiki.com/",
	GettingStarted: "To get started with this blank TiddlyWiki, you'll need to modify the following tiddlers:\n* SiteTitle & SiteSubtitle: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)\n* MainMenu: The menu (usually on the left)\n* DefaultTiddlers: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened\nYou'll also need to enter your username for signing your edits: <<option txtUserName>>",
	SideBarOptions: "<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal 'DD MMM YYYY'>><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel 'options Â»' 'Change TiddlyWiki advanced options'>>",
	OptionsPanel: "These InterfaceOptions for customising TiddlyWiki are saved in your browser\n\nYour username for signing your edits. Write it as a WikiWord (eg JoeBloggs)\n\n<<option txtUserName>>\n<<option chkSaveBackups>> SaveBackups\n<<option chkAutoSave>> AutoSave\n<<option chkRegExpSearch>> RegExpSearch\n<<option chkCaseSensitiveSearch>> CaseSensitiveSearch\n<<option chkAnimate>> EnableAnimations\n\nSee AdvancedOptions",
	AdvancedOptions: "<<option chkGenerateAnRssFeed>> GenerateAnRssFeed\n<<option chkOpenInNewWindow>> OpenLinksInNewWindow\n<<option chkSaveEmptyTemplate>> SaveEmptyTemplate\n<<option chkToggleLinks>> Clicking on links to tiddlers that are already open causes them to close\n^^(override with Control or other modifier key)^^\n<<option chkHttpReadOnly>> HideEditingFeatures when viewed over HTTP\n<<option chkForceMinorUpdate>> Treat edits as MinorChanges by preserving date and time\n^^(override with Shift key when clicking 'done' or by pressing Ctrl-Shift-Enter^^\n<<option chkConfirmDelete>> ConfirmBeforeDeleting\nMaximum number of lines in a tiddler edit box: <<option txtMaxEditRows>>\nFolder name for backup files: <<option txtBackupFolder>>\n",
	SideBarTabs: "<<tabs txtMainTab Timeline Timeline TabTimeline All 'All tiddlers' TabAll Tags 'All tags' TabTags More 'More lists' TabMore>>",
	TabTimeline: "<<timeline>>",
	TabAll: "<<list all>>",
	TabTags: "<<allTags>>",
	TabMore: "<<tabs txtMoreTab Missing 'Missing tiddlers' TabMoreMissing Orphans 'Orphaned tiddlers' TabMoreOrphans Shadowed 'Shadowed tiddlers' TabMoreShadowed>>",
	TabMoreMissing: "<<list missing>>",
	TabMoreOrphans: "<<list orphans>>",
	TabMoreShadowed: "<<list shadowed>>",
	StyleSheet: "/***\nPlace your custom CSS here\n***/\n/*{{{*/\n\n/*}}}*/\n",
	StyleSheetColors: "/***\n!Colors Used\n*@@bgcolor(#8cf): #8cf - Background blue@@\n*@@bgcolor(#18f): #18f - Top blue@@\n*@@bgcolor(#04b): #04b - Mid blue@@\n*@@bgcolor(#014):color(#fff): #014 - Bottom blue@@\n*@@bgcolor(#ffc): #ffc - Bright yellow@@\n*@@bgcolor(#fe8): #fe8 - Highlight yellow@@\n*@@bgcolor(#db4): #db4 - Background yellow@@\n*@@bgcolor(#841): #841 - Border yellow@@\n*@@bgcolor(#703):color(#fff): #703 - Title red@@\n*@@bgcolor(#866): #866 - Subtitle grey@@\n!Generic Rules /%==============================================%/\n***/\n/*{{{*/\nbody {\n	background: #fff;\n	color: #000;\n}\n\na{\n	color: #04b;\n}\n\na:hover{\n	background: #04b;\n	color: #fff;\n}\n\na img{\n	border: 0;\n}\n\nh1,h2,h3,h4,h5 {\n	color: #703;\n	background: #8cf;\n}\n\n.button {\n	color: #014;\n	border: 1px solid #fff;\n}\n\n.button:hover {\n	color: #014;\n	background: #fe8;\n	border-color: #db4;\n}\n\n.button:active {\n	color: #fff;\n	background: #db4;\n	border: 1px solid #841;\n}\n\n/*}}}*/\n/***\n!Header /%==================================================%/\n***/\n/*{{{*/\n.header {\n	background: #04b;\n}\n\n.headerShadow {\n	color: #000;\n}\n\n.headerShadow a {\n	font-weight: normal;\n	color: #000;\n}\n\n.headerForeground {\n	color: #fff;\n}\n\n.headerForeground a {\n	font-weight: normal;\n	color: #8cf;\n}\n\n/*}}}*/\n/***\n!General tabs /%=================================================%/\n***/\n/*{{{*/\n\n.tabSelected{\n	color: #014;\n	background: #eee;\n	border-left: 1px solid #ccc;\n	border-top: 1px solid #ccc;\n	border-right: 1px solid #ccc;\n}\n\n.tabUnselected {\n	color: #fff;\n	background: #999;\n}\n\n.tabContents {\n	color: #014;\n	background: #eee;\n	border: 1px solid #ccc;\n}\n\n.tabContents .button {\n	 border: 0;}\n\n/*}}}*/\n/***\n!Sidebar options /%=================================================%/\n~TiddlyLinks and buttons are treated identically in the sidebar and slider panel\n***/\n/*{{{*/\n#sidebar {\n}\n\n#sidebarOptions input {\n	border: 1px solid #04b;\n}\n\n#sidebarOptions .sliderPanel {\n	background: #8cf;\n}\n\n#sidebarOptions .sliderPanel a {\n	border: none;\n	color: #04b;\n}\n\n#sidebarOptions .sliderPanel a:hover {\n	color: #fff;\n	background: #04b;\n}\n\n#sidebarOptions .sliderPanel a:active {\n	color: #04b;\n	background: #fff;\n}\n/*}}}*/\n/***\n!Message Area /%=================================================%/\n***/\n/*{{{*/\n#messageArea {\n	border: 1px solid #841;\n	background: #db4;\n	color: #014;\n}\n\n#messageArea .button {\n	padding: 0.2em 0.2em 0.2em 0.2em;\n	color: #014;\n	background: #fff;\n}\n\n/*}}}*/\n/***\n!Popup /%=================================================%/\n***/\n/*{{{*/\n.popup {\n	background: #18f;\n	border: 1px solid #04b;\n}\n\n.popup hr {\n	color: #014;\n	background: #014;\n	border-bottom: 1px;\n}\n\n.popup li.disabled {\n	color: #04b;\n}\n\n.popup li a, .popup li a:visited {\n	color: #eee;\n	border: none;\n}\n\n.popup li a:hover {\n	background: #014;\n	color: #fff;\n	border: none;\n}\n/*}}}*/\n/***\n!Tiddler Display /%=================================================%/\n***/\n/*{{{*/\n.tiddler .defaultCommand {\n font-weight: bold;\n}\n\n.shadow .title {\n	color: #866;\n}\n\n.title {\n	color: #703;\n}\n\n.subtitle {\n	color: #866;\n}\n\n.toolbar {\n	color: #04b;\n}\n\n.tagging, .tagged {\n	border: 1px solid #eee;\n	background-color: #eee;\n}\n\n.selected .tagging, .selected .tagged {\n	background-color: #ddd;\n	border: 1px solid #bbb;\n}\n\n.tagging .listTitle, .tagged .listTitle {\n	color: #014;\n}\n\n.tagging .button, .tagged .button {\n		border: none;\n}\n\n.footer {\n	color: #ddd;\n}\n\n.selected .footer {\n	color: #888;\n}\n\n.sparkline {\n	background: #8cf;\n	border: 0;\n}\n\n.sparktick {\n	background: #014;\n}\n\n.errorButton {\n	color: #ff0;\n	background: #f00;\n}\n\n.cascade {\n	background: #eef;\n	color: #aac;\n	border: 1px solid #aac;\n}\n\n.imageLink, #displayArea .imageLink {\n	background: transparent;\n}\n\n/*}}}*/\n/***\n''The viewer is where the tiddler content is displayed'' /%------------------------------------------------%/\n***/\n/*{{{*/\n\n.viewer .listTitle {list-style-type: none; margin-left: -2em;}\n\n.viewer .button {\n	border: 1px solid #db4;\n}\n\n.viewer blockquote {\n	border-left: 3px solid #666;\n}\n\n.viewer table {\n	border: 2px solid #333;\n}\n\n.viewer th, thead td {\n	background: #db4;\n	border: 1px solid #666;\n	color: #fff;\n}\n\n.viewer td, .viewer tr {\n	border: 1px solid #666;\n}\n\n.viewer pre {\n	border: 1px solid #fe8;\n	background: #ffc;\n}\n\n.viewer code {\n	color: #703;\n}\n\n.viewer hr {\n	border: 0;\n	border-top: dashed 1px #666;\n	color: #666;\n}\n\n.highlight, .marked {\n	background: #fe8;\n}\n/*}}}*/\n/***\n''The editor replaces the viewer in the tiddler'' /%------------------------------------------------%/\n***/\n/*{{{*/\n.editor input {\n	border: 1px solid #04b;\n}\n\n.editor textarea {\n	border: 1px solid #04b;\n	width: 100%;\n}\n\n.editorFooter {\n	color: #aaa;\n}\n\n/*}}}*/",
	StyleSheetLayout: "/***\n!Sections in this Tiddler:\n*Generic rules\n**Links styles\n**Link Exceptions\n*Header\n*Main menu\n*Sidebar\n**Sidebar options\n**Sidebar tabs\n*Message area\n*Popup\n*Tabs\n*Tiddler display\n**Viewer\n**Editor\n*Misc. rules\n!Generic Rules /%==============================================%/\n***/\n/*{{{*/\nbody {\n	font-size: .75em;\n	font-family: arial,helvetica;\n	position: relative;\n	margin: 0;\n	padding: 0;\n}\n\nh1,h2,h3,h4,h5 {\n	font-weight: bold;\n	text-decoration: none;\n	padding-left: 0.4em;\n}\n\nh1 {font-size: 1.35em;}\nh2 {font-size: 1.25em;}\nh3 {font-size: 1.1em;}\nh4 {font-size: 1em;}\nh5 {font-size: .9em;}\n\nhr {\n	height: 1px;\n}\n\na{\n	text-decoration: none;\n}\n\nol { list-style-type: decimal }\nol ol { list-style-type: lower-alpha }\nol ol ol { list-style-type: lower-roman }\nol ol ol ol { list-style-type: decimal }\nol ol ol ol ol { list-style-type: lower-alpha }\nol ol ol ol ol ol { list-style-type: lower-roman }\nol ol ol ol ol ol ol { list-style-type: decimal }\n/*}}}*/\n/***\n''General Link Styles'' /%-----------------------------------------------------------------------------%/\n***/\n/*{{{*/\n.externalLink {\n	text-decoration: underline;\n}\n\n.tiddlyLinkExisting {\n	font-weight: bold;\n}\n\n.tiddlyLinkNonExisting {\n	font-style: italic;\n}\n\n/* the 'a' is required for IE, otherwise it renders the whole tiddler a bold */\na.tiddlyLinkNonExisting.shadow {\n	font-weight: bold;\n}\n/*}}}*/\n/***\n''Exceptions to common link styles'' /%------------------------------------------------------------------%/\n***/\n/*{{{*/\n\n#mainMenu .tiddlyLinkExisting, \n#mainMenu .tiddlyLinkNonExisting,\n#sidebarTabs .tiddlyLinkExisting,\n#sidebarTabs .tiddlyLinkNonExisting{\n font-weight: normal;\n font-style: normal;\n}\n\n/*}}}*/\n/***\n!Header /%==================================================%/\n***/\n/*{{{*/\n\n.header {\n		position: relative;\n}\n\n.header a:hover {\n	background: transparent;\n}\n\n.headerShadow {\n	position: relative;\n	padding: 4.5em 0em 1em 1em;\n	left: -1px;\n	top: -1px;\n}\n\n.headerForeground {\n	position: absolute;\n	padding: 4.5em 0em 1em 1em;\n	left: 0px;\n	top: 0px;\n}\n\n.siteTitle {\n	font-size: 3em;\n}\n\n.siteSubtitle {\n	font-size: 1.2em;\n}\n\n/*}}}*/\n/***\n!Main menu /%==================================================%/\n***/\n/*{{{*/\n#mainMenu {\n	position: absolute;\n	left: 0;\n	width: 10em;\n	text-align: right;\n	line-height: 1.6em;\n	padding: 1.5em 0.5em 0.5em 0.5em;\n	font-size: 1.1em;\n}\n\n/*}}}*/\n/***\n!Sidebar rules /%==================================================%/\n***/\n/*{{{*/\n#sidebar {\n	position: absolute;\n	right: 3px;\n	width: 16em;\n	font-size: .9em;\n}\n/*}}}*/\n/***\n''Sidebar options'' /%----------------------------------------------------------------------------------%/\n***/\n/*{{{*/\n#sidebarOptions {\n	padding-top: 0.3em;\n}\n\n#sidebarOptions a {\n	margin: 0em 0.2em;\n	padding: 0.2em 0.3em;\n	display: block;\n}\n\n#sidebarOptions input {\n	margin: 0.4em 0.5em;\n}\n\n#sidebarOptions .sliderPanel {\n	margin-left: 1em;\n	padding: 0.5em;\n	font-size: .85em;\n}\n\n#sidebarOptions .sliderPanel a {\n	font-weight: bold;\n	display: inline;\n	padding: 0;\n}\n\n#sidebarOptions .sliderPanel input {\n	margin: 0 0 .3em 0;\n}\n/*}}}*/\n/***\n''Sidebar tabs'' /%-------------------------------------------------------------------------------------%/\n***/\n/*{{{*/\n\n#sidebarTabs .tabContents {\n	width: 15em;\n	overflow: hidden;\n}\n\n/*}}}*/\n/***\n!Message area /%==================================================%/\n***/\n/*{{{*/\n#messageArea {\nposition:absolute; top:0; right:0; margin: 0.5em; padding: 0.5em;\n}\n\n*[id='messageArea'] {\nposition:fixed !important; z-index:99;}\n\n.messageToolbar {\ndisplay: block;\ntext-align: right;\n}\n\n#messageArea a{\n	text-decoration: underline;\n}\n/*}}}*/\n/***\n!Popup /%==================================================%/\n***/\n/*{{{*/\n.popup {\n	font-size: .9em;\n	padding: 0.2em;\n	list-style: none;\n	margin: 0;\n}\n\n.popup hr {\n	display: block;\n	height: 1px;\n	width: auto;\n	padding: 0;\n	margin: 0.2em 0em;\n}\n\n.popup li.disabled {\n	padding: 0.2em;\n}\n\n.popup li a{\n	display: block;\n	padding: 0.2em;\n}\n/*}}}*/\n/***\n!Tabs /%==================================================%/\n***/\n/*{{{*/\n.tabset {\n	padding: 1em 0em 0em 0.5em;\n}\n\n.tab {\n	margin: 0em 0em 0em 0.25em;\n	padding: 2px;\n}\n\n.tabContents {\n	padding: 0.5em;\n}\n\n.tabContents ul, .tabContents ol {\n	margin: 0;\n	padding: 0;\n}\n\n.txtMainTab .tabContents li {\n	list-style: none;\n}\n\n.tabContents li.listLink {\n	 margin-left: .75em;\n}\n/*}}}*/\n/***\n!Tiddler display rules /%==================================================%/\n***/\n/*{{{*/\n#displayArea {\n	margin: 1em 17em 0em 14em;\n}\n\n\n.toolbar {\n	text-align: right;\n	font-size: .9em;\n	visibility: hidden;\n}\n\n.selected .toolbar {\n	visibility: visible;\n}\n\n.tiddler {\n	padding: 1em 1em 0em 1em;\n}\n\n.missing .viewer,.missing .title {\n	font-style: italic;\n}\n\n.title {\n	font-size: 1.6em;\n	font-weight: bold;\n}\n\n.missing .subtitle {\n display: none;\n}\n\n.subtitle {\n	font-size: 1.1em;\n}\n\n/* I'm not a fan of how button looks in tiddlers... */\n.tiddler .button {\n	padding: 0.2em 0.4em;\n}\n\n.tagging {\nmargin: 0.5em 0.5em 0.5em 0;\nfloat: left;\ndisplay: none;\n}\n\n.isTag .tagging {\ndisplay: block;\n}\n\n.tagged {\nmargin: 0.5em;\nfloat: right;\n}\n\n.tagging, .tagged {\nfont-size: 0.9em;\npadding: 0.25em;\n}\n\n.tagging ul, .tagged ul {\nlist-style: none;margin: 0.25em;\npadding: 0;\n}\n\n.tagClear {\nclear: both;\n}\n\n.footer {\n	font-size: .9em;\n}\n\n.footer li {\ndisplay: inline;\n}\n/***\n''The viewer is where the tiddler content is displayed'' /%------------------------------------------------%/\n***/\n/*{{{*/\n* html .viewer pre {\n	width: 99%;\n	padding: 0 0 1em 0;\n}\n\n.viewer {\n	line-height: 1.4em;\n	padding-top: 0.5em;\n}\n\n.viewer .button {\n	margin: 0em 0.25em;\n	padding: 0em 0.25em;\n}\n\n.viewer blockquote {\n	line-height: 1.5em;\n	padding-left: 0.8em;\n	margin-left: 2.5em;\n}\n\n.viewer ul, .viewer ol{\n	margin-left: 0.5em;\n	padding-left: 1.5em;\n}\n\n.viewer table {\n	border-collapse: collapse;\n	margin: 0.8em 1.0em;\n}\n\n.viewer th, .viewer td, .viewer tr,.viewer caption{\n	padding: 3px;\n}\n\n.viewer pre {\n	padding: 0.5em;\n	margin-left: 0.5em;\n	font-size: 1.2em;\n	line-height: 1.4em;\n	overflow: auto;\n}\n\n.viewer code {\n	font-size: 1.2em;\n	line-height: 1.4em;\n}\n/*}}}*/\n/***\n''The editor replaces the viewer in the tiddler'' /%------------------------------------------------%/\n***/\n/*{{{*/\n.editor {\nfont-size: 1.1em;\n}\n\n.editor input, .editor textarea {\n	display: block;\n	width: 100%;\n	font: inherit;\n}\n\n.editorFooter {\n	padding: 0.25em 0em;\n	font-size: .9em;\n}\n\n.editorFooter .button {\npadding-top: 0px; padding-bottom: 0px;}\n\n.fieldsetFix {border: 0;\npadding: 0;\nmargin: 1px 0px 1px 0px;\n}\n/*}}}*/\n/***\n!Misc rules /%==================================================%/\n***/\n/*{{{*/\n.sparkline {\n	line-height: 1em;\n}\n\n.sparktick {\n	outline: 0;\n}\n\n.zoomer {\n	font-size: 1.1em;\n	position: absolute;\n	padding: 1em;\n}\n\n.cascade {\n	font-size: 1.1em;\n	position: absolute;\n	overflow: hidden;\n}\n/*}}}*/",
	StyleSheetPrint: "@media print {\n#mainMenu, #sidebar, #messageArea {display: none ! important;}\n#displayArea {margin: 1em 1em 0em 1em;}\n/* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */\nnoscript {display:none;}\n}",
	PageTemplate: "<div class='header' macro='gradient vert #18f #04b'>\n<div class='headerShadow'>\n<span class='siteTitle' refresh='content' tiddler='SiteTitle'></span>&nbsp;\n<span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'></span>\n</div>\n<div class='headerForeground'>\n<span class='siteTitle' refresh='content' tiddler='SiteTitle'></span>&nbsp;\n<span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'></span>\n</div>\n</div>\n<div id='mainMenu' refresh='content' tiddler='MainMenu'></div>\n<div id='sidebar'>\n<div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'></div>\n<div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'></div>\n</div>\n<div id='displayArea'>\n<div id='messageArea'></div>\n<div id='tiddlerDisplay'></div>\n</div>",
	ViewTemplate: "<div class='toolbar' macro='toolbar -closeTiddler closeOthers +editTiddler permalink references jump'></div>\n<div class='title' macro='view title'></div>\n<div class='subtitle'><span macro='view modifier link'></span>, <span macro='view modified date [[DD MMM YYYY]]'></span> (created <span macro='view created date [[DD MMM YYYY]]'></span>)</div>\n<div class='tagging' macro='tagging'></div>\n<div class='tagged' macro='tags'></div>\n<div class='viewer' macro='view text wikified'></div>\n<div class='tagClear'></div>",
	EditTemplate: "<div class='toolbar' macro='toolbar +saveTiddler -cancelTiddler deleteTiddler'></div>\n<div class='title' macro='view title'></div>\n<div class='editor' macro='edit title'></div>\n<div class='editor' macro='edit text'></div>\n<div class='editor' macro='edit tags'></div><div class='editorFooter'><span macro='message views.editor.tagPrompt'></span><span macro='tagChooser'></span></div>",
	MarkupPreHead: "<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml'>",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: ""
	};

// ---------------------------------------------------------------------------------
// Main
// ---------------------------------------------------------------------------------

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = new Animator(); // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies

// Starting up
function main()
{
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki();
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	loadOptionsCookie();
	for(var s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	store.loadFromDiv("storeArea","store");
	invokeParamifier(params,"onload");
	loadSystemConfig();
	formatter = new Formatter(config.formatters);
	readOnly = (window.location.protocol == "file:") ? false : config.options.chkHttpReadOnly;
	invokeParamifier(params,"onconfig");
	store.notifyAll();
	restart();
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty())
		{
		var defaultParams = store.getTiddlerText("DefaultTiddlers").parseParams("open",null,false);
		invokeParamifier(defaultParams,"onstart");
		}
	window.scrollTo(0,0);
}

function saveTest()
{
	var saveTest = document.getElementById("saveTest");
	if(saveTest.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	saveTest.appendChild(document.createTextNode("savetest"));
}

function loadSystemConfig()
{
	if(safeMode)
		return;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(var t=0; t<configTiddlers.length; t++)
		{
		var ex = processConfig(configTiddlers[t].text);
		if(ex)
			displayMessage(config.messages.customConfigError.format([ex,configTiddlers[t].title]));
		}
}

// Merge a custom configuration over the top of the current configuration
// Returns a string error message or null if it went OK
function processConfig(customConfig)
{
	try
		{
		if(customConfig && customConfig != "")
			window.eval(customConfig);
		}
	catch(e)
		{
		return(e.description ? e.description : e.toString());
		}
	return null;
}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try
		{
		var m = config.macros[macro];
		if(m && m.handler)
			m.handler(place,macro,params.readMacroParams(),wikifier,params,tiddler);
		else
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
		}
	catch(ex)
		{
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
		}
}

// ---------------------------------------------------------------------------------
// Paramifiers
// ---------------------------------------------------------------------------------

function getParameters()
{
	var p = null;
	if(window.location.hash)
		{
		p = decodeURI(window.location.hash.substr(1));
		if(config.browser.firefoxDate == null || config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
		}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	for(var t=1; t<params.length; t++)
		{
		var p = config.paramifiers[params[t].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[t].value);
		}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
		}
};

config.paramifiers.open = {
	onstart: function(v) {
		story.displayTiddler("bottom",v,null,false,false);
		}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
		}
};

config.paramifiers.tag = {
	onstart: function(v) {
		var tagged = store.getTaggedTiddlers(v,"title");
		for(var t=0; t<tagged.length; t++)
			story.displayTiddler("bottom",tagged[t].title,null,false,false);
		}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		if(!readOnly)
			{
			story.displayTiddler(null,v,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(v,"text");
			}
		}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly)
			{
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
			}
		}
};

// ---------------------------------------------------------------------------------
// Formatters
// ---------------------------------------------------------------------------------

function Formatter(formatters)
{
	this.formatters = [];
	var pattern = [];
	for(var n=0; n<formatters.length; n++)
		{
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
		}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	charFormatHelper: function(w)
	{
		var e = createTiddlyElement(w.output,this.element);
		w.subWikify(e,this.terminator);
	},
	
	inlineCssHelper:  function(w)
	{
		var styles = [];
		var lookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
		var lookaheadRegExp = new RegExp(lookahead,"mg");
		var hadStyle = false;
		do {
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var gotMatch = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(gotMatch)
				{
				var s,v;
				hadStyle = true;
				if(lookaheadMatch[1])
					{
					s = lookaheadMatch[1].unDash();
					v = lookaheadMatch[2];
					}
				else
					{
					s = lookaheadMatch[3].unDash();
					v = lookaheadMatch[4];
					}
				switch(s)
					{
					case "bgcolor": s = "backgroundColor"; break;
					}
				styles.push({style: s, value: v});
				w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
				}
		} while(gotMatch);
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		for(var t=0; t<styles.length; t++)
			{
			try
				{
				e.style[styles[t].style] = styles[t].value;
				}
			catch (ex)
				{
				}
			}
	},

	monospacedByLineHelper: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			var e = createTiddlyElement(w.output,"pre",null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}

};

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookahead: "^\\|([^\\n]*)\\|([fhck]?)$",
	rowTerminator: "\\|(?:[fhck]?)$\\n?",
	cellPattern: "(?:\\|([^\\n\\|]*)\\|)|(\\|[fhck]?$\\n?)",
	cellTerminator: "(?:\\x20*)\\|",
	rowTypes: {"c": "caption", "h": "thead", "": "tbody", "f": "tfoot"},
	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table");
		w.nextMatch = w.matchStart;
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		var currRowType = null, nextRowType;
		var rowContainer, rowElement;
		var prevColumns = [];
		var rowCount = 0;
		do {
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched)
				{
				nextRowType = lookaheadMatch[2];
				if(nextRowType == "k")
					{
					table.className = lookaheadMatch[1];
					w.nextMatch += lookaheadMatch[0].length+1;
					continue;
					}
				if(nextRowType != currRowType)
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
				currRowType = nextRowType;
				if(currRowType == "c")
					{
					if(rowCount == 0)
						rowContainer.setAttribute("align","top");
					else
						rowContainer.setAttribute("align","bottom");
					w.nextMatch = w.nextMatch + 1;
					w.subWikify(rowContainer,this.rowTerminator);
					table.insertBefore(rowContainer,table.firstChild);
					}
				else
					{
					var rowClass = (rowCount & 1) ? "oddRow" : "evenRow";
					rowElement = createTiddlyElement(rowContainer,"tr",null,rowClass);
					this.rowHandler(w,rowElement,prevColumns);
					}
				rowCount++;
				}
		} while(matched);
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var currColCount = 1;
		var matched;
		var cellRegExp = new RegExp(this.cellPattern,"mg");
		do {
			cellRegExp.lastIndex = w.nextMatch;
			var cellMatch = cellRegExp.exec(w.source);
			matched = cellMatch && cellMatch.index == w.nextMatch;
			if(matched)
				{
				if(cellMatch[1] == "~")
					{
					var last = prevColumns[col];
					if(last)
						{
						last.rowCount++;
						last.element.setAttribute("rowSpan",last.rowCount);
						last.element.setAttribute("rowspan",last.rowCount);
						last.element.valign = "center";
						}
					w.nextMatch = cellMatch.index + cellMatch[0].length-1;
					}
				else if(cellMatch[1] == ">")
					{
					currColCount++;
					w.nextMatch = cellMatch.index + cellMatch[0].length-1;
					}
				else if(cellMatch[2])
					{
					w.nextMatch = cellMatch.index + cellMatch[0].length;;
					break;
					}
				else
					{
					var spaceLeft = false, spaceRight = false;
					w.nextMatch++;
					var styles = config.formatterHelpers.inlineCssHelper(w);
					while(w.source.substr(w.nextMatch,1) == " ")
						{
						spaceLeft = true;
						w.nextMatch++;
						}
					var cell;
					if(w.source.substr(w.nextMatch,1) == "!")
						{
						cell = createTiddlyElement(e,"th");
						w.nextMatch++;
						}
					else
						cell = createTiddlyElement(e,"td");
					prevColumns[col] = {rowCount: 1, element: cell};
					if(currColCount > 1)
						{
						cell.setAttribute("colSpan",currColCount);
						cell.setAttribute("colspan",currColCount);
						currColCount = 1;
						}
					config.formatterHelpers.applyCssHelper(cell,styles);
					w.subWikify(cell,this.cellTerminator);
					if(w.matchText.substr(w.matchText.length-2,1) == " ")
						spaceRight = true;
					if(spaceLeft && spaceRight)
						cell.align = "center";
					else if (spaceLeft)
						cell.align = "right";
					else if (spaceRight)
						cell.align = "left";
					w.nextMatch = w.nextMatch-1;
					}
				col++;
				}
		} while(matched);		
	}
},

{
	name: "rule",
	match: "^----+$\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "heading",
	match: "^!{1,5}",
	terminator: "\\n",
	handler: function(w)
	{
		var e = createTiddlyElement(w.output,"h" + w.matchLength);
		w.subWikify(e,this.terminator);
	}
},

{
	name: "monospacedByLine",
	match: "^\\{\\{\\{\\n",
	lookahead: "^\\{\\{\\{\\n((?:^[^\\n]*\\n)+?)(^\\}\\}\\}$\\n?)",
	handler: config.formatterHelpers.monospacedByLineHelper
},

{
	name: "monospacedByLineForCSS",
	match: "^/\\*[\\{]{3}\\*/\\n",
	lookahead: "/\\*[\\{]{3}\\*/\\n*((?:^[^\\n]*\\n)+?)(\\n*^/\\*[\\}]{3}\\*/$\\n?)", 
	handler: config.formatterHelpers.monospacedByLineHelper
},

{
	name: "monospacedByLineForPlugin",
	match: "^//\\{\\{\\{\\n",
	lookahead: "^//\\{\\{\\{\\n\\n*((?:^[^\\n]*\\n)+?)(\\n*^//\\}\\}\\}$\\n?)",
	handler: config.formatterHelpers.monospacedByLineHelper
},

{
	name: "monospacedByLineForTemplate",
	match: "^<!--[\\{]{3}-->\\n",
	lookahead: "<!--[\\{]{3}-->\\n*((?:^[^\\n]*\\n)+?)(\\n*^<!--[\\}]{3}-->$\\n?)", 
	handler: config.formatterHelpers.monospacedByLineHelper
},

{
	name: "wikifyCommentForPlugin", 
	match: "^/\\*\\*\\*\\n",
	terminator: "^\\*\\*\\*/\\n",
	handler: function(w)
	{
		w.subWikify(w.output,this.terminator);
	}
},

{
	name: "wikifyCommentForTemplate", 
	match: "^<!---\\n",
	terminator: "^--->\\n",
	handler: function(w) 
	{
		w.subWikify(w.output,this.terminator);
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	terminator: "^<<<(\\n|$)",
	handler: function(w)
	{
		var e = createTiddlyElement(w.output,"blockquote");
		w.subWikify(e,this.terminator);
	}
},

{
	name: "quoteByLine",
	match: "^>+",
	terminator: "\\n",
	element: "blockquote",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.match,"mg");
		var placeStack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t;
		do {
			if(newLevel > currLevel)
				{
				for(t=currLevel; t<newLevel; t++)
					placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],this.element));
				}
			else if(newLevel < currLevel)
				{
				for(t=currLevel; t>newLevel; t--)
					placeStack.pop();
				}
			currLevel = newLevel;
			w.subWikify(placeStack[placeStack.length-1],this.terminator);
			createTiddlyElement(placeStack[placeStack.length-1],"br");
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched)
				{
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				}
		} while(matched);
	}
},

{
	name: "list",
	match: "^(?:(?:\\*+)|(?:#+))",
	lookahead: "^(?:(\\*+)|(#+))",
	terminator: "\\n",
	outerElement: "ul",
	itemElement: "li",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		w.nextMatch = w.matchStart;
		var placeStack = [w.output];
		var currType = null, newType;
		var currLevel = 0, newLevel;
		var t;
		do {
			lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			var matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched)
				{
				if(lookaheadMatch[1])
					newType = "ul";
				if(lookaheadMatch[2])
					newType = "ol";
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
				if(newLevel > currLevel)
					{
					for(t=currLevel; t<newLevel; t++)
						placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],newType));
					}
				else if(newLevel < currLevel)
					{
					for(t=currLevel; t>newLevel; t--)
						placeStack.pop();
					}
				else if(newLevel == currLevel && newType != currType)
					{
						placeStack.pop();
						placeStack.push(createTiddlyElement(placeStack[placeStack.length-1],newType));
					}
				currLevel = newLevel;
				currType = newType;
				var e = createTiddlyElement(placeStack[placeStack.length-1],"li");
				w.subWikify(e,this.terminator);
				}
		} while(matched);
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.wikiLink,
	badPrefix: config.textPrimitives.anyLetter,
	handler: function(w)
	{
		var preRegExp = new RegExp(config.textPrimitives.anyLetter,"mg");
		var preMatch = null;
		if(w.matchStart > 0)
			{
			preRegExp.lastIndex = w.matchStart-1;
			preMatch = preRegExp.exec(w.source);
			}
		if(preMatch && preMatch.index == w.matchStart-1)
			w.outputText(w.output,w.matchStart,w.nextMatch);
		else if(w.matchText.substr(0,1) == config.textPrimitives.unWikiLink)
			w.outputText(w.output,w.matchStart + 1,w.nextMatch);
		else
			{
			var link = createTiddlyLink(w.output,w.matchText,false);
			w.outputText(link,w.matchStart,w.nextMatch);
			}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookahead: "\\[\\[([^\\|\\]]*?)(?:(\\]\\])|(\\|(.*?)\\]\\]))",
	terminator: "\\|",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[2]) // Simple bracketted link
			{
			var link = createTiddlyLink(w.output,lookaheadMatch[1],false);
			w.outputText(link,w.nextMatch,w.nextMatch + lookaheadMatch[1].length);
			w.nextMatch += lookaheadMatch[1].length + 2;
			}
		else if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[3]) // Pretty bracketted link
			{
			var e;
			if(store.tiddlerExists(lookaheadMatch[4]) || store.isShadowTiddler(lookaheadMatch[4]))
				e = createTiddlyLink(w.output,lookaheadMatch[4],false);
			else
				e = createExternalLink(w.output,lookaheadMatch[4]);
			w.outputText(e,w.nextMatch,w.nextMatch + lookaheadMatch[1].length);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		var e = createExternalLink(w.output,w.matchText);
		w.outputText(e,w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[(?:[<]{0,1})(?:[>]{0,1})[Ii][Mm][Gg]\\[",
	lookahead: "\\[([<]{0,1})([>]{0,1})[Ii][Mm][Gg]\\[(?:([^\\|\\]]+)\\|)?([^\\[\\]\\|]+)\\](?:\\[([^\\]]*)\\]?)?(\\])",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) // Simple bracketted link
			{
			var e = w.output;
			if(lookaheadMatch[5])
				{
				if(store.tiddlerExists(lookaheadMatch[5]) || store.isShadowTiddler(lookaheadMatch[5]))
					e = createTiddlyLink(w.output,lookaheadMatch[5],false);
				else
					e = createExternalLink(w.output,lookaheadMatch[5]);
				addClass(e,"imageLink");
				}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3])
				img.title = lookaheadMatch[3];
			img.src = lookaheadMatch[4];
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "macro",
	match: "<<",
	lookahead: "<<([^>\\s]+)(?:\\s*)((?:[^>]|(?:>(?!>)))*)>>",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1])
			{		
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
			}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookahead: "<[Hh][Tt][Mm][Ll]>((?:.|\\n)*?)</[Hh][Tt][Mm][Ll]>",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var e = createTiddlyElement(w.output,"span");
			e.innerHTML = lookaheadMatch[1];
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookahead: "/%((?:.|\\n)*?)%/",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
	}
},

{
	name: "boldByChar",
	match: "''",
	terminator: "''",
	element: "strong",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "strikeByChar",
	match: "==",
	terminator: "==",
	element: "strike",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "underlineByChar",
	match: "__",
	terminator: "__",
	element: "u",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "italicByChar",
	match: "//",
	terminator: "//",
	element: "em",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "subscriptByChar",
	match: "~~",
	terminator: "~~",
	element: "sub",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "superscriptByChar",
	match: "\\^\\^",
	terminator: "\\^\\^",
	element: "sup",
	handler: config.formatterHelpers.charFormatHelper
},

{
	name: "monospacedByChar",
	match: "\\{\\{\\{",
	lookahead: "\\{\\{\\{((?:.|\\n)*?)\\}\\}\\}",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"mg");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			{
			var e = createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			}
	}
},

{
	name: "styleByChar",
	match: "@@",
	terminator: "@@",
	lookahead: "(?:([^\\(@]+)\\(([^\\)]+)(?:\\):))|(?:([^:@]+):([^;]+);)",
	handler:  function(w)
	{
		var e = createTiddlyElement(w.output,"span",null,null,null);
		var styles = config.formatterHelpers.inlineCssHelper(w);
		if(styles.length == 0)
			e.className = "marked";
		else
			config.formatterHelpers.applyCssHelper(e,styles);
		w.subWikify(e,this.terminator);
	}
},

{
	name: "lineBreak",
	match: "\\n",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "&#?[a-zA-Z0-9]{2,8};",
	handler: function(w)
		{
		var e = createTiddlyElement(w.output,"span");
		e.innerHTML = w.matchText ;
		}
},

{
	name: "customClasses",
	match: "\\{\\{",
	terminator: "\\}\\}\\}",
	lookahead: "\\{\\{[\\s]*([\\w]+[\\s\\w]*)[\\s]*\\{(\\n{0,1})",
	handler: function(w)
	{
		var lookaheadRegExp = new RegExp(this.lookahead,"g");
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source);
		if(lookaheadMatch)
			{
			var isByLine = lookaheadMatch[2] == "\n";
			var p = createTiddlyElement(w.output,isByLine ? "div" : "span",null,lookaheadMatch[1]);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			w.subWikify(p,this.terminator);
			}
	}
}

];

// ---------------------------------------------------------------------------------
// Wikifier
// ---------------------------------------------------------------------------------

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source && source != "")
		{
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.subWikify(output,null);
		}
}

// Wikify a named tiddler to plain text
function wikifyPlain(title)
{
	if(store.tiddlerExists(title) || store.isShadowTiddler(title))
		{
		var wikifier = new Wikifier(store.getTiddlerText(title),formatter,null,store.getTiddler(title));
		return wikifier.wikifyPlain();
		}
	else
		return "";
}

// Highlight plain text into an element
function highlightify(source,output,highlightRegExp)
{
	if(source && source != "")
		{
		var wikifier = new Wikifier(source,formatter,highlightRegExp,null);
		wikifier.outputText(output,0,source.length);
		}
}

// Construct a wikifier object
// source - source string that's going to be wikified
// formatter - Formatter() object containing the list of formatters to be used
// highlightRegExp - regular expression of the text string to highlight
// tiddler - reference to the tiddler that's taken to be the container for this wikification
function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;	
	if(highlightRegExp)
		{
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
		}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e,null);
	var text = getPlainText(e);
	e.parentNode.removeChild(e);
	return text;
}

Wikifier.prototype.subWikify = function(output,terminator)
{
	// Temporarily replace the output pointer
	var oldOutput = this.output;
	this.output = output;
	// Prepare the terminator RegExp
	var terminatorRegExp = terminator ? new RegExp("(" + terminator + ")","mg") : null;
	do {
		// Prepare the RegExp match positions
		this.formatter.formatterRegExp.lastIndex = this.nextMatch;
		if(terminatorRegExp)
			terminatorRegExp.lastIndex = this.nextMatch;
		// Get the first matches
		var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
		var terminatorMatch = terminatorRegExp ? terminatorRegExp.exec(this.source) : null;
		// Check for a terminator match
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index))
			{
			// Output any text before the match
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			// Set the match parameters
			this.matchStart = terminatorMatch.index;
			this.matchLength = terminatorMatch[1].length;
			this.matchText = terminatorMatch[1];
			this.nextMatch = terminatorMatch.index + terminatorMatch[1].length;
			// Restore the output pointer and exit
			this.output = oldOutput;
			return;		
			}
		// Check for a formatter match
		else if(formatterMatch)
			{
			// Output any text before the match
			if(formatterMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,formatterMatch.index);
			// Set the match parameters
			this.matchStart = formatterMatch.index;
			this.matchLength = formatterMatch[0].length;
			this.matchText = formatterMatch[0];
			this.nextMatch = this.formatter.formatterRegExp.lastIndex;
			// Figure out which formatter matched
			var matchingFormatter = -1;
			for(var t=1; t<formatterMatch.length; t++)
				if(formatterMatch[t])
					matchingFormatter = t-1;
			// Call the formatter
			if(matchingFormatter != -1)
				this.formatter.formatters[matchingFormatter].handler(this);
			}
	} while(terminatorMatch || formatterMatch);
	// Output any text after the last match
	if(this.nextMatch < this.source.length)
		{
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
		}
	// Restore the output pointer
	this.output = oldOutput;
}

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	// Check for highlights
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos))
		{
		// Deal with any plain text before the highlight
		if(this.highlightMatch.index > startPos)
			{
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
			}
		// Deal with the highlight
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		var theHighlight = createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		// Nudge along to the next highlight if we're done with this one
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
		}
	// Do the unhighlighted text left over
	if(startPos < endPos)
		{
		createTiddlyText(place,this.source.substring(startPos,endPos));
		}
}

// ---------------------------------------------------------------------------------
// Macro definitions
// ---------------------------------------------------------------------------------

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text;
	if(params[0])
		text = now.formatString(params[0].trim());
	else
		text = now.toLocaleString();
	createTiddlyElement(place,"span",null,null,text);
}

config.macros.version.handler = function(place)
{
	createTiddlyElement(place,"span",null,null,version.major + "." + version.minor + "." + version.revision + (version.beta ? " (beta " + version.beta + ")" : ""));
}

config.macros.list.handler = function(place,macroName,params)
{
	var type = params[0] ? params[0] : "all";
	var theList = document.createElement("ul");
	place.appendChild(theList);
	if(this[type].prompt)
		createTiddlyElement(theList,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	for (var t = 0; t < results.length; t++)
		{
		theListItem = document.createElement("li")
		theList.appendChild(theListItem);
		if(typeof results[t] == "string")
			createTiddlyLink(theListItem,results[t],true);
		else
			createTiddlyLink(theListItem,results[t].title,true);
		}
}

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
}

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
}

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
}

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
}

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags();
	var theDateList = createTiddlyElement(place,"ul",null,null,null);
	if(tags.length == 0)
		createTiddlyElement(theDateList,"li",null,"listTitle",this.noTags);
	for(var t=0; t<tags.length; t++)
		{
		var theListItem =createTiddlyElement(theDateList,"li",null,null,null);
		var theTag = createTiddlyButton(theListItem,tags[t][0] + " (" + tags[t][1] + ")",this.tooltip.format([tags[t][0]]),onClickTag);
		theTag.setAttribute("tag",tags[t][0]);
		}
}

config.macros.timeline.handler = function(place,macroName,params)
{
	var field = params[0] ? params[0] : "modified";
	var tiddlers = store.reverseLookup("tags","excludeLists",false,field);
	var lastDay = "";
	var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1])) : 0;
	for(var t=tiddlers.length-1; t>=last; t--)
		{
		var tiddler = tiddlers[t];
		var theDay = tiddler[field].convertToLocalYYYYMMDDHHMM().substr(0,8);
		if(theDay != lastDay)
			{
			var theDateList = document.createElement("ul");
			place.appendChild(theDateList);
			createTiddlyElement(theDateList,"li",null,"listTitle",tiddler[field].formatString(this.dateFormat));
			lastDay = theDay;
			}
		var theDateListItem = createTiddlyElement(theDateList,"li",null,"listLink",null);
		theDateListItem.appendChild(createTiddlyLink(place,tiddler.title,true));
		}
}

config.macros.search.handler = function(place,macroName,params)
{
	var searchTimeout = null;
	var btn = createTiddlyButton(place,this.label,this.prompt,this.onClick);
	var txt = createTiddlyElement(place,"input",null,null,null);
	if(params[0])
		txt.value = params[0];
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",this.accessKey);
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
	if(config.browser.isSafari)
		{
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
		}
	else
		txt.setAttribute("type","text");
}

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0)
		{
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
		}
}

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
}

config.macros.search.onKeyPress = function(e)
{
	if (!e) var e = window.event;
	switch(e.keyCode)
		{
		case 27:
			this.value = "";
			clearMessage();
			break;
		}
	if(this.value.length > 2)
		{
		if(this.value != this.getAttribute("lastSearchText"))
			{
			if(config.macros.search.timeout)
				clearTimeout(config.macros.search.timeout);
			var txt = this;
			config.macros.search.timeout = setTimeout(function() {config.macros.search.doSearch(txt);},500);
			}
		}
	else
		{
		if(config.macros.search.timeout)
			clearTimeout(config.macros.search.timeout);
		}
}

config.macros.search.onFocus = function(e)
{
	this.select();
}

config.macros.tiddler.handler = function(place,macroName,params)
{
	var wrapper = createTiddlyElement(place,"span",null,params[1] ? params[1] : null,null);
	var text = store.getTiddlerText(params[0]);
	if(text)
		{
		var tiddlerName = params[0];
		var stack = config.macros.tiddler.tiddlerStack;
		if(stack.find(tiddlerName) !== null)
			return;
		stack.push(tiddlerName);
		try
			{
			wikify(text,wrapper,null,store.getTiddler(tiddlerName));
			}
		finally
			{
			stack.pop();
			}
		}
}

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	createTagButton(place,params[0]);
}

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var theList = createTiddlyElement(place,"ul");
	if(params[0] && store.tiddlerExists[params[0]])
		tiddler = store.getTiddler(params[0]);
	var lingo = config.views.wikified.tag;
	var prompt = tiddler.tags.length == 0 ? lingo.labelNoTags : lingo.labelTags;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([tiddler.title]));
	for(var t=0; t<tiddler.tags.length; t++)
		createTagButton(createTiddlyElement(theList,"li"),tiddler.tags[t],tiddler.title);
}

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var theList = createTiddlyElement(place,"ul");
	var title = "";
	if(tiddler instanceof Tiddler)
        title = tiddler.title;
	if(params[0])
        title = params[0];
	theList.setAttribute("title",this.tooltip.format([title]));
	var tagged = store.getTaggedTiddlers(title);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(theList,"li",null,"listTitle",prompt.format([title]));
	for(var t=0; t<tagged.length; t++)
		createTiddlyLink(createTiddlyElement(theList,"li"),tagged[t].title,true);
}

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
}

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
}

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
}

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
}

config.macros.saveChanges.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
}

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
}

config.macros.slider.onClickSlider = function(e)
{
	if (!e) var e = window.event;
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate)
		anim.startAnimating(new Slider(n,!isOpen,e.shiftKey || e.altKey,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOptionCookie(cookie);
	return false;
}

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var cookie = cookie ? cookie : "";
	var btn = createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(place,"div",null,"sliderPanel",null);
	panel.setAttribute("cookie",cookie);
	panel.style.display = config.options[cookie] ? "block" : "none";
	return panel;
}

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
}

config.macros.option.onChangeOption = function(e)
{
	var opt = this.getAttribute("option");
	var elementType,valueField;
	if(opt)
		{
		switch(opt.substr(0,3))
			{
			case "txt":
				elementType = "input";
				valueField = "value";
				break;
			case "chk":
				elementType = "input";
				valueField = "checked";
				break;
			}
		config.options[opt] = this[valueField];
		saveOptionCookie(opt);
		var nodes = document.getElementsByTagName(elementType);
		for(var t=0; t<nodes.length; t++)
			{
			var optNode = nodes[t].getAttribute("option");
			if(opt == optNode)
				nodes[t][valueField] = this[valueField];
			}
		}
	return(true);
}

config.macros.option.handler = function(place,macroName,params)
{
	var opt = params[0];
	if(config.options[opt] == undefined)
		return;
	var c;
	switch(opt.substr(0,3))
		{
		case "txt":
			c = document.createElement("input");
			c.onkeyup = this.onChangeOption;
			c.setAttribute("option",opt);
			c.size = 15;
			place.appendChild(c);
			c.value = config.options[opt];
			break;
		case "chk":
			c = document.createElement("input");
			c.setAttribute("type","checkbox");
			c.onclick = this.onChangeOption;
			c.setAttribute("option",opt);
			place.appendChild(c);
			c.checked = config.options[opt];
			break;
		}
}

config.macros.newTiddler.onClick = function()
{
	story.displayTiddler(null,config.macros.newTiddler.title,DEFAULT_EDIT_TEMPLATE);
	story.focusTiddler(config.macros.newTiddler.title,"title");
	return false;
}

config.macros.newTiddler.handler = function(place)
{
	if(!readOnly)
		createTiddlyButton(place,this.label,this.prompt,this.onClick,null,null,this.accessKey);
}

config.macros.newJournal.handler = function(place,macroName,params)
{
	if(!readOnly)
		{
		var now = new Date();
		var title = now.formatString(params[0].trim());
		var btn = createTiddlyButton(place,this.label,this.prompt,this.createJournal,null,null,this.accessKey);
		btn.setAttribute("journalTitle",title);
		btn.setAttribute("params",params.join("|"));
		}
}

config.macros.newJournal.createJournal = function(e)
{
	var title = this.getAttribute("journalTitle");
	var params = this.getAttribute("params").split("|");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
	for(var t=1;t<params.length;t++)
		story.setTiddlerTag(title,params[t],+1);
	story.focusTiddler(title,"text");
	return false;
}

config.macros.sparkline.handler = function(place,macroName,params)
{
	var data = [];
	var min = 0;
	var max = 0;
	for(var t=0; t<params.length; t++)
		{
		var v = parseInt(params[t]);
		if(v < min)
			min = v;
		if(v > max)
			max = v;
		data.push(v);
		}
	if(data.length < 1)
		return;
	var box = createTiddlyElement(place,"span",null,"sparkline",String.fromCharCode(160));
	box.title = data.join(",");
	var w = box.offsetWidth;
	var h = box.offsetHeight;
	box.style.paddingRight = (data.length * 2 - w) + "px";
	box.style.position = "relative";
	for(var d=0; d<data.length; d++)
		{
		var tick = document.createElement("img");
		tick.border = 0;
		tick.className = "sparktick";
		tick.style.position = "absolute";
		tick.src = "data:image/gif,GIF89a%01%00%01%00%91%FF%00%FF%FF%FF%00%00%00%C0%C0%C0%00%00%00!%F9%04%01%00%00%02%00%2C%00%00%00%00%01%00%01%00%40%02%02T%01%00%3B";
		tick.style.left = d*2 + "px";
		tick.style.width = "2px";
		var v = Math.floor(((data[d] - min)/(max-min)) * h);
		tick.style.top = (h-v) + "px";
		tick.style.height = v + "px";
		box.appendChild(tick);
		}
}

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(place,"div",null,cookie,null);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset",null);
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	for(var t=0; t<numTabs; t++)
		{
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
		}
	if(!validTab)
		config.options[cookie] = params[1];
	this.switchTab(tabset,config.options[cookie]);
}

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
}

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null
	var nodes = tabset.childNodes;
	for(var t=0; t<nodes.length; t++)
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab)
			{
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
			}
		else
			nodes[t].className = "tab tabUnselected"
	if(theTab)
		{
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			tabset.parentNode.removeChild(tabset.nextSibling);
		var tabContent = createTiddlyElement(null,"div",null,"tabContents",null);
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie)
			{
			config.options[cookie] = tab;
			saveOptionCookie(cookie);
			}
		}
}

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier)
{
	var terminator = ">>";
	var panel;
	if(wikifier)
		panel = createTiddlyElement(place,"div",null,"gradient",null);
	else
		panel = place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	var t;
	if(wikifier)
		{
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
		}
	var colours = [];
	for(t=1; t<params.length; t++)
		{
		var c = new RGB(params[t]);
		if(c)
			colours.push(c);
		}
	drawGradient(panel,params[0] != "vert",colours);
	if(wikifier)
		wikifier.subWikify(panel,terminator);
	if(document.all)
		{
		panel.style.height = "100%";
		panel.style.width = "100%";
		}
}

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0])
		{
		var m = config;
		var p = params[0].split(".");
		for(var t=0; t<p.length; t++)
			{
			if(p[t] in m)
				m = m[p[t]];
			else
				break;
			}
		createTiddlyText(place,m.toString().format(params.splice(1)));
		}
}

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0] && (tiddler[params[0]] != undefined))
		{
		switch(params[1])
			{
			case undefined:
				highlightify(tiddler[params[0]],place,highlightHack);
				break;
			case "link":
				createTiddlyLink(place,tiddler[params[0]],true);
				break;
			case "wikified":
				wikify(tiddler[params[0]],place,highlightHack,tiddler);
				break;
			case "date":
				if(params[2])
					createTiddlyText(place,tiddler[params[0]].formatString(params[2]));
				else
					createTiddlyText(place,tiddler[params[0]]);
				break;
			}
		}
}

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	if((tiddler instanceof Tiddler) && field && (tiddler[field] != undefined))
		{
		story.setDirty(tiddler.title,true);
		switch(field)
			{
			case "title":
				var e = createTiddlyElement(place,"input");
				if(tiddler.isReadOnly())
					e.setAttribute("readOnly","readOnly");
				e.setAttribute("edit","title");
				e.setAttribute("type","text");
				e.value = tiddler.title;
				e.setAttribute("size","40");
				e.setAttribute("autocomplete","off");
				break;
			case "text":
				var wrapper1 = createTiddlyElement(place,"fieldset",null,"fieldsetFix",null);
				var wrapper2 = createTiddlyElement(wrapper1,"div",null,null,null);
				var e = createTiddlyElement(wrapper2,"textarea");
				if(tiddler.isReadOnly())
					e.setAttribute("readOnly","readOnly");
				e.value = tiddler.text;
				var rows = 10;
				var lines = tiddler.text.match(regexpNewLine);
				var maxLines = Math.max(parseInt(config.options.txtMaxEditRows),5);
				if(lines != null && lines.length > rows)
					rows = lines.length + 5;
				rows = Math.min(rows,maxLines);
				e.setAttribute("rows",rows);
				e.setAttribute("edit","text");
				break;
			case "tags":
				var e = createTiddlyElement(place,"input");
				if(tiddler.isReadOnly())
					e.setAttribute("readOnly","readOnly");
				e.setAttribute("edit","tags");
				e.setAttribute("type","text");
				e.value = tiddler.getTags();
				e.setAttribute("size","40");
				e.setAttribute("autocomplete","off");
				break;
			}
		}
}

config.macros.tagChooser.onClick = function(e)
{
	if (!e) var e = window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags();
	if(tags.length == 0)
		createTiddlyText(createTiddlyElement(popup,"li"),lingo.popupNone);
	for (var t=0; t<tags.length; t++)
		{
		var theTag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		theTag.setAttribute("tag",tags[t][0]);
		theTag.setAttribute("tiddler", this.getAttribute("tiddler"));
		}
	Popup.show(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return(false);
}

config.macros.tagChooser.onTagClick = function(e)
{
	if (!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	var tiddler = store.getTiddler(title);
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return(false);
}

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler)
		{
		var title = tiddler.title;
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler", title);
		}
}

// Create a toolbar command button
// place - parent DOM element
// command - reference to config.commands[] member -or- name of member
// tiddler - reference to tiddler that toolbar applies to
// theClass - the class to give the button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,theClass)
{
	if(typeof commandName != "string")
		{
		var c = null;
		for(var t in config.commands)
			if(config.commands[t] == commandName)
				c = t;
		commandName = c;
		}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string"))
		{
		var title = tiddler.title;
		var command = config.commands[commandName];
		var ro = tiddler.isReadOnly();
		var text = ro && command.readOnlyText ? command.readOnlyText : command.text;
		var tooltip = ro && command.readOnlyTooltip ? command.readOnlyTooltip : command.tooltip;
		if(!ro || (ro && !command.hideReadOnly))
			{
			var btn = createTiddlyButton(place,text,tooltip,this.onClickCommand);
			btn.setAttribute("commandName", commandName);
			btn.setAttribute("tiddler", title);
			if(theClass)
				addClass(btn,theClass);
			}
		}
}

config.macros.toolbar.onClickCommand = function(e)
{
	if (!e) var e = window.event;
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
}

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,theClass,event)
{
	var children = place.getElementsByTagName("a")
	for (var t=0; t<children.length; t++)
		{
		var c = children[t];
		if(hasClass(c,theClass) && c.getAttribute && c.getAttribute("commandName"))
			{
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
			}
		}
}

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	for(var t=0; t<params.length; t++)
		{
		var c = params[t];
		var theClass = "";
		switch(c.substr(0,1))
			{
			case "+":
				theClass = "defaultCommand";
				c = c.substr(1);
				break;
			case "-":
				theClass = "cancelCommand";
				c = c.substr(1);
				break;
			}
		if(c in config.commands)
			this.createCommand(place,c,tiddler,theClass);
		}
}

config.macros.br.handler = function(place)
{
	createTiddlyElement(place,"br");
}

// ---------------------------------------------------------------------------------
// Menu and toolbar commands
// ---------------------------------------------------------------------------------

config.commands.closeTiddler.handler = function(event,src,title)
{
	story.closeTiddler(title,true,event.shiftKey || event.altKey);
	return false;
}

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
}

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
	story.focusTiddler(title,"text");
	return false;
}

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
	   story.displayTiddler(null,newTitle);
	return false;
}

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly)
		if(!confirm(this.warning.format([title])))
			return false;
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
}

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true; 
	if (config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if (deleteIt)
		{
		store.removeTiddler(title);
		story.closeTiddler(title,true,event.shiftKey || event.altKey);
		if(config.options.chkAutoSave)
			saveChanges();
		}
	return false;
}

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
}

config.commands.references.handler = function(event,src,title)
{
	var popup = Popup.create(src);
	if(popup)
		{
		var references = store.getReferringTiddlers(title);
		var c = false;
		for(var r=0; r<references.length; r++)
			if(references[r].title != title && !references[r].isTagged("excludeLists"))
				{
				createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
				c = true;
				}
		if(!c)
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),this.popupNone);
		}
	Popup.show(popup,false);
	event.cancelBubble = true;
	if (event.stopPropagation) event.stopPropagation();
	return false;
}

config.commands.jump.handler = function(event,src,title)
{
	var popup = Popup.create(src);
	if(popup)
		{
		story.forEachTiddler(function(title,element) {
			createTiddlyLink(createTiddlyElement(popup,"li"),title,true);
			});
		}
	Popup.show(popup,false);
	event.cancelBubble = true;
	if (event.stopPropagation) event.stopPropagation();
	return false;
}

// ---------------------------------------------------------------------------------
// Tiddler() object
// ---------------------------------------------------------------------------------

function Tiddler()
{
	this.title = null;
	this.text = null;
	this.modifier = null;
	this.modified = new Date();
	this.created = new Date();
	this.links = [];
	this.tags = [];
	return this;
}

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
	var text = Tiddler.unescapeLineBreaks(divRef.firstChild ? divRef.firstChild.nodeValue : "");
	var modifier = divRef.getAttribute("modifier");
	var modified = Date.convertFromYYYYMMDDHHMM(divRef.getAttribute("modified"));
	var c = divRef.getAttribute("created");
	var created = c ? Date.convertFromYYYYMMDDHHMM(c) : modified;
	var tags = divRef.getAttribute("tags");
	this.assign(title,text,modifier,modified,tags,created);
	return this;
}

// Format the text for storage in an HTML DIV
Tiddler.prototype.saveToDiv = function()
{
	return '<div tiddler="%0" modifier="%1" modified="%2" created="%3" tags="%4">%5</div>'.format([
			this.title.htmlEncode(),
			this.modifier.htmlEncode(),
			this.modified.convertToYYYYMMDDHHMM(),
			this.created.convertToYYYYMMDDHHMM(),
			this.getTags().htmlEncode(),
			this.escapeLineBreaks().htmlEncode()
		]);
}

// Format the text for storage in an RSS item
Tiddler.prototype.saveToRss = function(url)
{
	var s = [];
	s.push("<item>");
	s.push("<title>" + this.title.htmlEncode() + "</title>");
	s.push("<description>" + this.text.replace(regexpNewLine,"<br />").htmlEncode() + "</description>");
	for(var t=0; t<this.tags.length; t++)
		s.push("<category>" + this.tags[t] + "</category>");
	s.push("<link>" + url + "#" + encodeURIComponent(String.encodeTiddlyLink(this.title)) + "</link>");
	s.push("<pubDate>" + this.modified.toGMTString() + "</pubDate>");
	s.push("</item>");
	return(s.join("\n"));
}

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created)
{
	this.assign(title,text,modifier,modified,tags,created);
	this.changed();
	return this;
}

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(created != undefined)
		this.created = created;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
}

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	if(this.tags)
		{
		var results = [];
		for(var t=0; t<this.tags.length; t++)
			results.push(String.encodeTiddlyLink(this.tags[t]));
		return results.join(" ");
		}
	else
		return "";
}

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.find(tag) != null;
}

var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");

// Static method to Convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	if(text && text != "")
		return text.replace(regexpBackSlashEn,"\n").replace(regexpBackSlashEss,"\\").replace(regexpCarriageReturn,"");
	else
		return "";
}

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.replace(regexpBackSlash,"\\s").replace(regexpNewLine,"\\n").replace(regexpCarriageReturn,"");
}

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var nextPos = 0;
	var theLink;
	var aliasedPrettyLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
	var prettyLink = "\\[\\[([^\\]]+)\\]\\]";
	var wikiNameRegExp = new RegExp("(" + config.textPrimitives.wikiLink + ")|(?:" + aliasedPrettyLink + ")|(?:" + prettyLink + ")","mg");
	do {
		var formatMatch = wikiNameRegExp.exec(this.text);
		if(formatMatch)
			{
			if(formatMatch[1] && formatMatch[1].substr(0,1) != config.textPrimitives.unWikiLink && formatMatch[1] != this.title)
				this.links.pushUnique(formatMatch[1]);
			else if(formatMatch[2] && (store.tiddlerExists(formatMatch[3]) || store.isShadowTiddler(formatMatch[3])))
				this.links.pushUnique(formatMatch[3]);
			else if(formatMatch[4] && formatMatch[4] != this.title)
				this.links.pushUnique(formatMatch[4]);
			}
	} while(formatMatch);
	return;
}

Tiddler.prototype.getSubtitle = function()
{
	var theModifier = this.modifier;
	if(!theModifier)
		theModifier = config.messages.subtitleUnknown;
	var theModified = this.modified;
	if(theModified)
		theModified = theModified.toLocaleString();
	else
		theModified = config.messages.subtitleUnknown;
	return(config.messages.tiddlerLinkTooltip.format([this.title,theModifier,theModified]));
}

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
}

// ---------------------------------------------------------------------------------
// TiddlyWiki() object contains Tiddler()s
// ---------------------------------------------------------------------------------

function TiddlyWiki()
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
		};
	this.fetchTiddler = function(title) {
		return tiddlers[title];
		};
	this.deleteTiddler = function(title) {
		 delete tiddlers[title];
		};
	this.addTiddler = function(tiddler) {
		 tiddlers[tiddler.title] = tiddler;
		};
	this.forEachTiddler = function(callback) {
		for(var t in tiddlers)
			{
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
			}
		};
}

// Set the dirty flag
TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
}

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
}

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
}

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
}

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel)
		for(var t=0; t<this.namedNotifications.length; t++)
			{
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
			}
}

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel)
		for(var t=0; t<this.namedNotifications.length; t++)
			{
			var n = this.namedNotifications[t];
			n.notify(n.name);
			}
}

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	for (var i=0; i<this.namedNotifications.length; i++)
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	this.namedNotifications.push({name: title, notify: fn});
	return this;
}

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		{
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
		}
}

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return (t != undefined);
}

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	var s = config.shadowTiddlers[title];
	return (s != undefined && typeof s == "string");
}

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
}

TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	if(!title)
		return(defaultText);
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		return tiddler.text;
	else if(this.isShadowTiddler(title))
		return config.shadowTiddlers[title];
	else if(defaultText != undefined)
		return defaultText;
	else
		return null;
}

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,defaultText);
	if(text == null)
		return "";
	var textOut = [];
	var lastPos = 0;
	do {
		var match = bracketRegExp.exec(text);
		if(match)
			{
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1])
				{
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],match[1],depth-1));
				}
			lastPos = match.index + match[0].length;
			}
		else
			textOut.push(text.substr(lastPos));
	} while(match);
	return(textOut.join(""));
}

TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags)
{
	var tiddler = this.fetchTiddler(title);
	var created;
	if(tiddler)
		{
 		created = tiddler.created; // preserve created date
		this.deleteTiddler(title);
		}
	else
		{
		tiddler = new Tiddler();
		created = modified;
		}
	tiddler.set(newTitle,newBody,modifier,modified,tags,created);
	this.addTiddler(tiddler);
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
}

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		{
		tiddler = new Tiddler();
		tiddler.title = title;
		this.addTiddler(tiddler);
		this.setDirty(true);
		}
	return tiddler;
}

// Load contents of a tiddlywiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(srcID,idPrefix)
{
	if(document.normalize)
		document.normalize();
	var lenPrefix = idPrefix.length;
	var store = document.getElementById(srcID).childNodes;
	var tiddlers = [];
	for(var t = 0; t < store.length; t++)
		{
		var e = store[t];
		var title = null;
		if(e.getAttribute)
			title = e.getAttribute("tiddler");
		if(!title && e.id && e.id.substr(0,lenPrefix) == idPrefix)
			title = e.id.substr(lenPrefix);
		if(title && title != "")
			{
			var tiddler = this.createTiddler(title);
			tiddler.loadFromDiv(e,title);
			tiddlers.push(tiddler);
			}
		}
	for(var t = 0;t<tiddlers.length; t++)
		tiddlers[t].changed();
	this.setDirty(false);
}

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag)
{
	var candidates = this.reverseLookup("tags",excludeTag,false);
	var results = [];
	for(var t=0; t<candidates.length; t++)
		{
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
		}
	if(!sortField)
		sortField = "title";
	results.sort(function (a,b) {if(a[sortField] == b[sortField]) return(0); else return (a[sortField] < b[sortField]) ? -1 : +1; });
	return results;
}

// Return an array of all the tags in use. Each member of the array is another array where [0] is the name of the tag and [1] is the number of occurances
TiddlyWiki.prototype.getTags = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		for(var g=0; g<tiddler.tags.length; g++)
			{
			var tag = tiddler.tags[g];
			var f = false;
			for(var c=0; c<results.length; c++)
				if(results[c][0] == tag)
					{
					f = true;
					results[c][1]++;
					}
			if(!f)
				results.push([tag,1]);
			}
		});
	results.sort(function (a,b) {if(a[0].toLowerCase() == b[0].toLowerCase()) return(0); else return (a[0].toLowerCase() < b[0].toLowerCase()) ? -1 : +1; });
	return results;
}

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
}

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	return this.reverseLookup("links",title,true,sortField);
}

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		for(var lookup=0; lookup<tiddler[lookupField].length; lookup++)
			if(tiddler[lookupField][lookup] == lookupValue)
				f = lookupMatch;
		if(f)
			results.push(tiddler);
		});
	if(!sortField)
		sortField = "title";
	results.sort(function (a,b) {if(a[sortField] == b[sortField]) return(0); else return (a[sortField] < b[sortField]) ? -1 : +1; });
	return results;
}

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || tiddler.tags.find(excludeTag) == null)
			results.push(tiddler);
		});
	if(field)
		results.sort(function (a,b) {if(a[field] == b[field]) return(0); else return (a[field] < b[field]) ? -1 : +1; });
	return results;
}

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function(sortField)
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(tiddler.tags.find("systemConfig") == null && tiddler.tags.find("excludeMissing") == null)
			for(var n=0; n<tiddler.links.length;n++)
				{
				var link = tiddler.links[n];
				if(this.fetchTiddler(link) == null && !this.isShadowTiddler(link))
					results.pushUnique(link);
				}
		});
	results.sort();
	return results;
}

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
		});
	results.sort();
	return results;
}

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var results = [];
	for(var t in config.shadowTiddlers)
		if(typeof config.shadowTiddlers[t] == "string")
			results.push(t);
	results.sort();
	return results;
}

// ---------------------------------------------------------------------------------
// Story functions
// ---------------------------------------------------------------------------------

function displayTiddlers(srcElement,titles,template,unused1,unused2,animate,slowly)
{
	story.displayTiddlers(srcElement,titles,template,animate,slowly);
}

function displayTiddler(srcElement,title,template,unused1,unused2,animate,slowly)
{
	story.displayTiddler(srcElement,title,template,animate,slowly);
}

// A story is a HTML div containing a sequence of tiddlers that can be manipulated
// container - id of containing element
// idPrefix - string prefix prepended to title to make ids for tiddlers in this story
function Story(container,idPrefix)
{
	this.container = container;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
}

// Iterate through all the tiddlers in a story
// fn - callback function to be called for each tiddler. Arguments are:
//		tiddler - reference to Tiddler object
//		element - reference to tiddler display element
Story.prototype.forEachTiddler = function(fn)
{
	var place = document.getElementById(this.container);
	if(!place)
		return;
	var e = place.firstChild;
	while(e)
		{
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		fn.call(this,title,e);
		e = n;
		}
}

// Display several tiddlers given their titles in an array. Parameters same as displayTiddler(), except:
// titles - array of string titles
Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,slowly)
{
	for(var t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,slowly);
}

// Display a given tiddler with a given template. If the tiddler is already displayed but with a different
// template, it is switched to the specified template
// srcElement - reference to element from which this one is being opened -or-
//              special positions "top", "bottom"
// title - title of tiddler to display
// template - the name of the tiddler containing the template -or-
//			  one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE -or-
//			  null or undefined to indicate the current template if there is one, DEFAULT_VIEW_TEMPLATE if not
// animate - whether to perform animations
// slowly - whether to perform animations in slomo
Story.prototype.displayTiddler = function(srcElement,title,template,animate,slowly)
{
	var place = document.getElementById(this.container);
	var theTiddler = document.getElementById(this.idPrefix + title);
	if(theTiddler)
		this.refreshTiddler(title,template);
	else
		{
		var before = this.positionTiddler(srcElement);
		theTiddler = this.createTiddler(place,before,title,template);
		}
	if(srcElement)
		{
		if(config.options.chkAnimate && (animate == undefined || animate == true))
			anim.startAnimating(new Cascade(title,srcElement,theTiddler,slowly),new Scroller(theTiddler,slowly));
		else
			window.scrollTo(0,ensureVisible(theTiddler));
		}
}

// Figure out the appropriate position for a newly opened tiddler
// srcElement - reference to the element containing the link to the tiddler -or-
//              special positions "top", "bottom"
// returns - reference to the tiddler that the new one should appear before (null for the bottom of the story)
Story.prototype.positionTiddler = function(srcElement)
{
	var place = document.getElementById(this.container);
	var before;
	if(typeof srcElement == "string")
		{
		switch(srcElement)
			{
			case "top":
				before = place.firstChild;
				break;
			case "bottom":
				before = null;
				break;
			}
		}
	else
		{
		var after = this.findContainingTiddler(srcElement);
		if(after == null)
			before = place.firstChild;
		else if(after.nextSibling)
			before = after.nextSibling;
		else
			before = null;
		}
	return before;
}

// Create a tiddler frame at the appropriate place in a story column
// place - reference to parent element
// before - null, or reference to element before which to insert new tiddler
// title - title of new tiddler
// template - the name of the tiddler containing the template or one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE
Story.prototype.createTiddler = function(place,before,title,template)
{
	var theTiddler = createTiddlyElement(null,"div",this.idPrefix + title,"tiddler",null);
	place.insertBefore(theTiddler,before);
	this.refreshTiddler(title,template);
	return theTiddler;
}

// Overridable for choosing the name of the template to apply for a tiddler
Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
}

// Overridable for extracting the text of a template from a tiddler
Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getTiddlerText(template);
}

// Apply a template to an existing tiddler if it is not already displayed using that template
// title - title of tiddler to update
// template - the name of the tiddler containing the template or one of the constants DEFAULT_VIEW_TEMPLATE and DEFAULT_EDIT_TEMPLATE
// force - if true, forces the refresh even if the template hasn't changedd
Story.prototype.refreshTiddler = function(title,template,force)
{
	var theTiddler = document.getElementById(this.idPrefix + title);
	if(theTiddler)
		{
		if(theTiddler.getAttribute("dirty") == "true" && !force)
			return theTiddler;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = theTiddler.getAttribute("template");
		if((template != currTemplate) || force)
			{
			var tiddler = store.getTiddler(title);
			if(!tiddler)
				{
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title))
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,[],version.date);
				else
					{
					var text = template=="EditTemplate"
								? config.views.editor.defaultText.format([title])
								: config.views.wikified.defaultText.format([title]);
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date);
					}
				}
			theTiddler.setAttribute("tags",tiddler.tags.join(" "));
			theTiddler.setAttribute("tiddler",title);
			theTiddler.setAttribute("template",template);
			var me = this;
			theTiddler.onmouseover = this.onTiddlerMouseOver;
			theTiddler.onmouseout = this.onTiddlerMouseOut;
			theTiddler.ondblclick = this.onTiddlerDblClick;
			theTiddler.onkeypress = this.onTiddlerKeyPress;
			var html = this.getTemplateForTiddler(title,template,tiddler);
			theTiddler.innerHTML = html;
			applyHtmlMacros(theTiddler,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				addClass(theTiddler,"isTag");
			else
				removeClass(theTiddler,"isTag");
			if(!store.tiddlerExists(title))
				{
				if(store.isShadowTiddler(title))
					addClass(theTiddler,"shadow");
				else
					addClass(theTiddler,"missing");
				}
			else
				{
				removeClass(theTiddler,"shadow");
				removeClass(theTiddler,"missing");
				}
			}
		}
	return theTiddler;
}

// Default tiddler onmouseover/out event handlers
Story.prototype.onTiddlerMouseOver = function(e)
{
	if(window.addClass instanceof Function)
		addClass(this,"selected");
}

Story.prototype.onTiddlerMouseOut = function(e)
{
	if(window.removeClass instanceof Function)
		removeClass(this,"selected");
}

// Default tiddler ondblclick event handler
Story.prototype.onTiddlerDblClick = function(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	if(theTarget && theTarget.nodeName.toLowerCase() != "input" && theTarget.nodeName.toLowerCase() != "textarea")
		{
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if (e.stopPropagation) e.stopPropagation();
		return true;
		}
	else
		return false;
}

// Default tiddler onkeypress event handler
Story.prototype.onTiddlerKeyPress = function(e)
{
	if (!e) var e = window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	switch(e.keyCode)
		{
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
		case 77: // Ctrl-Enter is "M" on some platforms
			if(e.ctrlKey)
				{
				blurElement(this);
				config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
				consume = true;
				}
			break;
		case 27: // Escape
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
			consume = true;
			break;
		}
	e.cancelBubble = consume;
	if(consume)
		if (e.stopPropagation) e.stopPropagation();
	return(!consume);
};

// Focus a specified tiddler. Attempts to focus the specified field, otherwise the first edit field it finds
Story.prototype.focusTiddler = function(title,field)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		{
		var children = tiddler.getElementsByTagName("*")
		var e = null;
		for (var t=0; t<children.length; t++)
			{
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea")
				{
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
				}
			}
		if(e)
			{
			e.focus();
			e.select();
			}
		}
}

// Ensures that a specified tiddler does not have the focus
Story.prototype.blurTiddler = function (title)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null && tiddler.focus && tiddler.blur)
		{
		tiddler.focus();
		tiddler.blur();
		}
}

// Adds a specified tag to the edit controls (if any) for a particular tiddler)
// title - name of tiddler
// tag - name of tag, without any [[brackets]]
// mode - +1 to add the tag, -1 to remove it, 0 to toggle it
Story.prototype.setTiddlerTag = function(title,tag,add)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		{
		var children = tiddler.getElementsByTagName("input")
		for (var t=0; t<children.length; t++)
			{
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" && c.getAttribute("edit") == "tags")
				{
				var tags = c.value.readBracketedList();
				var p = tags.find(tag);
				if(add == 0)
				    add = (p == null) ? +1 : -1;
				if(add == +1)
					{
					if(p == null)
						tags.push(tag);
					}
				else if(add == -1)
					{
					if(p != null)
						tags.splice(p,1);
					}
				var result = [];
				for(var r=0; r<tags.length; r++)
					result.push(String.encodeTiddlyLink(tags[r]));
				c.value = result.join(" ");
				}
			}
		}
}

// Close a specified tiddler
// title - name of tiddler to close
// animate - whether to perform animations
// slowly - whether to perform animations in slomo
Story.prototype.closeTiddler = function(title,animate,slowly)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		{
		clearMessage();
		this.scrubTiddler(tiddler);
		if(config.options.chkAnimate && animate)
			anim.startAnimating(new Slider(tiddler,false,slowly,"all"));
		else
			tiddler.parentNode.removeChild(tiddler);
		}
}

// Scrub IDs from a tiddler. This is so that the 'ghost' of a tiddler while it is being closed
// does not interfere with things
// tiddler - reference to the tiddler element
Story.prototype.scrubTiddler = function(tiddler)
{
	tiddler.id = null;
}

// Set the 'dirty' flag of a tiddler
// tiddler - title of tiddler to change
// dirty - new boolean status of flag
Story.prototype.setDirty = function(title,dirty)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		tiddler.setAttribute("dirty",dirty ? "true" : "false");
}

// Is a particular tiddler dirty (with unsaved changes)?
Story.prototype.isDirty = function(title)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		return tiddler.getAttribute("dirty") == "true";
	return null;
}

// Close all tiddlers in the story
Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
		});
	window.scrollTo(0,0);
}

// Check if there are any tiddlers in the story
Story.prototype.isEmpty = function()
{
	var place = document.getElementById(this.container);
	return(place && place.firstChild == null);
}

// Perform a search and display the result
// text - text to search for
// useCaseSensitive - true for case sensitive matching
// useRegExp - true to interpret text as a RegExp
Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ?	 text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	for(var t=matches.length-1; t>=0; t--)
		this.displayTiddler(null,matches[t].title);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
}

// Determine if the specified element is within a tiddler in this story
// e - reference to an element
// returns: reference to a tiddler element or null if none
Story.prototype.findContainingTiddler = function(e)
{
	while(e && !hasClass(e,"tiddler"))
		e = e.parentNode;
	return(e);
}

// Gather any saveable fields from a tiddler element
// e - reference to an element to scan recursively
// fields - object to contain gathered field values
Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute)
		{
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");;
		if(e.hasChildNodes())
			{
			var c = e.childNodes;
			for(var t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields)
			}
		}
}

// Determine whether a tiddler has any edit fields, and if so if their values have been changed
// title - name of tiddler
Story.prototype.hasChanges = function(title)
{
	var changed = false;
	var e = document.getElementById(this.idPrefix + title);
	if(e != null)
		{
		var fields = {};
		this.gatherSaveFields(e,fields);
		var tiddler = store.fetchTiddler(title);
		for(var n in fields)
			{
			switch(n)
				{
				case "title":
					if(tiddler && tiddler.title != fields.title)
						changed = true;
					break;
				case "text":
					if(tiddler && tiddler.text != fields.text)
						changed = true;
					break;
				case "tags":
					if(tiddler && tiddler.getTags() != fields.tags)
						changed = true;
					break;
				}
			}
		}
	return changed;
}

// Save any open edit fields of a tiddler and updates the display as necessary
// title - name of tiddler
// minorUpdate - true if the modified date shouldn't be updated
// returns: title of saved tiddler, or null if not saved
Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddler = document.getElementById(this.idPrefix + title);
	if(tiddler != null)
		{
		var fields = {};
		this.gatherSaveFields(tiddler,fields);
		var newTitle = fields.title ? fields.title : title;
		if(store.tiddlerExists(newTitle) && newTitle != title)
			{
			if(confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				this.closeTiddler(newTitle,false,false);
			else
				return null;
			}
		tiddler.id = this.idPrefix + newTitle;
		tiddler.setAttribute("tiddler",newTitle);
		tiddler.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		var newDate = new Date();
		store.saveTiddler(title,newTitle,fields.text,config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags);
		if(config.options.chkAutoSave)
			saveChanges();
		return newTitle;
		}
	return null;
}

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
		});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
}

// ---------------------------------------------------------------------------------
// Message area
// ---------------------------------------------------------------------------------

function displayMessage(text,linkText)
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		{
		alert(text);
		return;
		}
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),config.messages.messageClose.text,config.messages.messageClose.tooltip,clearMessage);
	var msg;
	if(linkText)
		{
		msg = createTiddlyElement(msgArea,"div",null,null,null);
		var link = createTiddlyElement(msg,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
		}
	else
		msg = createTiddlyElement(msgArea,"div",null,null,text);
	msgArea.style.display = "block";
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea)
		{
		removeChildren(msgArea);
		msgArea.style.display = "none";
		}
	return false;
}

// ---------------------------------------------------------------------------------
// Refresh mechanism
// ---------------------------------------------------------------------------------

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		},
		
	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		if(force != null || changeList == null || changeList.find(title) != null)
			{
			removeChildren(e);
			wikify(store.getTiddlerText(title,title),e,null,null);
			}
		}
};

function refreshElements(root,changeList)
{
	var nodes = root.childNodes;
	for(var c=0; c<nodes.length; c++)
		{
		var e = nodes[c],type;
		if(e.getAttribute)
			type = e.getAttribute("refresh");
		else
			type = null;
		var refresher = config.refreshers[type];
		if(refresher == undefined)
			{
			if(e.hasChildNodes())
				refreshElements(e,changeList);
			}
		else
			refresher(e,changeList);
		}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e)
		{
		var nextChild = e.nextSibling;
		if(e.getAttribute)
			{
			var macro = e.getAttribute("macro");
			if(macro)
				{
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1)
					{
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
					}
				invokeMacro(e,macro,params,null,tiddler);
				}
			}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
		}
}

function refreshPageTemplate(title)
{
	applyPageTemplate(title);
}

function applyPageTemplate(title)
{
	var stash = createTiddlyElement(document.body,"div");
	stash.style.display = "none";
	var display = document.getElementById("tiddlerDisplay");
	var nodes,t;
	if(display)
		{
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
		}
	var wrapper = document.getElementById("contentWrapper");
	if(!title)
		title = "PageTemplate";
	var html = store.getTiddlerText(title);
	wrapper.innerHTML = html;
	applyHtmlMacros(wrapper,null);
	refreshElements(wrapper,null);
	display = document.getElementById("tiddlerDisplay");
	removeChildren(display);
	if(!display)
		display = createTiddlyElement(wrapper,"div","tiddlerDisplay");
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	stash.parentNode.removeChild(stash);
}

function refreshDisplay(hint)
{
	var e = document.getElementById("contentWrapper");
	refreshElements(e,hint == null ? null : [hint]);
}

function refreshPageTitle()
{
	document.title = wikifyPlain("SiteTitle") + " - " + wikifyPlain("SiteSubtitle");
}

function refreshStyles(title)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title);
}

// ---------------------------------------------------------------------------------
// Options cookie stuff
// ---------------------------------------------------------------------------------

function loadOptionsCookie()
{
	if(safeMode)
		return;
	var cookies = document.cookie.split(";");
	for(var c=0; c<cookies.length; c++)
		{
		var p = cookies[c].indexOf("=");
		if(p != -1)
			{
			var name = cookies[c].substr(0,p).trim();
			var value = cookies[c].substr(p+1).trim();
			switch(name.substr(0,3))
				{
				case "txt":
					config.options[name] = unescape(value);
					break;
				case "chk":
					config.options[name] = value == "true";
					break;
				}
			}
		}
}

function saveOptionCookie(name)
{
	if(safeMode)
		return;
	var c = name + "=";
	switch(name.substr(0,3))
		{
		case "txt":
			c += escape(config.options[name].toString());
			break;
		case "chk":
			c += config.options[name] ? "true" : "false";
			break;
		}
	c += "; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/";
	document.cookie = c;
}

// ---------------------------------------------------------------------------------
// Saving
// ---------------------------------------------------------------------------------

var saveUsingSafari = false;
var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var endSaveArea = '</d' + 'iv>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if(store && store.isDirty && store.isDirty())
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false)
		{
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
		}
}

// Save this tiddlywiki with the pending changes
function saveChanges()
{
	clearMessage();
	// Get the URL of the document
	var originalPath = document.location.toString();
	// Check we were loaded from a file URL
	if(originalPath.substr(0,5) != "file:")
		{
		alert(config.messages.notFileUrlError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			displayTiddler(null,config.messages.saveInstructions);
		return;
		}
	var localPath = getLocalPath(originalPath);
	// Load the original file
	var original = loadFile(localPath);
	if(original == null)
		{
		alert(config.messages.cantSaveError);
		if(store.tiddlerExists(config.messages.saveInstructions))
			displayTiddler(null,config.messages.saveInstructions);
		return;
		}
	// Locate the storeArea div's
	var posOpeningDiv = original.indexOf(startSaveArea);
	var posClosingDiv = original.lastIndexOf(endSaveArea);
	if((posOpeningDiv == -1) || (posClosingDiv == -1))
		{
		alert(config.messages.invalidFileError.format([localPath]));
		return;
		}
	// Save the backup
	if(config.options.chkSaveBackups)
		{
		var backupPath = getBackupPath(localPath);
		var backup = saveFile(backupPath,original);
		if(backup)
			displayMessage(config.messages.backupSaved,"file://" + backupPath);
		else
			alert(config.messages.backupFailed);
		}
	// Save Rss
	if(config.options.chkGenerateAnRssFeed)
		{
		var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
		var rssSave = saveFile(rssPath,convertUnicodeToUTF8(generateRss()));
		if(rssSave)
			displayMessage(config.messages.rssSaved,"file://" + rssPath);
		else
			alert(config.messages.rssFailed);
		}
	// Save empty template
	if(config.options.chkSaveEmptyTemplate)
		{
		var emptyPath,p;
		if((p = localPath.lastIndexOf("/")) != -1)
			emptyPath = localPath.substr(0,p) + "/empty.html";
		else if((p = localPath.lastIndexOf("\\")) != -1)
			emptyPath = localPath.substr(0,p) + "\\empty.html";
		else
			emptyPath = localPath + ".empty.html";
		var empty = original.substr(0,posOpeningDiv + startSaveArea.length) + original.substr(posClosingDiv);
		var emptySave = saveFile(emptyPath,empty);
		if(emptySave)
			displayMessage(config.messages.emptySaved,"file://" + emptyPath);
		else
			alert(config.messages.emptyFailed);
		}
	// Save new file
	var revised = original.substr(0,posOpeningDiv + startSaveArea.length) + 
				convertUnicodeToUTF8(allTiddlersAsHtml()) + "\n\t\t" +
				original.substr(posClosingDiv);
	var newSiteTitle = convertUnicodeToUTF8((wikifyPlain("SiteTitle") + " - " + wikifyPlain("SiteSubtitle")).htmlEncode());
	revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
	revised = revised.replaceChunk("<!--PRE-HEAD-START--"+">","<!--PRE-HEAD-END--"+">","\n" + store.getTiddlerText("MarkupPreHead","") + "\n");
	revised = revised.replaceChunk("<!--POST-HEAD-START--"+">","<!--POST-HEAD-END--"+">","\n" + store.getTiddlerText("MarkupPostHead","") + "\n");
	revised = revised.replaceChunk("<!--PRE-BODY-START--"+">","<!--PRE-BODY-END--"+">","\n" + store.getTiddlerText("MarkupPreBody","") + "\n");
	revised = revised.replaceChunk("<!--POST-BODY-START--"+">","<!--POST-BODY-END--"+">","\n" + store.getTiddlerText("MarkupPostBody","") + "\n");
	var save = saveFile(localPath,revised);
	if(save)
		{
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
		}
	else
		alert(config.messages.mainFailed);
}

function getLocalPath(originalPath)
{
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format assuming
	// "file:///x:/path/path/path..." - pc local file --> "x:\path\path\path..."
	// "file://///server/share/path/path/path..." - FireFox pc network file --> "\\server\share\path\path\path..."
	// "file:///path/path/path..." - mac/unix local file --> "/path/path/path..."
	// "file://server/share/path/path/path..." - pc network file --> "\\server\share\path\path\path..."
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath)
{
	var backSlash = true;
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1)
		{
		dirPathPos = localPath.lastIndexOf("/");
		backSlash = false;
		}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + (backSlash ? "\\" : "/") + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + "." + (new Date()).convertToYYYYMMDDHHMMSSMMM() + ".html";
	return backupPath;
}

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl",null);
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title>" + wikifyPlain("SiteTitle").htmlEncode() + "</title>");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlain("SiteSubtitle").htmlEncode() + "</description>");
	s.push("<language>en-us</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + version.major + "." + version.minor + "." + version.revision + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for (var t=tiddlers.length-1; t>=n; t--)
		s.push(tiddlers[t].saveToRss(u));
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}

function allTiddlersAsHtml()
{
	var savedTiddlers = [];
	var tiddlers = store.getTiddlers("title");
	for (var t = 0; t < tiddlers.length; t++)
		savedTiddlers.push(tiddlers[t].saveToDiv());
	return savedTiddlers.join("\n");
}

// UTF-8 encoding rules:
// 0x0000 - 0x007F:	0xxxxxxx
// 0x0080 - 0x07FF:	110xxxxx 10xxxxxx
// 0x0800 - 0xFFFF:	1110xxxx 10xxxxxx 10xxxxxx

function convertUTF8ToUnicode(u)
{
	if(window.Components)
		return mozConvertUTF8ToUnicode(u);
	else
		return manualConvertUTF8ToUnicode(u);
}

function manualConvertUTF8ToUnicode(u)
{
	var s = "";
	var t = 0;
	var b1, b2, b3;
	while(t < u.length)
		{
		b1 = u.charCodeAt(t++);
		if(b1 < 0x80)
			s += String.fromCharCode(b1);
		else if(b1 < 0xE0)
			{
			b2 = u.charCodeAt(t++);
			s += String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			}
		else
			{
			b2 = u.charCodeAt(t++);
			b3 = u.charCodeAt(t++);
			s += String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			}
	}
	return(s);
}

function mozConvertUTF8ToUnicode(u)
{
	if (window.netscape == undefined)
		return manualConvertUTF8ToUnicode(u); // fallback
	try
		{
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		}
	catch(e)
		{
		return manualConvertUTF8ToUnicode(u);
		} // fallback
	var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
	converter.charset = "UTF-8";
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return (fin.length > 0) ? s+fin : s;
}

function convertUnicodeToUTF8(s)
{
	if(saveUsingSafari)
		return s;
	else if(window.Components)
		return mozConvertUnicodeToUTF8(s);
	else
		return manualConvertUnicodeToUTF8(s);
}

function manualConvertUnicodeToUTF8(s)
{
	var re = /[^\u0000-\u007F]/g ;
	return s.replace(re, function($0) {return("&#" + $0.charCodeAt(0).toString() + ";");})
}

function mozConvertUnicodeToUTF8(s)
{
	netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
	var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
	converter.charset = "UTF-8";
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	if(fin.length > 0)
		return u + fin;
	else
		return u;
}

function saveFile(fileUrl, content)
{
	var r = null;
	if(saveUsingSafari)
		r = safariSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = mozillaSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = ieSaveFile(fileUrl, content);
	if((r == null) || (r == false))
		r = operaSaveFile(fileUrl, content);
	return(r);
}

function loadFile(fileUrl)
{
	var r = null;
	if(saveUsingSafari)
		r = safariLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = operaLoadFile(fileUrl);
	return(r);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath, content)
{
	try
		{
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		}
	catch(e)
		{
		//alert("Exception while attempting to save\n\n" + e.toString());
		return(null);
		}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return(true);
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try
		{
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
		}
	catch(e)
		{
		//alert("Exception while attempting to load\n\n" + e.toString());
		return(null);
		}
	return(content);
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath, content)
{
	if(window.Components)
		try
			{
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if (!file.exists())
				file.create(0, 0664);
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file, 0x20 | 0x02, 00004,null);
			out.write(content, content.length);
			out.flush();
			out.close();
			return(true);
			}
		catch(e)
			{
			//alert("Exception while attempting to save\n\n" + e);
			return(false);
			}
	return(null);
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components)
		try
			{
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if (!file.exists())
				return(null);
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file, 0x01, 00004, null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			return(sInputStream.read(sInputStream.available()));
			}
		catch(e)
			{
			//alert("Exception while attempting to load\n\n" + e);
			return(false);
			}
	return(null);
}

function operaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	if(i > 0)
		return url.substring(i-1);
	return url;
}

function operaSaveFile(filePath, content)
{
	try
		{
		var s = new java.io.PrintStream(new java.io.FileOutputStream(operaUrlToFilename(filePath)));
		s.print(content);
		s.close();
		}
	catch(e)
		{
		if(window.opera)
			opera.postError(e);
		return null;
		}
	return true;
}

function operaLoadFile(filePath)
{
	var content = [];
	try
		{
		var r = new java.io.BufferedReader(new java.io.FileReader(operaUrlToFilename(filePath)));
		var line;
		while ((line = r.readLine()) != null)
			content.push(new String(line));
		r.close();
		}
	catch(e)
		{
		if(window.opera)
			opera.postError(e);
		return null;
		}
	return content.join("\n");
}

function safariFilenameToUrl(filename) {
	return ("file://" + filename);
}

function safariLoadFile(url)
{
	url = safariFilenameToUrl(url);
	var plugin = document.embeds["tiddlyWikiSafariSaver"];
	return plugin.readURL(url);
}

function safariSaveFile(url,content)
{
	url = safariFilenameToUrl(url);
	var plugin = document.embeds["tiddlyWikiSafariSaver"];
	return plugin.writeStringToURL(content,url);
}

// Lifted from http://developer.apple.com/internet/webcontent/detectplugins.html
function detectPlugin()
{
	var daPlugins = detectPlugin.arguments;
	var pluginFound = false;
	if (navigator.plugins && navigator.plugins.length > 0)
		{
		var pluginsArrayLength = navigator.plugins.length;
		for (var pluginsArrayCounter=0; pluginsArrayCounter < pluginsArrayLength; pluginsArrayCounter++ )
			{
			var numFound = 0;
			for(var namesCounter=0; namesCounter < daPlugins.length; namesCounter++)
				{
				if( (navigator.plugins[pluginsArrayCounter].name.indexOf(daPlugins[namesCounter]) >= 0) || 
						(navigator.plugins[pluginsArrayCounter].description.indexOf(daPlugins[namesCounter]) >= 0) )
					numFound++;
				}
			if(numFound == daPlugins.length)
				{
				pluginFound = true;
				break;
				}
			}
	}
	return pluginFound;
}

// ---------------------------------------------------------------------------------
// TiddlyWiki-specific utility functions
// ---------------------------------------------------------------------------------

function createTiddlyButton(theParent,theText,theTooltip,theAction,theClass,theId,theAccessKey)
{
	var theButton = document.createElement("a");
	theButton.className = "button";
	if(theAction)
		{
		theButton.onclick = theAction;
		theButton.setAttribute("href","javascript:;");
		}
	theButton.setAttribute("title",theTooltip);
	if(theText)
		theButton.appendChild(document.createTextNode(theText));
	if(theClass)
		theButton.className = theClass;
	if(theId)
		theButton.id = theId;
	if(theParent)
		theParent.appendChild(theButton);
	if(theAccessKey)
		theButton.setAttribute("accessKey",theAccessKey);
	return(theButton);
}

function createTiddlyLink(place,title,includeText,theClass)
{
	var text = includeText ? title : null;
	var btn = createTiddlyButton(place,text,null,onClickTiddlerLink,theClass);
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	refreshTiddlyLink(btn,title);
	return(btn);
}

function refreshTiddlyLink(e,title)
{
	var subTitle, theClass = "tiddlyLink";
	var tiddler = store.fetchTiddler(title);
	if(tiddler)
		{
		subTitle = tiddler.getSubtitle();
		theClass += " tiddlyLinkExisting";
		}
	else
		{
		subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
		theClass += " tiddlyLinkNonExisting";
		if(store.isShadowTiddler(title))
			{
			subTitle = config.messages.shadowedTiddlerToolTip.format([title]);
			theClass += " shadow";
			}
		else
			subTitle = config.messages.undefinedTiddlerToolTip.format([title]);
		}
	e.className = theClass;
	e.title = subTitle;
}

function createExternalLink(place,url)
{
	var theLink = document.createElement("a");
	theLink.className = "externalLink";
	theLink.href = url;
	theLink.title = config.messages.externalLinkTooltip.format([url]);
	if(config.options.chkOpenInNewWindow)
		theLink.target = "_blank";
	place.appendChild(theLink);
	return(theLink);
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var theLink = theTarget;
	var title = null;
	do {
		title = theLink.getAttribute("tiddlyLink");
		theLink = theLink.parentNode;
	} while(title == null && theLink != null);
	if(title)
		{
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		var opening;
		if(toggling && document.getElementById("tiddler" + title))
			story.closeTiddler(title,true,e.shiftKey || e.altKey);
		else
			story.displayTiddler(theTarget,title,null,true,e.shiftKey || e.altKey);
		}
	clearMessage();
	return(false);
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler)
{
	var theTag = createTiddlyButton(place,tag,config.views.wikified.tag.tooltip.format([tag]),onClickTag);
	theTag.setAttribute("tag",tag);
	if(excludeTiddler)
		theTag.setAttribute("tiddler",excludeTiddler);
	return(theTag);
}

// Event handler for clicking on a tiddler tag
function onClickTag(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	var popup = Popup.create(this);
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag)
		{
		var tagged = store.getTaggedTiddlers(tag);
		var titles = [];
		var li,r;
		for(r=0;r<tagged.length;r++)
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		var lingo = config.views.wikified.tag;
		if(titles.length > 0)
			{
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			createTiddlyElement(createTiddlyElement(popup,"li"),"hr");
			for(r=0; r<titles.length; r++)
				{
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
				}
			}
		else
			createTiddlyText(createTiddlyElement(popup,"li",null,"disabled"),lingo.popupNone.format([tag]));
		createTiddlyElement(createTiddlyElement(popup,"li"),"hr");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
		}
	Popup.show(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return(false);
}

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(e)
{
	if (!e) var e = window.event;
	var tag = this.getAttribute("tag");
	var tagged = store.getTaggedTiddlers(tag);
	for(var t=tagged.length-1; t>=0; t--)
		story.displayTiddler(this,tagged[t].title,null,false,e.shiftKey || e.altKey);
	return(false);
}

function onClickError(e)
{
	if (!e) var e = window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	for(var t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show(popup,false);
	e.cancelBubble = true;
	if (e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if (text) btn.setAttribute("errorText",text);
}

// ---------------------------------------------------------------------------------
// Animation engine
// ---------------------------------------------------------------------------------

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() // Variable number of arguments
{
	for(var t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0)
		{
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},5);
		}
	this.running += arguments.length;
}

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length)
		{
		var animation = me.animations[a];
		if(animation.tick())
			a++;
		else
			{
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
			}
		}
}

// Map a 0..1 value to 0..1, but slow down at the start and end
Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
}

// ---------------------------------------------------------------------------------
// Cascade animation
// ---------------------------------------------------------------------------------

function Cascade(text,startElement,targetElement,slowly)
{
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	this.elements = [];
	this.startElement = startElement;
	this.startLeft = findPosX(this.startElement);
	this.startTop = findPosY(this.startElement);
	this.startWidth = Math.min(this.startElement.offsetWidth,winWidth);
	this.startHeight = Math.min(this.startElement.offsetHeight,winHeight);
	this.targetElement = targetElement;
	targetElement.style.position = "relative";
	targetElement.style.zIndex = 2;
	this.targetLeft = findPosX(this.targetElement);
	this.targetTop = findPosY(this.targetElement);
	this.targetWidth = Math.min(this.targetElement.offsetWidth,winWidth);
	this.targetHeight = Math.min(this.targetElement.offsetHeight,winHeight);
	this.progress = -1;
	this.steps = slowly ? config.cascadeSlow : config.cascadeFast;
	this.text = text;
	this.tick();
	return this;
}

Cascade.prototype.tick = function()
{
	this.progress++;
	if(this.progress >= this.steps)
		{
		while(this.elements.length > 0)
			this.removeTail();
		this.targetElement.style.position = "static";
		this.targetElement.style.zIndex = null;
		return false;
		}
	else
		{
		if(this.elements.length > 0 && this.progress > config.cascadeDepth)
			this.removeTail();
		if(this.progress < (this.steps - config.cascadeDepth))
			{
			var f = Animator.slowInSlowOut(this.progress/(this.steps - config.cascadeDepth - 1));
			var e = createTiddlyElement(document.body,"div",null,"cascade",this.text);
			e.style.zIndex = 1;
			e.style.left = this.startLeft + (this.targetLeft-this.startLeft) * f + "px";
			e.style.top = this.startTop + (this.targetTop-this.startTop) * f + "px";
			e.style.width = this.startWidth + (this.targetWidth-this.startWidth) * f + "px";
			e.style.height = this.startHeight + (this.targetHeight-this.startHeight) * f + "px";
			e.style.display = "block";
			this.elements.push(e);
			}
		return true;
		}
}

Cascade.prototype.removeTail = function()
{
	var e = this.elements[0];
	e.parentNode.removeChild(e);
	this.elements.shift();
}

// ---------------------------------------------------------------------------------
// Scroller animation
// ---------------------------------------------------------------------------------

function Scroller(targetElement,slowly)
{
	this.targetElement = targetElement;
	this.startScroll = findScrollY();
	this.targetScroll = ensureVisible(targetElement);
	this.progress = 0;
	this.step = slowly ? config.animSlow : config.animFast;
	return this;
}

Scroller.prototype.tick = function()
{
	this.progress += this.step;
	if(this.progress > 1)
		{
		window.scrollTo(0,this.targetScroll);
		return false;
		}
	else
		{
		var f = Animator.slowInSlowOut(this.progress);
		window.scrollTo(0,this.startScroll + (this.targetScroll-this.startScroll) * f);
		return true;
		}
}

// ---------------------------------------------------------------------------------
// Slider animation
// ---------------------------------------------------------------------------------

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,slowly,deleteMode)
{
	this.element = element;
	element.style.display = "block";
	this.deleteMode = deleteMode;
	this.element.style.height = "auto";
	this.realHeight = element.offsetHeight;
	this.opening = opening;
	this.step = slowly ? config.animSlow : config.animFast;
	if(opening)
		{
		this.progress = 0;
		element.style.height = "0px";
		element.style.display = "block";
		}
	else
		{
		this.progress = 1;
		this.step = -this.step;
		}
	element.style.overflow = "hidden";
	return this;
}

Slider.prototype.stop = function()
{
	if(this.opening)
		{
		this.element.style.height = "auto";
		this.element.style.opacity = 1;
		this.element.style.filter = "alpha(opacity:100)";
		}
	else
		{
		switch(this.deleteMode)
			{
			case "none":
				this.element.style.display = "none";
				break;
			case "all":
				this.element.parentNode.removeChild(this.element);
				break;
			case "children":
				removeChildren(this.element);
				break;
			}
		}
}

Slider.prototype.tick = function()
{
	this.progress += this.step;
	if(this.progress < 0 || this.progress > 1)
		{
		this.stop();
		return false;
		}
	else
		{
		var f = Animator.slowInSlowOut(this.progress);
		var h = this.realHeight * f;
		this.element.style.height = h + "px";
		this.element.style.opacity = f;
		this.element.style.filter = "alpha(opacity:" + f * 100 +")";
		return true;
		}
}

// ---------------------------------------------------------------------------------
// Popup menu
// ---------------------------------------------------------------------------------

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root)
{
	Popup.remove();
	var popup = createTiddlyElement(document.body,"ol","popup","popup",null);
	Popup.stack.push({root: root, popup: popup});
	return popup;
}

Popup.onDocumentClick = function(e)
{
	if (!e) var e = window.event;
	var target = resolveTarget(e);
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
}

Popup.show = function(unused,slowly)
{
	var curr = Popup.stack[Popup.stack.length-1];
	var rootLeft = findPosX(curr.root);
	var rootTop = findPosY(curr.root);
	var rootHeight = curr.root.offsetHeight;
	var popupLeft = rootLeft;
	var popupTop = rootTop + rootHeight;
	var popupWidth = curr.popup.offsetWidth;
	var winWidth = findWindowWidth();
	if(popupLeft + popupWidth > winWidth)
		popupLeft = winWidth - popupWidth;
	curr.popup.style.left = popupLeft + "px";
	curr.popup.style.top = popupTop + "px";
	curr.popup.style.display = "block";
	addClass(curr.root,"highlight");
	if(config.options.chkAnimate)
		anim.startAnimating(new Scroller(curr.popup,slowly));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
}

Popup.remove = function()
{
	if(Popup.stack.length > 0)
		{
		Popup.removeFrom(0);
		}
}

Popup.removeFrom = function(from)
{
	for(var t=Popup.stack.length-1; t>=from; t--)
		{
		var p = Popup.stack[t];
		removeClass(p.root,"highlight");
		p.popup.parentNode.removeChild(p.popup);
		}
	Popup.stack = Popup.stack.slice(0,from);
}

// Backwards compatibility
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// ---------------------------------------------------------------------------------
// Augmented methods for the JavaScript Number(), Array() and String() objects
// ---------------------------------------------------------------------------------

// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return c;
}

// Find an entry in an array. Returns the array index or null
Array.prototype.find = function(item)
{
	for(var t=0; t<this.length; t++)
		if(this[t] == item)
			return t;
	return null;
}

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
    return this.find(item) != null;
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
    for(var i=0; i<items.length; i++)
        if (this.contains(items[i]))
            return true;
    return false;
};

// Return wheter all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
    for (var i = 0; i<items.length; i++)
        if (!this.contains(items[i]))
            return false;
    return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique != undefined && unique == false)
		this.push(item);
	else
		{
		if(this.find(item) == null)
			this.push(item);
		}
}

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	if(n < this.length)
		return this.slice(this.length-n);
	else
		return this;
}

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
}

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var s = this.split("-");
	if(s.length > 1)
		for(var t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	return s.join("");
}

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(substrings)
{
	var subRegExp = new RegExp("(?:%(\\d+))","mg");
	var currPos = 0;
	var r = [];
	do {
		var match = subRegExp.exec(this);
		if(match && match[1])
			{
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1])]);
			currPos = subRegExp.lastIndex;
			}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
}

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var c = this;
	for(var t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
}

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	var regexpAmp = new RegExp("&","mg");
	var regexpLessThan = new RegExp("<","mg");
	var regexpGreaterThan = new RegExp(">","mg");
	var regexpQuote = new RegExp("\"","mg");
	return(this.replace(regexpAmp,"&amp;").replace(regexpLessThan,"&lt;").replace(regexpGreaterThan,"&gt;").replace(regexpQuote,"&quot;"));
}

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	var regexpAmp = new RegExp("&amp;","mg");
	var regexpLessThan = new RegExp("&lt;","mg");
	var regexpGreaterThan = new RegExp("&gt;","mg");
	var regexpQuote = new RegExp("&quot;","mg");
	return(this.replace(regexpLessThan,"<").replace(regexpGreaterThan,">").replace(regexpQuote,"\"").replace(regexpAmp,"&"));
}

// Parse a space-separated string of name:value parameters where:
//   - the name or the value can be optional (and a separate default is used instead)
//     - in case of ambiguity, a lone word is taken to be a value
//   - if both the name and value are present they must be separated by a colon
//   - the name and the value may both be quoted with single- or double-quotes, double-square brackets
//   - names or values quoted with {{double-curly braces}} are evaluated as a JavaScript expression
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames)
{
	var parseToken = function(match,p)
		{
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try
				{
				n = match[p+3];
				if(allowEval)
					n = window.eval(n);
				}
			catch(ex)
				{
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + ex.toString();
				}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		return n;
		};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])*)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])*)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + ")";
	var re = noNames
		? new RegExp(token,"mg")
		: new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + "){0,1}","mg");
	var params = [];
	do {
		var match = re.exec(this);
		if(match)
			{
			var n = parseToken(match,1);
			if(noNames)
				r.push({name: "", value: n});
			else
				{
				var v = parseToken(match,7);
				if(v == null && defaultName)
					{
					v = n;
					n = defaultName;
					}
				else if(v == null && defaultValue)
					v = defaultValue;
				r.push({name: n, value: v});
				}
			}
	} while(match);
	// Summarise parameters into first element
	for(var t=1; t<r.length; t++)
		{
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
		}
	return r;
}

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function()
{
	var p = this.parseParams("list",null,true,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
}

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var n = [];
	for(var t=1; t<p.length; t++)
		n.pushUnique(p[t].value,unique);
	return n;
}

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var s = this.indexOf(start);
	if(s != -1)
		{
		var e = this.indexOf(end,s + start.length);
		if(e != -1)
			return this.substring(0,s + start.length) + sub + this.substring(e);
		}
	return this;
}

// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	if(title.indexOf(" ") == -1)
		return(title);
	else
		return("[[" + title + "]]");
}

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return(s);
}

// ---------------------------------------------------------------------------------
// RGB colour object
// ---------------------------------------------------------------------------------

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string")
		{
		if(r.substr(0,1) == "#")
			{
			if(r.length == 7)
				{
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
				}
			else
				{
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
				}
			}
		else
			{
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/ ;
			var c = r.match(rgbPattern);
			if (c)
				{
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
				}
			}
		}
	else
		{
		this.r = r;
		this.g = g;
		this.b = b;
		}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
}

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	var r = this.r.clamp(0,1);
	var g = this.g.clamp(0,1);
	var b = this.b.clamp(0,1);
	return("#" + ("0" + Math.floor(r * 255).toString(16)).right(2) +
				 ("0" + Math.floor(g * 255).toString(16)).right(2) +
				 ("0" + Math.floor(b * 255).toString(16)).right(2));
}

// ---------------------------------------------------------------------------------
// Augmented methods for the JavaScript Date() object
// ---------------------------------------------------------------------------------

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	template = template.replace(/YYYY/g,this.getFullYear());
	template = template.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	template = template.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	template = template.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	template = template.replace(/MM/g,this.getMonth()+1);
	template = template.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	template = template.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	template = template.replace(/DDth/g,this.getDate()+this.daySuffix());
	template = template.replace(/DD/g,this.getDate());
	template = template.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	template = template.replace(/hh/g,this.getHours());
	template = template.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	template = template.replace(/mm/g,this.getMinutes());
	template = template.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	template = template.replace(/ss/g,this.getSeconds());
	return template;
}

Date.prototype.daySuffix = function()
{
	var num = this.getDate();
	if (num >= 11 && num <= 13) return "th";
	else if (num.toString().substr(-1)=="1") return "st";
	else if (num.toString().substr(-1)=="2") return "nd";
	else if (num.toString().substr(-1)=="3") return "rd";
	return "th";
}

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return(String.zeroPad(this.getFullYear(),4) + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2));
}

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return(String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2));
}

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return(String.zeroPad(this.getUTCFullYear(),4) + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),4));
}

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	var theDate = new Date(Date.UTC(parseInt(d.substr(0,4),10),
							parseInt(d.substr(4,2),10)-1,
							parseInt(d.substr(6,2),10),
							parseInt(d.substr(8,2),10),
							parseInt(d.substr(10,2),10),0,0));
	return(theDate);
}

// ---------------------------------------------------------------------------------
// DOM utilities - many derived from www.quirksmode.org 
// ---------------------------------------------------------------------------------

function drawGradient(place,horiz,colours)
{
	for(var t=0; t<= 100; t+=2)
		{
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var f = t/100;
		var p = f*(colours.length-1);
		bar.style.backgroundColor = colours[Math.floor(p)].mix(colours[Math.ceil(p)],p-Math.floor(p)).toString();
		}
}

function createTiddlyText(theParent,theText)
{
	return theParent.appendChild(document.createTextNode(theText));
}

function createTiddlyElement(theParent,theElement,theID,theClass,theText)
{
	var e = document.createElement(theElement);
	if(theClass != null)
		e.className = theClass;
	if(theID != null)
		e.setAttribute("id",theID);
	if(theText != null)
		e.appendChild(document.createTextNode(theText));
	if(theParent != null)
		theParent.appendChild(e);
	return(e);
}

// Add an event handler
// Thanks to John Resig, via QuirksMode
function addEvent(obj,type,fn)
{
	if(obj.attachEvent)
		{
		obj['e'+type+fn] = fn;
		obj[type+fn] = function(){obj['e'+type+fn](window.event);}
		obj.attachEvent('on'+type,obj[type+fn]);
		}
	else
		obj.addEventListener(type,fn,false);
}

// Remove  an event handler
// Thanks to John Resig, via QuirksMode
function removeEvent(obj,type,fn)
{
	if(obj.detachEvent)
		{
		obj.detachEvent('on'+type,obj[type+fn]);
		obj[type+fn] = null;
		}
	else
		obj.removeEventListener(type,fn,false);
}

function addClass(e,theClass)
{
	removeClass(e,theClass);
	e.className += " " + theClass;
}

function removeClass(e,theClass)
{
	var newClass = [];
	var currClass = e.className.split(" ");
	for(var t=0; t<currClass.length; t++)
		if(currClass[t] != theClass)
			newClass.push(currClass[t]);
	e.className = newClass.join(" ");
}

function hasClass(e,theClass)
{
	var c = e.className;
	if(c)
		{
		c = c.split(" ");
		for(var t=0; t<c.length; t++)
			if(c[t] == theClass)
				return true;
		}
	return false;
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if (e.target)
		obj = e.target;
	else if (e.srcElement)
		obj = e.srcElement;
	if (obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return(obj);
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	var text = "";
	if(e.innerText)
		text = e.innerText;
	else if(e.textContent)
		text = e.textContent;
	return text;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop)
		return(posTop);
	else if(posBot > winBot)
		{
		if(e.offsetHeight < winHeight)
			return(posTop - (winHeight - e.offsetHeight));
		else
			return(posTop);
		}
	else
		return(winTop);
}

// Get the current width of the display window
function findWindowWidth()
{
	return(window.innerWidth ? window.innerWidth : document.documentElement.clientWidth);
}

// Get the current height of the display window
function findWindowHeight()
{
	return(window.innerHeight ? window.innerHeight : document.documentElement.clientHeight);
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return(window.scrollX ? window.scrollX : document.documentElement.scrollLeft);
}

// Get the current vertical page scroll position
function findScrollY()
{
	return(window.scrollY ? window.scrollY : document.documentElement.scrollTop);
}

function findPosX(obj)
{
	var curleft = 0;
	while (obj.offsetParent)
		{
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
		}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while (obj.offsetParent)
		{
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
		}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e != null && e.focus && e.blur)
		{
		e.focus();
		e.blur();
		}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Remove all children of a node
function removeChildren(e)
{
	while(e.hasChildNodes())
		e.removeChild(e.firstChild);
}

// Add a stylesheet, replacing any previous custom stylesheet
function setStylesheet(s,id)
{
	if(!id)
		id = "customStyleSheet";
	var n = document.getElementById(id);
	if(document.createStyleSheet) // Test for IE's non-standard createStyleSheet method
		{
		if(n)
			n.parentNode.removeChild(n);
		// This failed without the &nbsp;
		document.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd","&nbsp;<style id='" + id + "'>" + s + "</style>");
		}
	else
		{
		if(n)
			n.replaceChild(document.createTextNode(s),n.firstChild);
		else
			{
			var n = document.createElement("style");
			n.type = "text/css";
			n.id = id;
			n.appendChild(document.createTextNode(s));
			document.getElementsByTagName("head")[0].appendChild(n);
			}
		}
}

// ---------------------------------------------------------------------------------
// End of scripts
// ---------------------------------------------------------------------------------

</script>
<style type="text/css">

#saveTest {
	display: none;
}

.zoomer {
	display: none;
}

#messageArea {
	display: none;
}

#storeArea, #copyright {
	display: none;
}

.popup {
	position: absolute;
}

</style>
<noscript>
<style type="text/css">

#storeArea {
	display: block;
	margin: 4em 10em 3em;
}

#storeArea div {
 padding: 0.5em;
 margin: 1em 0em 0em 0em;
 border-color: #f0f0f0 #606060 #404040 #d0d0d0; 
 border-style: solid; 
 border-width: 2px;
 overflow: auto;
}

#javascriptWarning {
	width: 100%;
	text-align: center;
	font-weight: bold;
	background-color: #dd1100;
	color: #fff;
	padding:1em 0em; 
}

</style>
</noscript>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.checkUnsavedChanges) checkUnsavedChanges();" onbeforeunload="if(window.confirmExit) return confirmExit();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
	<script>
	if (detectPlugin("TiddlyWiki Saver"))
		{
		document.write('<embed style="display: none" name="tiddlyWikiSafariSaver" width="0" height="0" type="application/x-webkit-tiddlywiki-saver"></embed>'); 
		saveUsingSafari = true;
		}
	</script>
	<div id="copyright">
	Welcome to TiddlyWiki by Jeremy Ruston, Copyright &copy; 2005 Osmosoft Limited
	</div>
	<noscript>
		<div id="javascriptWarning">This page requires JavaScript to function properly</div>
	</noscript>
	<div id="saveTest"></div>
	<div id="contentWrapper"></div>
	<div id="contentStash"></div>
	<div id="storeArea"><div tiddler="BlooBot" modifier="Brad" modified="200605101618" created="200605101618" tags="">[[about Bloobot]]</div>
<div tiddler="Bloobot closed" modifier="YourName" modified="200605152253" created="200605152241" tags="">Here's what it looks like in the upper left of those merchants it knows about (in this case Amazon). Clicking on it will [[open it up|Bloobot open]] and let you change your beneficiary, etc.\n\n [img[http://www.mediaventure.org/bloobot/images/bb-amazon-min.gif]]  \n\n</div>
<div tiddler="Bloobot open" modifier="YourName" modified="200605161433" created="200605152241" tags="">Here's what it looks like when you open it up (in its current early beta form) by clicking on the [[mini Bloobot logo|Bloobot closed]]. You rarely need to do it, but it allows you to change your beneficiary and get added information about the merchant and product.\n\n[img[http://www.mediaventure.org/bloobot/images/bb-amazon-max2.gif]] </div>
<div tiddler="DefaultTiddlers" modifier="Brad" modified="200605101649" created="200604071638" tags="">[[about Bloobot]]</div>
<div tiddler="ExportTiddlersPanel" modifier="ELSDesignStudios" modified="200601180855" created="200511111142" tags="importexport">&lt;&lt;exportTiddlers inline&gt;&gt;</div>
<div tiddler="ExportTiddlersPlugin" modifier="ELSDesignStudios" modified="200603291525" created="200512240702" tags="systemConfig plugin2.0 importexport">/***\n''Export Tiddlers Plugin for TiddlyWiki version 2.0''\n^^author: Eric Shulman - ELS Design Studios\nsource: http://www.TiddlyTools.com/#ExportTiddlersPlugin\nlicense: [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]^^\n\nWhen many people edit copies of the same TiddlyWiki document, the ability to easily copy and share these changes so they can then be redistributed to the entire group is very important.  This ability is also very useful when moving your own tiddlers from document to document (e.g., when upgrading to the latest version of TiddlyWiki, or 'pre-loading' your favorite stylesheets into a new 'empty' TiddlyWiki document.)\n\nExportTiddlersPlugin let you ''select and extract tiddlers from your ~TiddlyWiki documents and save them to a local file'' or a remote server (requires installation of compatible server-side scripting, still under development...).  An interactive control panel lets you specify a destination, and then select which tiddlers to export.  A convenient 'selection filter' helps you pick desired tiddlers by specifying a combination of modification dates, tags, or tiddler text to be matched or excluded.  ''Tiddler data can be output as ~TiddlyWiki &quot;storeArea ~DIVs&quot; that can be imported into another ~TiddlyWiki or as ~RSS-compatible XML that can be published for RSS syndication.''\n\n!!!!!Inline interface (live)\n&lt;&lt;&lt;\n&lt;&lt;exportTiddlers inline&gt;&gt;\n&lt;&lt;&lt;\n!!!!!Usage\n&lt;&lt;&lt;\nOptional &quot;special tiddlers&quot; used by this plugin:\n* SiteUrl^^\nURL for official server-published version of document being viewed\ndefault: //none//^^\n* SiteHost^^\nhost name/address for remote server (e.g., &quot;www.server.com&quot; or &quot;192.168.1.27&quot;)\ndefault: //none//^^\n* SitePost^^\nremote path/filename for submitting changes (e.g., &quot;/cgi-bin/submit.cgi&quot;)\ndefault: //none//^^\n* SiteParams^^\narguments (if any) for server-side receiving script\ndefault: //none//^^\n* SiteID^^\nusername or other authorization identifier for login-controlled access to remote server\ndefault: current TiddlyWiki username (e.g., &quot;YourName&quot;)^^\n* SiteDate^^\nstored date/time stamp for most recent published version of document\ndefault: current document.modified value (i.e., the 'file date')^^\n&lt;&lt;&lt;\n!!!!!Example\n&lt;&lt;&lt;\n&lt;&lt;exportTiddlers&gt;&gt;\n&lt;&lt;&lt;\n!!!!!Installation\n&lt;&lt;&lt;\nImport (or copy/paste) the following tiddlers into your document:\n''ExportTiddlersPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)\n\ncreate/edit ''SideBarOptions'': (sidebar menu items) \n^^Add &quot;&lt; &lt; exportTiddlers &gt; &gt;&quot; macro^^\n&lt;&lt;&lt;\n!!!!!Revision History\n&lt;&lt;&lt;\n''2006.03.29 [2.1.3]''^^\nadded calls to convertUnicodeToUTF8() for generated output, so it better handles international characters.\n''2006.02.12 [2.1.2]''^^\nadded var to unintended global 'tags' in matchTags(). Avoids FF1501 bug when filtering by tags.  (based on report by TedPavlic)\n''2006.02.04 [2.1.1]''^^\nadded var to variables that were unintentionally global.  Avoids FireFox 1.5.0.1 crash bug when referencing global variables\n''2006.02.02 [2.1.0]''^^\nAdded support for output of complete TiddlyWiki documents.  Let's you use ExportTiddlers to generate 'starter' documents from selected tiddlers.^^\n''2006.01.21 [2.0.1]''^^\nDefer initial panel creation and only register a notification function when panel first is created\nin saveChanges 'hijack', create panel as needed.  Note: if window.event is not available to identify the click location, the export panel is positioned relative to the 'tiddlerDisplay' element of the TW document.\n^^\n''2005.12.27 [2.0.0]''^^\nUpdate for TW2.0\nDefer initial panel creation and only register a notification function when panel first is created\n^^\n''2005.12.24 [0.9.5]''^^\nMinor adjustments to CSS to force correct link colors regardless of TW stylesheet selection\n^^\n''2005.12.16 [0.9.4]''^^\nDynamically create/remove exportPanel as needed to ensure only one instance of interface elements exists, even if there are multiple instances of macro embedding.\n^^\n''2005.11.15 [0.9.2]''^^\nadded non-Ajax post function to bypass javascript security restrictions on cross-domain I/O.  Moved AJAX functions to separate tiddler (no longer needed here).  Generalized HTTP server to support UnaWiki servers\n^^\n+++[previous releases...]\n''2005.11.08 [0.9.1]''^^\nmoved HTML, CSS and control initialization into exportInit() function and call from macro handler instead of at load time.  This allows exportPanel to be placed within the same containing element as the &quot;export tiddlers&quot; button, so that relative positioning can be achieved.\n^^\n''2005.10.28 [0.9.0]''^^\nadded 'select opened tiddlers' feature\nBased on a suggestion by Geoff Slocock\n^^\n''2005.10.24 [0.8.3]''^^\nCorrected hijack of 'save changes' when using http:\n^^\n''2005.10.18 [0.8.2]''^^\nadded AJAX functions\n^^\n''2005.10.18 [0.8.1]''^^\nCorrected timezone handling when filtering for date ranges.\nImproved error checking/reporting for invalid filter values and filters that don't match any tiddlers.\nExporting localfile-to-localfile is working for IE and FF\nExporting server-to-localfile works in IE (after ActiveX warnings), but has security issues in FF\nCross-domain exporting (localfile/server-to-server) is under development\nCookies to remember filter settings - coming soon\nMore style tweaks, minor text changes and some assorted layout cleanup.\n^^\n''2005.10.17 [0.8.0]''^^\nFirst pre-release.\n^^\n''2005.10.16 [0.7.0]''^^\nfilter by tags\n^^\n''2005.10.15 [0.6.0]''^^\nfilter by title/text\n^^\n''2005.10.14 [0.5.0]''^^\nexport to local file (DIV or XML)\n^^\n''2005.10.14 [0.4.0]''^^\nfilter by start/end date\n^^\n''2005.10.13 [0.3.0]''^^\npanel interaction\n^^\n''2005.10.11 [0.2.0]''^^\npanel layout\n^^\n''2005.10.10 [0.1.0]''^^\ncode framework\n^^\n''2005.10.09 [0.0.0]''^^\ndevelopment started\n^^\n===\n&lt;&lt;&lt;\n!!!!!Credits\n&lt;&lt;&lt;\nThis feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]]\n&lt;&lt;&lt;\n!!!!!Code\n***/\n// // +++[version]\n//{{{\nversion.extensions.exportTiddlers = {major: 2, minor: 1, revision: 3, date: new Date(2006,3,29)};\n//}}}\n// //===\n\n// // +++[macro handler]\n//{{{\nconfig.macros.exportTiddlers = {\n	label: &quot;export tiddlers&quot;,\n	prompt: &quot;Copy selected tiddlers to an export document&quot;,\n	datetimefmt: &quot;0MM/0DD/YYYY 0hh:0mm:0ss&quot; // for &quot;filter date/time&quot; edit fields\n};\n\nconfig.macros.exportTiddlers.handler = function(place,macroName,params) {\n	if (params[0]!=&quot;inline&quot;)\n		{ createTiddlyButton(place,this.label,this.prompt,onClickExportMenu); return; }\n	var panel=createExportPanel(place);\n	panel.style.position=&quot;static&quot;;\n	panel.style.display=&quot;block&quot;;\n}\n\nfunction createExportPanel(place) {\n	var panel=document.getElementById(&quot;exportPanel&quot;);\n	if (panel) { panel.parentNode.removeChild(panel); }\n	setStylesheet(config.macros.exportTiddlers.css,&quot;exportTiddlers&quot;);\n	panel=createTiddlyElement(place,&quot;span&quot;,&quot;exportPanel&quot;,null,null)\n	panel.innerHTML=config.macros.exportTiddlers.html;\n	exportShowPanel(document.location.protocol);\n	exportInitFilter();\n	refreshExportList(0);\n	store.addNotification(null,refreshExportList); // refresh listbox after every tiddler change\n	return panel;\n}\n\nfunction onClickExportMenu(e)\n{\n	if (!e) var e = window.event;\n	var parent=resolveTarget(e).parentNode;\n	var panel = document.getElementById(&quot;exportPanel&quot;);\n	if (panel==undefined || panel.parentNode!=parent)\n		panel=createExportPanel(parent);\n	var isOpen = panel.style.display==&quot;block&quot;;\n	if(config.options.chkAnimate)\n		anim.startAnimating(new Slider(panel,!isOpen,e.shiftKey || e.altKey,&quot;none&quot;));\n	else\n		panel.style.display = isOpen ? &quot;none&quot; : &quot;block&quot; ;\n	e.cancelBubble = true;\n	if (e.stopPropagation) e.stopPropagation();\n	return(false);\n}\n//}}}\n// //===\n\n// // +++[Hijack saveChanges] diverts 'notFileUrlError' to display export control panel instead\n//{{{\nwindow.coreSaveChanges=window.saveChanges;\nwindow.saveChanges = function()\n{\n	if (document.location.protocol==&quot;file:&quot;) { coreSaveChanges(); return; }\n	var e = window.event;\n	var parent=e?resolveTarget(e).parentNode:document.body;\n	var panel = document.getElementById(&quot;exportPanel&quot;);\n	if (panel==undefined || panel.parentNode!=parent) panel=createExportPanel(parent);\n	exportShowPanel(document.location.protocol);\n	if (parent==document.body) { panel.style.left=&quot;30%&quot;; panel.style.top=&quot;30%&quot;; }\n	panel.style.display = &quot;block&quot; ;\n}\n//}}}\n// //===\n\n// // +++[IE needs explicit scoping] for functions called by browser events\n//{{{\nwindow.onClickExportMenu=onClickExportMenu;\nwindow.onClickExportButton=onClickExportButton;\nwindow.exportShowPanel=exportShowPanel;\nwindow.exportShowFilterFields=exportShowFilterFields;\nwindow.refreshExportList=refreshExportList;\n//}}}\n// //===\n\n// // +++[CSS] for floating export control panel\n//{{{\nconfig.macros.exportTiddlers.css = '\s\n#exportPanel {\s\n	display: none; position:absolute; z-index:12; width:35em; right:105%; top:6em;\s\n	background-color: #eee; color:#000; font-size: 8pt; line-height:110%;\s\n	border:1px solid black; border-bottom-width: 3px; border-right-width: 3px;\s\n	padding: 0.5em; margin:0em; -moz-border-radius:1em;\s\n}\s\n#exportPanel a, #exportPanel td a { color:#009; display:inline; margin:0px; padding:1px; }\s\n#exportPanel table { width:100%; border:0px; padding:0px; margin:0px; font-size:8pt; line-height:110%; background:transparent; }\s\n#exportPanel tr { border:0px;padding:0px;margin:0px; background:transparent; }\s\n#exportPanel td { color:#000; border:0px;padding:0px;margin:0px; background:transparent; }\s\n#exportPanel select { width:98%;margin:0px;font-size:8pt;line-height:110%;}\s\n#exportPanel input  { width:98%;padding:0px;margin:0px;font-size:8pt;line-height:110%}\s\n#exportPanel .box { border:1px solid black; padding:3px; margin-bottom:5px; background:#f8f8f8; -moz-border-radius:5px;}\s\n#exportPanel .topline { border-top:2px solid black; padding-top:3px; margin-bottom:5px; }\s\n#exportPanel .rad { width:auto; }\s\n#exportPanel .chk { width:auto; }\s\n#exportPanel .btn { width:auto; }\s\n#exportPanel .btn1 { width:98%; }\s\n#exportPanel .btn2 { width:48%; }\s\n#exportPanel .btn3 { width:32%; }\s\n#exportPanel .btn4 { width:24%; }\s\n#exportPanel .btn5 { width:19%; }\s\n';\n//}}}\n// //===\n\n// // +++[HTML] for export control panel interface\n//{{{\nconfig.macros.exportTiddlers.html = '\s\n&lt;!-- output target and format --&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr&gt;&lt;td width=50%&gt;\s\n	export to\s\n	&lt;select size=1 id=&quot;exportTo&quot; onchange=&quot;exportShowPanel(this.value);&quot;&gt;\s\n	&lt;option value=&quot;file:&quot; SELECTED&gt;this computer&lt;/option&gt;\s\n	&lt;option value=&quot;http:&quot;&gt;web server (http)&lt;/option&gt;\s\n	&lt;option value=&quot;https:&quot;&gt;secure web server (https)&lt;/option&gt;\s\n	&lt;option value=&quot;ftp:&quot;&gt;file server (ftp)&lt;/option&gt;\s\n	&lt;/select&gt;\s\n&lt;/td&gt;&lt;td width=50%&gt;\s\n	output format\s\n	&lt;select id=&quot;exportFormat&quot; size=1&gt;\s\n	&lt;option value=&quot;DIV&quot;&gt;TiddlyWiki export file&lt;/option&gt;\s\n	&lt;option value=&quot;TW&quot;&gt;TiddlyWiki document&lt;/option&gt;\s\n	&lt;option value=&quot;XML&quot;&gt;RSS feed (XML)&lt;/option&gt;\s\n	&lt;/select&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n\s\n&lt;!-- export to local file  --&gt;\s\n&lt;div id=&quot;exportLocalPanel&quot; style=&quot;margin-bottom:5px;margin-top:5px;&quot;&gt;\s\nlocal path/filename&lt;br&gt;\s\n&lt;input type=&quot;file&quot; id=&quot;exportFilename&quot; size=56 style=&quot;width:100%&quot;&gt;&lt;br&gt;\s\n&lt;/div&gt;&lt;!--panel--&gt;\s\n\s\n&lt;!-- export to http server --&gt;\s\n&lt;div id=&quot;exportHTTPPanel&quot; style=&quot;display:none;margin-bottom:5px;margin-top:5px;&quot;&gt;\s\ndocument URL&lt;br&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;exportHTTPSiteURL&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\nserver script / parameters&lt;br&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;exportHTTPServerURL&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/div&gt;&lt;!--panel--&gt;\s\n\s\n&lt;!-- export to ftp server --&gt;\s\n&lt;div id=&quot;exportFTPPanel&quot; style=&quot;display:none;margin-bottom:5px;margin-top:5px;&quot;&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; width=&quot;33%&quot;&gt;&lt;tr valign=&quot;top&quot;&gt;&lt;td&gt;\s\n	host server&lt;br&gt;\s\n	&lt;input type=&quot;text&quot; id=&quot;exportFTPHost&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/td&gt;&lt;td width=&quot;33%&quot;&gt;\s\n	username&lt;br&gt;\s\n	&lt;input type=&quot;text&quot; id=&quot;exportFTPID&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/td&gt;&lt;td width=&quot;33%&quot;&gt;\s\n	password&lt;br&gt;\s\n	&lt;input type=&quot;password&quot; id=&quot;exportFTPPW&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\nFTP path/filename&lt;br&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;exportFTPFilename&quot; onfocus=&quot;this.select()&quot;&gt;&lt;br&gt;\s\n&lt;/div&gt;&lt;!--panel--&gt;\s\n\s\n&lt;!-- list of tiddlers --&gt;\s\n&lt;table&gt;&lt;tr align=&quot;left&quot;&gt;&lt;td&gt;\s\n	select:\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;exportSelectAll&quot;\s\n		onclick=&quot;onClickExportButton(this)&quot; title=&quot;select all tiddlers&quot;&gt;\s\n		&amp;nbsp;all&amp;nbsp;&lt;/a&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;exportSelectChanges&quot;\s\n		onclick=&quot;onClickExportButton(this)&quot; title=&quot;select tiddlers changed since last save&quot;&gt;\s\n		&amp;nbsp;changes&amp;nbsp;&lt;/a&gt; \s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;exportSelectOpened&quot;\s\n		onclick=&quot;onClickExportButton(this)&quot; title=&quot;select tiddlers currently being displayed&quot;&gt;\s\n		&amp;nbsp;opened&amp;nbsp;&lt;/a&gt; \s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;exportToggleFilter&quot;\s\n		onclick=&quot;onClickExportButton(this)&quot; title=&quot;show/hide selection filter&quot;&gt;\s\n		&amp;nbsp;filter&amp;nbsp;&lt;/a&gt;  \s\n&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;exportListSmaller&quot;\s\n		onclick=&quot;onClickExportButton(this)&quot; title=&quot;reduce list size&quot;&gt;\s\n		&amp;nbsp;&amp;#150;&amp;nbsp;&lt;/a&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;exportListLarger&quot;\s\n		onclick=&quot;onClickExportButton(this)&quot; title=&quot;increase list size&quot;&gt;\s\n		&amp;nbsp;+&amp;nbsp;&lt;/a&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;select id=&quot;exportList&quot; multiple size=&quot;10&quot; style=&quot;margin-bottom:5px;&quot;\s\n	onchange=&quot;refreshExportList(this.selectedIndex)&quot;&gt;\s\n&lt;/select&gt;&lt;br&gt;\s\n\s\n&lt;!-- selection filter --&gt;\s\n&lt;div id=&quot;exportFilterPanel&quot; style=&quot;display:none&quot;&gt;\s\n&lt;table&gt;&lt;tr align=&quot;left&quot;&gt;&lt;td&gt;\s\n	selection filter\s\n&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;exportHideFilter&quot;\s\n		onclick=&quot;onClickExportButton(this)&quot; title=&quot;hide selection filter&quot;&gt;hide&lt;/a&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;div class=&quot;box&quot;&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;exportFilterStart&quot; value=&quot;1&quot;\s\n	onclick=&quot;exportShowFilterFields(this)&quot;&gt; starting date/time&lt;br&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr valign=&quot;center&quot;&gt;&lt;td width=&quot;50%&quot;&gt;\s\n	&lt;select size=1 id=&quot;exportFilterStartBy&quot; onchange=&quot;exportShowFilterFields(this);&quot;&gt;\s\n		&lt;option value=&quot;0&quot;&gt;today&lt;/option&gt;\s\n		&lt;option value=&quot;1&quot;&gt;yesterday&lt;/option&gt;\s\n		&lt;option value=&quot;7&quot;&gt;a week ago&lt;/option&gt;\s\n		&lt;option value=&quot;30&quot;&gt;a month ago&lt;/option&gt;\s\n		&lt;option value=&quot;site&quot;&gt;SiteDate&lt;/option&gt;\s\n		&lt;option value=&quot;file&quot;&gt;file date&lt;/option&gt;\s\n		&lt;option value=&quot;other&quot;&gt;other (mm/dd/yyyy hh:mm)&lt;/option&gt;\s\n	&lt;/select&gt;\s\n&lt;/td&gt;&lt;td width=&quot;50%&quot;&gt;\s\n	&lt;input type=&quot;text&quot; id=&quot;exportStartDate&quot; onfocus=&quot;this.select()&quot;\s\n		onchange=&quot;document.getElementById(\s'exportFilterStartBy\s').value=\s'other\s';&quot;&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;exportFilterEnd&quot; value=&quot;1&quot;\s\n	onclick=&quot;exportShowFilterFields(this)&quot;&gt; ending date/time&lt;br&gt;\s\n&lt;table cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&lt;tr valign=&quot;center&quot;&gt;&lt;td width=&quot;50%&quot;&gt;\s\n	&lt;select size=1 id=&quot;exportFilterEndBy&quot; onchange=&quot;exportShowFilterFields(this);&quot;&gt;\s\n		&lt;option value=&quot;0&quot;&gt;today&lt;/option&gt;\s\n		&lt;option value=&quot;1&quot;&gt;yesterday&lt;/option&gt;\s\n		&lt;option value=&quot;7&quot;&gt;a week ago&lt;/option&gt;\s\n		&lt;option value=&quot;30&quot;&gt;a month ago&lt;/option&gt;\s\n		&lt;option value=&quot;site&quot;&gt;SiteDate&lt;/option&gt;\s\n		&lt;option value=&quot;file&quot;&gt;file date&lt;/option&gt;\s\n		&lt;option value=&quot;other&quot;&gt;other (mm/dd/yyyy hh:mm)&lt;/option&gt;\s\n	&lt;/select&gt;\s\n&lt;/td&gt;&lt;td width=&quot;50%&quot;&gt;\s\n	&lt;input type=&quot;text&quot; id=&quot;exportEndDate&quot; onfocus=&quot;this.select()&quot;\s\n		onchange=&quot;document.getElementById(\s'exportFilterEndBy\s').value=\s'other\s';&quot;&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=exportFilterTags value=&quot;1&quot;\s\n	onclick=&quot;exportShowFilterFields(this)&quot;&gt; match tags&lt;br&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;exportTags&quot; onfocus=&quot;this.select()&quot;&gt;\s\n&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=exportFilterText value=&quot;1&quot;\s\n	onclick=&quot;exportShowFilterFields(this)&quot;&gt; match titles/tiddler text&lt;br&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;exportText&quot; onfocus=&quot;this.select()&quot;&gt;\s\n&lt;/div&gt; &lt;!--box--&gt;\s\n&lt;/div&gt; &lt;!--panel--&gt;\s\n\s\n&lt;!-- action buttons --&gt;\s\n&lt;div style=&quot;text-align:center&quot;&gt;\s\n&lt;input type=button class=&quot;btn3&quot; onclick=&quot;onClickExportButton(this)&quot;\s\n	id=&quot;exportFilter&quot; value=&quot;apply filter&quot;&gt;\s\n&lt;input type=button class=&quot;btn3&quot; onclick=&quot;onClickExportButton(this)&quot;\s\n	id=&quot;exportStart&quot; value=&quot;export tiddlers&quot;&gt;\s\n&lt;input type=button class=&quot;btn3&quot; onclick=&quot;onClickExportButton(this)&quot;\s\n	id=&quot;exportClose&quot; value=&quot;close&quot;&gt;\s\n&lt;/div&gt;&lt;!--center--&gt;\s\n';\n//}}}\n// //===\n\n// // +++[initialize interface]&gt;\n// // +++[exportShowPanel(which)]\n//{{{\nfunction exportShowPanel(which) {\n	var index=0; var panel='exportLocalPanel';\n	switch (which) {\n		case 'file:':\n		case undefined:\n			index=0; panel='exportLocalPanel'; break;\n		case 'http:':\n			index=1; panel='exportHTTPPanel'; break;\n		case 'https:':\n			index=2; panel='exportHTTPPanel'; break;\n		case 'ftp:':\n			index=3; panel='exportFTPPanel'; break;\n		default:\n			alert(&quot;Sorry, export to &quot;+which+&quot; is not yet available&quot;);\n			break;\n	}\n	exportInitPanel(which);\n	document.getElementById('exportTo').selectedIndex=index;\n	document.getElementById('exportLocalPanel').style.display='none';\n	document.getElementById('exportHTTPPanel').style.display='none';\n	document.getElementById('exportFTPPanel').style.display='none';\n	document.getElementById(panel).style.display='block';\n}\n//}}}\n// //===\n\n// // +++[exportInitPanel(which)]\n//{{{\nfunction exportInitPanel(which) {\n	switch (which) {\n		case &quot;file:&quot;: // LOCAL EXPORT PANEL: file/path:\n			// ** no init - security issues in IE **\n			break;\n		case &quot;http:&quot;: // WEB EXPORT PANEL\n		case &quot;https:&quot;: // SECURE WEB EXPORT PANEL\n			// url\n			var siteURL=store.getTiddlerText(&quot;SiteUrl&quot;);\n			if (store.tiddlerExists(&quot;unawiki_download&quot;)) {\n				var theURL=store.getTiddlerText(&quot;unawiki_download&quot;);\n				theURL=theURL.replace(/\s[\s[download\s|/,'').replace(/\s]\s]/,'');\n				var title=(store.tiddlerExists(&quot;unawiki_host&quot;))?&quot;unawiki_host&quot;:&quot;SiteHost&quot;;\n				var theHost=store.getTiddlerText(title);\n				if (!theHost || !theHost.length) theHost=document.location.host;\n				if (!theHost || !theHost.length) theHost=title;\n				siteURL=which+&quot;//&quot;+theHost+theURL\n			}\n			if (!siteURL) siteURL=&quot;SiteUrl&quot;;\n			document.getElementById(&quot;exportHTTPSiteURL&quot;).value=siteURL;;\n			// server script/params\n			var title=(store.tiddlerExists(&quot;unawiki_host&quot;))?&quot;unawiki_host&quot;:&quot;SiteHost&quot;;\n			var theHost=store.getTiddlerText(title);\n			if (!theHost || !theHost.length) theHost=document.location.host;\n			if (!theHost || !theHost.length) theHost=title;\n			// get POST\n			var title=(store.tiddlerExists(&quot;unawiki_post&quot;))?&quot;unawiki_post&quot;:&quot;SitePost&quot;;\n			var thePost=store.getTiddlerText(title);\n			if (!thePost || !thePost.length) thePost=&quot;/&quot;+title;\n			// get PARAMS\n			var title=(store.tiddlerExists(&quot;unawiki_params&quot;))?&quot;unawiki_params&quot;:&quot;SiteParams&quot;;\n			var theParams=store.getTiddlerText(title);\n			if (!theParams|| !theParams.length) theParams=title;\n			var serverURL = which+&quot;//&quot;+theHost+thePost+&quot;?&quot;+theParams;\n			document.getElementById(&quot;exportHTTPServerURL&quot;).value=serverURL;\n			break;\n		case &quot;ftp:&quot;: // FTP EXPORT PANEL\n			// host\n			var siteHost=store.getTiddlerText(&quot;SiteHost&quot;);\n			if (!siteHost || !siteHost.length) siteHost=document.location.host;\n			if (!siteHost || !siteHost.length) siteHost=&quot;SiteHost&quot;;\n			document.getElementById(&quot;exportFTPHost&quot;).value=siteHost;\n			// username\n			var siteID=store.getTiddlerText(&quot;SiteID&quot;);\n			if (!siteID || !siteID.length) siteID=config.options.txtUserName;\n			document.getElementById(&quot;exportFTPID&quot;).value=siteID;\n			// password\n			document.getElementById(&quot;exportFTPPW&quot;).value=&quot;&quot;;\n			// file/path\n			document.getElementById(&quot;exportFTPFilename&quot;).value=&quot;&quot;;\n			break;\n	}\n}\n//}}}\n// //===\n\n// // +++[exportInitFilter()]\n//{{{\nfunction exportInitFilter() {\n	// TBD: persistent settings via local cookies\n	// start date\n	document.getElementById(&quot;exportFilterStart&quot;).checked=false;\n	document.getElementById(&quot;exportStartDate&quot;).value=&quot;&quot;;\n	// end date\n	document.getElementById(&quot;exportFilterEnd&quot;).checked=false;\n	document.getElementById(&quot;exportEndDate&quot;).value=&quot;&quot;;\n	// tags\n	document.getElementById(&quot;exportFilterTags&quot;).checked=false;\n	document.getElementById(&quot;exportTags&quot;).value=&quot;not excludeExport&quot;;\n	// text\n	document.getElementById(&quot;exportFilterText&quot;).checked=false;\n	document.getElementById(&quot;exportText&quot;).value=&quot;&quot;;\n	// show/hide filter input fields\n	exportShowFilterFields();\n}\n//}}}\n// //===\n\n// // +++[exportShowFilterFields(which)]\n//{{{\nfunction exportShowFilterFields(which) {\n	var show;\n\n	show=document.getElementById('exportFilterStart').checked;\n	document.getElementById('exportFilterStartBy').style.display=show?&quot;block&quot;:&quot;none&quot;;\n	document.getElementById('exportStartDate').style.display=show?&quot;block&quot;:&quot;none&quot;;\n	var val=document.getElementById('exportFilterStartBy').value;\n	document.getElementById('exportStartDate').value\n		=getFilterDate(val,'exportStartDate').formatString(config.macros.exportTiddlers.datetimefmt);\n	 if (which &amp;&amp; (which.id=='exportFilterStartBy') &amp;&amp; (val=='other'))\n		document.getElementById('exportStartDate').focus();\n\n	show=document.getElementById('exportFilterEnd').checked;\n	document.getElementById('exportFilterEndBy').style.display=show?&quot;block&quot;:&quot;none&quot;;\n	document.getElementById('exportEndDate').style.display=show?&quot;block&quot;:&quot;none&quot;;\n	var val=document.getElementById('exportFilterEndBy').value;\n	document.getElementById('exportEndDate').value\n		=getFilterDate(val,'exportEndDate').formatString(config.macros.exportTiddlers.datetimefmt);\n	 if (which &amp;&amp; (which.id=='exportFilterEndBy') &amp;&amp; (val=='other'))\n		document.getElementById('exportEndDate').focus();\n\n	show=document.getElementById('exportFilterTags').checked;\n	document.getElementById('exportTags').style.display=show?&quot;block&quot;:&quot;none&quot;;\n\n	show=document.getElementById('exportFilterText').checked;\n	document.getElementById('exportText').style.display=show?&quot;block&quot;:&quot;none&quot;;\n}\n//}}}\n// //===\n// //===\n\n// // +++[onClickExportButton(which): control interactions]\n//{{{\nfunction onClickExportButton(which)\n{\n	// DEBUG alert(which.id);\n	var theList=document.getElementById('exportList'); if (!theList) return;\n	var count = 0;\n	var total = store.getTiddlers('title').length;\n	switch (which.id)\n		{\n		case 'exportFilter':\n			count=filterExportList();\n			var panel=document.getElementById('exportFilterPanel');\n			if (count==-1) { panel.style.display='block'; break; }\n			theList.options[0].text=formatExportListHeader(count,total);\n			document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n			clearMessage(); displayMessage(&quot;filtered &quot;+theList.options[0].text);\n			if (count==0) { alert(&quot;No tiddlers were selected&quot;); panel.style.display='block'; }\n			break;\n		case 'exportStart':\n			exportTiddlers();\n			break;\n		case 'exportHideFilter':\n		case 'exportToggleFilter':\n			var panel=document.getElementById('exportFilterPanel')\n			panel.style.display=(panel.style.display=='block')?'none':'block';\n			break;\n		case 'exportSelectChanges':\n			var lastmod=new Date(document.lastModified);\n			for (var t = 0; t &lt; theList.options.length; t++) {\n				if (theList.options[t].value==&quot;&quot;) continue;\n				var tiddler=store.getTiddler(theList.options[t].value); if (!tiddler) continue;\n				theList.options[t].selected=(tiddler.modified&gt;lastmod);\n				count += (tiddler.modified&gt;lastmod)?1:0;\n			}\n			theList.options[0].text=formatExportListHeader(count,total);\n			document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n			clearMessage(); displayMessage(theList.options[0].text);\n			if (count==0) alert(&quot;There are no unsaved changes&quot;);\n			break;\n		case 'exportSelectAll':\n			for (var t = 0; t &lt; theList.options.length; t++) {\n				if (theList.options[t].value==&quot;&quot;) continue;\n				theList.options[t].selected=true;\n				count += 1;\n			}\n			theList.options[0].text=formatExportListHeader(count,count);\n			document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n			clearMessage(); displayMessage(theList.options[0].text);\n			break;\n		case 'exportSelectOpened':\n			for (var t = 0; t &lt; theList.options.length; t++) theList.options[t].selected=false;\n			var tiddlerDisplay = document.getElementById(&quot;tiddlerDisplay&quot;);\n			for (var t=0;t&lt;tiddlerDisplay.childNodes.length;t++) {\n				var tiddler=tiddlerDisplay.childNodes[t].id.substr(7);\n				for (var i = 0; i &lt; theList.options.length; i++) {\n					if (theList.options[i].value!=tiddler) continue;\n					theList.options[i].selected=true; count++; break;\n				}\n			}\n			theList.options[0].text=formatExportListHeader(count,total);\n			document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n			clearMessage(); displayMessage(theList.options[0].text);\n			if (count==0) alert(&quot;There are no tiddlers currently opened&quot;);\n			break;\n		case 'exportListSmaller':	// decrease current listbox size\n			var min=5;\n			theList.size-=(theList.size&gt;min)?1:0;\n			break;\n		case 'exportListLarger':	// increase current listbox size\n			var max=(theList.options.length&gt;25)?theList.options.length:25;\n			theList.size+=(theList.size&lt;max)?1:0;\n			break;\n		case 'exportClose':\n			document.getElementById('exportPanel').style.display='none';\n			break;\n		}\n}\n//}}}\n// //===\n\n// // +++[list display]\n//{{{\nfunction formatExportListHeader(count,total)\n{\n	var txt=total+' tiddler'+((total!=1)?'s':'')+&quot; - &quot;;\n	txt += (count==0)?&quot;none&quot;:(count==total)?&quot;all&quot;:count;\n	txt += &quot; selected for export&quot;;\n	return txt;\n}\n\nfunction refreshExportList(selectedIndex)\n{\n	var theList  = document.getElementById(&quot;exportList&quot;);\n	var sort;\n	if (!theList) return;\n	// get the sort order\n	if (!selectedIndex)   selectedIndex=0;\n	if (selectedIndex==0) sort='modified';\n	if (selectedIndex==1) sort='title';\n	if (selectedIndex==2) sort='modified';\n	if (selectedIndex==3) sort='modifier';\n\n	// get the alphasorted list of tiddlers\n	var tiddlers = store.getTiddlers('title');\n	// unselect headings and count number of tiddlers actually selected\n	var count=0;\n	for (var i=0; i&lt;theList.options.length; i++) {\n		if (theList.options[i].value==&quot;&quot;) theList.options[i].selected=false;\n		count+=theList.options[i].selected?1:0;\n	}\n	// disable &quot;export&quot; button if no tiddlers selected\n	document.getElementById(&quot;exportStart&quot;).disabled=(count==0);\n	// update listbox heading to show selection count\n	if (theList.options.length)\n		theList.options[0].text=formatExportListHeader(count,tiddlers.length);\n\n	// if a [command] item, reload list... otherwise, no further refresh needed\n	if (selectedIndex&gt;3)  return;\n\n	// clear current list contents\n	while (theList.length &gt; 0) { theList.options[0] = null; }\n	// add heading and control items to list\n	var i=0;\n	var indent=String.fromCharCode(160)+String.fromCharCode(160);\n	theList.options[i++]=\n		new Option(formatExportListHeader(0,tiddlers.length), &quot;&quot;,false,false);\n	theList.options[i++]=\n		new Option(((sort==&quot;title&quot;        )?&quot;&gt;&quot;:indent)+' [by title]', &quot;&quot;,false,false);\n	theList.options[i++]=\n		new Option(((sort==&quot;modified&quot;)?&quot;&gt;&quot;:indent)+' [by date]', &quot;&quot;,false,false);\n	theList.options[i++]=\n		new Option(((sort==&quot;modifier&quot;)?&quot;&gt;&quot;:indent)+' [by author]', &quot;&quot;,false,false);\n	// output the tiddler list\n	switch(sort)\n		{\n		case &quot;title&quot;:\n			for(var t = 0; t &lt; tiddlers.length; t++)\n				theList.options[i++] = new Option(tiddlers[t].title,tiddlers[t].title,false,false);\n			break;\n		case &quot;modifier&quot;:\n		case &quot;modified&quot;:\n			var tiddlers = store.getTiddlers(sort);\n			// sort descending for newest date first\n			tiddlers.sort(function (a,b) {if(a[sort] == b[sort]) return(0); else return (a[sort] &gt; b[sort]) ? -1 : +1; });\n			var lastSection = &quot;&quot;;\n			for(var t = 0; t &lt; tiddlers.length; t++)\n				{\n				var tiddler = tiddlers[t];\n				var theSection = &quot;&quot;;\n				if (sort==&quot;modified&quot;) theSection=tiddler.modified.toLocaleDateString();\n				if (sort==&quot;modifier&quot;) theSection=tiddler.modifier;\n				if (theSection != lastSection)\n					{\n					theList.options[i++] = new Option(theSection,&quot;&quot;,false,false);\n					lastSection = theSection;\n					}\n				theList.options[i++] = new Option(indent+indent+tiddler.title,tiddler.title,false,false);\n				}\n			 break;\n		}\n	theList.selectedIndex=selectedIndex;		  // select current control item\n}\n//}}}\n// //===\n\n// // +++[list filtering]\n//{{{\nfunction getFilterDate(val,id)\n{\n	var result=0;\n	switch (val) {\n		case 'site':\n			var timestamp=store.getTiddlerText(&quot;SiteDate&quot;);\n			if (!timestamp) timestamp=document.lastModified;\n			result=new Date(timestamp);\n			break;\n		case 'file':\n			result=new Date(document.lastModified);\n			break;\n		case 'other':\n			result=new Date(document.getElementById(id).value);\n			break;\n		default: // today=0, yesterday=1, one week=7, two weeks=14, a month=31\n			var now=new Date(); var tz=now.getTimezoneOffset()*60000; now-=tz;\n			var oneday=86400000;\n			if (id=='exportStartDate')\n				result=new Date((Math.floor(now/oneday)-val)*oneday+tz);\n			else\n				result=new Date((Math.floor(now/oneday)-val+1)*oneday+tz-1);\n			break;\n	}\n	// DEBUG alert('getFilterDate('+val+','+id+')=='+result+&quot;\snnow=&quot;+now);\n	return result;\n}\n\nfunction filterExportList()\n{\n	var theList  = document.getElementById(&quot;exportList&quot;); if (!theList) return -1;\n\n	var filterStart=document.getElementById(&quot;exportFilterStart&quot;).checked;\n	var val=document.getElementById(&quot;exportFilterStartBy&quot;).value;\n	var startDate=getFilterDate(val,'exportStartDate');\n\n	var filterEnd=document.getElementById(&quot;exportFilterEnd&quot;).checked;\n	var val=document.getElementById(&quot;exportFilterEndBy&quot;).value;\n	var endDate=getFilterDate(val,'exportEndDate');\n\n	var filterTags=document.getElementById(&quot;exportFilterTags&quot;).checked;\n	var tags=document.getElementById(&quot;exportTags&quot;).value;\n\n	var filterText=document.getElementById(&quot;exportFilterText&quot;).checked;\n	var text=document.getElementById(&quot;exportText&quot;).value;\n\n	if (!(filterStart||filterEnd||filterTags||filterText)) {\n		alert(&quot;Please set the selection filter&quot;);\n		document.getElementById('exportFilterPanel').style.display=&quot;block&quot;;\n		return -1;\n	}\n	if (filterStart&amp;&amp;filterEnd&amp;&amp;(startDate&gt;endDate)) {\n		var msg=&quot;starting date/time:\sn&quot;\n		msg+=startDate.toLocaleString()+&quot;\sn&quot;;\n		msg+=&quot;is later than ending date/time:\sn&quot;\n		msg+=endDate.toLocaleString()\n		alert(msg);\n		return -1;\n	}\n\n	// scan list and select tiddlers that match all applicable criteria\n	var total=0;\n	var count=0;\n	for (var i=0; i&lt;theList.options.length; i++) {\n		// get item, skip non-tiddler list items (section headings)\n		var opt=theList.options[i]; if (opt.value==&quot;&quot;) continue;\n		// get tiddler, skip missing tiddlers (this should NOT happen)\n		var tiddler=store.getTiddler(opt.value); if (!tiddler) continue; \n		var sel=true;\n		if ( (filterStart &amp;&amp; tiddler.modified&lt;startDate)\n		|| (filterEnd &amp;&amp; tiddler.modified&gt;endDate)\n		|| (filterTags &amp;&amp; !matchTags(tiddler,tags))\n		|| (filterText &amp;&amp; (tiddler.text.indexOf(text)==-1) &amp;&amp; (tiddler.title.indexOf(text)==-1)))\n			sel=false;\n		opt.selected=sel;\n		count+=sel?1:0;\n		total++;\n	}\n	return count;\n}\n//}}}\n\n//{{{\nfunction matchTags(tiddler,cond)\n{\n	if (!cond||!cond.trim().length) return false;\n\n	// build a regex of all tags as a big-old regex that \n	// OR's the tags together (tag1|tag2|tag3...) in length order\n	var tgs = store.getTags();\n	if ( tgs.length == 0 ) return results ;\n	var tags = tgs.sort( function(a,b){return (a[0].length&lt;b[0].length)-(a[0].length&gt;b[0].length);});\n	var exp = &quot;(&quot; + tags.join(&quot;|&quot;) + &quot;)&quot; ;\n	exp = exp.replace( /(,[\sd]+)/g, &quot;&quot; ) ;\n	var regex = new RegExp( exp, &quot;ig&quot; );\n\n	// build a string such that an expression that looks like this: tag1 AND tag2 OR NOT tag3\n	// turns into : /tag1/.test(...) &amp;&amp; /tag2/.test(...) || ! /tag2/.test(...)\n	cond = cond.replace( regex, &quot;/$1\s\s|/.test(tiddlerTags)&quot; );\n	cond = cond.replace( /\ssand\ss/ig, &quot; &amp;&amp; &quot; ) ;\n	cond = cond.replace( /\ssor\ss/ig, &quot; || &quot; ) ;\n	cond = cond.replace( /\ss?not\ss/ig, &quot; ! &quot; ) ;\n\n	// if a boolean uses a tag that doesn't exist - it will get left alone \n	// (we only turn existing tags into actual tests).\n	// replace anything that wasn't found as a tag, AND, OR, or NOT with the string &quot;false&quot;\n	// if the tag doesn't exist then /tag/.test(...) will always return false.\n	cond = cond.replace( /(\ss|^)+[^\s/\s|&amp;!][^\ss]*/g, &quot;false&quot; ) ;\n\n	// make a string of the tags in the tiddler and eval the 'cond' string against that string \n	// if it's TRUE then the tiddler qualifies!\n	var tiddlerTags = (tiddler.tags?tiddler.tags.join(&quot;|&quot;):&quot;&quot;)+&quot;|&quot; ;\n	try { if ( eval( cond ) ) return true; }\n	catch( e ) { displayMessage(&quot;Error in tag filter '&quot; + e + &quot;'&quot; ); }\n	return false;\n}\n//}}}\n// //===\n\n// // +++[output data formatting]&gt;\n// // +++[exportHeader(format)]\n//{{{\nfunction exportHeader(format)\n{\n	switch (format) {\n		case &quot;TW&quot;:	return exportTWHeader();\n		case &quot;DIV&quot;:	return exportDIVHeader();\n		case &quot;XML&quot;:	return exportXMLHeader();\n	}\n}\n//}}}\n// //===\n\n// // +++[exportFooter(format)]\n//{{{\nfunction exportFooter(format)\n{\n	switch (format) {\n		case &quot;TW&quot;:	return exportDIVFooter();\n		case &quot;DIV&quot;:	return exportDIVFooter();\n		case &quot;XML&quot;:	return exportXMLFooter();\n	}\n}\n//}}}\n// //===\n\n// // +++[exportTWHeader()]\n//{{{\nfunction exportTWHeader()\n{\n	// Get the URL of the document\n	var originalPath = document.location.toString();\n	// Check we were loaded from a file URL\n	if(originalPath.substr(0,5) != &quot;file:&quot;)\n		{ alert(config.messages.notFileUrlError); return; }\n	// Remove any location part of the URL\n	var hashPos = originalPath.indexOf(&quot;#&quot;); if(hashPos != -1) originalPath = originalPath.substr(0,hashPos);\n	// Convert to a native file format assuming\n	// &quot;file:///x:/path/path/path...&quot; - pc local file --&gt; &quot;x:\spath\spath\spath...&quot;\n	// &quot;file://///server/share/path/path/path...&quot; - FireFox pc network file --&gt; &quot;\s\sserver\sshare\spath\spath\spath...&quot;\n	// &quot;file:///path/path/path...&quot; - mac/unix local file --&gt; &quot;/path/path/path...&quot;\n	// &quot;file://server/share/path/path/path...&quot; - pc network file --&gt; &quot;\s\sserver\sshare\spath\spath\spath...&quot;\n	var localPath;\n	if(originalPath.charAt(9) == &quot;:&quot;) // pc local file\n		localPath = unescape(originalPath.substr(8)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\s\s&quot;);\n	else if(originalPath.indexOf(&quot;file://///&quot;) == 0) // FireFox pc network file\n		localPath = &quot;\s\s\s\s&quot; + unescape(originalPath.substr(10)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\s\s&quot;);\n	else if(originalPath.indexOf(&quot;file:///&quot;) == 0) // mac/unix local file\n		localPath = unescape(originalPath.substr(7));\n	else if(originalPath.indexOf(&quot;file:/&quot;) == 0) // mac/unix local file\n		localPath = unescape(originalPath.substr(5));\n	else // pc network file\n		localPath = &quot;\s\s\s\s&quot; + unescape(originalPath.substr(7)).replace(new RegExp(&quot;/&quot;,&quot;g&quot;),&quot;\s\s&quot;);\n	// Load the original file\n	var original = loadFile(localPath);\n	if(original == null)\n		{ alert(config.messages.cantSaveError); return; }\n	// Locate the storeArea div's\n	var posOpeningDiv = original.indexOf(startSaveArea);\n	var posClosingDiv = original.lastIndexOf(endSaveArea);\n	if((posOpeningDiv == -1) || (posClosingDiv == -1))\n		{ alert(config.messages.invalidFileError.format([localPath])); return; }\n	return original.substr(0,posOpeningDiv+startSaveArea.length)\n}\n//}}}\n// //===\n\n// // +++[exportDIVHeader()]\n//{{{\nfunction exportDIVHeader()\n{\n	var out=[];\n	var now = new Date();\n	var title = convertUnicodeToUTF8(wikifyPlain(&quot;SiteTitle&quot;).htmlEncode());\n	var subtitle = convertUnicodeToUTF8(wikifyPlain(&quot;SiteSubtitle&quot;).htmlEncode());\n	var user = convertUnicodeToUTF8(config.options.txtUserName.htmlEncode());\n	var twver = version.major+&quot;.&quot;+version.minor+&quot;.&quot;+version.revision;\n	var pver = version.extensions.exportTiddlers.major+&quot;.&quot;\n		+version.extensions.exportTiddlers.minor+&quot;.&quot;+version.extensions.exportTiddlers.revision;\n	out.push(&quot;&lt;html&gt;&lt;body&gt;&quot;);\n	out.push(&quot;&lt;style type=\s&quot;text/css\s&quot;&gt;&quot;);\n	out.push(&quot;#storeArea {display:block;margin:1em;}&quot;);\n	out.push(&quot;#storeArea div&quot;);\n	out.push(&quot;{padding:0.5em;margin:1em;border:2px solid black;height:10em;overflow:auto;}&quot;);\n	out.push(&quot;#javascriptWarning&quot;);\n	out.push(&quot;{width:100%;text-align:left;background-color:#eeeeee;padding:1em;}&quot;);\n	out.push(&quot;&lt;/style&gt;&quot;);\n	out.push(&quot;&lt;div id=\s&quot;javascriptWarning\s&quot;&gt;&quot;);\n	out.push(&quot;TiddlyWiki export file&lt;br&gt;&quot;);\n	out.push(&quot;Source: &lt;b&gt;&quot;+convertUnicodeToUTF8(document.location.toString())+&quot;&lt;/b&gt;&lt;br&gt;&quot;);\n	out.push(&quot;Title: &lt;b&gt;&quot;+title+&quot;&lt;/b&gt;&lt;br&gt;&quot;);\n	out.push(&quot;Subtitle: &lt;b&gt;&quot;+subtitle+&quot;&lt;/b&gt;&lt;br&gt;&quot;);\n	out.push(&quot;Created: &lt;b&gt;&quot;+now.toLocaleString()+&quot;&lt;/b&gt; by &lt;b&gt;&quot;+user+&quot;&lt;/b&gt;&lt;br&gt;&quot;);\n	out.push(&quot;TiddlyWiki &quot;+twver+&quot; / &quot;+&quot;ExportTiddlersPlugin &quot;+pver+&quot;&lt;br&gt;&quot;);\n	out.push(&quot;&lt;/div&gt;&quot;);\n	out.push(&quot;&lt;div id=\s&quot;storeArea\s&quot;&gt;&quot;);\n	return out;\n}\n//}}}\n// //===\n\n// // +++[exportDIVFooter()]\n//{{{\nfunction exportDIVFooter()\n{\n	var out=[];\n	out.push(&quot;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;);\n	return out;\n}\n//}}}\n// //===\n\n// // +++[exportXMLHeader()]\n//{{{\nfunction exportXMLHeader()\n{\n	var out=[];\n	var now = new Date();\n	var u = store.getTiddlerText(&quot;SiteUrl&quot;,null);\n	var title = convertUnicodeToUTF8(wikifyPlain(&quot;SiteTitle&quot;).htmlEncode());\n	var subtitle = convertUnicodeToUTF8(wikifyPlain(&quot;SiteSubtitle&quot;).htmlEncode());\n	var user = convertUnicodeToUTF8(config.options.txtUserName.htmlEncode());\n	var twver = version.major+&quot;.&quot;+version.minor+&quot;.&quot;+version.revision;\n	var pver = version.extensions.exportTiddlers.major+&quot;.&quot;\n		+version.extensions.exportTiddlers.minor+&quot;.&quot;+version.extensions.exportTiddlers.revision;\n	out.push(&quot;&lt;&quot; + &quot;?xml version=\s&quot;1.0\s&quot;?&quot; + &quot;&gt;&quot;);\n	out.push(&quot;&lt;rss version=\s&quot;2.0\s&quot;&gt;&quot;);\n	out.push(&quot;&lt;channel&gt;&quot;);\n	out.push(&quot;&lt;title&gt;&quot; + title + &quot;&lt;/title&gt;&quot;);\n	if(u) out.push(&quot;&lt;link&gt;&quot; + convertUnicodeToUTF8(u.htmlEncode()) + &quot;&lt;/link&gt;&quot;);\n	out.push(&quot;&lt;description&gt;&quot; + subtitle + &quot;&lt;/description&gt;&quot;);\n	out.push(&quot;&lt;language&gt;en-us&lt;/language&gt;&quot;);\n	out.push(&quot;&lt;copyright&gt;Copyright &quot; + now.getFullYear() + &quot; &quot; + user + &quot;&lt;/copyright&gt;&quot;);\n	out.push(&quot;&lt;pubDate&gt;&quot; + now.toGMTString() + &quot;&lt;/pubDate&gt;&quot;);\n	out.push(&quot;&lt;lastBuildDate&gt;&quot; + now.toGMTString() + &quot;&lt;/lastBuildDate&gt;&quot;);\n	out.push(&quot;&lt;docs&gt;http://blogs.law.harvard.edu/tech/rss&lt;/docs&gt;&quot;);\n	out.push(&quot;&lt;generator&gt;TiddlyWiki &quot;+twver+&quot; plus ExportTiddlersPlugin &quot;+pver+&quot;&lt;/generator&gt;&quot;);\n	return out;\n}\n//}}}\n// //===\n\n// // +++[exportXMLFooter()]\n//{{{\nfunction exportXMLFooter()\n{\n	var out=[];\n	out.push(&quot;&lt;/channel&gt;&lt;/rss&gt;&quot;);\n	return out;\n}\n//}}}\n// //===\n\n// // +++[exportData()]\n//{{{\nfunction exportData(theList,theFormat)\n{\n	// scan export listbox and collect DIVs or XML for selected tiddler content\n	var out=[];\n	for (var i=0; i&lt;theList.options.length; i++) {\n		// get item, skip non-selected items and section headings\n		var opt=theList.options[i]; if (!opt.selected||(opt.value==&quot;&quot;)) continue;\n		// get tiddler, skip missing tiddlers (this should NOT happen)\n		var thisTiddler=store.getTiddler(opt.value); if (!thisTiddler) continue; \n		if (theFormat==&quot;TW&quot;)	out.push(convertUnicodeToUTF8(thisTiddler.saveToDiv()));\n		if (theFormat==&quot;DIV&quot;)	out.push(convertUnicodeToUTF8(thisTiddler.title+&quot;\sn&quot;+thisTiddler.saveToDiv()));\n		if (theFormat==&quot;XML&quot;)	out.push(convertUnicodeToUTF8(thisTiddler.saveToRss()));\n	}\n	return out;\n}\n//}}}\n// //===\n// //===\n\n// // +++[exportTiddlers(): output selected data to local or server]\n//{{{\nfunction exportTiddlers()\n{\n	var theList  = document.getElementById(&quot;exportList&quot;); if (!theList) return;\n\n	// get the export settings\n	var theProtocol = document.getElementById(&quot;exportTo&quot;).value;\n	var theFormat = document.getElementById(&quot;exportFormat&quot;).value;\n\n	// assemble output: header + tiddlers + footer\n	var theData=exportData(theList,theFormat);\n	var count=theData.length;\n	var out=[]; var txt=out.concat(exportHeader(theFormat),theData,exportFooter(theFormat)).join(&quot;\sn&quot;);\n	var msg=&quot;&quot;;\n	switch (theProtocol) {\n		case &quot;file:&quot;:\n			var theTarget = document.getElementById(&quot;exportFilename&quot;).value.trim();\n			if (!theTarget.length) msg = &quot;A local path/filename is required\sn&quot;;\n			if (!msg &amp;&amp; saveFile(theTarget,txt))\n				msg=count+&quot; tiddler&quot;+((count!=1)?&quot;s&quot;:&quot;&quot;)+&quot; exported to local file&quot;;\n			else if (!msg)\n				msg+=&quot;An error occurred while saving to &quot;+theTarget;\n			break;\n		case &quot;http:&quot;:\n		case &quot;https:&quot;:\n			var theTarget = document.getElementById(&quot;exportHTTPServerURL&quot;).value.trim();\n			if (!theTarget.length) msg = &quot;A server URL is required\sn&quot;;\n			if (!msg &amp;&amp; exportPost(theTarget+encodeURIComponent(txt)))\n				msg=count+&quot; tiddler&quot;+((count!=1)?&quot;s&quot;:&quot;&quot;)+&quot; exported to &quot;+theProtocol+&quot; server&quot;;\n			else if (!msg)\n				msg+=&quot;An error occurred while saving to &quot;+theTarget;\n			break;\n		case &quot;ftp:&quot;:\n		default:\n			msg=&quot;Sorry, export to &quot;+theLocation+&quot; is not yet available&quot;;\n			break;\n	}\n	clearMessage(); displayMessage(msg,theTarget);\n}\n//}}}\n// //===\n\n// // +++[exportPost(url): cross-domain post] uses hidden iframe to submit url and capture responses\n//{{{\nfunction exportPost(url)\n{\n	var f=document.getElementById(&quot;exportFrame&quot;); if (f) document.body.removeChild(f);\n	f=document.createElement(&quot;iframe&quot;); f.id=&quot;exportFrame&quot;;\n	f.style.width=&quot;0px&quot;; f.style.height=&quot;0px&quot;; f.style.border=&quot;0px&quot;;\n	document.body.appendChild(f);\n	var d=f.document;\n	if (f.contentDocument) d=f.contentDocument; // For NS6\n	else if (f.contentWindow) d=f.contentWindow.document; // For IE5.5 and IE6\n 	d.location.replace(url);\n 	return true;\n}\n//}}}\n// //===\n</div>
<div tiddler="FormattingInstructions" modifier="Brad" modified="200605101626" created="200605072306" tags="">TiddlyWiki\nuses Wiki style markup, a way of lightly &quot;tagging&quot; plain text so it can\nbe transformed into HTML. Edit this Tiddler to see samples.\n\n! Header\nSamples\n!Header 1\n!!Header 2\n!!!Header 3\n!!!!Header 4\n!!!!!Header 5\n\n! Unordered Lists:\n* Lists are where it's at\n* Just use an\nasterisk and you're set\n** To nest lists just add more\nasterisks...\n***...like this\n* The circle makes a great bullet\nbecause once you've printed a list you can mark off completed items\n*\nYou can also nest mixed list types\n## Like this\n\n! Ordered Lists\n#\nOrdered lists are pretty neat too\n# If you're handy with HTML and CSS\nyou could customize the [[numbering\nscheme|http://www.w3schools.com/css/pr_list-style-type.asp]]\n## To\nnest, just add more octothorpes (pound signs)...\n### Like this\n* You\ncan also\n** Mix list types\n*** like this\n# Pretty neat don't you\nthink?\n\n! Tiddler links\nTo create a Tiddler link, just use\nmixed-case WikiWord, or use [[brackets]] for NonWikiWordLinks. This is\nhow the GTD style [[@Action]] lists are created. \n\nNote that existing\nTiddlers are in bold and empty Tiddlers are in italics. See\nCreatingTiddlers for details.\n\n! External Links\nYou can link to\n[[external sites|http://google.com]] with brackets. You can also\nLinkToFolders on your machine or network shares.\n\n! Images\nEdit this\ntiddler to see how it's\ndone.\n[img[http://img110.echo.cx/img110/139/gorilla8nw.jpg]]\n\n!Tables\n|!th1111111111|!th2222222222|\n|&gt;|\ncolspan |\n| rowspan |left|\n|~| right|\n|colored| center\n|\n|caption|c\n\nFor a complex table example, see PeriodicTable.\n\n!\nHorizontal Rules\nYou can divide a tiddler into\n----\nsections by\ntyping four dashes on a line by themselves.\n\n!\nBlockquotes\n&lt;&lt;&lt;\nThis is how you do an extended, wrapped\nblockquote so you don't have to put angle quotes on every\nline.\n&lt;&lt;&lt;\n&gt;level 1\n&gt;level 1\n&gt;&gt;level\n2\n&gt;&gt;level 2\n&gt;&gt;&gt;level 3\n&gt;&gt;&gt;level\n3\n&gt;&gt;level 2\n&gt;level 1\n\n! Other\nFormatting\n''Bold''\n==Strike==\n__Underline__\n//Italic//\nSuperscript:\n2^^3^^=8\nSubscript: a~~ij~~ = -a~~ji~~\n@@highlight@@ Unfortunately\nhighlighting is broken right now.\n@@color(green):green\ncolored@@\n@@bgcolor(#ff0000):color(#ffffff):red colored@@ Hex colors\nare also broken right now.</div>
<div tiddler="ImportTiddlersPanel" modifier="ELSDesignStudios" modified="200512280426" created="200512280426" tags="importexport">&lt;&lt;importTiddlers inline&gt;&gt;</div>
<div tiddler="ImportTiddlersPlugin" modifier="ELSDesignStudios" modified="200604181554" created="200512271920" tags="systemConfig plugin2.1 plugin2.0 plugin1.2 importexport">/***\n''Import Tiddlers Plugin for TiddlyWiki version 1.2.x, 2.0 and 2.1beta''\n^^author: Eric Shulman - ELS Design Studios\nsource: http://www.TiddlyTools.com/#ImportTiddlersPlugin\nlicense: [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]^^\n\nWhen many people share and edit copies of the same TiddlyWiki document, the ability to quickly collect all these changes back into a single, updated document that can then be redistributed to the entire group is very important.  This plugin lets you selectively combine tiddlers from any two TiddlyWiki documents.  It can also be very useful when moving your own tiddlers from document to document (e.g., when upgrading to the latest version of TiddlyWiki, or 'pre-loading' your favorite stylesheets into a new 'empty' TiddlyWiki document.)\n\n!!!!!Interactive interface\n&lt;&lt;&lt;\n{{{&lt;&lt;importTiddlers&gt;&gt;}}}\ncreates &quot;import tiddlers&quot; link.  click to show/hide import control panel\n\n{{{&lt;&lt;importTiddlers inline&gt;&gt;}}}\ncreates import control panel directly in tiddler content\n\n&lt;&lt;importTiddlers inline&gt;&gt;\n\nPress ''[browse]'' to select a TiddlyWiki document file to import.  You can also type in the path/filename or a remote document URL (starting with http://)and press ''[open]''.  //Note: There may be some delay to permit the browser time to access and load the document before updating the listbox with the titles of all tiddlers that are available to be imported.//\n\nSelect one or more titles from the listbox (hold CTRL or SHIFT while clicking to add/remove the highlight from individual list items).  You can press ''[select all]'' to quickly highlight all tiddler titles in the list.  Use the ''[-]'', ''[+]'', or ''[=]'' links to adjust the listbox size so you can view more (or less) tiddler titles at one time.  When you have chosen the tiddlers you want to import and entered any extra tags, press ''[import]'' to begin copying them to the current TiddlyWiki document.\n\n''select: all, new, changes, or differences''\n\nYou can click on ''all'', ''new'', ''changes'', or ''differences'' to automatically select a subset of tiddlers from the list. This makes it very quick and easy to find and import just the updated tiddlers you are interested in:\n&gt;''&quot;all&quot;'' selects ALL tiddlers from the import source document, even if they have not been changed.\n&gt;''&quot;new&quot;'' selects only tiddlers that are found in the import source document, but do not yet exist in the destination document\n&gt;''&quot;changes&quot;'' selects only tiddlers that exist in both documents but that are newer in the source document\n&gt;''&quot;differences&quot;'' selects all new and existing tiddlers that are different from the destination document (even if destination tiddler is newer)\n\n''Import Tagging:''\n\nTiddlers that have been imported can be automatically tagged, so they will be easier to find later on, after they have been added to your document.  New tags are entered into the &quot;add tags&quot; input field, and then //added// to the existing tags for each tiddler as it is imported.\n\n''Skip, Rename, Merge, or Replace:''\n\nWhen importing a tiddler whose title is identical to one that already exists, the import process pauses and the tiddler title is displayed in an input field, along with four push buttons: ''[skip]'', ''[rename]'', ''[merge]'' and ''[replace]''.\n\nTo bypass importing this tiddler, press ''[skip]''.  To import the tiddler with a different name (so that both the tiddlers will exist when the import is done), enter a new title in the input field and then press ''[rename]''.   Press ''[merge]'' to combine the content from both tiddlers into a single tiddler.  Press ''[replace]'' to overwrite the existing tiddler with the imported one, discarding the previous tiddler content.\n\n//Note: if both the title ''and'' modification date/////time match, the imported tiddler is assumed to be identical to the existing one, and will be automatically skipped (i.e., not imported) without asking.//\n\n''Import Report History''\n\nWhen tiddlers are imported, a report is generated into ImportedTiddlers, indicating when the latest import was performed, the number of tiddlers successfully imported, from what location, and by whom. It also includes a list with the title, date and author of each tiddler that was imported.\n\nWhen the import process is completed, the ImportedTiddlers report is automatically displayed for your review.  If more tiddlers are subsequently imported, a new report is //added// to ImportedTiddlers, above the previous report (i.e., at the top of the tiddler), so that a reverse-chronological history of imports is maintained.\n\nIf a cumulative record is not desired, the ImportedTiddlers report may be deleted at any time. A new ImportedTiddlers report will be created the next time tiddlers are imported.\n\nNote: You can prevent the ImportedTiddlers report from being generated for any given import activity by clearing the &quot;create a report&quot; checkbox before beginning the import processing.\n\n&lt;&lt;&lt;\n!!!!!non-interactive 'load tiddlers' macro\n&lt;&lt;&lt;\nUseful for automated installation/update of plugins and other tiddler content.\n\n{{{&lt;&lt;loadTiddlers &quot;label:load tiddlers from %0&quot; http://www.tiddlytools.com/example.html confirm&gt;&gt;}}}\n&lt;&lt;loadTiddlers &quot;label:load tiddlers from %0&quot; http://www.tiddlytools.com/example.html confirm&gt;&gt;\n\nSyntax:\n{{{&lt;&lt;loadTiddlers label:text prompt:text filter source quiet confirm&gt;&gt;}}}\n\n''label:text'' and ''prompt:text''\n&gt;defines link text and tooltip (prompt) that can be clicked to trigger the load tiddler processing.  If a label is NOT provided, then no link is created and loadTiddlers() is executed whenever the containing tiddler is rendered.\n''filter'' (optional) determines which tiddlers will be automatically selected for importing.  Use one of the following keywords:\n&gt;''&quot;all&quot;'' retrieves ALL tiddlers from the import source document, even if they have not been changed.\n&gt;''&quot;new&quot;'' retrieves only tiddlers that are found in the import source document, but do not yet exist in the destination document\n&gt;''&quot;changes&quot;'' retrieves only tiddlers that exist in both documents for which the import source tiddler is newer than the existing tiddler\n&gt;''&quot;updates&quot;'' retrieves both ''new'' and ''changed'' tiddlers (this is the default action when none is specified)\n&gt;''&quot;tiddler:~TiddlerName&quot;'' retrieves only the specific tiddler named in the parameter.\n&gt;''&quot;tag:text&quot;'' retrieves only the tiddlers tagged with the indicated text.\n''source'' (required) is the location of the imported document.  It can be either a local document path/filename in whatever format your system requires, or a remote web location (starting with &quot;http://&quot; or &quot;https://&quot;)\n&gt;use the keyword ''ask'' to prompt for a source location whenever the macro is invoked\n''&quot;quiet&quot;'' (optional)\n&gt;supresses all status message during the import processing (e.g., &quot;opening local file...&quot;, &quot;found NN tiddlers...&quot; etc).  Note that if ANY tiddlers are actualy imported, a final information message will still be displayed (along with the ImportedTiddlers report), even when 'quiet' is specified.  This ensures that changes to your document cannot occur without any visible indication at all.\n''&quot;confirm&quot;'' (optional)\n&gt;adds interactive confirmation.  A browser message box (OK/Cancel) is displayed for each tiddler that will be imported, so that you can manually bypass any tiddlers that you do not want to import.\n&lt;&lt;&lt;\n!!!!!Installation\n&lt;&lt;&lt;\ncopy/paste the following tiddlers into your document:\n''ImportTiddlersPlugin'' (tagged with &lt;&lt;tag systemConfig&gt;&gt;)\n\ncreate/edit ''SideBarOptions'': (sidebar menu items) \n^^Add &quot;&lt; &lt; ImportTiddlers &gt; &gt;&quot; macro^^\n\n''Quick Installation Tip #1:''\nIf you are using an unmodified version of TiddlyWiki (core release version &lt;&lt;version&gt;&gt;), you can get a new, empty TiddlyWiki with the Import Tiddlers plugin pre-installed (''[[download from here|TW+ImportExport.html]]''), and then simply import all your content from your old document into this new, empty document.\n&lt;&lt;&lt;\n!!!!!Revision History\n&lt;&lt;&lt;\n''2006.04.18 [3.0.4]''\nin loadTiddlers.handler, fixed parsing of &quot;prompt:&quot; param. Also, corrected parameters mismatch in loadTiddlers() callback function definition (order of params was wrong, resulting in filters NOT being applied)\n''2006.04.12 [3.0.3]''\nmoved many display messages to macro properties for easier L10N translations via 'lingo' definitions.\n''2006.04.12 [3.0.2]''\nadditional refactoring of 'core candidate' code.  Proposed API now defines &quot;loadRemoteFile()&quot; for XMLHttpRequest processing with built in fallback for handling local filesystem access, and readTiddlersFromHTML() to process the resulting source HTML content.\n''2006.04.04 [3.0.1]''\nin refreshImportList(), when using [by tags], tiddlers without tags are now included in a new &quot;untagged&quot; psuedo-tag list section\n''2006.04.04 [3.0.0]''\nSeparate non-interactive {{{&lt;&lt;importTiddlers...&gt;&gt;}}} macro functionality for incorporation into TW2.1 core and renamed as {{{&lt;&lt;loadTiddlers&gt;&gt;}}} macro.  New parameters for loadTiddlers: ''label:text'' and ''prompt:text'' for link creation,  ''ask'' for filename/URL, ''tag:text'' for filtering, &quot;confirm&quot; for accept/reject of individual inbound tiddlers.  Also, ImportedTiddlers report generator output has been simplified and &quot;importReplace/importPublic&quot; tags and associated &quot;force&quot; param (which were rarely, if ever, used) has been dropped.\n''2006.03.30 [2.9.1]''\nwhen extracting store area from remote URL, look for &quot;&lt;/body&gt;&quot; instead of &quot;&lt;/body&gt;\sn&lt;/html&gt;&quot; so it will match even if the &quot;\sn&quot; is absent from the source.\n''2006.03.30 [2.9.0]''\nadded optional 'force' macro param.  When present, autoImportTiddlers() bypasses the checks for importPublic and importReplace.  Based on a request from Tom Otvos.\n''2006.03.28 [2.8.1]''\nin loadImportFile(), added checks to see if 'netscape' and 'x.overrideMimeType()' are defined (IE does *not* define these values, so we bypass this code)\nAlso, when extracting store area from remote URL, explicitly look for &quot;&lt;/body&gt;\sn&lt;/html&gt;&quot; to exclude any extra content that may have been added to the end of the file by hosting environments such as GeoCities.  Thanks to Tom Otvos for finding these bugs and suggesting some fixes.\n''2006.02.21 [2.8.0]''\nadded support for &quot;tiddler:TiddlerName&quot; filtering parameter in auto-import processing\n''2006.02.21 [2.7.1]''\nClean up layout problems with IE.  (Use tables for alignment instead of SPANs styled with float:left and float:right)\n''2006.02.21 [2.7.0]''\nAdded &quot;local file&quot; and &quot;web server&quot; radio buttons for selecting dynamic import source controls in ImportPanel.  Default file control is replaced with URL text input field when &quot;web server&quot; is selected.  Default remote document URL is defined in SiteURL tiddler.  Also, added option for prepending SiteProxy URL as prefix to remote URL to mask cross-domain document access (requires compatible server-side script)\n''2006.02.17 [2.6.0]''\nRemoved &quot;differences only&quot; listbox display mode, replaced with selection filter 'presets': all/new/changes/differences.  Also fixed initialization handling for &quot;add new tags&quot; so that checkbox state is correctly tracked when panel is first displayed.\n''2006.02.16 [2.5.4]''\nadded checkbox options to control &quot;import remote tags&quot; and &quot;keep existing tags&quot; behavior, in addition to existing &quot;add new tags&quot; functionality.\n''2006.02.14 [2.5.3]''\nFF1501 corrected unintended global 't' (loop index) in importReport() and autoImportTiddlers()\n''2006.02.10 [2.5.2]''\ncorrected unintended global variable in importReport().\n''2006.02.05 [2.5.1]''\nmoved globals from window.* to config.macros.importTiddlers.* to avoid FireFox 1.5.0.1 crash bug when referencing globals\n''2006.01.18 [2.5.0]''\nadded checkbox for &quot;create a report&quot;.  Default is to create/update the ImportedTiddlers report.  Clear the checkbox to skip this step.\n''2006.01.15 [2.4.1]''\nadded &quot;importPublic&quot; tag and inverted default so that auto sharing is NOT done unless tagged with importPublic\n''2006.01.15 [2.4.0]''\nAdded support for tagging individual tiddlers with importSkip, importReplace, and/or importPrivate to control which tiddlers can be overwritten or shared with others when using auto-import macro syntax.  Defaults are to SKIP overwriting existing tiddlers with imported tiddlers, and ALLOW your tiddlers to be auto-imported by others.\n''2006.01.15 [2.3.2]''\nAdded &quot;ask&quot; parameter to confirm each tiddler before importing (for use with auto-importing)\n''2006.01.15 [2.3.1]''\nStrip TW core scripts from import source content and load just the storeArea into the hidden IFRAME.  Makes loading more efficient by reducing the document size and by preventing the import document from executing its TW initialization (including plugins).  Seems to resolve the &quot;Found 0 tiddlers&quot; problem.  Also, when importing local documents, use convertUTF8ToUnicode() to convert the file contents so support international characters sets.\n''2006.01.12 [2.3.0]''\nReorganized code to use callback function for loading import files to support event-driven I/O via an ASYNCHRONOUS XMLHttpRequest.  Let's processing continue while waiting for remote hosts to respond to URL requests.  Added non-interactive 'batch' macro mode, using parameters to specify which tiddlers to import, and from what document source.  Improved error messages and diagnostics, plus an optional 'quiet' switch for batch mode to eliminate //most// feedback.\n''2006.01.11 [2.2.0]''\nAdded &quot;[by tags]&quot; to list of tiddlers, based on code submitted by BradleyMeck\n''2006.01.09 [2.1.1]''\nWhen a URL is typed in, and then the &quot;open&quot; button is pressed, it generates both an onChange event for the file input and a click event for open button.  This results in multiple XMLHttpRequest()'s which seem to jam things up quite a bit.  I removed the onChange handling for file input field.  To open a file (local or URL), you must now explicitly press the &quot;open&quot; button in the control panel.\n''2006.01.08 [2.1.0]''\nIMPORT FROM ANYWHERE!!! re-write getImportedTiddlers() logic to either read a local file (using local I/O), OR... read a remote file, using a combination of XML and an iframe to permit cross-domain reading of DOM elements.  Adapted from example code and techniques courtesy of Jonny LeRoy.\n''2006.01.06 [2.0.2]''\nWhen refreshing list contents, fixed check for tiddlerExists() when &quot;show differences only&quot; is selected, so that imported tiddlers that don't exist in the current file will be recognized as differences and included in the list.\n''2006.01.04 [2.0.1]''\nWhen &quot;show differences only&quot; is NOT checked, import all tiddlers that have been selected even when they have a matching title and date.\n''2005.12.27 [2.0.0]''\nUpdate for TW2.0\nDefer initial panel creation and only register a notification function when panel first is created\n''2005.12.22 [1.3.1]''\ntweak formatting in importReport() and add 'discard report' link to output\n''2005.12.03 [1.3.0]''\nDynamically create/remove importPanel as needed to ensure only one instance of interface elements exists, even if there are multiple instances of macro embedding.  Also, dynamically create/recreate importFrame each time an external TW document is loaded for importation (reduces DOM overhead and ensures a 'fresh' frame for each document)\n''2005.11.29 [1.2.1]''\nfixed formatting of 'detail info' in importReport()\n''2005.11.11 [1.2.0]''\nadded 'inline' param to embed controls in a tiddler\n''2005.11.09 [1.1.0]''\nonly load HTML and CSS the first time the macro handler is called.  Allows for redundant placement of the macro without creating multiple instances of controls with the same ID's.\n''2005.10.25 [1.0.5]''\nfixed typo in importReport() that prevented reports from being generated\n''2005.10.09 [1.0.4]''\ncombined documentation with plugin code instead of using separate tiddlers\n''2005.08.05 [1.0.3]''\nmoved CSS and HTML definitions into plugin code instead of using separate tiddlers\n''2005.07.27 [1.0.2]''\ncore update 1.2.29: custom overlayStyleSheet() replaced with new core setStylesheet()\n''2005.07.23 [1.0.1]''\nadded parameter checks and corrected addNotification() usage\n''2005.07.20 [1.0.0]''\nInitial Release\n&lt;&lt;&lt;\n!!!!!Credits\n&lt;&lt;&lt;\nThis feature was developed by EricShulman from [[ELS Design Studios|http:/www.elsdesign.com]]\n&lt;&lt;&lt;\n!!!!!Code\n***/\n// // ''MACRO DEFINITION''\n//{{{\n// Version\nversion.extensions.importTiddlers = {major: 3, minor: 0, revision: 4, date: new Date(2006,4,18)};\n\n// IE needs explicit global scoping for functions/vars called from browser events\nwindow.onClickImportButton=onClickImportButton;\nwindow.refreshImportList=refreshImportList;\n\n// default cookie/option values\nif (!config.options.chkImportReport) config.options.chkImportReport=true;\n\nconfig.macros.importTiddlers = { };\nconfig.macros.importTiddlers = {\n	label: &quot;import tiddlers&quot;,\n	prompt: &quot;Copy tiddlers from another document&quot;,\n	foundMsg: &quot;Found %0 tiddlers in %1&quot;,\n	countMsg: &quot;%0 tiddlers selected for import&quot;,\n	importedMsg: &quot;Imported %0 of %1 tiddlers from %2&quot;,\n	src: &quot;&quot;,		// path/filename or URL of document to import (retrieved from SiteUrl tiddler)\n	proxy: &quot;&quot;,		// URL for remote proxy script (retrieved from SiteProxy tiddler)\n	useProxy: false,	// use specific proxy script in front of remote URL\n	inbound: null,		// hash-indexed array of tiddlers from other document\n	newTags: &quot;&quot;,		// text of tags added to imported tiddlers\n	addTags: true,		// add new tags to imported tiddlers\n	listsize: 8,		// # of lines to show in imported tiddler list\n	importTags: true,	// include tags from remote source document when importing a tiddler\n	keepTags: true,		// retain existing tags when replacing a tiddler\n	index: 0,		// current processing index in import list\n	sort: &quot;&quot;		// sort order for imported tiddler listbox\n};\n\nconfig.macros.importTiddlers.handler = function(place,macroName,params) {\n	if (!config.macros.loadTiddlers.handler)\n		{ alert(&quot;importTiddlers error: this plugin requires LoadTiddlersPlugin or TiddlyWiki 2.1+&quot;); return; }\n	if (!params[0]) // LINK TO FLOATING PANEL\n		createTiddlyButton(place,this.label,this.prompt,onClickImportMenu);\n	else if (params[0]==&quot;inline&quot;) {// // INLINE TIDDLER CONTENT\n		createImportPanel(place);\n		document.getElementById(&quot;importPanel&quot;).style.position=&quot;static&quot;;\n		document.getElementById(&quot;importPanel&quot;).style.display=&quot;block&quot;;\n	}\n	else config.macros.loadTiddlers.handler(place,macroName,params); // FALLBACK: PASS TO LOADTIDDLERS\n}\n//}}}\n\n// // ''INTERFACE DEFINITION''\n\n// // Handle link click to create/show/hide control panel\n//{{{\nfunction onClickImportMenu(e)\n{\n	if (!e) var e = window.event;\n	var parent=resolveTarget(e).parentNode;\n	var panel = document.getElementById(&quot;importPanel&quot;);\n	if (panel==undefined || panel.parentNode!=parent)\n		panel=createImportPanel(parent);\n	var isOpen = panel.style.display==&quot;block&quot;;\n	if(config.options.chkAnimate)\n		anim.startAnimating(new Slider(panel,!isOpen,e.shiftKey || e.altKey,&quot;none&quot;));\n	else\n		panel.style.display = isOpen ? &quot;none&quot; : &quot;block&quot; ;\n	e.cancelBubble = true;\n	if (e.stopPropagation) e.stopPropagation();\n	return(false);\n}\n//}}}\n\n// // Create control panel: HTML, CSS, register for notification\n//{{{\nfunction createImportPanel(place) {\n	var panel=document.getElementById(&quot;importPanel&quot;);\n	if (panel) { panel.parentNode.removeChild(panel); }\n	setStylesheet(config.macros.importTiddlers.css,&quot;importTiddlers&quot;);\n	panel=createTiddlyElement(place,&quot;span&quot;,&quot;importPanel&quot;,null,null)\n	panel.innerHTML=config.macros.importTiddlers.html;\n	store.addNotification(null,refreshImportList); // refresh listbox after every tiddler change\n	refreshImportList();\n	var siteURL=store.getTiddlerText(&quot;SiteUrl&quot;); if (!siteURL) siteURL=&quot;&quot;;\n	document.getElementById(&quot;importSourceURL&quot;).value=siteURL;\n	config.macros.importTiddlers.src=siteURL;\n	var siteProxy=store.getTiddlerText(&quot;SiteProxy&quot;); if (!siteProxy) siteProxy=&quot;SiteProxy&quot;;\n	document.getElementById(&quot;importSiteProxy&quot;).value=siteProxy;\n	config.macros.importTiddlers.proxy=siteProxy;\n	return panel;\n}\n//}}}\n\n// // CSS\n//{{{\nconfig.macros.importTiddlers.css = '\s\n#importPanel {\s\n	display: none; position:absolute; z-index:11; width:35em; right:105%; top:3em;\s\n	background-color: #eee; color:#000; font-size: 8pt; line-height:110%;\s\n	border:1px solid black; border-bottom-width: 3px; border-right-width: 3px;\s\n	padding: 0.5em; margin:0em; -moz-border-radius:1em;\s\n}\s\n#importPanel a, #importPanel td a { color:#009; display:inline; margin:0px; padding:1px; }\s\n#importPanel table { width:100%; border:0px; padding:0px; margin:0px; font-size:8pt; line-height:110%; background:transparent; }\s\n#importPanel tr { border:0px;padding:0px;margin:0px; background:transparent; }\s\n#importPanel td { color:#000; border:0px;padding:0px;margin:0px; background:transparent; }\s\n#importPanel select { width:98%;margin:0px;font-size:8pt;line-height:110%;}\s\n#importPanel input  { width:98%;padding:0px;margin:0px;font-size:8pt;line-height:110%}\s\n#importPanel .box { border:1px solid black; padding:3px; margin-bottom:5px; background:#f8f8f8; -moz-border-radius:5px;}\s\n#importPanel .topline { border-top:2px solid black; padding-top:3px; margin-bottom:5px; }\s\n#importPanel .rad { width:auto; }\s\n#importPanel .chk { width:auto; margin:1px; }\s\n#importPanel .btn { width:auto; }\s\n#importPanel .btn1 { width:98%; }\s\n#importPanel .btn2 { width:48%; }\s\n#importPanel .btn3 { width:32%; }\s\n#importPanel .btn4 { width:24%; }\s\n#importPanel .btn5 { width:19%; }\s\n#importPanel .importButton { padding: 0em; margin: 0px; font-size:8pt; }\s\n#importPanel .importListButton { padding:0em 0.25em 0em 0.25em; color: #000000; display:inline }\s\n#importCollisionPanel { display:none; margin:0.5em 0em 0em 0em; }\s\n';\n//}}}\n\n// // HTML \n//{{{\nconfig.macros.importTiddlers.html = '\s\n&lt;!-- source and report --&gt;\s\n&lt;table&gt;&lt;tr&gt;&lt;td align=left&gt;\s\n	import from\s\n	&lt;input type=&quot;radio&quot; class=&quot;rad&quot; name=&quot;importFrom&quot; value=&quot;file&quot; CHECKED\s\n		onClick=&quot;document.getElementById(\s'importLocalPanel\s').style.display=this.checked?\s'block\s':\s'none\s';\s\n			document.getElementById(\s'importHTTPPanel\s').style.display=!this.checked?\s'block\s':\s'none\s'&quot;&gt; local file\s\n	&lt;input type=&quot;radio&quot; class=&quot;rad&quot; name=&quot;importFrom&quot; value=&quot;http&quot;\s\n		onClick=&quot;document.getElementById(\s'importLocalPanel\s').style.display=!this.checked?\s'block\s':\s'none\s';\s\n			document.getElementById(\s'importHTTPPanel\s').style.display=this.checked?\s'block\s':\s'none\s'&quot;&gt; web server\s\n&lt;/td&gt;&lt;td align=right&gt;\s\n	&lt;input type=checkbox class=&quot;chk&quot; id=&quot;chkImportReport&quot; checked\s\n		onClick=&quot;config.options[\s'chkImportReport\s']=this.checked;&quot;&gt; create a report\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;!-- import from local file  --&gt;\s\n&lt;div id=&quot;importLocalPanel&quot; style=&quot;display:block;margin-bottom:5px;margin-top:5px;padding-top:3px;border-top:1px solid #999&quot;&gt;\s\nlocal document path/filename:&lt;br&gt;\s\n&lt;input type=&quot;file&quot; id=&quot;fileImportSource&quot; size=57 style=&quot;width:100%&quot;\s\n	onKeyUp=&quot;config.macros.importTiddlers.src=this.value&quot;\s\n	onChange=&quot;config.macros.importTiddlers.src=this.value;&quot;&gt;\s\n&lt;/div&gt;&lt;!--panel--&gt;\s\n\s\n&lt;!-- import from http server --&gt;\s\n&lt;div id=&quot;importHTTPPanel&quot; style=&quot;display:none;margin-bottom:5px;margin-top:5px;padding-top:3px;border-top:1px solid #999&quot;&gt;\s\n&lt;table&gt;&lt;tr&gt;&lt;td align=left&gt;\s\n	remote document URL:&lt;br&gt;\s\n&lt;/td&gt;&lt;td align=right&gt;\s\n	&lt;input type=&quot;checkbox&quot; class=&quot;chk&quot; id=&quot;importUseProxy&quot;\s\n		onClick=&quot;config.macros.importTiddlers.useProxy=this.checked;\s\n			document.getElementById(\s'importSiteProxy\s').style.display=this.checked?\s'block\s':\s'none\s'&quot;&gt; use a proxy script\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;importSiteProxy&quot; style=&quot;display:none;margin-bottom:1px&quot; onfocus=&quot;this.select()&quot; value=&quot;SiteProxy&quot;\s\n	onKeyUp=&quot;config.macros.importTiddlers.proxy=this.value&quot;\s\n	onChange=&quot;config.macros.importTiddlers.proxy=this.value;&quot;&gt;\s\n&lt;input type=&quot;text&quot; id=&quot;importSourceURL&quot; onfocus=&quot;this.select()&quot; value=&quot;SiteUrl&quot;\s\n	onKeyUp=&quot;config.macros.importTiddlers.src=this.value&quot;\s\n	onChange=&quot;config.macros.importTiddlers.src=this.value;&quot;&gt;\s\n&lt;/div&gt;&lt;!--panel--&gt;\s\n\s\n&lt;table&gt;&lt;tr&gt;&lt;td align=left&gt;\s\n	select:\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectAll&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;select all tiddlers&quot;&gt;\s\n		&amp;nbsp;all&amp;nbsp;&lt;/a&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectNew&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;select tiddlers not already in destination document&quot;&gt;\s\n		&amp;nbsp;added&amp;nbsp;&lt;/a&gt; \s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectChanges&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;select tiddlers that have been updated in source document&quot;&gt;\s\n		&amp;nbsp;changes&amp;nbsp;&lt;/a&gt; \s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importSelectDifferences&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;select tiddlers that have been added or are different from existing tiddlers&quot;&gt;\s\n		&amp;nbsp;differences&amp;nbsp;&lt;/a&gt; \s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importToggleFilter&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;show/hide selection filter&quot;&gt;\s\n		&amp;nbsp;filter&amp;nbsp;&lt;/a&gt; \s\n&lt;/td&gt;&lt;td align=right&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importListSmaller&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;reduce list size&quot;&gt;\s\n		&amp;nbsp;&amp;#150;&amp;nbsp;&lt;/a&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importListLarger&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;increase list size&quot;&gt;\s\n		&amp;nbsp;+&amp;nbsp;&lt;/a&gt;\s\n	&lt;a href=&quot;JavaScript:;&quot; id=&quot;importListMaximize&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot; title=&quot;maximize/restore list size&quot;&gt;\s\n		&amp;nbsp;=&amp;nbsp;&lt;/a&gt;\s\n&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;\s\n&lt;select id=&quot;importList&quot; size=8 multiple\s\n	onchange=&quot;setTimeout(\s'refreshImportList(\s'+this.selectedIndex+\s')\s',1)&quot;&gt;\s\n	&lt;!-- NOTE: delay refresh so list is updated AFTER onchange event is handled --&gt;\s\n&lt;/select&gt;\s\n&lt;input type=checkbox class=&quot;chk&quot; id=&quot;chkAddTags&quot; checked\s\n	onClick=&quot;config.macros.importTiddlers.addTags=this.checked;&quot;&gt;add new tags &amp;nbsp;\s\n&lt;input type=checkbox class=&quot;chk&quot; id=&quot;chkImportTags&quot; checked\s\n	onClick=&quot;config.macros.importTiddlers.importTags=this.checked;&quot;&gt;import source tags &amp;nbsp;\s\n&lt;input type=checkbox class=&quot;chk&quot; id=&quot;chkKeepTags&quot; checked\s\n	onClick=&quot;config.macros.importTiddlers.keepTags=this.checked;&quot;&gt;keep existing tags&lt;br&gt;\s\n&lt;input type=text id=&quot;txtNewTags&quot; size=15 onKeyUp=&quot;config.macros.importTiddlers.newTags=this.value&quot; autocomplete=off&gt;\s\n&lt;div align=center&gt;\s\n	&lt;input type=button id=&quot;importOpen&quot; class=&quot;importButton&quot; style=&quot;width:32%&quot; value=&quot;open&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot;&gt;\s\n	&lt;input type=button id=&quot;importStart&quot;	 class=&quot;importButton&quot; style=&quot;width:32%&quot; value=&quot;import&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot;&gt;\s\n	&lt;input type=button id=&quot;importClose&quot;	 class=&quot;importButton&quot; style=&quot;width:32%&quot; value=&quot;close&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot;&gt;\s\n&lt;/div&gt;\s\n&lt;div id=&quot;importCollisionPanel&quot;&gt;\s\n	tiddler already exists:\s\n	&lt;input type=text id=&quot;importNewTitle&quot; size=15 autocomplete=off&quot;&gt;\s\n	&lt;div align=center&gt;\s\n	&lt;input type=button id=&quot;importSkip&quot;	class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;skip&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot;&gt;\s\n	&lt;input type=button id=&quot;importRename&quot;  class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;rename&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot;&gt;\s\n	&lt;input type=button id=&quot;importMerge&quot;   class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;merge&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot;&gt;\s\n	&lt;input type=button id=&quot;importReplace&quot; class=&quot;importButton&quot; style=&quot;width:23%&quot; value=&quot;replace&quot;\s\n		onclick=&quot;onClickImportButton(this)&quot;&gt;\s\n	&lt;/div&gt;\s\n&lt;/div&gt;\s\n';\n//}}}\n\n// // Control interactions\n//{{{\nfunction onClickImportButton(which)\n{\n	// DEBUG alert(which.id);\n	var theList		  = document.getElementById('importList');\n	if (!theList) return;\n	var thePanel	= document.getElementById('importPanel');\n	var theCollisionPanel   = document.getElementById('importCollisionPanel');\n	var theNewTitle   = document.getElementById('importNewTitle');\n	var count=0;\n	switch (which.id)\n		{\n		case 'fileImportSource':\n		case 'importOpen':		// load import source into hidden frame\n			importReport();		// if an import was in progress, generate a report\n			config.macros.importTiddlers.inbound=null;	// clear the imported tiddler buffer\n			refreshImportList();	// reset/resize the listbox\n			if (config.macros.importTiddlers.src==&quot;&quot;) break;\n			// Load document into hidden iframe so we can read it's DOM and fill the list\n			loadRemoteFile(config.macros.importTiddlers.src, function(src,txt) {\n				var tiddlers = readTiddlersFromHTML(txt);\n				var count=tiddlers?tiddlers.length:0;\n				displayMessage(config.macros.importTiddlers.foundMsg.format([count,src]));\n				config.macros.importTiddlers.inbound=tiddlers;\n				window.refreshImportList(0);\n			});\n			break;\n		case 'importSelectAll':		// select all tiddler list items (i.e., not headings)\n			importReport();		// if an import was in progress, generate a report\n			for (var t=0,count=0; t &lt; theList.options.length; t++) {\n				if (theList.options[t].value==&quot;&quot;) continue;\n				theList.options[t].selected=true;\n				count++;\n			}\n			clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));\n			break;\n		case 'importSelectNew':		// select tiddlers not in current document\n			importReport();		// if an import was in progress, generate a report\n			for (var t=0,count=0; t &lt; theList.options.length; t++) {\n				theList.options[t].selected=false;\n				if (theList.options[t].value==&quot;&quot;) continue;\n				theList.options[t].selected=!store.tiddlerExists(theList.options[t].value);\n				count+=theList.options[t].selected?1:0;\n			}\n			clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));\n			break;\n		case 'importSelectChanges':		// select tiddlers that are updated from existing tiddlers\n			importReport();		// if an import was in progress, generate a report\n			for (var t=0,count=0; t &lt; theList.options.length; t++) {\n				theList.options[t].selected=false;\n				if (theList.options[t].value==&quot;&quot;||!store.tiddlerExists(theList.options[t].value)) continue;\n				for (var i=0; i&lt;config.macros.importTiddlers.inbound.length; i++) // find matching inbound tiddler\n					{ var inbound=config.macros.importTiddlers.inbound[i]; if (inbound.title==theList.options[t].value) break; }\n				theList.options[t].selected=(inbound.modified-store.getTiddler(theList.options[t].value).modified&gt;0); // updated tiddler\n				count+=theList.options[t].selected?1:0;\n			}\n			clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));\n			break;\n		case 'importSelectDifferences':		// select tiddlers that are new or different from existing tiddlers\n			importReport();		// if an import was in progress, generate a report\n			for (var t=0,count=0; t &lt; theList.options.length; t++) {\n				theList.options[t].selected=false;\n				if (theList.options[t].value==&quot;&quot;) continue;\n				if (!store.tiddlerExists(theList.options[t].value)) { theList.options[t].selected=true; count++; continue; }\n				for (var i=0; i&lt;config.macros.importTiddlers.inbound.length; i++) // find matching inbound tiddler\n					{ var inbound=config.macros.importTiddlers.inbound[i]; if (inbound.title==theList.options[t].value) break; }\n				theList.options[t].selected=(inbound.modified-store.getTiddler(theList.options[t].value).modified!=0); // changed tiddler\n				count+=theList.options[t].selected?1:0;\n			}\n			clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));\n			break;\n		case 'importToggleFilter': // show/hide filter\n		case 'importFilter': // apply filter\n			alert(&quot;coming soon!&quot;);\n			break;\n		case 'importStart':		// initiate the import processing\n			importReport();		// if an import was in progress, generate a report\n			config.macros.importTiddlers.index=0;\n			config.macros.importTiddlers.index=importTiddlers(0);\n			importStopped();\n			break;\n		case 'importClose':		// unload imported tiddlers or hide the import control panel\n			// if imported tiddlers not loaded, close the import control panel\n			if (!config.macros.importTiddlers.inbound) { thePanel.style.display='none'; break; }\n			importReport();		// if an import was in progress, generate a report\n			config.macros.importTiddlers.inbound=null;	// clear the imported tiddler buffer\n			refreshImportList();	// reset/resize the listbox\n			break;\n		case 'importSkip':	// don't import the tiddler\n			var theItem	= theList.options[config.macros.importTiddlers.index];\n			for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)\n			if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;\n			var theImported = config.macros.importTiddlers.inbound[j];\n			theImported.status='skipped after asking';			// mark item as skipped\n			theCollisionPanel.style.display='none';\n			config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index+1);	// resume with NEXT item\n			importStopped();\n			break;\n		case 'importRename':		// change name of imported tiddler\n			var theItem		= theList.options[config.macros.importTiddlers.index];\n			for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)\n			if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;\n			var theImported		= config.macros.importTiddlers.inbound[j];\n			theImported.status	= 'renamed from '+theImported.title;	// mark item as renamed\n			theImported.set(theNewTitle.value,null,null,null,null);		// change the tiddler title\n			theItem.value		= theNewTitle.value;			// change the listbox item text\n			theItem.text		= theNewTitle.value;			// change the listbox item text\n			theCollisionPanel.style.display='none';\n			config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index);	// resume with THIS item\n			importStopped();\n			break;\n		case 'importMerge':	// join existing and imported tiddler content\n			var theItem	= theList.options[config.macros.importTiddlers.index];\n			for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)\n			if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;\n			var theImported	= config.macros.importTiddlers.inbound[j];\n			var theExisting	= store.getTiddler(theItem.value);\n			var theText	= theExisting.text+'\sn----\sn^^merged from: ';\n			theText		+='[['+config.macros.importTiddlers.src+'#'+theItem.value+'|'+config.macros.importTiddlers.src+'#'+theItem.value+']]^^\sn';\n			theText		+='^^'+theImported.modified.toLocaleString()+' by '+theImported.modifier+'^^\sn'+theImported.text;\n			var theDate	= new Date();\n			var theTags	= theExisting.getTags()+' '+theImported.getTags();\n			theImported.set(null,theText,null,theDate,theTags);\n			theImported.status   = 'merged with '+theExisting.title;	// mark item as merged\n			theImported.status  += ' - '+theExisting.modified.formatString(&quot;MM/DD/YYYY 0hh:0mm:0ss&quot;);\n			theImported.status  += ' by '+theExisting.modifier;\n			theCollisionPanel.style.display='none';\n			config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index);	// resume with this item\n			importStopped();\n			break;\n		case 'importReplace':		// substitute imported tiddler for existing tiddler\n			var theItem		  = theList.options[config.macros.importTiddlers.index];\n			for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)\n			if (config.macros.importTiddlers.inbound[j].title==theItem.value) break;\n			var theImported     = config.macros.importTiddlers.inbound[j];\n			var theExisting	  = store.getTiddler(theItem.value);\n			theImported.status  = 'replaces '+theExisting.title;		// mark item for replace\n			theImported.status += ' - '+theExisting.modified.formatString(&quot;MM/DD/YYYY 0hh:0mm:0ss&quot;);\n			theImported.status += ' by '+theExisting.modifier;\n			theCollisionPanel.style.display='none';\n			config.macros.importTiddlers.index=importTiddlers(config.macros.importTiddlers.index);	// resume with THIS item\n			importStopped();\n			break;\n		case 'importListSmaller':		// decrease current listbox size, minimum=5\n			if (theList.options.length==1) break;\n			theList.size-=(theList.size&gt;5)?1:0;\n			config.macros.importTiddlers.listsize=theList.size;\n			break;\n		case 'importListLarger':		// increase current listbox size, maximum=number of items in list\n			if (theList.options.length==1) break;\n			theList.size+=(theList.size&lt;theList.options.length)?1:0;\n			config.macros.importTiddlers.listsize=theList.size;\n			break;\n		case 'importListMaximize':	// toggle listbox size between current and maximum\n			if (theList.options.length==1) break;\n			theList.size=(theList.size==theList.options.length)?config.macros.importTiddlers.listsize:theList.options.length;\n			break;\n		}\n}\n//}}}\n\n// // refresh listbox\n//{{{\nfunction refreshImportList(selectedIndex)\n{\n	var theList  = document.getElementById(&quot;importList&quot;);\n	if (!theList) return;\n	// if nothing to show, reset list content and size\n	if (!config.macros.importTiddlers.inbound) \n	{\n		while (theList.length &gt; 0) { theList.options[0] = null; }\n		theList.options[0]=new Option('please open a document...',&quot;&quot;,false,false);\n		theList.size=config.macros.importTiddlers.listsize;\n		return;\n	}\n	// get the sort order\n	if (!selectedIndex)   selectedIndex=0;\n	if (selectedIndex==0) config.macros.importTiddlers.sort='title';		// heading\n	if (selectedIndex==1) config.macros.importTiddlers.sort='title';\n	if (selectedIndex==2) config.macros.importTiddlers.sort='modified';\n	if (selectedIndex==3) config.macros.importTiddlers.sort='tags';\n	if (selectedIndex&gt;3) {\n		// display selected tiddler count\n		for (var t=0,count=0; t &lt; theList.options.length; t++) count+=(theList.options[t].selected&amp;&amp;theList.options[t].value!=&quot;&quot;)?1:0;\n		clearMessage(); displayMessage(config.macros.importTiddlers.countMsg.format([count]));\n		return; // no refresh needed\n	}\n\n	// get the alphasorted list of tiddlers (optionally, filter out unchanged tiddlers)\n	var tiddlers=config.macros.importTiddlers.inbound;\n	tiddlers.sort(function (a,b) {if(a['title'] == b['title']) return(0); else return (a['title'] &lt; b['title']) ? -1 : +1; });\n	// clear current list contents\n	while (theList.length &gt; 0) { theList.options[0] = null; }\n	// add heading and control items to list\n	var i=0;\n	var indent=String.fromCharCode(160)+String.fromCharCode(160);\n	theList.options[i++]=new Option(tiddlers.length+' tiddler'+((tiddlers.length!=1)?'s are':' is')+' in the document',&quot;&quot;,false,false);\n	theList.options[i++]=new Option(((config.macros.importTiddlers.sort==&quot;title&quot;   )?&quot;&gt;&quot;:indent)+' [by title]',&quot;&quot;,false,false);\n	theList.options[i++]=new Option(((config.macros.importTiddlers.sort==&quot;modified&quot;)?&quot;&gt;&quot;:indent)+' [by date]',&quot;&quot;,false,false);\n	theList.options[i++]=new Option(((config.macros.importTiddlers.sort==&quot;tags&quot;)?&quot;&gt;&quot;:indent)+' [by tags]',&quot;&quot;,false,false);\n	// output the tiddler list\n	switch(config.macros.importTiddlers.sort)\n		{\n		case &quot;title&quot;:\n			for(var t = 0; t &lt; tiddlers.length; t++)\n				theList.options[i++] = new Option(tiddlers[t].title,tiddlers[t].title,false,false);\n			break;\n		case &quot;modified&quot;:\n			// sort descending for newest date first\n			tiddlers.sort(function (a,b) {if(a['modified'] == b['modified']) return(0); else return (a['modified'] &gt; b['modified']) ? -1 : +1; });\n			var lastSection = &quot;&quot;;\n			for(var t = 0; t &lt; tiddlers.length; t++) {\n				var tiddler = tiddlers[t];\n				var theSection = tiddler.modified.toLocaleDateString();\n				if (theSection != lastSection) {\n					theList.options[i++] = new Option(theSection,&quot;&quot;,false,false);\n					lastSection = theSection;\n				}\n				theList.options[i++] = new Option(indent+indent+tiddler.title,tiddler.title,false,false);\n			}\n			break;\n		case &quot;tags&quot;:\n			var theTitles = {}; // all tiddler titles, hash indexed by tag value\n			var theTags = new Array();\n			for(var t=0; t&lt;tiddlers.length; t++) {\n				var title=tiddlers[t].title;\n				var tags=tiddlers[t].tags;\n				if (!tags || !tags.length) {\n					if (theTitles[&quot;untagged&quot;]==undefined) { theTags.push(&quot;untagged&quot;); theTitles[&quot;untagged&quot;]=new Array(); }\n					theTitles[&quot;untagged&quot;].push(title);\n				}\n				else for(var s=0; s&lt;tags.length; s++) {\n					if (theTitles[tags[s]]==undefined) { theTags.push(tags[s]); theTitles[tags[s]]=new Array(); }\n					theTitles[tags[s]].push(title);\n				}\n			}\n			theTags.sort();\n			for(var tagindex=0; tagindex&lt;theTags.length; tagindex++) {\n				var theTag=theTags[tagindex];\n				theList.options[i++]=new Option(theTag,&quot;&quot;,false,false);\n				for(var t=0; t&lt;theTitles[theTag].length; t++)\n					theList.options[i++]=new Option(indent+indent+theTitles[theTag][t],theTitles[theTag][t],false,false);\n			}\n			break;\n		}\n	theList.selectedIndex=selectedIndex;		  // select current control item\n	if (theList.size&lt;config.macros.importTiddlers.listsize) theList.size=config.macros.importTiddlers.listsize;\n	if (theList.size&gt;theList.options.length) theList.size=theList.options.length;\n}\n//}}}\n\n// // re-entrant processing for handling import with interactive collision prompting\n//{{{\nfunction importTiddlers(startIndex)\n{\n	if (!config.macros.importTiddlers.inbound) return -1;\n\n	var theList = document.getElementById('importList');\n	if (!theList) return;\n	var t;\n	// if starting new import, reset import status flags\n	if (startIndex==0)\n		for (var t=0;t&lt;config.macros.importTiddlers.inbound.length;t++)\n			config.macros.importTiddlers.inbound[t].status=&quot;&quot;;\n	for (var i=startIndex; i&lt;theList.options.length; i++)\n		{\n		// if list item is not selected or is a heading (i.e., has no value), skip it\n		if ((!theList.options[i].selected) || ((t=theList.options[i].value)==&quot;&quot;))\n			continue;\n		for (var j=0;j&lt;config.macros.importTiddlers.inbound.length;j++)\n			if (config.macros.importTiddlers.inbound[j].title==t) break;\n		var theImported = config.macros.importTiddlers.inbound[j];\n		var theExisting = store.getTiddler(theImported.title);\n		// avoid redundant import for tiddlers that are listed multiple times (when 'by tags')\n		if (theImported.status==&quot;added&quot;)\n			continue;\n		// don't import the &quot;ImportedTiddlers&quot; history from the other document...\n		if (theImported.title=='ImportedTiddlers')\n			continue;\n		// if tiddler exists and import not marked for replace or merge, stop importing\n		if (theExisting &amp;&amp; (theImported.status.substr(0,7)!=&quot;replace&quot;) &amp;&amp; (theImported.status.substr(0,5)!=&quot;merge&quot;))\n			return i;\n		// assemble tags (remote + existing + added)\n		var newTags = &quot;&quot;;\n		if (config.macros.importTiddlers.importTags)\n			newTags+=theImported.getTags()	// import remote tags\n		if (config.macros.importTiddlers.keepTags &amp;&amp; theExisting)\n			newTags+=&quot; &quot;+theExisting.getTags(); // keep existing tags\n		if (config.macros.importTiddlers.addTags &amp;&amp; config.macros.importTiddlers.newTags.trim().length)\n			newTags+=&quot; &quot;+config.macros.importTiddlers.newTags; // add new tags\n		theImported.set(null,null,null,null,newTags.trim());\n		// set the status to 'added' (if not already set by the 'ask the user' UI)\n		theImported.status=(theImported.status==&quot;&quot;)?'added':theImported.status;\n		// do the import!\n		store.addTiddler(theImported);\n		store.setDirty(true);\n		}\n	return(-1);	// signals that we really finished the entire list\n}\n//}}}\n\n//{{{\nfunction importStopped()\n{\n	var theList     = document.getElementById('importList');\n	var theNewTitle = document.getElementById('importNewTitle');\n	if (!theList) return;\n	if (config.macros.importTiddlers.index==-1)\n		importReport();		// import finished... generate the report\n	else\n		{\n		// DEBUG alert('import stopped at: '+config.macros.importTiddlers.index);\n		// import collision... show the collision panel and set the title edit field\n		document.getElementById('importCollisionPanel').style.display='block';\n		theNewTitle.value=theList.options[config.macros.importTiddlers.index].value;\n		}\n}\n//}}}\n\n// // ''REPORT GENERATOR''\n//{{{\nfunction importReport(quiet)\n{\n	if (!config.macros.importTiddlers.inbound) return;\n	// DEBUG alert('importReport: start');\n\n	// if import was not completed, the collision panel will still be open... close it now.\n	var panel=document.getElementById('importCollisionPanel'); if (panel) panel.style.display='none';\n\n	// get the alphasorted list of tiddlers\n	var tiddlers = config.macros.importTiddlers.inbound;\n	// gather the statistics\n	var count=0;\n	for (var t=0; t&lt;tiddlers.length; t++)\n		if (tiddlers[t].status &amp;&amp; tiddlers[t].status.trim().length &amp;&amp; tiddlers[t].status.substr(0,7)!=&quot;skipped&quot;) count++;\n\n	// generate a report\n	if (count &amp;&amp; config.options.chkImportReport) {\n		// get/create the report tiddler\n		var theReport = store.getTiddler('ImportedTiddlers');\n		if (!theReport) { theReport= new Tiddler(); theReport.title = 'ImportedTiddlers'; theReport.text  = &quot;&quot;; }\n		// format the report content\n		var now = new Date();\n		var newText = &quot;On &quot;+now.toLocaleString()+&quot;, &quot;+config.options.txtUserName\n		newText +=&quot; imported &quot;+count+&quot; tiddler&quot;+(count==1?&quot;&quot;:&quot;s&quot;)+&quot; from\sn[[&quot;+config.macros.importTiddlers.src+&quot;|&quot;+config.macros.importTiddlers.src+&quot;]]:\sn&quot;;\n		if (config.macros.importTiddlers.addTags &amp;&amp; config.macros.importTiddlers.newTags.trim().length)\n			newText += &quot;imported tiddlers were tagged with: \s&quot;&quot;+config.macros.importTiddlers.newTags+&quot;\s&quot;\sn&quot;;\n		newText += &quot;&lt;&lt;&lt;\sn&quot;;\n		for (var t=0; t&lt;tiddlers.length; t++) if (tiddlers[t].status) newText += &quot;#[[&quot;+tiddlers[t].title+&quot;]] - &quot;+tiddlers[t].status+&quot;\sn&quot;;\n		newText += &quot;&lt;&lt;&lt;\sn&quot;;\n		newText += &quot;&lt;html&gt;&lt;input type=\s&quot;button\s&quot; href=\s&quot;javascript:;\s&quot; &quot;;\n		newText += &quot;onclick=\s&quot;story.closeTiddler('&quot;+theReport.title+&quot;'); store.deleteTiddler('&quot;+theReport.title+&quot;');\s&quot; &quot;;\n		newText += &quot;value=\s&quot;discard report\s&quot;&gt;&lt;/html&gt;&quot;;\n		// update the ImportedTiddlers content and show the tiddler\n		theReport.text	 = newText+((theReport.text!=&quot;&quot;)?'\sn----\sn':&quot;&quot;)+theReport.text;\n		theReport.modifier = config.options.txtUserName;\n		theReport.modified = new Date();\n		store.addTiddler(theReport);\n		if (!quiet) { story.displayTiddler(null,theReport.title,1,null,null,false); story.refreshTiddler(theReport.title,1,true); }\n	}\n\n	// reset status flags\n	for (var t=0; t&lt;config.macros.importTiddlers.inbound.length; t++) config.macros.importTiddlers.inbound[t].status=&quot;&quot;;\n\n	// refresh display if tiddlers have been loaded\n	if (count) { store.setDirty(true);  store.notifyAll(); }\n\n	// always show final message when tiddlers were actually loaded\n	if (count) displayMessage(config.macros.importTiddlers.importedMsg.format([count,tiddlers.length,config.macros.importTiddlers.src]));\n}\n//}}}\n\n/***\n!!!!!TW 2.1beta Core Code Candidate\n//The following section is a preliminary 'code candidate' for incorporation of non-interactive 'load tiddlers' functionality into TW2.1beta. //\n***/\n//{{{\n// default cookie/option values\nif (!config.options.chkImportReport) config.options.chkImportReport=true;\n\nconfig.macros.loadTiddlers = {\n	label: &quot;&quot;,\n	prompt: &quot;add/update tiddlers from '%0'&quot;,\n	askMsg: &quot;Please enter a local path/filename or a remote URL&quot;,\n	openMsg: &quot;Opening %0&quot;,\n	openErrMsg: &quot;Could not open %0 - error=%1&quot;,\n	readMsg: &quot;Read %0 bytes from %1&quot;,\n	foundMsg: &quot;Found %0 tiddlers in %1&quot;,\n	loadedMsg: &quot;Loaded %0 of %1 tiddlers from %2&quot;\n};\n\nconfig.macros.loadTiddlers.handler = function(place,macroName,params) {\n	var label=(params[0] &amp;&amp; params[0].substr(0,6)=='label:')?params.shift().substr(6):this.label;\n	var prompt=(params[0] &amp;&amp; params[0].substr(0,7)=='prompt:')?params.shift().substr(7):this.prompt;\n	var filter=&quot;updates&quot;;\n	if (params[0] &amp;&amp; (params[0]=='all' || params[0]=='new' || params[0]=='changes' || params[0]=='updates'\n		|| params[0].substr(0,8)=='tiddler:' || params[0].substr(0,4)=='tag:'))\n		filter=params.shift();\n	var src=params.shift(); if (!src || !src.length) return; // filename is required\n	var quiet=(params[0]==&quot;quiet&quot;); if (quiet) params.shift();\n	var ask=(params[0]==&quot;confirm&quot;); if (ask) params.shift();\n	if (label.trim().length) {\n		// link triggers load tiddlers from another file/URL and then applies filtering rules to add/replace tiddlers in the store\n		createTiddlyButton(place,label.format([src]),prompt.format([src]), function() {\n			if (src==&quot;ask&quot;) src=prompt(config.macros.loadTiddlers.askMsg);\n			loadRemoteFile(src,loadTiddlers,quiet,ask,filter);\n		})\n	}\n	else {\n		// load tiddlers from another file/URL and then apply filtering rules to add/replace tiddlers in the store\n		if (src==&quot;ask&quot;) src=prompt(config.macros.loadTiddlers.askMsg);\n		loadRemoteFile(src,loadTiddlers,quiet,ask,filter);\n	}\n}\n\nfunction loadTiddlers(src,html,quiet,ask,filter)\n{\n	var tiddlers = readTiddlersFromHTML(html);\n	var count=tiddlers?tiddlers.length:0;\n	if (!quiet) displayMessage(config.macros.loadTiddlers.foundMsg.format([count,src]));\n	var count=0;\n	if (tiddlers) for (var t=0;t&lt;tiddlers.length;t++) {\n		var theInbound = tiddlers[t];\n		var theExisting = store.getTiddler(theInbound.title);\n		if (theInbound.title=='ImportedTiddlers')\n			continue; // skip &quot;ImportedTiddlers&quot; history from the other document...\n\n		// apply the all/new/changes/updates filter (if any)\n		if (filter &amp;&amp; filter!=&quot;all&quot;) {\n			if ((filter==&quot;new&quot;) &amp;&amp; theExisting) // skip existing tiddlers\n				continue;\n			if ((filter==&quot;changes&quot;) &amp;&amp; !theExisting) // skip new tiddlers\n				continue;\n			if ((filter.substr(0,4)==&quot;tag:&quot;) &amp;&amp; theInbound.tags.find(filter.substr(4))==null) // must match specific tag value\n				continue;\n			if ((filter.substr(0,8)==&quot;tiddler:&quot;) &amp;&amp; theInbound.title!=filter.substr(8)) // must match specific tiddler name\n				continue;\n			if (store.tiddlerExists(theInbound.title) &amp;&amp; ((theExisting.modified.getTime()-theInbound.modified.getTime())&gt;=0)) // tiddler is unchanged\n				continue;\n		}\n		// get confirmation if required\n		if (ask &amp;&amp; !confirm((theExisting?&quot;Update&quot;:&quot;Add&quot;)+&quot; tiddler '&quot;+theInbound.title+&quot;'\snfrom &quot;+src))\n			{ tiddlers[t].status=&quot;skipped - cancelled by user&quot;; continue; }\n		// DO IT!\n		store.addTiddler(theInbound);\n		tiddlers[t].status=theExisting?&quot;updated&quot;:&quot;added&quot;\n		count++;\n	}\n	if (count) {\n		// refresh display\n		store.setDirty(true);\n		store.notifyAll();\n		// generate a report\n		if (config.options.chkImportReport) {\n			// get/create the report tiddler\n			var theReport = store.getTiddler('ImportedTiddlers');\n			if (!theReport) { theReport= new Tiddler(); theReport.title = 'ImportedTiddlers'; theReport.text  = &quot;&quot;; }\n			// format the report content\n			var now = new Date();\n			var newText = &quot;On &quot;+now.toLocaleString()+&quot;, &quot;+config.options.txtUserName+&quot; loaded &quot;+count+&quot; tiddlers from\sn[[&quot;+src+&quot;|&quot;+src+&quot;]]:\sn&quot;;\n			newText += &quot;&lt;&lt;&lt;\sn&quot;;\n			for (var t=0; t&lt;tiddlers.length; t++) if (tiddlers[t].status) newText += &quot;#[[&quot;+tiddlers[t].title+&quot;]] - &quot;+tiddlers[t].status+&quot;\sn&quot;;\n			newText += &quot;&lt;&lt;&lt;\sn&quot;;\n			newText += &quot;&lt;html&gt;&lt;input type=\s&quot;button\s&quot; href=\s&quot;javascript:;\s&quot; &quot;;\n			newText += &quot;onclick=\s&quot;story.closeTiddler('&quot;+theReport.title+&quot;'); store.deleteTiddler('&quot;+theReport.title+&quot;');\s&quot; &quot;;\n			newText += &quot;value=\s&quot;discard report\s&quot;&gt;&lt;/html&gt;&quot;;\n			// update the ImportedTiddlers content and show the tiddler\n			theReport.text	 = newText+((theReport.text!=&quot;&quot;)?'\sn----\sn':&quot;&quot;)+theReport.text;\n			theReport.modifier = config.options.txtUserName;\n			theReport.modified = new Date();\n			store.addTiddler(theReport);\n			if (!quiet) { story.displayTiddler(null,theReport.title,1,null,null,false); story.refreshTiddler(theReport.title,1,true); }\n		}\n	}\n	// always show final message when tiddlers were actually loaded\n	if (!quiet||count) displayMessage(config.macros.loadTiddlers.loadedMsg.format([count,tiddlers.length,src]));\n}\n\nfunction loadRemoteFile(src,callback,quiet,ask,filter) {\n	if (src==undefined || !src.length) return null; // filename is required\n	if (!quiet) clearMessage();\n	if (!quiet) displayMessage(config.macros.loadTiddlers.openMsg.format([src]));\n	if (src.substr(0,4)!=&quot;http&quot;) { // fallback to read from local filesystem\n		var txt=loadFile(src);\n		if ((txt==null)||(txt==false)) // file didn't load\n			{ if (!quiet) displayMessage(config.macros.loadTiddlers.openErrMsg.format([src,&quot;(unknown)&quot;])); }\n		else {\n			if (!quiet) displayMessage(config.macros.loadTiddlers.readMsg.format([txt.length,src]));\n			if (callback) callback(src,convertUTF8ToUnicode(txt),quiet,ask,filter);\n		}\n	}\n	else {\n		var x; // XML object\n		try {x = new XMLHttpRequest()}\n		catch(e) {\n			try {x = new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;)}\n			catch (e) {\n				try {x = new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)}\n				catch (e) { return }\n			}\n		}\n		x.onreadystatechange = function() {\n			if (x.readyState == 4) {\n				if (x.status == 200) {\n					if (!quiet) displayMessage(config.macros.loadTiddlers.readMsg.format([x.responseText.length,src]));\n					if (callback) callback(src,x.responseText,quiet,ask,filter);\n				}\n				else {\n					if (!quiet) displayMessage(config.macros.loadTiddlers.openErrMsg.format([src,x.status]));\n				}\n			}\n		}\n		if ((document.location.protocol==&quot;file:&quot;) &amp;&amp; (typeof(netscape)!=&quot;undefined&quot;)) { // UniversalBrowserRead only works from a local file context\n			try { netscape.security.PrivilegeManager.enablePrivilege('UniversalBrowserRead')}\n			catch (e) { if (!quiet) displayMessage(e.description?e.description:e.toString()); }\n		}\n		try {\n			var url=src+(src.indexOf('?')&lt;0?'?':'&amp;')+'nocache='+Math.random();\n			x.open(&quot;GET&quot;,url,true);\n			if (x.overrideMimeType) x.overrideMimeType('text/html');\n			x.send(null);\n		}\n		catch (e) {\n			if (!quiet) {\n				displayMessage(config.macros.loadTiddlers.openErrMsg.format([src,&quot;(unknown)&quot;]));\n				displayMessage(e.description?e.description:e.toString());\n			}\n		}\n	}\n}\n\nfunction readTiddlersFromHTML(html)\n{\n	// extract store area from html \n	var start=html.indexOf('&lt;div id=&quot;storeArea&quot;&gt;');\n	var end=html.indexOf('&lt;/body&gt;',start);\n	var sa=&quot;&lt;html&gt;&lt;body&gt;&quot;+html.substring(start,end)+&quot;&lt;/body&gt;&lt;/html&gt;&quot;;\n\n	// load html into iframe document\n	var f=document.getElementById(&quot;loaderFrame&quot;); if (f) document.body.removeChild(f);\n	f=document.createElement(&quot;iframe&quot;); f.id=&quot;loaderFrame&quot;;\n	f.style.width=&quot;0px&quot;; f.style.height=&quot;0px&quot;; f.style.border=&quot;0px&quot;;\n	document.body.appendChild(f);\n	var d=f.document;\n	if (f.contentDocument) d=f.contentDocument; // For NS6\n	else if (f.contentWindow) d=f.contentWindow.document; // For IE5.5 and IE6\n	d.open(); d.writeln(sa); d.close();\n\n	// read tiddler DIVs from storeArea DOM element	\n	var sa = d.getElementById(&quot;storeArea&quot;);\n	if (!sa) return null;\n	sa.normalize();\n	var nodes = sa.childNodes;\n	if (!nodes || !nodes.length) return null;\n	var tiddlers = [];\n	for(var t = 0; t &lt; nodes.length; t++) {\n		var title = null;\n		if(nodes[t].getAttribute)\n			title = nodes[t].getAttribute(&quot;tiddler&quot;);\n		if(!title &amp;&amp; nodes[t].id &amp;&amp; (nodes[t].id.substr(0,5) == &quot;store&quot;))\n			title = nodes[t].id.substr(5);\n		if(title &amp;&amp; title != &quot;&quot;)\n			tiddlers.push((new Tiddler()).loadFromDiv(nodes[t],title));\n	}\n	return tiddlers;\n}\n//}}}</div>
<div tiddler="MainMenu" modifier="YourName" modified="200605132055" created="200605072254" tags="">[[about Bloobot]] [[how it works]] [[where it works|supported merchant sites]] [[where the $ goes]]  [[install it]]  [[privacy]] [[register|to register]]\n</div>
<div tiddler="MyOptions" modifier="YourName" modified="200605100027" created="200605100027" tags="">&lt;&lt;newTiddler&gt;&gt;\n&lt;&lt;newJournal 'DD MMM YYYY'&gt;&gt;\n&lt;&lt;saveChanges&gt;&gt;\n&lt;&lt;slider chkSliderOptionsPanel OptionsPanel 'options Â»' 'Change TiddlyWiki advanced options'&gt;&gt;</div>
<div tiddler="PageTemplate" modifier="YourName" modified="200605100013" created="200605072136" tags="">&lt;div class='header' &gt;\n&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;\n&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;\n&lt;/div&gt;\n&lt;div id='mainMenu' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;\n&lt;div id='sidebar'&gt;\n&lt;div id='sidebarOptions' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;\n&lt;div id='sidebarTabs' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;\n&lt;/div&gt;\n&lt;div id='displayArea'&gt;\n&lt;div id='messageArea'&gt;&lt;/div&gt;\n&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;\n&lt;/div&gt;</div>
<div tiddler="SideBarOptions" modifier="YourName" modified="200605100028" created="200605100028" tags="">&lt;&lt;search&gt;&gt;&lt;&lt;closeAll&gt;&gt;&lt;&lt;permaview&gt;&gt;&lt;&lt;slider chkMyOptions MyOptions 'edit document Â»' 'advanced editing commands'&gt;&gt;</div>
<div tiddler="SiteSubtitle" modifier="YourName" modified="200605120007" created="200605072246" tags="">[img[http://www.mediaventure.org/bloobot/images/bloobot2-med.jpg]] &amp;nbsp;smart money for progressive causes</div>
<div tiddler="SiteTitle" modifier="YourName" modified="200605072245" created="200605072245" tags="">Bloobot</div>
<div tiddler="Structure" modifier="YourName" modified="200605072244" created="200605072244" tags="">Its useful to understand the structure of a web page so you can 'describe' in your styles which element (like div, a, or #contentWrapper) you are coloring. For simplicity I'll only include elements that you would want to style. (Firefox extensions make this easier and somwhat automated.) I hope to make this list collapsable in the future to improve legibility.\n\n*html\n**body\n***div#contentWrapper //Use this for [[Centering the TiddlyWiki]] or [[Increasing specificity]]//\n****div#header\n*****div#titleLine\n******span.siteTitle //The site's title (content is controlled by the SiteTitle tiddler)// \n******span.siteSubtitle //The site's subtitle (content is controlled by the SiteSubtitle tiddler)//\n****div#sidebar //The sidebar on the right//\n*****div#sidebarOptions //The sidebar that contains the seach box (content is controlled by the SideBarOptions tiddler)//\n******div.sliderPanel //This is the panel containing the option checkboxes (content is controled by the OptionsPanel tiddler)//\n*****div#sidebarTabs //The sidebar with the tabs (content is controlled by the SideBarTabs tiddler) //\n******div.txtMainTab //The class name is determined by the tab generating macro//\n*******div.tabset //The tabs are contained in the tabset//\n********a.tab.tabSelected\n********a.tab.tabUnselected\n*******div.tabContents\n****div#mainMenu\n****div#displayArea\n*****div#messageArea\n*****div#tiddlerDisplay\n******div#tiddlerTiddlerName.tiddler //The TiddlerName part of the id is customized per tiddler (See [[Tiddler IDs]]) //\n*******div.unselectedTiddler //This div's class changes to .unselected when the mouse hovers over it. //\n********div#toolbarTiddlerName.toolbar\n********div#titleTiddlerName.title\n********div#bodyTiddlerName.body //This div and its children (.viewer and .footer) change when editing (see [[Editor Structure]]) //\n*********div#viewerTiddlerName.viewer\n**********div#popup //The popup is generated in a number of places but it uses the same code (see [[Styling the popup]]) //\n***********hr //The horizontal rule exists in all popups//\n*********div#footerTiddlerName.footer\n**********div //This div holds the tags listing//</div>
<div tiddler="StyleSheet" modifier="YourName" modified="200605162109" created="200605072257" tags="">/***\nPlace your custom CSS here\n***/\n/*{{{*/\n\n#contentWrapper {\nfont-family: verdana;\nfont-size: 11px;\n}\n\n.header {\nfont-family: 'Courier New';\ncolor: yellow; }\n\n.siteTitle {\nfont-weight: bold;\nfont-size: 30px;\npadding-left: 10px;\n}\n.siteSubtitle {\n  font-size: 18px;\n  font-weight: bold;\n  padding-left: 10px;\n\n}\n\n.siteSubtitle img {\nmargin-bottom: -9px;\n}\n\n#displayArea {\nborder: 0px solid grey;\nmargin-left: 150px;\n}\n\n.header {\nbackground:#0678B4;\n}\n\n#mainMenu {\n  line-height: 166%;\n  border: 1px solid #999;\n  border-bottom: 1px solid #999;\n  letter-spacing: 1px;\nfont-size: 11px;\nwidth: auto;\n}\n\n\n#mainMenu, #mainMenu a {\nbackground: #FFFFee;\n}\n\n#mainMenu a {\n  color: #003;\n  display: block;\n  padding: 0 5px 0 5px;\n  height: 22px;\n  line-height: 22px;\n  border-top: 0;\n  border-bottom: 0;\n  letter-spacing: 1px;\n}\n#mainMenu a:hover {\n  background: #0678B4;\n  color: yellow;\n}\n\n\n\n\n#titleLine { color: #66f; }\n#titleLine a { color: #36c; }\n#titleLine a:hover { color: #99f; }\n\n.tiddler {\nborder: 1px solid grey;\nmargin: 3px;\nmargin-top: 15px;\npadding-bottom: 10px;\nbackground: #f5f5f5;\n}\n/*}}}*/\n</div>
<div tiddler="UniqueID" modifier="YourName" modified="200605161546" created="200605161546" tags="">see [[credits for spreading the word]].</div>
<div tiddler="UsefulStuff" modifier="YourName" modified="200605072255" created="200605072255" tags="">SiteTitle\nSiteSubtitle\nStyleSheet\nFormattingInstructions\nDefaultTiddlers\nMainMenu</div>
<div tiddler="ViewTemplate" modifier="YourName" modified="200605152251" created="200605092339" tags="">&lt;div class='toolbar' macro='toolbar -closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;\n&lt;div class='title' macro='view title'&gt;&lt;/div&gt;\n&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;\n&lt;div class='tagClear'&gt;&lt;/div&gt;</div>
<div tiddler="about Bloobot" modifier="YourName" modified="200605161713" created="200605101613" tags="">''BlooBot is very simple''. You [[install it]], and with no further effort on your part, 4-10% of your subsequent online purchases at [[most major retailers|supported merchant sites]] automatically goes to your [[favorite progressive causes|where the $ goes]].\n\n''No registration, no extra cost, no change in your shopping behavior''. Just free money for good things.\n\n''If you're not using it, you're throwing away money''. Progressives spent hundreds of millions of dollars online last year, most of which could be generating commissions of 4-10%. BlooBot is here to make that easy.\n\nIt is a simple addition to your browser (Firefox only currently), that recognizes webpages of merchants we have agreements with, and &quot;handshakes&quot; with them in the background so that any purchases you make will generate commissions for your chosen beneficiary. \n\nSo what are you waiting for? [[Install it|install it]].</div>
<div tiddler="credits for spreading the word" modifier="YourName" modified="200605161546" created="200605161451" tags="">Each time Bloobot is installed, it is assigned a UniqueID in the form of a timestamp in milliseconds (yyyymmddhhmmssmmm).  It is displayed in the Bloobot window when you open it up.\n\nUsers can get credited anonymously for spreading the word by telling others about Bloobot using the URL www.mediaventure.org/bloobot?id=# where # is your UniqueID. \n\nWhen new users install it thru that link, they will be credited to you, for future use in deciding how to allocate the money.\n\nSuch credits will be converted to something useful if and when you [[register|to register]].</div>
<div tiddler="how it works" modifier="YourName" modified="200605152250" created="200605102140" tags="">Bloobot works by using [[&quot;affiliate&quot; programs|http://www.google.com/search?hl=en&amp;lr=&amp;defl=en&amp;q=define:Affiliate+programs&amp;sa=X&amp;oi=glossary_definition&amp;ct=title]] at all the [[major online retailers|supported merchant sites]].\n\nWhenever you surf to a merchant it knows about, a little Bloobot logo [img[http://www.mediaventure.org/bloobot/images/bloobot2-tiny.jpg]] appears in the upper left, [[looking like this|Bloobot closed]]. That lets you know it's working, and clicking on it [[opens it up|Bloobot open]] to let you change your beneficiary, get info on the merchant and product, etc.\n\nWhen you choose a beneficiary, that determines the appropriate affiliate codes to use, depending on what retailer you're using. \n\nBloobot automatically appends the code where it's needed so that any purchases you make get credited to your chosen beneficiary.\n\nEach retailer tracks all such purchases and gives the owner of the code a 4-10% (depending on the retailer) commission on each one, distributed quarterly.\n</div>
<div tiddler="install it" modifier="YourName" modified="200605161447" created="200605101617" tags="">BlooBot is easy to install, and requires no registration. It will get even easier in upcoming versions. \n\nIn its current prototype form, it runs only on Firefox 1.5 and up, and is built on Greasemonkey (also from [[Mozilla|http://mozilla.org]]), which needs to be installed first. Both it and BlooBot are easy to install and uninstall.\n\nFollow these simple instructions carefully and you'll have no problem. \n\n#First, assuming your on Firefox 1.5, ''[[install Greasemonkey|http://greasemonkey.mozdev.org/]]''. It's fast and simple. \n#''If it seems like nothing happens'', it's probably because you have pop-ups blocked.  You'll need to allow them for the Greasemonkey installation, and re-click the &quot;install Greasemonkey&quot; link.\n#You then need to ''restart Firefox''.\n#Now ''[[install Bloobot|http://www.mediaventure.org/bloobot/bloobotdev11.user.js]]''. This should show up as Javascript code in your browser. Firefox should prompt you with an ''Install button in the upper right'', but if not, install it using its Tools menu, where there will be a new menu item to &quot;Install User Script&quot;. Accept the default configuration and install.\n\nThat's it. It should work on all the [[supported merchant sites]].\n\n*So, try it - Go to any Amazon product page, like ''[[this one|http://www.amazon.com/gp/product/B000A3WS8O/sr=1-2/qid=1135549102/ref=pd_bbs_2/002-7197333-3186429?%5Fencoding=UTF8]]'' or browse around ''[[Barnes and Noble|http://www.barnesandnoble.com]]'' or ''[[Sony Style|http://www.sonystyle.com]]''. \n\nA little Bloobot logo [img[http://www.mediaventure.org/bloobot/images/bloobot2-tiny.jpg]] should show up in the upper left. Click on it to see the approximate commission the current product would yield (Amazon only right now). All product links on the page will link to a URL at www.mediaventure.org with the information needed to link back with the appropriate code, which you can see by mousing over such links. </div>
<div tiddler="privacy" modifier="YourName" modified="200605161447" created="200605112357" tags="">We, like most people, value privacy and security highly. \n\nBloobot is structured so we don't need to know any personal data about you. You don't need to register, and we thus can't contact you except through the Bloobot button under your control.\n\nNor does Bloobot communicate anything about your behavior to us or anyone. Communication with our server is minimal and almost entirely from us to you. Anyone who wishes to can confirm that because the code is exposed and viewable at [[install Bloobot|http://www.mediaventure.org/bloobot/bloobotdev11.user.js]]. \n\nThere are two infrequent times that your Bloobot sends information to our server:\n# The first time you use it, it sends a notice to our server that a new user is activated, identified by a unique ID. This allows us to reliable count the number of users (as opposed to just those who view the script), and to [[credit you for helping promote Bloobot|credits for spreading the word]].\n# Each time you initiate a session with a merchant that Bloobot recognizes, it handshakes with our server to know what to do. \nThat's it. \n\n</div>
<div tiddler="supported merchant sites" modifier="YourName" modified="200605132205" created="200605102208" tags="">''Currently works best on Amazon'', where it displays product-related information. \n\nWe have agreements with the following, and will be adding many more. Try it out on the ones with links.\n\nBooks - [[Amazon|http://www.amazon.com/gp/product/B000A3WS8O/sr=1-2/qid=1135549102/ref=pd_bbs_2/002-7197333-3186429?%5Fencoding=UTF8]], [[Powells|http://www.powells.com]], [[Barnes and Noble|http://www.barnesandnoble.com]], Abe Books, Booksense, Alibris and more\nGeneral shopping - Buy.com, Shop.com, Overstock.com\nFlowers - [[1800Flowers.com|http://www.1800flowers.com]]\nOutdoor - [[Eddie Bauer|http://www.eddiebaueroutlet.com]]\nElectronics - [[Sony Style|http://www.sonystyle.com]], Best Buy, [[CompUSA|http://www.compusa.com]]\nAuto - Toshiba, Enterprise Rental</div>
<div tiddler="to register" modifier="YourName" modified="200605132053" created="200605132053" tags="">We will be adding voluntary registration shortly so that we can provide additional services that require having a way to contact you. \n\nWe will be using [[YADIS|http://yadis.org/wiki/Main_Page]], built on the principles of [[Identity Commons|http://www.idcommons.net]]  for that purpose.\n\nUntil then, anyone interested can send email to bloobot-register at mediaventure.org. \n\nThanks\n</div>
<div tiddler="where the $ goes" modifier="YourName" modified="200605112355" created="200605102218" tags="">We try to focus on organizations that further progressive causes, primarily but not exclusively in the media and communications arena.\n\nThese include [[Alternet|http://www.alternet.org]], [[Witness|http://www.witness.org]], [[DailyKos|http://www.dailykos.com]], [[MyDD|http://www.mydd.com]], [[firedoglake|http://www.firedoglake.com]], [[Organic Consumers Association|http://www.organicconsumers.org]], [[LinkTV|http://www.linktv.org]], [[Code Pink|http://www.codepink.org]].\n\nWe will be adding more over time.\n\nIf you would like to suggest a beneficiary, send email to bloobot at mediaventure dot org.</div>
		</div>
<!--POST-BODY-START-->

<!--POST-BODY-END-->
	</body>
</html>
